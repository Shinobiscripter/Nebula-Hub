<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NEBULAHUB</title>

  <!-- NebulaHub SVG Favicon - unique nebula/galaxy logo -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='nebula' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%2322c55e'/%3E%3Cstop offset='40%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%23030014'/%3E%3C/radialGradient%3E%3CradialGradient id='glow' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='0.9'/%3E%3Cstop offset='100%25' stop-color='%23ffffff' stop-opacity='0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='%23030014'/%3E%3Ccircle cx='50' cy='50' r='46' fill='url(%23nebula)' opacity='0.9'/%3E%3Cellipse cx='50' cy='50' rx='28' ry='12' fill='none' stroke='%23a78bfa' stroke-width='2.5' opacity='0.7' transform='rotate(-20 50 50)'/%3E%3Cellipse cx='50' cy='50' rx='38' ry='16' fill='none' stroke='%2322c55e' stroke-width='1.5' opacity='0.5' transform='rotate(15 50 50)'/%3E%3Ccircle cx='50' cy='50' r='7' fill='url(%23glow)'/%3E%3Ccircle cx='50' cy='50' r='4' fill='white' opacity='0.95'/%3E%3Ccircle cx='30' cy='32' r='1.5' fill='white' opacity='0.8'/%3E%3Ccircle cx='70' cy='28' r='1' fill='white' opacity='0.7'/%3E%3Ccircle cx='72' cy='68' r='1.5' fill='%2322c55e' opacity='0.9'/%3E%3Ccircle cx='25' cy='65' r='1' fill='%23a78bfa' opacity='0.8'/%3E%3Ccircle cx='62' cy='22' r='1' fill='white' opacity='0.6'/%3E%3C/svg%3E">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-886SN3349C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-886SN3349C');
  </script>

  <!-- AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8989843364629092" crossorigin="anonymous"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- SortableJS for drag-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ============================================================
       NEBULAHUB — STYLESHEET
       ============================================================
       TABLE OF CONTENTS
       ----------------------------------------------------------
       1.  CSS VARIABLES & ROOT
       2.  BASE / RESET / BODY
       3.  LAYOUT — APP SHELL & SIDEBAR
       4.  LIBRARY — GAME GRID & CARDS
       5.  PLAYER VIEW
       6.  DEVELOPER MODE
       7.  UPDATE MODAL
       8.  PORTAL MODE
       9.  THEMES
       10. NEBULACHAT
       11. ANNOUNCEMENTS & SURVEY
       12. SOLAR UI — BRAND & SEARCH BAR
       13. SOLAR UI — BOTTOM DOCK
       14. SOLAR UI — FULL-SCREEN PANELS
       15. UI TOGGLE DROPDOWN
       ============================================================ */

    /* ============================================================
       1. CSS VARIABLES & ROOT
       ============================================================ */
    :root {
      --bg: #030014;
      --bg-elevated: #06051c;
      --bg-soft: #0c1024;
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.25);
      --accent-strong: #22c55e;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.6);
      --transition-fast: 0.15s ease-out;
      
      /* Custom user overrides */
      --custom-brand-color: #22c55e;
      --custom-accent-color: #8b5cf6;
      --custom-accent-strong: #22c55e;
      --custom-bg-grad-1: #1f2937;
      --custom-bg-grad-2: #111827;
      --custom-overlay-1: rgba(59,130,246,0.35);
      --custom-overlay-2: rgba(236,72,153,0.3);
      --custom-chat-sent: #8b5cf6;
      --custom-chat-bg: #0c1024;
    }

    /* ============================================================
       2. BASE / RESET / BODY
       ============================================================ */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background:
        radial-gradient(circle at top left, var(--custom-bg-grad-1) 0, transparent 55%),
        radial-gradient(circle at bottom right, var(--custom-bg-grad-2) 0, transparent 55%),
        radial-gradient(circle at top right, var(--custom-overlay-1), transparent 60%),
        radial-gradient(circle at bottom left, var(--custom-overlay-2), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.55;
      mix-blend-mode: screen;
      z-index: -2;
    }

    body::before {
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.8) 0, transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 30%, rgba(244,244,245,0.7) 0, transparent 55%),
        radial-gradient(2px 2px at 50% 80%, rgba(248,250,252,0.7) 0, transparent 60%),
        radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,0.4) 0, transparent 55%);
      animation: driftStars 38s linear infinite;
    }

    body::after {
      background-image:
        radial-gradient(circle at 20% 0%, rgba(59,130,246,0.45), transparent 60%),
        radial-gradient(circle at 80% 100%, rgba(236,72,153,0.45), transparent 60%);
      filter: blur(8px);
      z-index: -3;
      opacity: 0.8;
    }

    @keyframes driftStars {
      0% { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-40px, -60px, 0); }
    }

    /* ============================================================
       3. LAYOUT — APP SHELL & SIDEBAR
       ============================================================ */
    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, rgba(129,140,248,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(236,72,153,0.16), transparent 55%),
                  linear-gradient(145deg, rgba(15,23,42,0.97), rgba(3,7,18,0.98));
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(129,140,248,0.4);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      backdrop-filter: blur(18px) saturate(1.2);
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand { display:flex; align-items:center; gap:10px; }

    .brand-logo {
      width: 38px; height: 38px; border-radius: 14px;
      background: conic-gradient(from 200deg, var(--custom-accent-color), var(--custom-accent-strong), #ec4899, #0ea5e9, var(--custom-accent-color));
      padding: 2px;
      box-shadow: 0 0 20px rgba(129,140,248,0.8);
    }

    .brand-logo-inner {
      width: 100%; height: 100%; border-radius: 12px;
      background:
        radial-gradient(circle at 30% 20%, var(--custom-brand-color), #040018 65%),
        radial-gradient(circle at 80% 80%, rgba(96,165,250,0.65), transparent 60%);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:1.1rem; color:#e5e7eb; letter-spacing:0.08em;
    }

    .brand-text-main {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .brand-text-main span:nth-child(2) { color: var(--custom-accent-strong); font-weight: 800; }
    .brand-sub { font-size: 0.78rem; color: var(--text-soft); }

    .pill {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--custom-accent-strong);
      box-shadow: 0 0 10px rgba(34,197,94,0.8);
    }

    .toolbar {
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
    }

    .search-wrapper { flex:1 1 220px; position:relative; max-width:420px; }

    .search-input {
      width:100%;
      padding:10px 34px 10px 32px;
      background: rgba(15,23,42,0.95);
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      color:var(--text);
      outline:none;
      font-size:0.9rem;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    .search-input::placeholder { color:#6b7280; }

    .search-input:focus {
      border-color: var(--custom-accent-color);
      box-shadow: 0 0 0 1px rgba(139,92,246,0.75), 0 0 24px rgba(59,130,246,0.45);
      background: rgba(15,23,42,0.98);
      transform: translateY(-1px);
    }

    .search-icon {
      position:absolute; left:10px; top:50%;
      transform:translateY(-50%);
      font-size:0.9rem; color:#6b7280; pointer-events:none;
    }

    .clear-search {
      position:absolute; right:10px; top:50%;
      transform:translateY(-50%);
      border:none; background:transparent;
      color:#6b7280; cursor:pointer;
      font-size:0.8rem; padding:0;
      display:none;
    }

    .filters {
      display:flex; flex-wrap:wrap;
      gap:8px; justify-content:flex-end;
    }

    .filter-chip {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.96);
      padding:6px 11px;
      font-size:0.78rem;
      color:var(--text-soft);
      cursor:pointer;
      transition: background var(--transition-fast), border var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
      display:inline-flex; align-items:center; gap:6px;
    }

    .filter-chip span.dot {
      width:8px; height:8px; border-radius:999px;
      background: rgba(148,163,184,0.8);
    }

    .filter-chip.active {
      background: var(--accent-soft);
      border-color: var(--custom-accent-color);
      color:#e5e7eb;
      transform: translateY(-1px);
    }

    .filter-chip.active span.dot {
      background: var(--custom-accent-strong);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .content {
      margin-top: 4px;
      display:grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap:14px;
      transition: all 0.3s ease;
    }

    .content.dev-mode-layout {
      border: 2px dashed var(--custom-accent-color);
      padding: 10px;
      border-radius: 16px;
    }

    @media (max-width: 850px) {
      .content { grid-template-columns: minmax(0,1fr); }
    }

    .sidebar {
      background: radial-gradient(circle at top left, rgba(51,65,85,0.5), transparent 60%), var(--bg-elevated);
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.35);
      padding:13px 13px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition: all 0.3s ease;
    }

    .sidebar.dragging {
      opacity: 0.5;
      border-color: var(--custom-accent-strong);
      transform: scale(0.98);
    }

    .dev-drag-handle {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background: var(--custom-accent-color);
      border-radius: 6px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: grab;
      font-size: 14px;
      z-index: 10;
    }

    body.dev-mode-active .dev-drag-handle { display: flex; }
    body.dev-mode-active .sidebar,
    body.dev-mode-active .library { position: relative; }
    body.dev-mode-active .sidebar:hover .dev-drag-handle,
    body.dev-mode-active .library:hover .dev-drag-handle { opacity: 1; }

    .sidebar-title {
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-soft);
      margin-bottom:4px;
    }

    .sidebar-card {
      background: var(--bg-soft);
      border-radius:16px;
      padding:10px 11px;
      border:1px solid rgba(148,163,184,0.28);
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .sidebar-card-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }

    .badge {
      font-size:0.72rem;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(34,197,94,0.16);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.6);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .sidebar-card-title { font-size:0.9rem; font-weight:600; }
    .sidebar-card-text { font-size:0.78rem; color:var(--text-soft); line-height:1.45; }

    .hint-list {
      font-size:0.75rem;
      color:var(--text-soft);
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:4px;
    }

    .hint-list span { opacity:0.95; }

    .stat-row {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:0.78rem;
      margin-top:6px;
      color:var(--text-soft);
    }

    .stat-row strong { font-size:0.9rem; color:#e5e7eb; }

    .small-link {
      font-size:0.75rem;
      color:#93c5fd;
      text-decoration:none;
      margin-top:4px;
      align-self:flex-start;
    }

    .small-link:hover { text-decoration:underline; }

    .library {
      background: radial-gradient(circle at top right, rgba(79,70,229,0.24), transparent 60%), var(--bg-elevated);
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.3);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:260px;
      position: relative;
      transition: all 0.3s ease;
    }

    .library.dragging {
      opacity: 0.5;
      border-color: var(--custom-accent-strong);
      transform: scale(0.98);
    }

    .library-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .library-title {
      font-size:0.97rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .library-title span.count {
      font-size:0.75rem;
      color:var(--text-soft);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    .view-toggle { display:flex; gap:6px; font-size:0.75rem; flex-wrap: wrap; }

    .view-btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      padding:4px 9px;
      color:var(--text-soft);
      cursor:pointer;
      transition: background var(--transition-fast), border var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .view-btn.active {
      background: rgba(15,23,42,0.9);
      border-color: var(--custom-accent-color);
      color:#e5e7eb;
      transform: translateY(-1px);
    }

    .view-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .view-btn.dev-btn {
      background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(245,158,11,0.2));
      border-color: rgba(239,68,68,0.5);
      color: #fca5a5;
      font-weight: 600;
    }

    .view-btn.dev-btn:hover {
      background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(245,158,11,0.3));
      border-color: rgba(239,68,68,0.8);
      transform: translateY(-1px) scale(1.05);
    }

    .view-btn .btn-badge {
      background: #ef4444;
      color: white;
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 999px;
      margin-left: 4px;
      font-weight: 700;
      animation: pulse 2s infinite;
    }

    .library-body {
      margin-top:2px;
      border-radius:18px;
      background: rgba(15,23,42,0.7);
      border:1px solid rgba(30,64,175,0.5);
      padding:10px;
      flex: 1;
    }

    /* ============================================================
       4. LIBRARY — GAME GRID & CARDS
       ============================================================ */
    .game-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap:10px;
    }

    @media (max-width:600px) {
      .game-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
    }

    .game-card {
      background: radial-gradient(circle at top left, rgba(22,163,74,0.32), transparent 58%),
                  linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.85));
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.45);
      padding:8px 9px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast), background var(--transition-fast);
      position:relative;
      overflow:hidden;
    }

    .game-card::before {
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at top, rgba(129,140,248,0.45), transparent 60%);
      opacity:0;
      transition: opacity var(--transition-fast);
      pointer-events:none;
    }

    .game-card:hover::before { opacity:0.65; }

    .game-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(15,23,42,0.9);
      border-color: rgba(129,140,248,0.9);
    }

    .game-thumb {
      height:80px;
      border-radius:11px;
      background:
        radial-gradient(circle at 30% 20%, var(--custom-brand-color), #0b1020),
        radial-gradient(circle at 80% 90%, rgba(56,189,248,0.9), transparent 60%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#e5e7eb;
      position:relative;
      overflow:hidden;
    }

    .game-thumb span {
      position:relative;
      z-index:1;
      font-weight:700;
      letter-spacing:0.12em;
      font-size:0.9rem;
      text-transform:uppercase;
    }

    .game-thumb::after {
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at bottom right, rgba(56,189,248,0.6), transparent 60%);
      mix-blend-mode: screen;
      opacity:0.7;
    }

    .game-name {
      font-size:0.88rem;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .game-meta {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:0.75rem;
      color:var(--text-soft);
    }

    .game-tag {
      font-size:0.7rem;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(37,99,235,0.25);
      border:1px solid rgba(129,140,248,0.7);
    }

    .empty-state {
      padding:24px 10px;
      text-align:center;
      font-size:0.85rem;
      color:var(--text-soft);
    }

    .empty-state strong { color:#e5e7eb; }

    /* ============================================================
       5. PLAYER VIEW
       ============================================================ */
    .player-view { display:none; flex-direction:column; gap:8px; }

    .player-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .player-title {
      font-size:0.93rem;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .player-title span.main { font-weight:600; }
    .player-title span.sub { font-size:0.76rem; color:var(--text-soft); }

    .btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.96);
      padding:6px 11px;
      font-size:0.78rem;
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: background var(--transition-fast), border var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      background: rgba(30,64,175,0.9);
      border-color: rgba(129,140,248,0.95);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.8);
    }

    .btn-ghost { background: rgba(15,23,42,0.9); }

    .player-frame {
      margin-top:2px;
      border-radius:18px;
      border:1px solid rgba(30,64,175,0.6);
      overflow:hidden;
      background:#020617;
      height: 80vh;
      max-height: 800px;
    }

    .player-frame iframe {
      width:100%;
      height:100%;
      border:none;
      display:block;
      background:#020617;
    }

    footer {
      margin-top:6px;
      font-size:0.7rem;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:4px;
      flex-wrap:wrap;
    }

    footer a { color:#93c5fd; text-decoration:none; }
    footer a:hover { text-decoration:underline; }

    footer .portal-link {
      cursor:pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    /* ============================================================
       6. DEVELOPER MODE
       ============================================================ */
    .dev-view {
      display: none;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.3s ease;
    }

    .dev-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .dev-card {
      background: var(--bg-soft);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(148,163,184,0.28);
      position: relative;
      overflow: hidden;
    }

    .dev-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ef4444, #f97316, #eab308);
    }

    .dev-card h3 {
      font-size: 1rem;
      margin-bottom: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .dev-badge {
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .dev-section { margin-bottom: 20px; }
    .dev-section:last-child { margin-bottom: 0; }

    .dev-label {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 8px;
      display: block;
      font-weight: 500;
    }

    .layout-preview {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 16px;
      border: 2px dashed rgba(148,163,184,0.3);
      min-height: 200px;
    }

    .layout-zone {
      background: rgba(139,92,246,0.1);
      border: 2px solid rgba(139,92,246,0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: move;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .layout-zone:hover {
      background: rgba(139,92,246,0.2);
      border-color: rgba(139,92,246,0.5);
      transform: translateX(4px);
    }

    .layout-zone.sortable-ghost { opacity: 0.4; background: rgba(139,92,246,0.3); }
    .layout-zone.sortable-drag { cursor: grabbing; background: rgba(139,92,246,0.4); transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    .zone-icon { width: 32px; height: 32px; background: var(--custom-accent-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .zone-info { flex: 1; }
    .zone-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .zone-desc { font-size: 0.75rem; color: var(--text-soft); }

    .zone-toggle {
      width: 40px; height: 22px;
      background: rgba(148,163,184,0.3);
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .zone-toggle.active { background: var(--custom-accent-strong); }
    .zone-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: transform 0.2s; }
    .zone-toggle.active::after { transform: translateX(18px); }

    .feature-list { display: flex; flex-direction: column; gap: 10px; }

    .feature-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(15,23,42,0.6);
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      transition: all 0.15s ease;
    }

    .feature-item:hover { background: rgba(15,23,42,0.8); border-color: rgba(148,163,184,0.4); transform: translateX(2px); }
    .feature-info { display: flex; flex-direction: column; gap: 2px; }
    .feature-name { font-weight: 600; font-size: 0.85rem; color: var(--text); display: flex; align-items: center; gap: 6px; }
    .feature-beta { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase; }
    .feature-desc { font-size: 0.75rem; color: var(--text-soft); }

    .feature-toggle {
      appearance: none;
      width: 44px; height: 24px;
      background: rgba(148,163,184,0.3);
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: background 0.2s;
    }

    .feature-toggle:checked { background: var(--custom-accent-strong); }
    .feature-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .feature-toggle:checked::after { transform: translateX(20px); }

    .css-editor {
      width: 100%;
      min-height: 120px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 12px;
      color: #a5f3fc;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      resize: vertical;
      tab-size: 2;
    }

    .css-editor:focus { outline: none; border-color: var(--custom-accent-color); box-shadow: 0 0 0 2px var(--accent-soft); }

    .dev-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    .btn-danger { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); color: #fca5a5; }
    .btn-danger:hover { background: rgba(239,68,68,0.4); border-color: rgba(239,68,68,0.8); }
    .btn-success { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.5); color: #bbf7d0; }
    .btn-success:hover { background: rgba(34,197,94,0.4); border-color: rgba(34,197,94,0.8); }
    .btn-warning { background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.5); color: #fde68a; }

    .dev-auth-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .dev-auth-modal.show { display: flex; }

    .dev-auth-card {
      background: var(--bg-elevated);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 24px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      text-align: center;
    }

    .dev-auth-card h2 { margin-bottom: 8px; font-size: 1.5rem; background: linear-gradient(135deg, #ef4444, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .dev-auth-card p { color: var(--text-soft); margin-bottom: 24px; font-size: 0.9rem; }

    .password-input-group { position: relative; margin-bottom: 20px; }
    .password-input-group input {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-soft);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: all 0.15s ease;
      text-align: center;
      letter-spacing: 0.1em;
    }
    .password-input-group input:focus { border-color: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.2); }

    .dev-access-indicator {
      position: fixed;
      bottom: 20px; right: 20px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(239,68,68,0.4);
      z-index: 1000;
      animation: pulse 2s infinite;
      cursor: pointer;
    }

    body.dev-active .dev-access-indicator { display: flex; }

    .game-list-editor { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

    .game-edit-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(15,23,42,0.6); border-radius: 8px; border: 1px solid rgba(148,163,184,0.2); }
    .game-edit-thumb { width: 40px; height: 40px; background: var(--custom-accent-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
    .game-edit-info { flex: 1; min-width: 0; }
    .game-edit-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-edit-cat { font-size: 0.75rem; color: var(--text-soft); }
    .game-edit-actions { display: flex; gap: 4px; }

    .icon-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.8); color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.15s; }
    .icon-btn:hover { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); transform: scale(1.1); }

    .add-game-btn {
      width: 100%; padding: 12px;
      border: 2px dashed rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.4);
      color: var(--text-soft);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .add-game-btn:hover { border-color: var(--custom-accent-color); color: var(--text); background: rgba(139,92,246,0.1); }

    .config-textarea { width: 100%; min-height: 100px; background: rgba(0,0,0,0.5); border: 1px solid rgba(148,163,184,0.3); border-radius: 8px; padding: 12px; color: #a5f3fc; font-family: monospace; font-size: 0.75rem; word-break: break-all; resize: vertical; }

    .customize-view {
      display: none;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .customize-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }

    .customize-card { background: var(--bg-soft); border-radius: 16px; padding: 16px; border: 1px solid rgba(148,163,184,0.28); }
    .customize-card h3 { font-size: 0.9rem; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 8px; }

    .color-input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .color-input-group label { font-size: 0.78rem; color: var(--text-soft); display: flex; justify-content: space-between; align-items: center; }

    .color-picker-wrapper { display: flex; align-items: center; gap: 10px; }
    .color-picker-wrapper input[type="color"] { width: 50px; height: 36px; border: none; border-radius: 8px; cursor: pointer; background: none; }
    .color-picker-wrapper input[type="text"] { flex: 1; padding: 6px 10px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 8px; color: var(--text); font-size: 0.8rem; font-family: monospace; }

    .customize-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    .btn-primary { background: var(--custom-accent-color); border-color: var(--custom-accent-color); color: white; }
    .btn-primary:hover { background: var(--custom-accent-strong); border-color: var(--custom-accent-strong); }
    .btn-secondary { background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.4); }

    .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .preset-btn { padding: 8px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.6); color: var(--text-soft); cursor: pointer; font-size: 0.75rem; transition: all 0.15s ease; }
    .preset-btn:hover { border-color: var(--custom-accent-color); color: var(--text); }

    .settings-view { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s ease; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .settings-card { background: var(--bg-soft); border-radius: 16px; padding: 20px; border: 1px solid rgba(148,163,184,0.28); }
    .settings-card h3 { font-size: 1rem; margin-bottom: 6px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .settings-desc { font-size: 0.8rem; color: var(--text-soft); margin-bottom: 16px; }

    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-soft); margin-bottom: 8px; font-weight: 500; }
    .input-group input[type="text"] { width: 100%; padding: 10px 14px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 10px; color: var(--text); font-size: 0.9rem; transition: all 0.15s ease; }
    .input-group input[type="text"]:focus { outline: none; border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }

    .favicon-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .favicon-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 12px; border: 2px solid transparent; background: rgba(15,23,42,0.6); cursor: pointer; transition: all 0.15s ease; }
    .favicon-btn:hover { background: rgba(15,23,42,0.9); transform: translateY(-2px); }
    .favicon-btn.active { border-color: var(--custom-accent-color); background: var(--accent-soft); }
    .favicon-preview { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .favicon-preview.default { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .favicon-preview.google { background: #4285F4; }
    .favicon-preview.classroom { background: linear-gradient(135deg, #24a865, #1e8a53); }
    .favicon-preview.docs { background: #4285F4; }
    .favicon-preview.slides { background: #fbbc04; }
    .favicon-btn span:last-child { font-size: 0.75rem; color: var(--text-soft); }
    .favicon-btn.active span:last-child { color: var(--text); font-weight: 600; }

    /* ============================================================
       7. UPDATE MODAL
       ============================================================ */
    .update-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .update-modal.show { display: flex; }

    .update-card {
      background: var(--bg-elevated);
      border-radius: 24px;
      border: 1px solid var(--accent-soft);
      max-width: 480px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      animation: slideUp 0.3s ease;
      color: var(--text);
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .update-header {
      background: linear-gradient(135deg, rgba(129,140,248,0.1), transparent 60%);
      padding: 24px 24px 16px;
      border-bottom: 1px solid rgba(148,163,184,0.2);
      border-radius: 24px 24px 0 0;
    }

    .update-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .update-date { font-size: 0.8rem; color: var(--text-soft); }
    .update-body { padding: 20px 24px; background: var(--bg-elevated); }

    .update-list { list-style: none; display: flex; flex-direction: column; gap: 10px; margin: 0; padding: 0; }
    .update-list li { font-size: 0.9rem; color: var(--text); padding-left: 24px; position: relative; line-height: 1.5; }
    .update-list li::before { content: "→"; position: absolute; left: 0; color: var(--custom-accent-strong); font-weight: bold; font-size: 1.1rem; }

    .update-footer {
      padding: 16px 24px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border-top: 1px solid rgba(148,163,184,0.2);
      background: var(--bg-elevated);
      border-radius: 0 0 24px 24px;
    }

    .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-soft); cursor: pointer; }
    .checkbox-label input[type="checkbox"] { accent-color: var(--custom-accent-color); width: 16px; height: 16px; cursor: pointer; }

    /* ============================================================
       8. PORTAL MODE
       ============================================================ */
    body.portal-mode { background:#f9fafb; color:#111827; }
    body.portal-mode::before, body.portal-mode::after { display:none; }
    body.portal-mode .app-shell { background:#fff; border-radius:0; border:1px solid #e5e7eb; box-shadow:none; }
    body.portal-mode .sidebar, body.portal-mode .library { background:#fff; border-color:#e5e7eb; }
    body.portal-mode .game-card { background:#f9fafb; box-shadow:none; border-color:#e5e7eb; }
    body.portal-mode .game-thumb { background:#e5e7eb; }
    body.portal-mode .brand-logo { box-shadow:none; }
    body.portal-mode .brand-logo-inner { background:#f3f4f6; color:#111827; }
    body.portal-mode .brand-text-main span:nth-child(2) { color:#111827; }
    body.portal-mode .search-input, body.portal-mode .view-btn, body.portal-mode .filter-chip, body.portal-mode .btn { background:#f9fafb; border-color:#e5e7eb; color:#374151; box-shadow:none; }
    body.portal-mode .search-input:focus { box-shadow:none; border-color:#9ca3af; }
    body.portal-mode .customize-card, body.portal-mode .settings-card, body.portal-mode .dev-card { background: #f9fafb; border-color: #e5e7eb; }
    body.portal-mode .color-picker-wrapper input[type="text"], body.portal-mode .input-group input[type="text"], body.portal-mode .css-editor, body.portal-mode .config-textarea { background: #ffffff; border-color: #e5e7eb; color: #111827; }
    body.portal-mode .preset-btn, body.portal-mode .favicon-btn { background: #ffffff; border-color: #e5e7eb; color: #374151; }
    body.portal-mode .favicon-btn.active { background: rgba(99,102,241,0.1); border-color: #4f46e5; }
    body.portal-mode .feature-item, body.portal-mode .game-edit-item { background: #ffffff; border-color: #e5e7eb; }

    /* ============================================================
       9. THEMES
       (data-theme attribute on <html> — options: nebula / midnight / bubblegum / matrix / minecraft)
       ============================================================ */
    :root[data-theme="nebula"] { --bg: #050816; --bg-elevated: #0b1020; --bg-soft: #11182a; --accent: #4f46e5; --accent-soft: rgba(79, 70, 229, 0.25); --accent-strong: #22c55e; --text: #e5e7eb; --text-soft: #9ca3af; }
    :root[data-theme="midnight"] { --bg: #010409; --bg-elevated: #0d1117; --bg-soft: #161b22; --accent: #58a6ff; --accent-soft: rgba(88,166,255,0.23); --accent-strong: #238636; --text: #c9d1d9; --text-soft: #8b949e; }
    :root[data-theme="bubblegum"] { --bg: #ffe4f1; --bg-elevated: #ffd6ec; --bg-soft: #ffcae6; --accent: #ff4fa3; --accent-soft: rgba(255, 79, 163, 0.23); --accent-strong: #ff1e80; --text: #3a0035; --text-soft: #5f1a50; }
    :root[data-theme="matrix"] { --bg: #000000; --bg-elevated: #020402; --bg-soft: #001100; --accent: #00ff41; --accent-soft: rgba(0,255,65,0.15); --accent-strong: #00ff41; --text: #d9ffd9; --text-soft: #71ff8e; }
    :root[data-theme="minecraft"] { --bg: #0b2e0b; --bg-elevated: #0f3d0f; --bg-soft: #145214; --accent: #3c8527; --accent-soft: rgba(60,133,39,0.25); --accent-strong: #8b5a2b; --text: #d6f5d6; --text-soft: #a4c9a4; }

    .panic-btn { background:#ef4444; border:1px solid #f87171; color:white; font-weight:600; border-radius:12px; padding:6px 12px; cursor:pointer; transition:0.15s ease; }
    .panic-btn:hover { background:#dc2626; border-color:#fca5a5; }

    .legal-footer { margin-top: 10px; font-size: 0.75rem; color: #9ca3af; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .legal-footer a { color:#93c5fd; text-decoration:none; }
    .legal-footer a:hover { text-decoration:underline; }

    .theme-active-notice { font-size: 0.75rem; color: var(--custom-accent-strong); margin-top: 8px; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 8px; border: 1px solid rgba(34,197,94,0.3); display: none; }
    .theme-active-notice.show { display: block; }
    body.portal-mode .theme-active-notice { background: rgba(34,197,94,0.05); color: #059669; border-color: rgba(34,197,94,0.2); }

    /* ============================================================
       10. NEBULACHAT
       ============================================================ */
    .chat-view { display: none; flex-direction: column; gap: 16px; animation: fadeIn 0.3s ease; height: 70vh; min-height: 500px; }

    .chat-container { display: grid; grid-template-columns: 260px 1fr; gap: 16px; height: 100%; background: var(--bg-elevated); border-radius: 22px; border: 1px solid rgba(148,163,184,0.3); overflow: hidden; }

    .chat-sidebar { background: var(--custom-chat-bg, var(--bg-soft)); border-right: 1px solid rgba(148,163,184,0.2); padding: 16px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }

    .chat-room-btn { width: 100%; padding: 12px; background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; color: var(--text); cursor: pointer; text-align: left; transition: all 0.15s ease; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
    .chat-room-btn:hover, .chat-room-btn.active { background: var(--accent-soft); border-color: var(--custom-accent-color); transform: translateX(4px); }
    .chat-room-btn .room-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; }

    .chat-main { display: flex; flex-direction: column; height: 100%; background: radial-gradient(circle at top right, rgba(79,70,229,0.1), transparent 60%); }
    .chat-header { padding: 16px 20px; border-bottom: 1px solid rgba(148,163,184,0.2); display: flex; justify-content: space-between; align-items: center; }
    .chat-header-title { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .chat-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-soft); }
    .status-dot { width: 8px; height: 8px; background: var(--custom-accent-strong); border-radius: 50%; animation: pulse 2s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }

    .message { display: flex; gap: 12px; max-width: 80%; animation: slideIn 0.2s ease; }
    .message.own { align-self: flex-end; flex-direction: row-reverse; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    .message-content { background: var(--bg-soft); padding: 12px 16px; border-radius: 16px; border: 1px solid rgba(148,163,184,0.3); position: relative; }
    .message.own .message-content { background: linear-gradient(135deg, var(--custom-chat-sent, var(--custom-accent-color)), var(--custom-accent-strong)); border-color: transparent; color: white; }

    .message-header { font-size: 0.75rem; color: var(--text-soft); margin-bottom: 4px; display: flex; gap: 8px; align-items: center; }
    .message.own .message-header { color: rgba(255,255,255,0.8); justify-content: flex-end; }
    .message-text { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }

    .chat-input-area { padding: 16px 20px; border-top: 1px solid rgba(148,163,184,0.2); background: rgba(0,0,0,0.2); }
    .chat-input-wrapper { display: flex; gap: 10px; background: var(--bg-soft); padding: 4px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.3); transition: all 0.15s ease; }
    .chat-input-wrapper:focus-within { border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }
    .chat-input { flex: 1; background: transparent; border: none; padding: 10px 16px; color: var(--text); font-size: 0.9rem; outline: none; }
    .chat-send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--custom-accent-color); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; }
    .chat-send-btn:hover { background: var(--custom-accent-strong); transform: scale(1.05); }
    .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .username-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .username-modal.show { display: flex; }
    .username-card { background: var(--bg-elevated); border: 1px solid var(--accent-soft); border-radius: 24px; padding: 32px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.5); text-align: center; }
    .username-card h2 { margin-bottom: 8px; font-size: 1.5rem; }
    .username-card p { color: var(--text-soft); margin-bottom: 24px; font-size: 0.9rem; }
    .username-input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .username-input-group input { padding: 14px 18px; background: var(--bg-soft); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; color: var(--text); font-size: 1rem; outline: none; transition: all 0.15s ease; }
    .username-input-group input:focus { border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }

    @media (max-width: 850px) { .chat-container { grid-template-columns: 1fr; } .chat-sidebar { display: none; } }

    .customize-card.chat-colors { grid-column: 1 / -1; }
    .chat-preview-box { height: 120px; background: var(--custom-chat-bg, var(--bg-soft)); border-radius: 12px; border: 1px solid rgba(148,163,184,0.3); margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; }
    .chat-preview-msg { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; max-width: 140px; }
    .chat-preview-msg.received { background: var(--bg-elevated); color: var(--text); border: 1px solid rgba(148,163,184,0.3); align-self: flex-start; }
    .chat-preview-msg.sent { background: var(--custom-chat-sent, var(--custom-accent-color)); color: white; align-self: flex-end; }

    /* ============================================================
       11. ANNOUNCEMENTS & SURVEY
       ============================================================ */
    .announcements-view, .survey-view { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s ease; max-height: 75vh; overflow-y: auto; }

    .announcement-card { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(30,64,175,0.05)); border: 1px solid rgba(139,92,246,0.3); border-radius: 20px; padding: 24px; position: relative; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .announcement-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .announcement-card.important { border-color: rgba(239,68,68,0.5); background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(245,158,11,0.05)); }
    .announcement-card.update { border-color: rgba(34,197,94,0.5); background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(21,128,61,0.05)); }

    .announcement-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; background: rgba(139,92,246,0.2); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.4); }
    .announcement-card.important .announcement-badge { background: rgba(239,68,68,0.2); color: #fca5a5; border-color: rgba(239,68,68,0.4); }
    .announcement-card.update .announcement-badge { background: rgba(34,197,94,0.2); color: #bbf7d0; border-color: rgba(34,197,94,0.4); }

    .announcement-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; color: var(--text); }
    .announcement-date { font-size: 0.8rem; color: var(--text-soft); margin-bottom: 16px; opacity: 0.8; }
    .announcement-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; margin: 16px 0; border: 1px solid rgba(148,163,184,0.2); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .announcement-gif { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; margin: 16px 0; background: rgba(0,0,0,0.3); padding: 8px; }
    .announcement-content { font-size: 0.95rem; line-height: 1.6; color: var(--text); opacity: 0.95; }
    .announcement-empty { text-align: center; padding: 60px 20px; color: var(--text-soft); }
    .announcement-empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }

    .survey-container { background: var(--bg-soft); border-radius: 20px; border: 1px solid rgba(148,163,184,0.3); overflow: hidden; display: flex; flex-direction: column; height: 70vh; min-height: 500px; }
    .survey-header { padding: 20px 24px; background: radial-gradient(circle at top right, rgba(79,70,229,0.2), transparent 60%); border-bottom: 1px solid rgba(148,163,184,0.2); display: flex; justify-content: space-between; align-items: center; }
    .survey-title { font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .survey-frame-container { flex: 1; position: relative; background: #fff; }
    .survey-frame { width: 100%; height: 100%; border: none; background: #fff; }

    /* ============================================================
       12. SOLAR UI — BRAND, SEARCH BAR & PROXY SELECTOR
       ============================================================ */
    .nebulahub-ui {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 30px;
      padding: 20px;
      position: relative;
    }

    .nebulahub-ui.active { display: flex; }

    /* NebulaHub brand in the minimal UI */
    .nebulahub-minimal-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    /* Animated nebula logo SVG */
    .nebulahub-logo-svg {
      width: 80px;
      height: 80px;
      animation: nebulaSpin 12s linear infinite;
      filter: drop-shadow(0 0 18px rgba(139,92,246,0.7));
    }

    @keyframes nebulaSpin {
      0% { filter: drop-shadow(0 0 18px rgba(139,92,246,0.7)); }
      33% { filter: drop-shadow(0 0 24px rgba(34,197,94,0.8)); }
      66% { filter: drop-shadow(0 0 20px rgba(236,72,153,0.7)); }
      100% { filter: drop-shadow(0 0 18px rgba(139,92,246,0.7)); }
    }

    @keyframes orbitRing {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .nebulahub-minimal-title {
      font-size: 2.8rem;
      font-weight: 200;
      letter-spacing: 0.2em;
      color: var(--text);
      text-transform: uppercase;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    .nebulahub-minimal-title strong {
      font-weight: 700;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nebulahub-minimal-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .nebulahub-search-container {
      width: 100%;
      max-width: 640px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    /* Proxy selector */
    .proxy-selector {
      display: flex;
      gap: 8px;
      background: rgba(15,23,42,0.9);
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
    }

    .proxy-option {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .proxy-option.active {
      background: var(--custom-accent-color);
      color: white;
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }

    .nebulahub-search-box {
      width: 100%;
      position: relative;
    }

    .nebulahub-search-input {
      width: 100%;
      padding: 18px 60px 18px 28px;
      background: rgba(15,23,42,0.95);
      border: 2px solid var(--custom-accent-strong);
      border-radius: 999px;
      color: var(--text);
      font-size: 1.05rem;
      outline: none;
      transition: all 0.2s ease;
    }

    .nebulahub-search-input::placeholder { color: #6b7280; }

    .nebulahub-search-input:focus {
      border-color: var(--custom-accent-color);
      box-shadow: 0 0 40px rgba(139,92,246,0.25);
      transform: scale(1.01);
    }

    .nebulahub-search-submit {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--custom-accent-color);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s ease;
    }

    .nebulahub-search-submit:hover {
      background: var(--custom-accent-strong);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(34,197,94,0.4);
    }

    .nebulahub-proxy-status {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nebulahub-proxy-status .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--custom-accent-strong); animation: pulse 2s infinite; }

    /* NebulaHub search results panel */
    .nebulahub-results-frame {
      width: 100%;
      max-width: 900px;
      height: 60vh;
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.3);
      overflow: hidden;
      background: #020617;
      display: none;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .nebulahub-results-frame.show { display: block; }

    .nebulahub-results-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ============================================================
       13. SOLAR UI — BOTTOM DOCK
       ============================================================ */
    .nebulahub-dock {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      background: rgba(6,5,28,0.92);
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 999px;
      backdrop-filter: blur(20px) saturate(1.3);
      box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(139,92,246,0.15);
      z-index: 200;
    }

    .nebulahub-dock-item {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-size: 1.3rem;
      position: relative;
      color: var(--text-soft);
      border: 1px solid transparent;
    }

    .nebulahub-dock-item:hover {
      transform: translateY(-8px) scale(1.15);
      background: rgba(139,92,246,0.2);
      border-color: rgba(139,92,246,0.4);
      color: var(--text);
    }

    .nebulahub-dock-item.active-dock-item {
      background: rgba(139,92,246,0.25);
      border-color: rgba(139,92,246,0.6);
      color: #c4b5fd;
    }

    /* Tooltip on hover */
    .nebulahub-dock-item::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.97);
      border: 1px solid rgba(148,163,184,0.3);
      color: var(--text);
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .nebulahub-dock-item:hover::after { opacity: 1; }

    .nebulahub-dock-divider { width: 1px; height: 26px; background: rgba(148,163,184,0.25); margin: 0 4px; }

    .nebulahub-dock-time {
      font-size: 0.82rem;
      color: var(--text-soft);
      font-family: monospace;
      padding: 0 6px;
      letter-spacing: 0.05em;
    }

    /* Portal mode adjustments for nebulahub UI */
    body.portal-mode .nebulahub-search-input,
    body.portal-mode .nebulahub-dock,
    body.portal-mode .proxy-selector {
      background: #ffffff;
      border-color: #e5e7eb;
      color: #111827;
    }

    body.portal-mode .nebulahub-dock-item:hover { background: rgba(99,102,241,0.1); }

    /* ============================================================
       14. SOLAR UI — FULL-SCREEN PANELS
       (library / player / news / survey / chat / customize / settings / dev)
       ============================================================ */
    .minimal-panel {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      bottom: 88px; /* dock is ~70px + 18px gap */
      background: rgba(3, 0, 20, 0.98);
      backdrop-filter: blur(28px) saturate(1.4);
      flex-direction: column;
      z-index: 200;
      overflow: hidden;
      animation: panelIn 0.2s ease-out;
    }
    .minimal-panel.show { display: flex; }

    @keyframes panelIn {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Panel header */
    .mp-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 36px;
      border-bottom: 1px solid rgba(139,92,246,0.2);
      background: rgba(6,5,28,0.9);
      flex-shrink: 0;
    }

    .mp-title {
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .mp-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.8);
      color: var(--text-soft);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      transition: all 0.15s;
    }
    .mp-close:hover { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); color: #fca5a5; }

    /* Panel body scroll */
    .mp-body {
      overflow-y: auto;
      padding: 24px 36px;
      flex: 1;
    }

    /* ---- LIBRARY PANEL ---- */
    .mp-game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .mp-game-card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.8));
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 14px;
      padding: 10px 8px;
      cursor: pointer;
      display: flex; flex-direction: column; gap: 6px;
      transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
      position: relative; overflow: hidden;
    }
    .mp-game-card:hover { transform: translateY(-3px); border-color: rgba(139,92,246,0.8); box-shadow: 0 12px 28px rgba(0,0,0,0.5); }

    .mp-game-thumb {
      height: 90px; border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, var(--custom-brand-color), #0b1020);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; letter-spacing: 0.1em; color: #e5e7eb;
      text-transform: uppercase;
    }

    .mp-game-name {
      font-size: 0.78rem; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: var(--text);
    }

    .mp-game-cat {
      font-size: 0.65rem; color: var(--text-soft);
      text-transform: uppercase; letter-spacing: 0.08em;
    }

    .mp-search-bar {
      display: flex; gap: 8px; margin-bottom: 14px;
    }

    .mp-search-input {
      flex: 1; padding: 9px 14px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 999px; color: var(--text);
      font-size: 0.85rem; outline: none;
      transition: border-color 0.15s;
    }
    .mp-search-input:focus { border-color: var(--custom-accent-color); }
    .mp-search-input::placeholder { color: #6b7280; }

    .mp-filter-row {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px;
    }

    .mp-chip {
      padding: 4px 10px; border-radius: 999px; font-size: 0.72rem;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.8); color: var(--text-soft);
      cursor: pointer; transition: all 0.15s;
    }
    .mp-chip.active { background: var(--accent-soft); border-color: var(--custom-accent-color); color: #e5e7eb; }

    /* ---- PLAYER PANEL ---- */
    .mp-player-frame {
      width: 100%; flex: 1;
      border-radius: 0 0 20px 20px;
      overflow: hidden; background: #020617;
      min-height: 400px;
    }
    .mp-player-frame iframe { width:100%; height:100%; border:none; display:block; min-height: 400px; }

    /* ---- NEWS PANEL ---- */
    .mp-announcement {
      background: rgba(139,92,246,0.08);
      border: 1px solid rgba(139,92,246,0.25);
      border-radius: 16px; padding: 18px;
      margin-bottom: 12px;
      transition: transform 0.2s;
    }
    .mp-announcement:hover { transform: translateY(-1px); }
    .mp-announcement.important { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.07); }
    .mp-announcement.update { border-color: rgba(34,197,94,0.4); background: rgba(34,197,94,0.07); }

    .mp-ann-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 999px; font-size: 0.68rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 10px;
      background: rgba(139,92,246,0.2); color: #c4b5fd;
      border: 1px solid rgba(139,92,246,0.4);
    }
    .mp-announcement.important .mp-ann-badge { background: rgba(239,68,68,0.2); color: #fca5a5; border-color: rgba(239,68,68,0.4); }
    .mp-announcement.update .mp-ann-badge { background: rgba(34,197,94,0.2); color: #bbf7d0; border-color: rgba(34,197,94,0.4); }

    .mp-ann-title { font-size: 1.1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .mp-ann-date { font-size: 0.75rem; color: var(--text-soft); margin-bottom: 10px; }
    .mp-ann-content { font-size: 0.88rem; color: var(--text); line-height: 1.6; opacity: 0.92; }

    /* ---- SURVEY PANEL ---- */
    .mp-survey-frame {
      flex: 1; width: 100%; border: none; background: #fff;
      min-height: 440px;
    }

    /* ---- CHAT PANEL ---- */
    .mp-chat-layout {
      display: flex; flex: 1; overflow: hidden;
    }

    .mp-chat-rooms {
      width: 140px; flex-shrink: 0;
      background: rgba(15,23,42,0.5);
      border-right: 1px solid rgba(148,163,184,0.15);
      padding: 12px 8px;
      display: flex; flex-direction: column; gap: 6px;
      overflow-y: auto;
    }

    .mp-room-btn {
      padding: 8px 10px; border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.6);
      color: var(--text-soft); cursor: pointer;
      font-size: 0.78rem; text-align: left;
      transition: all 0.15s;
      display: flex; align-items: center; gap: 6px;
    }
    .mp-room-btn:hover, .mp-room-btn.active {
      background: var(--accent-soft);
      border-color: var(--custom-accent-color);
      color: var(--text);
    }

    .mp-chat-main {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
    }

    .mp-messages {
      flex: 1; overflow-y: auto; padding: 14px;
      display: flex; flex-direction: column; gap: 10px;
      scroll-behavior: smooth;
    }

    .mp-msg {
      display: flex; gap: 8px; max-width: 85%;
      animation: slideIn 0.2s ease;
    }
    .mp-msg.own { align-self: flex-end; flex-direction: row-reverse; }

    .mp-msg-avatar {
      width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; color: white;
    }

    .mp-msg-bubble {
      background: var(--bg-soft); padding: 8px 12px;
      border-radius: 12px; border: 1px solid rgba(148,163,184,0.25);
    }
    .mp-msg.own .mp-msg-bubble { background: linear-gradient(135deg, var(--custom-chat-sent, var(--custom-accent-color)), var(--custom-accent-strong)); border-color: transparent; color: white; }

    .mp-msg-meta { font-size: 0.68rem; color: var(--text-soft); margin-bottom: 3px; }
    .mp-msg.own .mp-msg-meta { color: rgba(255,255,255,0.7); text-align: right; }
    .mp-msg-text { font-size: 0.85rem; line-height: 1.4; word-break: break-word; }

    .mp-chat-input-row {
      padding: 10px 14px;
      border-top: 1px solid rgba(148,163,184,0.15);
      display: flex; gap: 8px;
    }

    .mp-chat-input {
      flex: 1; padding: 8px 14px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 999px; color: var(--text);
      font-size: 0.85rem; outline: none;
      transition: border-color 0.15s;
    }
    .mp-chat-input:focus { border-color: var(--custom-accent-color); }

    .mp-chat-send {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--custom-accent-color);
      border: none; color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.9rem; transition: all 0.15s;
    }
    .mp-chat-send:hover { background: var(--custom-accent-strong); transform: scale(1.08); }

    /* ---- CUSTOMIZE PANEL ---- */
    .mp-setting-group { margin-bottom: 18px; }
    .mp-setting-label { font-size: 0.78rem; color: var(--text-soft); margin-bottom: 8px; display: block; font-weight: 500; }
    .mp-color-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .mp-color-row input[type="color"] { width: 44px; height: 34px; border: none; border-radius: 8px; cursor: pointer; background: none; }
    .mp-color-row input[type="text"] { flex:1; padding: 6px 10px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 8px; color: var(--text); font-size: 0.78rem; font-family: monospace; outline: none; }
    .mp-color-row input[type="text"]:focus { border-color: var(--custom-accent-color); }

    .mp-preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
    .mp-preset-btn { padding: 7px 6px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.6); color: var(--text-soft); cursor: pointer; font-size: 0.72rem; transition: all 0.15s; }
    .mp-preset-btn:hover { border-color: var(--custom-accent-color); color: var(--text); }

    .mp-action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .mp-btn { padding: 7px 14px; border-radius: 999px; font-size: 0.78rem; cursor: pointer; border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.9); color: var(--text); transition: all 0.15s; }
    .mp-btn:hover { background: rgba(30,64,175,0.7); border-color: rgba(139,92,246,0.7); }
    .mp-btn.primary { background: var(--custom-accent-color); border-color: var(--custom-accent-color); color: white; }
    .mp-btn.primary:hover { background: var(--custom-accent-strong); border-color: var(--custom-accent-strong); }
    .mp-btn.danger { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); color: #fca5a5; }
    .mp-btn.danger:hover { background: rgba(239,68,68,0.4); }

    /* ---- SETTINGS PANEL ---- */
    .mp-input-group { margin-bottom: 14px; }
    .mp-input-group label { display: block; font-size: 0.78rem; color: var(--text-soft); margin-bottom: 6px; }
    .mp-input-group input[type="text"] { width: 100%; padding: 9px 12px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 10px; color: var(--text); font-size: 0.85rem; outline: none; transition: border-color 0.15s; }
    .mp-input-group input[type="text"]:focus { border-color: var(--custom-accent-color); }

    .mp-section-title { font-size: 0.85rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 6px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(148,163,184,0.15); }

    .mp-favicon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 14px; }
    .mp-fav-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 8px 4px; border-radius: 10px; border: 2px solid transparent; background: rgba(15,23,42,0.6); cursor: pointer; transition: all 0.15s; }
    .mp-fav-btn:hover { background: rgba(15,23,42,0.9); }
    .mp-fav-btn.active { border-color: var(--custom-accent-color); background: var(--accent-soft); }
    .mp-fav-icon { width: 28px; height: 28px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: white; }
    .mp-fav-label { font-size: 0.62rem; color: var(--text-soft); }
    .mp-fav-btn.active .mp-fav-label { color: var(--text); }

    /* ---- DEV PANEL ---- */
    .mp-dev-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 600px) { .mp-dev-grid { grid-template-columns: 1fr; } }

    .mp-dev-card {
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 14px; padding: 14px;
      position: relative; overflow: hidden;
    }
    .mp-dev-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, #ef4444, #f97316, #eab308); }

    .mp-dev-card-title { font-size: 0.88rem; font-weight: 700; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 6px; }

    .mp-feature-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(15,23,42,0.5); border-radius: 8px; border: 1px solid rgba(148,163,184,0.15); margin-bottom: 6px; }
    .mp-feature-name { font-size: 0.8rem; color: var(--text); font-weight: 500; }
    .mp-feature-desc { font-size: 0.7rem; color: var(--text-soft); }
    .mp-toggle { appearance: none; width: 38px; height: 20px; background: rgba(148,163,184,0.3); border-radius: 999px; position: relative; cursor: pointer; outline: none; transition: background 0.2s; flex-shrink: 0; }
    .mp-toggle:checked { background: var(--custom-accent-strong); }
    .mp-toggle::after { content:''; position:absolute; top:2px; left:2px; width:16px; height:16px; background:white; border-radius:50%; transition:transform 0.2s; }
    .mp-toggle:checked::after { transform: translateX(18px); }

    .mp-css-editor { width:100%; min-height:90px; background:rgba(0,0,0,0.5); border:1px solid rgba(148,163,184,0.3); border-radius:8px; padding:10px; color:#a5f3fc; font-family:monospace; font-size:0.75rem; resize:vertical; }
    .mp-css-editor:focus { outline:none; border-color:var(--custom-accent-color); }

    .mp-game-editor-list { max-height: 160px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
    .mp-game-edit-row { display:flex; align-items:center; gap:8px; padding:8px; background:rgba(15,23,42,0.5); border-radius:8px; border:1px solid rgba(148,163,184,0.15); }
    .mp-game-edit-thumb { width:32px; height:32px; border-radius:7px; background:var(--custom-accent-color); display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:700; flex-shrink:0; }
    .mp-game-edit-info { flex:1; min-width:0; }
    .mp-game-edit-name { font-size:0.78rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mp-game-edit-cat { font-size:0.68rem; color:var(--text-soft); }
    .mp-game-edit-btns { display:flex; gap:4px; }
    .mp-icon-btn { width:24px; height:24px; border-radius:5px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.7); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition:all 0.15s; }
    .mp-icon-btn:hover { background:rgba(239,68,68,0.3); border-color:rgba(239,68,68,0.5); }

    .mp-add-btn { width:100%; padding:8px; border:2px dashed rgba(148,163,184,0.35); background:rgba(15,23,42,0.4); color:var(--text-soft); border-radius:8px; cursor:pointer; font-size:0.78rem; transition:all 0.15s; display:flex; align-items:center; justify-content:center; gap:6px; }
    .mp-add-btn:hover { border-color:var(--custom-accent-color); color:var(--text); }

    .mp-config-area { width:100%; min-height:80px; background:rgba(0,0,0,0.5); border:1px solid rgba(148,163,184,0.3); border-radius:8px; padding:10px; color:#a5f3fc; font-family:monospace; font-size:0.7rem; word-break:break-all; resize:vertical; }

    /* ============================================================
       15. UI TOGGLE DROPDOWN
       ============================================================ */
    .ui-toggle-container { position: relative; }

    .ui-toggle-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 14px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 12px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ui-toggle-btn:hover { background: var(--accent-soft); border-color: var(--custom-accent-color); }

    .ui-toggle-dropdown {
      position: absolute; top: 100%; right: 0;
      margin-top: 8px;
      background: var(--bg-elevated);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 8px;
      min-width: 190px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      opacity: 0; visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 100;
    }

    .ui-toggle-container:hover .ui-toggle-dropdown,
    .ui-toggle-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }

    .ui-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s ease; font-size: 0.85rem; }
    .ui-option:hover { background: rgba(139,92,246,0.15); }
    .ui-option.active { background: var(--accent-soft); }
    .ui-option-icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .ui-option-text { display: flex; flex-direction: column; }
    .ui-option-label { font-weight: 600; color: var(--text); }
    .ui-option-desc { font-size: 0.7rem; color: var(--text-soft); }

    /* Theme specific modal adjustments */
    body.portal-mode .update-modal { background: rgba(255,255,255,0.9); }
    body.portal-mode .update-card { background: #ffffff; border-color: #e5e7eb; box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
    body.portal-mode .update-header { background: linear-gradient(135deg, rgba(99,102,241,0.1), transparent 60%); border-bottom-color: #e5e7eb; }
    body.portal-mode .update-title { background: linear-gradient(135deg, #4f46e5, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    body.portal-mode .update-body, body.portal-mode .update-footer { background: #ffffff; }
    body.portal-mode .update-list li { color: #111827; }
    body.portal-mode .update-date, body.portal-mode .checkbox-label { color: #6b7280; }
    body.portal-mode .update-footer { border-top-color: #e5e7eb; }
    body.portal-mode .survey-container { background: #ffffff; border-color: #e5e7eb; }
    body.portal-mode .chat-container { background: #ffffff; border-color: #e5e7eb; }
    body.portal-mode .chat-sidebar { background: #f9fafb; border-color: #e5e7eb; }
    body.portal-mode .chat-room-btn { background: #ffffff; border-color: #e5e7eb; color: #374151; }
    body.portal-mode .message-content { background: #f3f4f6; border-color: #e5e7eb; color: #111827; }
    body.portal-mode .message.own .message-content { background: linear-gradient(135deg, #4f46e5, #22c55e); color: white; }
  </style>
</head>
<body>
  <!-- ============================================================
       FULL HUB UI  (visible when mode = 'nebulahub')
       ============================================================ -->
  <div class="app-shell" id="nebulaHubUI">
    <header class="top-bar">
      <div class="brand">
        <div class="brand-logo">
          <div class="brand-logo-inner"><span>NH</span></div>
        </div>
        <div>
          <div class="brand-text-main">
            <span>NEBULA</span><span>HUB</span>
          </div>
          <div class="brand-sub">Games • Apps • Your cosmic escape 🌌</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="pill">
          <span class="pill-dot"></span>
          LIVE LIBRARY
        </div>

        <select id="themeSelector" class="theme-selector"
          style="padding:6px 10px; border-radius:12px; background:var(--bg-soft); border:1px solid var(--accent-soft); color:var(--text);">
          <option value="nebula">Nebula</option>
          <option value="midnight">Midnight</option>
          <option value="bubblegum">Bubblegum</option>
          <option value="matrix">Matrix</option>
          <option value="minecraft">Minecraft</option>
        </select>

        <!-- UI Toggle Dropdown -->
        <div class="ui-toggle-container">
          <button class="ui-toggle-btn" onclick="toggleUIDropdown()">
            <span>🎨</span>
            <span>UI Mode</span>
            <span style="margin-left:4px;">▼</span>
          </button>
          <div class="ui-toggle-dropdown" id="uiToggleDropdown">
            <div class="ui-option active" onclick="switchUI('nebulahub')" id="optionNebulaHub">
              <div class="ui-option-icon" style="background: linear-gradient(135deg, #8b5cf6, #22c55e);">🌌</div>
              <div class="ui-option-text">
                <span class="ui-option-label">NebulaHub</span>
                <span class="ui-option-desc">Full game portal</span>
              </div>
            </div>
            <div class="ui-option" onclick="switchUI('solar')" id="optionMinimal">
              <div class="ui-option-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">⚡</div>
              <div class="ui-option-text">
                <span class="ui-option-label">Solar UI</span>
                <span class="ui-option-desc">Solar UI — clean launcher</span>
              </div>
            </div>
          </div>
        </div>

        <button class="btn panic-btn" onclick="panicHide()">🚨 Panic</button>
      </div>
    </header>

    <section class="toolbar">
      <div class="search-wrapper">
        <span class="search-icon">🔍</span>
        <input id="searchInput" class="search-input" type="text"
          placeholder="Search games (eg. geometry, backrooms, shooter)..."
          autocomplete="off" />
        <button id="clearSearchBtn" class="clear-search" aria-label="Clear search">✕</button>
      </div>

      <div class="filters">
        <button class="filter-chip active" data-category="all"><span class="dot"></span>All</button>
        <button class="filter-chip" data-category="arcade"><span class="dot"></span>Arcade</button>
        <button class="filter-chip" data-category="horror"><span class="dot"></span>Horror</button>
        <button class="filter-chip" data-category="fps"><span class="dot"></span>FPS</button>
        <button class="filter-chip" data-category="sandbox"><span class="dot"></span>Sandbox</button>
        <button class="filter-chip" data-category="movies"><span class="dot"></span>Movies</button>
      </div>
    </section>

    <main class="content" id="mainContent">
      <aside class="sidebar" id="sidebarZone">
        <div class="dev-drag-handle" title="Drag to reorder">⋮⋮</div>
        <div>
          <div class="sidebar-title">Session info</div>
          <div class="sidebar-card">
            <div class="sidebar-card-header">
              <div class="sidebar-card-title">Stealth mode tips</div>
              <span class="badge">School safe*</span>
            </div>
            <p class="sidebar-card-text">
              Rename this tab, change the favicon, and host from a boring-looking URL
              so it blends in with "homework" tabs.
            </p>
            <div class="hint-list">
              <span>• Name suggestion: <strong>Algebra Notes</strong></span>
              <span>• Use a subpage like: <strong>#portal</strong></span>
              <span>• Keep volume low 💀</span>
            </div>
            <a class="small-link" href="https://github.com" target="_blank" rel="noreferrer">
              Manage on GitHub ↗
            </a>
          </div>
        </div>

        <div>
          <div class="sidebar-title">Stats</div>
          <div class="sidebar-card">
            <div class="stat-row"><span>Games loaded</span><strong id="statGames">0</strong></div>
            <div class="stat-row"><span>Filters</span><strong>Search + category</strong></div>
            <div class="stat-row"><span>Status</span><strong style="color:#bbf7d0;">Online</strong></div>
            <p class="sidebar-card-text">
              All links are static. Nothing is stored server-side; it's literally just HTML + JS.
            </p>
          </div>
        </div>
      </aside>

      <section class="library" id="libraryZone">
        <div class="dev-drag-handle" title="Drag to reorder">⋮⋮</div>
        <div class="library-header">
          <div class="library-title">
            <span>Library</span>
            <span class="count" id="resultCountLabel">0 RESULTS</span>
          </div>
          <div class="view-toggle">
            <button class="view-btn active" id="viewLibraryBtn">Library</button>
            <button class="view-btn" id="viewPlayerBtn" disabled>Player</button>
            <button class="view-btn" id="viewAnnouncementsBtn">📢 News<span class="btn-badge" id="announcementBadge" style="display:none;">NEW</span></button>
            <button class="view-btn" id="viewSurveyBtn">📋 Survey</button>
            <button class="view-btn" id="viewCustomizeBtn">Customize</button>
            <button class="view-btn" id="viewSettingsBtn">Settings</button>
            <button class="view-btn" id="viewChatBtn">💬 Chat</button>
            <button class="view-btn dev-btn" id="viewDevBtn" onclick="devMode.requestAccess()">⚡ Dev</button>
          </div>
        </div>

        <div class="library-body">
          <div id="libraryView">
            <div id="gameGrid" class="game-grid"></div>
            <div id="emptyState" class="empty-state" style="display:none;">
              <strong>No matches.</strong><br />
              Try clearing the search or switching categories.
            </div>
          </div>

          <div id="playerView" class="player-view">
            <div class="player-header">
              <div class="player-title">
                <span class="main" id="playerGameName">Game name</span>
                <span class="sub" id="playerGameMeta">Category • Opens in iframe</span>
              </div>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn btn-ghost" id="openInNewTabBtn">🔗 Open in new tab</button>
                <button class="btn" id="backToLibraryBtn">⬅ Back to library</button>
              </div>
            </div>
            <div class="player-frame">
              <iframe id="playerIframe" src=""></iframe>
            </div>
          </div>

          <div id="announcementsView" class="announcements-view"></div>

          <div id="surveyView" class="survey-view">
            <div class="survey-container">
              <div class="survey-header">
                <div class="survey-title"><span>📋</span><span>Community Survey</span></div>
                <div style="font-size:0.8rem;color:var(--text-soft);">Help us improve NebulaHub</div>
              </div>
              <div class="survey-frame-container">
                <iframe class="survey-frame" id="surveyFrame" src=""></iframe>
              </div>
            </div>
          </div>

          <div id="customizeView" class="customize-view">
            <div class="customize-grid">
              <div class="customize-card">
                <h3>🎨 Icon & Brand Colors</h3>
                <div class="color-input-group">
                  <label>Logo Primary Color</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="brandColorPicker" value="#22c55e">
                    <input type="text" id="brandColorText" value="#22c55e" placeholder="#22c55e">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Accent Color</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="accentColorPicker" value="#8b5cf6">
                    <input type="text" id="accentColorText" value="#8b5cf6" placeholder="#8b5cf6">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Strong Accent (Highlights)</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="accentStrongPicker" value="#22c55e">
                    <input type="text" id="accentStrongText" value="#22c55e" placeholder="#22c55e">
                  </div>
                </div>
              </div>

              <div class="customize-card">
                <h3>🌌 Background Gradients</h3>
                <div class="color-input-group">
                  <label>Gradient Top-Left</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="bgGrad1Picker" value="#1f2937">
                    <input type="text" id="bgGrad1Text" value="#1f2937" placeholder="#1f2937">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Gradient Bottom-Right</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="bgGrad2Picker" value="#111827">
                    <input type="text" id="bgGrad2Text" value="#111827" placeholder="#111827">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Overlay Tint 1</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="overlay1Picker" value="#3b82f6">
                    <input type="text" id="overlay1Text" value="rgba(59,130,246,0.35)" placeholder="rgba(59,130,246,0.35)">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Overlay Tint 2</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="overlay2Picker" value="#ec4899">
                    <input type="text" id="overlay2Text" value="rgba(236,72,153,0.3)" placeholder="rgba(236,72,153,0.3)">
                  </div>
                </div>
              </div>

              <div class="customize-card">
                <h3>⚡ Quick Presets</h3>
                <div class="preset-grid">
                  <button class="preset-btn" onclick="applyPreset('ocean')">Ocean</button>
                  <button class="preset-btn" onclick="applyPreset('sunset')">Sunset</button>
                  <button class="preset-btn" onclick="applyPreset('forest')">Forest</button>
                  <button class="preset-btn" onclick="applyPreset('crimson')">Crimson</button>
                  <button class="preset-btn" onclick="applyPreset('gold')">Gold</button>
                  <button class="preset-btn" onclick="applyPreset('purple')">Purple</button>
                </div>
                <div class="theme-active-notice" id="customActiveNotice">
                  ✨ Custom theme active! Select a preset theme from the dropdown above to reset.
                </div>
              </div>

              <div class="customize-card chat-colors">
                <h3>💬 Chat Theme Colors</h3>
                <div class="color-input-group">
                  <label>Sent Message Bubble</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="chatSentPicker" value="#8b5cf6">
                    <input type="text" id="chatSentText" value="#8b5cf6" placeholder="#8b5cf6">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Chat Background Tint</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="chatBgPicker" value="#0c1024">
                    <input type="text" id="chatBgText" value="#0c1024" placeholder="#0c1024">
                  </div>
                </div>
                <div class="chat-preview-box" id="chatPreviewBox">
                  <div class="chat-preview-msg received">Hello there! 👋</div>
                  <div class="chat-preview-msg sent">Hey! How's it going?</div>
                </div>
              </div>
            </div>

            <div class="customize-actions">
              <button class="btn btn-primary" onclick="saveCustomTheme()">💾 Save Theme</button>
              <button class="btn btn-secondary" onclick="resetCustomTheme()">↩ Reset to Default</button>
              <button class="btn btn-secondary" onclick="previewTheme()">👁 Preview</button>
            </div>
          </div>

          <div id="settingsView" class="settings-view">
            <div class="settings-grid">
              <div class="settings-card">
                <h3>🕵️ Tab Cloaking</h3>
                <p class="settings-desc">Disguise this site to look like a different tab</p>
                <div class="input-group">
                  <label>Tab Title</label>
                  <input type="text" id="tabTitleInput" placeholder="e.g. Algebra Notes, Google Docs, My Drive" maxlength="50">
                </div>
                <div class="input-group">
                  <label>Tab Icon</label>
                  <div class="favicon-options">
                    <button class="favicon-btn active" data-favicon="default">
                      <span class="favicon-preview default">NH</span>
                      <span>Default</span>
                    </button>
                    <button class="favicon-btn" data-favicon="google">
                      <span class="favicon-preview google">G</span>
                      <span>Google</span>
                    </button>
                    <button class="favicon-btn" data-favicon="classroom">
                      <span class="favicon-preview classroom">C</span>
                      <span>Classroom</span>
                    </button>
                    <button class="favicon-btn" data-favicon="docs">
                      <span class="favicon-preview docs">D</span>
                      <span>Docs</span>
                    </button>
                    <button class="favicon-btn" data-favicon="slides">
                      <span class="favicon-preview slides">S</span>
                      <span>Slides</span>
                    </button>
                  </div>
                </div>
                <div class="customize-actions">
                  <button class="btn btn-primary" onclick="applyTabCloak()">🔄 Apply Cloak</button>
                  <button class="btn btn-secondary" onclick="resetTabCloak()">↩ Reset</button>
                </div>
              </div>

              <div class="settings-card">
                <h3>⚠️ Panic Button</h3>
                <p class="settings-desc">Configure the panic button redirect destination</p>
                <div class="input-group">
                  <label>Panic URL (where 🚨 takes you)</label>
                  <input type="text" id="panicUrlInput" placeholder="https://classroom.google.com" value="https://clever.com/in/dallasisd/student/portal">
                </div>
                <button class="btn btn-primary" onclick="savePanicUrl()" style="margin-top: 8px;">💾 Save Panic URL</button>
              </div>
            </div>
          </div>

          <!-- Developer View -->
          <div id="devView" class="dev-view">
            <div class="dev-grid">
              <div class="dev-card">
                <h3><span>🎛️</span> Layout Editor <span class="dev-badge">Dev</span></h3>
                <div class="dev-section">
                  <span class="dev-label">Drag zones to reorder layout</span>
                  <div class="layout-preview" id="layoutPreview">
                    <div class="layout-zone" data-zone="sidebar" draggable="true">
                      <div class="zone-icon">📊</div>
                      <div class="zone-info">
                        <div class="zone-title">Sidebar</div>
                        <div class="zone-desc">Session info & Stats</div>
                      </div>
                      <div class="zone-toggle active" onclick="devMode.toggleZone('sidebar')"></div>
                    </div>
                    <div class="layout-zone" data-zone="library" draggable="true">
                      <div class="zone-icon">🎮</div>
                      <div class="zone-info">
                        <div class="zone-title">Library</div>
                        <div class="zone-desc">Games grid & Player</div>
                      </div>
                      <div class="zone-toggle active" onclick="devMode.toggleZone('library')"></div>
                    </div>
                  </div>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.saveLayout()">💾 Save Layout</button>
                  <button class="btn btn-secondary" onclick="devMode.resetLayout()">↩ Reset</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🧪</span> Experimental Features</h3>
                <div class="feature-list" id="featureList"></div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; border: 1px solid rgba(245,158,11,0.3);">
                  <div style="font-size: 0.8rem; color: #fde68a; font-weight: 600;">💡 Developer Note</div>
                  <div style="font-size: 0.75rem; color: var(--text-soft); margin-top: 4px;">
                    New features can be registered via <code>devMode.registerFeature()</code>.
                  </div>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🎨</span> Live CSS Editor</h3>
                <div class="dev-section">
                  <span class="dev-label">Custom CSS (injected live)</span>
                  <textarea class="css-editor" id="devCssEditor" placeholder="/* Enter custom CSS here */"></textarea>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.applyCSS()">⚡ Apply CSS</button>
                  <button class="btn btn-secondary" onclick="devMode.clearCSS()">🗑️ Clear</button>
                  <button class="btn btn-success" onclick="devMode.saveCSS()">💾 Save</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🎮</span> Quick Game Manager</h3>
                <div class="dev-section">
                  <span class="dev-label">Current Games (<span id="devGameCount">0</span>)</span>
                  <div class="game-list-editor" id="devGameList"></div>
                  <button class="add-game-btn" onclick="devMode.showAddGameModal()"><span>+</span> Add New Game</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>⚙️</span> Global Configuration</h3>
                <div class="dev-section">
                  <span class="dev-label">Export/Import Settings</span>
                  <textarea class="config-textarea" id="devConfigExport" readonly placeholder="Configuration JSON will appear here..."></textarea>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.exportConfig()">📋 Export</button>
                  <button class="btn btn-secondary" onclick="devMode.importConfig()">📥 Import</button>
                  <button class="btn btn-danger" onclick="devMode.resetAll()">⚠️ Reset All</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat View -->
          <div id="chatView" class="chat-view">
            <div class="library-header">
              <div class="library-title">
                <span>💬 NebulaChat</span>
                <span class="count" id="chatUserCount">Live</span>
              </div>
            </div>
            <div class="chat-container">
              <div class="chat-sidebar" id="chatSidebar">
                <div class="sidebar-title">Channels</div>
                <button class="chat-room-btn active" data-room="general">
                  <div class="room-icon">#</div>
                  <div>
                    <div style="font-weight:600;">general</div>
                    <div style="font-size:0.75rem;opacity:0.7;">Public chat</div>
                  </div>
                </button>
                <button class="chat-room-btn" data-room="gaming">
                  <div class="room-icon">🎮</div>
                  <div>
                    <div style="font-weight:600;">gaming</div>
                    <div style="font-size:0.75rem;opacity:0.7;">Game discussions</div>
                  </div>
                </button>
                <button class="chat-room-btn" data-room="random">
                  <div class="room-icon">💫</div>
                  <div>
                    <div style="font-weight:600;">random</div>
                    <div style="font-size:0.75rem;opacity:0.7;">Off-topic</div>
                  </div>
                </button>
              </div>
              <div class="chat-main">
                <div class="chat-header">
                  <div class="chat-header-title"><span>#</span><span id="currentRoomName">general</span></div>
                  <div class="chat-status"><span class="status-dot"></span><span id="connectionStatus">Connecting...</span></div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                  <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." maxlength="500">
                    <button class="chat-send-btn" id="sendMessageBtn">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>NebulaHub • static HTML build</span>
      <span>
        Host this on <a href="https://pages.github.com/" target="_blank" rel="noreferrer">GitHub Pages</a>.
        <span class="portal-link" id="portalLink">Portal mode</span>
      </span>
    </footer>

    <div class="legal-footer">
      <span>© <span id="yearSpan"></span> NebulaHub</span>
      <a href="/about.html">About</a>
      <a href="/privacy.html">Privacy Policy</a>
      <a href="/terms.html">Terms of Use</a>
    </div>
  </div>

  <!-- ============================================================
       SOLAR UI  (visible when mode = 'solar')
       ============================================================ -->
  <div class="nebulahub-ui" id="nebulaHubMinimalUI">
    
    <!-- Animated NebulaHub Logo & Brand -->
    <div class="nebulahub-minimal-brand">
      <svg class="nebulahub-logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="nb1" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#22c55e"/>
            <stop offset="45%" stop-color="#8b5cf6"/>
            <stop offset="100%" stop-color="#030014"/>
          </radialGradient>
          <radialGradient id="nb2" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="1"/>
            <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <!-- Outer glow ring -->
        <circle cx="50" cy="50" r="48" fill="url(#nb1)" opacity="0.85"/>
        <!-- Orbit rings -->
        <ellipse cx="50" cy="50" rx="30" ry="12" fill="none" stroke="#a78bfa" stroke-width="2" opacity="0.7" transform="rotate(-25 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="-25 50 50;335 50 50;-25 50 50" dur="8s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="50" cy="50" rx="40" ry="17" fill="none" stroke="#22c55e" stroke-width="1.5" opacity="0.5" transform="rotate(15 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="15 50 50;375 50 50;15 50 50" dur="13s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="50" cy="50" rx="22" ry="8" fill="none" stroke="#ec4899" stroke-width="1.5" opacity="0.4" transform="rotate(60 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="60 50 50;420 50 50;60 50 50" dur="6s" repeatCount="indefinite"/>
        </ellipse>
        <!-- Core star -->
        <circle cx="50" cy="50" r="8" fill="url(#nb2)"/>
        <circle cx="50" cy="50" r="4.5" fill="white" opacity="0.95"/>
        <!-- Stars -->
        <circle cx="28" cy="30" r="1.5" fill="white" opacity="0.8"/>
        <circle cx="72" cy="27" r="1" fill="white" opacity="0.7"/>
        <circle cx="74" cy="70" r="1.5" fill="#22c55e" opacity="0.9"/>
        <circle cx="23" cy="66" r="1" fill="#a78bfa" opacity="0.8"/>
        <circle cx="60" cy="20" r="1" fill="white" opacity="0.6"/>
        <circle cx="80" cy="52" r="1" fill="#22c55e" opacity="0.7"/>
      </svg>
      <div class="nebulahub-minimal-title">NEBULA<strong>HUB</strong></div>
      <div class="nebulahub-minimal-sub">Your cosmic escape</div>
    </div>

    <!-- Search with Proxy -->
    <div class="nebulahub-search-container">
      <!-- Proxy selector tabs -->
      <div class="proxy-selector" id="proxySelectorBar">
        <button class="proxy-option active" data-proxy="duckduckgo" onclick="selectProxy('duckduckgo', this)">DuckDuckGo</button>
        <button class="proxy-option" data-proxy="google" onclick="selectProxy('google', this)">Google</button>
        <button class="proxy-option" data-proxy="bing" onclick="selectProxy('bing', this)">Bing</button>
        <button class="proxy-option" data-proxy="ultraviolet" onclick="selectProxy('ultraviolet', this)">🔒 UV Proxy</button>
        <button class="proxy-option" data-proxy="direct" onclick="selectProxy('direct', this)">Direct URL</button>
      </div>

      <!-- Search bar -->
      <div class="nebulahub-search-box">
        <input type="text" class="nebulahub-search-input" id="nebulaSearchInput"
          placeholder="Search or enter a URL..."
          onkeypress="handleNebulaSearch(event)">
        <button class="nebulahub-search-submit" onclick="launchNebulaSearch()" title="Search">🔍</button>
      </div>

      <!-- Proxy status indicator -->
      <div class="nebulahub-proxy-status">
        <span class="dot"></span>
        <span id="proxyStatusText">DuckDuckGo · Private search</span>
      </div>
    </div>

    <!-- Search results frame (shows inline results) -->
    <div class="nebulahub-results-frame" id="nebulaResultsFrame">
      <iframe id="nebulaResultsIframe" src="" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>

    <!-- ============================================================
         SOLAR UI — FULL-SCREEN PANELS
         (each panel is position:fixed, toggled via .show class)
         ============================================================ -->

    <!-- LIBRARY PANEL -->
    <div class="minimal-panel" id="mpLibrary">
      <div class="mp-header">
        <div class="mp-title">🎮 <span>Games Library</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpLibrary')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-search-bar">
          <input type="text" class="mp-search-input" id="mpSearchInput" placeholder="Search games...">
        </div>
        <div class="mp-filter-row">
          <button class="mp-chip active" data-mpcat="all" onclick="mpFilterGame(this,'all')">All</button>
          <button class="mp-chip" data-mpcat="arcade" onclick="mpFilterGame(this,'arcade')">Arcade</button>
          <button class="mp-chip" data-mpcat="horror" onclick="mpFilterGame(this,'horror')">Horror</button>
          <button class="mp-chip" data-mpcat="fps" onclick="mpFilterGame(this,'fps')">FPS</button>
          <button class="mp-chip" data-mpcat="sandbox" onclick="mpFilterGame(this,'sandbox')">Sandbox</button>
        </div>
        <div class="mp-game-grid" id="mpGameGrid"></div>
      </div>
    </div>

    <!-- PLAYER PANEL -->
    <div class="minimal-panel" id="mpPlayer">
      <div class="mp-header">
        <div class="mp-title">▶️ <span id="mpPlayerTitle">Now Playing</span></div>
        <div style="display:flex;gap:8px;">
          <button class="mp-close" style="width:auto;padding:0 10px;border-radius:999px;" onclick="window.open(mpCurrentGameUrl,'_blank')" title="Open in new tab">🔗</button>
          <button class="mp-close" onclick="closeMinimalPanel('mpPlayer')">✕</button>
        </div>
      </div>
      <div class="mp-player-frame">
        <iframe id="mpPlayerIframe" src="" allowfullscreen></iframe>
      </div>
    </div>

    <!-- NEWS PANEL -->
    <div class="minimal-panel" id="mpNews">
      <div class="mp-header">
        <div class="mp-title">📢 <span>News & Announcements</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpNews')">✕</button>
      </div>
      <div class="mp-body" id="mpNewsBody"></div>
    </div>

    <!-- SURVEY PANEL -->
    <div class="minimal-panel" id="mpSurvey">
      <div class="mp-header">
        <div class="mp-title">📋 <span>Community Survey</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpSurvey')">✕</button>
      </div>
      <iframe class="mp-survey-frame" id="mpSurveyIframe" src=""></iframe>
    </div>

    <!-- CHAT PANEL -->
    <div class="minimal-panel" id="mpChat">
      <div class="mp-header">
        <div class="mp-title">💬 <span>NebulaChat</span> <span style="font-size:0.75rem;color:var(--text-soft);font-weight:400;" id="mpChatStatus">· Connecting...</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpChat')">✕</button>
      </div>
      <div class="mp-chat-layout">
        <div class="mp-chat-rooms">
          <button class="mp-room-btn active" data-mproom="general" onclick="mpSwitchRoom(this,'general')"># general</button>
          <button class="mp-room-btn" data-mproom="gaming" onclick="mpSwitchRoom(this,'gaming')">🎮 gaming</button>
          <button class="mp-room-btn" data-mproom="random" onclick="mpSwitchRoom(this,'random')">💫 random</button>
        </div>
        <div class="mp-chat-main">
          <div class="mp-messages" id="mpMessages"></div>
          <div class="mp-chat-input-row">
            <input type="text" class="mp-chat-input" id="mpChatInput" placeholder="Type a message..." maxlength="500" onkeypress="if(event.key==='Enter')mpSendMessage()">
            <button class="mp-chat-send" onclick="mpSendMessage()">➤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOMIZE PANEL -->
    <div class="minimal-panel" id="mpCustomize">
      <div class="mp-header">
        <div class="mp-title">🎨 <span>Customize</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpCustomize')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-setting-group">
          <span class="mp-setting-label">Brand Color</span>
          <div class="mp-color-row"><input type="color" id="mpBrandPicker" oninput="mpSyncColor('mpBrandPicker','mpBrandText','brand')"><input type="text" id="mpBrandText" placeholder="#22c55e" onchange="mpSyncColorText('mpBrandPicker','mpBrandText','brand')"></div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Accent Color</span>
          <div class="mp-color-row"><input type="color" id="mpAccentPicker" oninput="mpSyncColor('mpAccentPicker','mpAccentText','accent')"><input type="text" id="mpAccentText" placeholder="#8b5cf6" onchange="mpSyncColorText('mpAccentPicker','mpAccentText','accent')"></div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Strong Accent</span>
          <div class="mp-color-row"><input type="color" id="mpStrongPicker" oninput="mpSyncColor('mpStrongPicker','mpStrongText','accentStrong')"><input type="text" id="mpStrongText" placeholder="#22c55e" onchange="mpSyncColorText('mpStrongPicker','mpStrongText','accentStrong')"></div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Quick Presets</span>
          <div class="mp-preset-grid">
            <button class="mp-preset-btn" onclick="applyPreset('ocean');mpSyncFromMain()">🌊 Ocean</button>
            <button class="mp-preset-btn" onclick="applyPreset('sunset');mpSyncFromMain()">🌅 Sunset</button>
            <button class="mp-preset-btn" onclick="applyPreset('forest');mpSyncFromMain()">🌲 Forest</button>
            <button class="mp-preset-btn" onclick="applyPreset('crimson');mpSyncFromMain()">🔴 Crimson</button>
            <button class="mp-preset-btn" onclick="applyPreset('gold');mpSyncFromMain()">✨ Gold</button>
            <button class="mp-preset-btn" onclick="applyPreset('purple');mpSyncFromMain()">💜 Purple</button>
          </div>
        </div>
        <div class="mp-action-row">
          <button class="mp-btn primary" onclick="applyCustomColors();saveCustomTheme();showNotification('💾 Theme saved!')">💾 Save</button>
          <button class="mp-btn" onclick="resetCustomTheme();mpSyncFromMain()">↩ Reset</button>
          <button class="mp-btn" onclick="applyCustomColors()">👁 Preview</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="minimal-panel" id="mpSettings">
      <div class="mp-header">
        <div class="mp-title">⚙️ <span>Settings</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpSettings')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-section-title">🕵️ Tab Cloaking</div>
        <div class="mp-input-group">
          <label>Tab Title</label>
          <input type="text" id="mpTabTitle" placeholder="e.g. Algebra Notes" maxlength="50">
        </div>
        <div class="mp-input-group">
          <label>Tab Icon</label>
          <div class="mp-favicon-grid">
            <button class="mp-fav-btn active" data-mpfav="default" onclick="mpSelectFav(this,'default')">
              <span class="mp-fav-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a);">NH</span>
              <span class="mp-fav-label">Default</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="google" onclick="mpSelectFav(this,'google')">
              <span class="mp-fav-icon" style="background:#4285F4;">G</span>
              <span class="mp-fav-label">Google</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="classroom" onclick="mpSelectFav(this,'classroom')">
              <span class="mp-fav-icon" style="background:#24a865;">C</span>
              <span class="mp-fav-label">Class</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="docs" onclick="mpSelectFav(this,'docs')">
              <span class="mp-fav-icon" style="background:#4285F4;">D</span>
              <span class="mp-fav-label">Docs</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="slides" onclick="mpSelectFav(this,'slides')">
              <span class="mp-fav-icon" style="background:#fbbc04;">S</span>
              <span class="mp-fav-label">Slides</span>
            </button>
          </div>
        </div>
        <div class="mp-action-row" style="margin-bottom:20px;">
          <button class="mp-btn primary" onclick="mpApplyCloak()">🔄 Apply Cloak</button>
          <button class="mp-btn" onclick="resetTabCloak();document.getElementById('mpTabTitle').value='';">↩ Reset</button>
        </div>

        <div class="mp-section-title">⚠️ Panic Button</div>
        <div class="mp-input-group">
          <label>Panic URL</label>
          <input type="text" id="mpPanicUrl" placeholder="https://classroom.google.com">
        </div>
        <div class="mp-action-row" style="margin-bottom:20px;">
          <button class="mp-btn primary" onclick="mpSavePanic()">💾 Save</button>
        </div>

        <div class="mp-section-title">🎨 Theme</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="mp-btn" onclick="mpSetTheme('nebula')">🌌 Nebula</button>
          <button class="mp-btn" onclick="mpSetTheme('midnight')">🌙 Midnight</button>
          <button class="mp-btn" onclick="mpSetTheme('bubblegum')">🍬 Bubblegum</button>
          <button class="mp-btn" onclick="mpSetTheme('matrix')">💚 Matrix</button>
          <button class="mp-btn" onclick="mpSetTheme('minecraft')">🟩 Minecraft</button>
        </div>
      </div>
    </div>

    <!-- DEV PANEL -->
    <div class="minimal-panel" id="mpDev">
      <div class="mp-header">
        <div class="mp-title">🛠️ <span>Dev Tools</span> <span style="background:linear-gradient(135deg,#ef4444,#f97316);color:white;padding:2px 8px;border-radius:999px;font-size:0.65rem;font-weight:800;margin-left:4px;">DEV</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpDev')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-dev-grid">
          <!-- Features -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🧪 Feature Flags</div>
            <div id="mpFeatureList"></div>
          </div>
          <!-- CSS -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🎨 Live CSS</div>
            <textarea class="mp-css-editor" id="mpCssEditor" placeholder="/* custom CSS */"></textarea>
            <div class="mp-action-row" style="margin-top:8px;">
              <button class="mp-btn primary" onclick="mpApplyCSS()">⚡ Apply</button>
              <button class="mp-btn" onclick="mpClearCSS()">🗑️ Clear</button>
              <button class="mp-btn" onclick="devMode.saveCSS();showNotification('💾 Saved')">💾 Save</button>
            </div>
          </div>
          <!-- Game Manager -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🎮 Game Manager <span style="font-size:0.72rem;color:var(--text-soft);font-weight:400;">(<span id="mpGameCount">0</span>)</span></div>
            <div class="mp-game-editor-list" id="mpGameEditorList"></div>
            <button class="mp-add-btn" onclick="devMode.showAddGameModal();mpRenderGameEditor()">+ Add Game</button>
          </div>
          <!-- Config -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">⚙️ Config</div>
            <textarea class="mp-config-area" id="mpConfigArea" readonly placeholder="Export JSON appears here..."></textarea>
            <div class="mp-action-row" style="margin-top:8px;">
              <button class="mp-btn primary" onclick="mpExportConfig()">📋 Export</button>
              <button class="mp-btn" onclick="devMode.importConfig()">📥 Import</button>
              <button class="mp-btn danger" onclick="devMode.resetAll()">⚠️ Reset All</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================
         BOTTOM DOCK  (shared between Solar UI and Full Hub)
         ============================================================ -->
    <div class="nebulahub-dock" id="nebulaHubDock">
      <!-- Back to full UI -->
      <div class="nebulahub-dock-item" onclick="switchUI('nebulahub')" data-tip="Full Hub">🌌</div>

      <!-- Library / Games -->
      <div class="nebulahub-dock-item" onclick="openDockTab('library',this)" data-tip="Games Library">🎮</div>

      <!-- Announcements / News -->
      <div class="nebulahub-dock-item" onclick="openDockTab('news',this)" data-tip="News & Announcements">📢</div>

      <!-- Survey -->
      <div class="nebulahub-dock-item" onclick="openDockTab('survey',this)" data-tip="Community Survey">📋</div>

      <!-- Chat -->
      <div class="nebulahub-dock-item" onclick="openDockTab('chat',this)" data-tip="NebulaChat">💬</div>

      <!-- Customize -->
      <div class="nebulahub-dock-item" onclick="openDockTab('customize',this)" data-tip="Customize">🎨</div>

      <!-- Settings -->
      <div class="nebulahub-dock-item" onclick="openDockTab('settings',this)" data-tip="Settings">⚙️</div>

      <!-- Player -->
      <div class="nebulahub-dock-item" onclick="openDockTab('player',this)" data-tip="Now Playing">▶️</div>

      <!-- Dev -->
      <div class="nebulahub-dock-item" onclick="openDockTab('dev',this)" data-tip="Dev Tools">🛠️</div>

      <div class="nebulahub-dock-divider"></div>

      <!-- Panic -->
      <div class="nebulahub-dock-item" onclick="panicHide()" data-tip="Panic!">🚨</div>

      <div class="nebulahub-dock-divider"></div>

      <!-- Clock -->
      <div class="nebulahub-dock-time" id="nebulaTime">00:00</div>
    </div>
  </div>

  <!-- ============================================================
       MODALS
       ============================================================ -->
  <!-- Username Setup Modal -->
  <div id="usernameModal" class="username-modal">
    <div class="username-card">
      <h2>👋 Welcome to NebulaChat</h2>
      <p>Choose a display name to join the conversation</p>
      <div class="username-input-group">
        <input type="text" id="usernameInput" placeholder="Enter username..." maxlength="20">
      </div>
      <button class="btn btn-primary" onclick="saveChatUser()" style="width:100%; justify-content:center;">Join Chat</button>
    </div>
  </div>

  <!-- Dev Auth Modal -->
  <div id="devAuthModal" class="dev-auth-modal">
    <div class="dev-auth-card">
      <h2>⚡ Developer Access</h2>
      <p>Enter password to access developer tools</p>
      <div class="password-input-group">
        <input type="password" id="devPasswordInput" placeholder="••••••••" maxlength="20">
      </div>
      <button class="btn btn-primary" onclick="devMode.authenticate()" style="width:100%; justify-content:center;">Unlock Dev Mode</button>
      <button class="btn btn-ghost" onclick="devMode.closeAuth()" style="width:100%; justify-content:center; margin-top: 8px;">Cancel</button>
    </div>
  </div>

  <!-- Update Modal -->
  <div id="updateModal" class="update-modal">
    <div class="update-card">
      <div class="update-header">
        <div class="update-title" id="updateTitle">🚀 What's New</div>
        <div class="update-date" id="updateDate">January 28, 2026</div>
      </div>
      <div class="update-body">
        <ul class="update-list" id="updateList"></ul>
      </div>
      <div class="update-footer">
        <label class="checkbox-label">
          <input type="checkbox" id="dontShowAgain">
          Don't show again until next update
        </label>
        <button class="btn btn-primary" onclick="closeUpdateModal()">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Dev Access Indicator -->
  <div class="dev-access-indicator" id="devIndicator" onclick="devMode.lock()">
    <span>⚡</span>
    <span>DEV MODE ACTIVE (Click to lock)</span>
  </div>

  <script>
    /* ============================================================
       NEBULAHUB — JAVASCRIPT
       ============================================================
       TABLE OF CONTENTS
       ----------------------------------------------------------
       §1   PROXY CONFIGURATION         (search engines & UV proxy)
       §2   SOLAR UI PANEL SYSTEM       (open/close full-screen panels)
       §3   SOLAR UI — LIBRARY PANEL    (game grid, search, filter)
       §4   SOLAR UI — NEWS PANEL       (announcements renderer)
       §5   SOLAR UI — SURVEY PANEL     (Google Form iframe)
       §6   SOLAR UI — CHAT PANEL       (room switching, send, render)
       §7   SOLAR UI — CUSTOMIZE PANEL  (color pickers sync)
       §8   SOLAR UI — SETTINGS PANEL   (cloak, panic, theme)
       §9   SOLAR UI — DEV PANEL        (features, CSS editor, game mgr)
       §10  DOCK TAB HANDLER            (routes dock clicks → correct UI)
       §11  UI TOGGLE SYSTEM            (switchUI, Solar ↔ Full Hub)
       §12  ANNOUNCEMENTS               (data array + MAX_DISPLAYED)
       §13  SURVEY                      (SURVEY_URL constant)
       §14  UPDATE MODAL CONFIG         (version, changelog entries)
       §15  FAVICONS                    (tab-cloak icon presets)
       §16  GAME LIBRARY DATA           (games[] array — add games here)
       §17  CORE STATE VARIABLES        (activeCategory, activeGame…)
       §18  ANNOUNCEMENTS SYSTEM        (render, badge, unread count)
       §19  SURVEY SYSTEM               (renderSurveyView)
       §20  DEVELOPER MODE SYSTEM       (devMode object — auth, features)
       §21  CUSTOMIZATION SYSTEM        (colors, presets, applyCustomColors)
       §22  TAB CLOAKING SYSTEM         (title + favicon spoofing)
       §23  UPDATE MODAL                (showUpdateModal, close)
       §24  CORE FUNCTIONS              (renderGrid, showView helpers)
       §25  NEBULACHAT SYSTEM           (Supabase realtime chat)
       §26  INIT                        (DOMContentLoaded bootstrap)
       ============================================================ */

    // ================================================================
    // §1  PROXY CONFIGURATION
    // ================================================================
    let activeProxy = 'duckduckgo';

    const PROXY_CONFIG = {
      duckduckgo: {
        label: 'DuckDuckGo · Private search',
        buildUrl: (query) => `https://duckduckgo.com/?q=${encodeURIComponent(query)}&kae=d`,
        isSearch: true
      },
      google: {
        label: 'Google · Standard search',
        buildUrl: (query) => `https://www.google.com/search?q=${encodeURIComponent(query)}`,
        isSearch: true
      },
      bing: {
        label: 'Bing · Microsoft search',
        buildUrl: (query) => `https://www.bing.com/search?q=${encodeURIComponent(query)}`,
        isSearch: true
      },
      ultraviolet: {
        label: '🔒 UV Proxy · Bypass filters',
        buildUrl: (query) => {
          // Ultraviolet proxy (common self-hosted path)
          const encoded = btoa(query.startsWith('http') ? query : `https://${query}`);
          return `/~/uv/service/${encoded}`;
        },
        isSearch: false,
        note: 'Requires UV proxy server'
      },
      direct: {
        label: 'Direct URL · Open in new tab',
        buildUrl: (query) => {
          if (query.startsWith('http')) return query;
          return `https://${query}`;
        },
        isSearch: false,
        openNew: true
      }
    };

    function selectProxy(proxyKey, btn) {
      activeProxy = proxyKey;
      // Update active button
      document.querySelectorAll('.proxy-option').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Update status text
      const cfg = PROXY_CONFIG[proxyKey];
      document.getElementById('proxyStatusText').textContent = cfg.label;
      // Update placeholder
      const input = document.getElementById('nebulaSearchInput');
      if (cfg.isSearch) {
        input.placeholder = 'Search or enter a URL...';
      } else if (proxyKey === 'direct') {
        input.placeholder = 'Enter URL (e.g. github.com)...';
      } else {
        input.placeholder = 'Enter URL to proxy...';
      }
    }

    function handleNebulaSearch(event) {
      if (event.key === 'Enter') launchNebulaSearch();
    }

    function launchNebulaSearch() {
      const query = document.getElementById('nebulaSearchInput').value.trim();
      if (!query) return;

      const cfg = PROXY_CONFIG[activeProxy];
      const url = cfg.buildUrl(query);

      if (cfg.openNew) {
        window.open(url, '_blank');
        document.getElementById('nebulaSearchInput').value = '';
        return;
      }

      // Show results in inline frame
      const frame = document.getElementById('nebulaResultsFrame');
      const iframe = document.getElementById('nebulaResultsIframe');
      iframe.src = url;
      frame.classList.add('show');
      document.getElementById('nebulaSearchInput').value = '';
    }

    // ================================================================
    // §2  SOLAR UI PANEL SYSTEM
    // ================================================================
    let mpActivePanel = null;
    let mpCurrentGameUrl = '';
    let mpActiveCategory = 'all';

    const MP_PANELS = ['mpLibrary','mpPlayer','mpNews','mpSurvey','mpChat','mpCustomize','mpSettings','mpDev'];

    function closeAllMinimalPanels() {
      MP_PANELS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('show');
      });
      // Also hide search results
      document.getElementById('nebulaResultsFrame').classList.remove('show');
      mpActivePanel = null;
      // Remove active state from dock items
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => d.classList.remove('active-dock-item'));
    }

    function openMinimalPanel(panelId, dockEl) {
      if (mpActivePanel === panelId) {
        // Toggle off if already open
        closeAllMinimalPanels();
        return;
      }
      closeAllMinimalPanels();
      mpActivePanel = panelId;
      const panel = document.getElementById(panelId);
      if (panel) panel.classList.add('show');
      if (dockEl) dockEl.classList.add('active-dock-item');
    }

    function closeMinimalPanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) panel.classList.remove('show');
      if (mpActivePanel === panelId) mpActivePanel = null;
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => d.classList.remove('active-dock-item'));
    }

    // ----------------------------------------------------------------
    // §3  SOLAR UI — LIBRARY PANEL
    // ----------------------------------------------------------------
    function mpRenderLibrary() {
      const query = (document.getElementById('mpSearchInput')?.value || '').toLowerCase().trim();
      const grid = document.getElementById('mpGameGrid');
      if (!grid) return;

      const filtered = games.filter(g => {
        const catMatch = mpActiveCategory === 'all' || g.category === mpActiveCategory;
        const hay = (g.name + ' ' + (g.tags||[]).join(' ')).toLowerCase();
        return catMatch && (query === '' || hay.includes(query));
      });

      grid.innerHTML = filtered.map((g, i) => {
        const initials = g.name.split(' ').map(w => w[0]?.toUpperCase()||'').join('').slice(0,3);
        // Use data-index to avoid quote-escaping issues in onclick
        const idx = games.indexOf(g);
        return `
          <div class="mp-game-card" data-game-idx="${idx}" onclick="mpOpenGameByIndex(this)">
            <div class="mp-game-thumb">${initials}</div>
            <div class="mp-game-name" title="${g.name}">${g.name}</div>
            <div class="mp-game-cat">${(g.category||'game').toUpperCase()}</div>
          </div>
        `;
      }).join('') || '<div style="padding:20px;text-align:center;color:var(--text-soft);">No matches found.</div>';
    }

    function mpOpenGameByIndex(cardEl) {
      const idx = parseInt(cardEl.getAttribute('data-game-idx'), 10);
      const g = games[idx];
      if (!g) return;
      mpOpenGame(g.url, g.name);
    }

    function mpFilterGame(btn, cat) {
      mpActiveCategory = cat;
      document.querySelectorAll('.mp-chip').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      mpRenderLibrary();
    }

    function mpOpenGame(url, name) {
      mpCurrentGameUrl = url;
      document.getElementById('mpPlayerTitle').textContent = name;
      document.getElementById('mpPlayerIframe').src = url;
      activeGame = { name, url, category: 'game', tags: [] };

      // Close all panels (including library), then open player — Solar UI tab navigation
      closeAllMinimalPanels();
      mpActivePanel = 'mpPlayer';
      document.getElementById('mpPlayer').classList.add('show');
      // Highlight the ▶️ dock icon
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => {
        if (d.getAttribute('data-tip') === 'Now Playing') d.classList.add('active-dock-item');
      });
    }

    // ----------------------------------------------------------------
    // §4  SOLAR UI — NEWS PANEL
    // ----------------------------------------------------------------
    function mpRenderNews() {
      const body = document.getElementById('mpNewsBody');
      if (!body) return;

      if (!ANNOUNCEMENTS.length) {
        body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-soft);">📭 No announcements yet.</div>';
        return;
      }

      const sorted = [...ANNOUNCEMENTS].sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, MAX_DISPLAYED_ANNOUNCEMENTS);
      body.innerHTML = sorted.map(ann => `
        <div class="mp-announcement ${ann.type||'normal'}">
          ${ann.badge ? `<div class="mp-ann-badge">${ann.badge}</div>` : ''}
          <div class="mp-ann-title">${ann.title}</div>
          <div class="mp-ann-date">${ann.date}</div>
          ${ann.image ? `<img src="${ann.image}" style="width:100%;border-radius:10px;margin:8px 0;" alt="">` : ''}
          ${ann.gif ? `<img src="${ann.gif}" style="width:100%;border-radius:10px;margin:8px 0;" alt="">` : ''}
          <div class="mp-ann-content">${ann.content.replace(/\n/g,'<br>')}</div>
        </div>
      `).join('');

      // Mark as seen
      const latestId = Math.max(...ANNOUNCEMENTS.map(a=>a.id));
      localStorage.setItem('nebulahub-last-announcement', latestId);
      document.getElementById('announcementBadge').style.display = 'none';
    }

    // ----------------------------------------------------------------
    // §5  SOLAR UI — SURVEY PANEL
    // ----------------------------------------------------------------
    function mpOpenSurvey() {
      const iframe = document.getElementById('mpSurveyIframe');
      if (!iframe) return;
      if (SURVEY_URL && SURVEY_URL !== 'https://forms.gle/gsBVKuUB9vhhrRNr9') {
        iframe.src = SURVEY_URL;
      } else {
        iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#9ca3af;text-align:center;padding:40px;background:#020617;"><div><div style="font-size:3rem;margin-bottom:16px;">📋</div><h3 style="color:#e5e7eb;margin-bottom:8px;">No survey configured</h3><p>Edit SURVEY_URL in the script.</p></div></div>';
      }
    }

    // ----------------------------------------------------------------
    // §6  SOLAR UI — CHAT PANEL
    // ----------------------------------------------------------------
    function mpSwitchRoom(btn, room) {
      document.querySelectorAll('.mp-room-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentRoom = room;
      document.getElementById('mpMessages').innerHTML = '';
      if (supabaseClient) { loadMessages(); subscribeToMessages(); }
      // Mirror in main chat
      document.getElementById('currentRoomName').textContent = room;
    }

    async function mpSendMessage() {
      const input = document.getElementById('mpChatInput');
      const content = input.value.trim();
      if (!content || !currentUser) return;
      input.value = '';
      const { error } = await supabaseClient.from('messages').insert({
        chat_id: currentRoom, user_id: currentUser.id,
        display_name: currentUser.display_name, content,
        created_at: new Date().toISOString()
      });
      if (error) console.error('Send error:', error);
    }

    // Override renderMessage to also push to mpMessages
    const _origRenderMessage = window.renderMessage;

    function renderMpMessage(msg, animate = false) {
      const container = document.getElementById('mpMessages');
      if (!container) return;
      const isOwn = msg.user_id === currentUser?.id;
      const div = document.createElement('div');
      div.className = `mp-msg ${isOwn ? 'own' : ''}`;
      const avatarText = (msg.display_name || '?').charAt(0).toUpperCase();
      const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      div.innerHTML = `
        <div class="mp-msg-avatar">${avatarText}</div>
        <div class="mp-msg-bubble">
          <div class="mp-msg-meta">${msg.display_name || 'Anonymous'} · ${time}</div>
          <div class="mp-msg-text">${escapeHtml(msg.content)}</div>
        </div>
      `;
      container.appendChild(div);
      if (animate) container.scrollTop = container.scrollHeight;
    }

    // Patch loadMessages to also populate mpMessages
    const _origLoadMessages = loadMessages;
    async function loadMessages() {
      if (!supabaseClient) return;
      const { data, error } = await supabaseClient.from('messages').select('*').eq('chat_id', currentRoom).order('created_at', {ascending:true}).limit(50);
      if (error) return;
      // Clear both containers
      document.getElementById('chatMessages').innerHTML = '';
      const mpContainer = document.getElementById('mpMessages');
      if (mpContainer) mpContainer.innerHTML = '';
      if (data) {
        data.forEach(msg => {
          renderMessage(msg);
          renderMpMessage(msg);
        });
        document.getElementById('chatMessages').scrollTop = 9999;
        if (mpContainer) mpContainer.scrollTop = 9999;
      }
    }

    // Patch renderMessage to also render in mp panel
    const _baseRenderMessage = renderMessage;
    function renderMessage(msg, animate = false) {
      // Main chat
      const container = document.getElementById('chatMessages');
      if (!container) return;
      const isOwn = msg.user_id === currentUser?.id;
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${isOwn ? 'own' : ''}`;
      if (animate) msgDiv.style.animation = 'slideIn 0.3s ease';
      const avatarText = msg.display_name ? msg.display_name.charAt(0).toUpperCase() : '?';
      const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      msgDiv.innerHTML = `<div class="message-avatar">${avatarText}</div><div class="message-content"><div class="message-header"><span>${msg.display_name||'Anonymous'}</span><span style="opacity:0.6;">${time}</span></div><div class="message-text">${escapeHtml(msg.content)}</div></div>`;
      container.appendChild(msgDiv);
      if (animate) container.scrollTop = container.scrollHeight;
      // Also mirror to mp panel
      if (animate) renderMpMessage(msg, true);
    }

    // Patch initSupabase to update mpChatStatus
    const _origInitSupabase = initSupabase;
    function initSupabase() {
      if (window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        document.getElementById('connectionStatus').textContent = 'Connected';
        const mpStatus = document.getElementById('mpChatStatus');
        if (mpStatus) mpStatus.textContent = '· Connected';
        checkChatUser();
      } else {
        document.getElementById('connectionStatus').textContent = 'Error';
      }
    }

    // ----------------------------------------------------------------
    // §7  SOLAR UI — CUSTOMIZE PANEL
    // ----------------------------------------------------------------
    function mpSyncFromMain() {
      // Sync mp pickers from main customColors
      const mp = {
        mpBrandPicker: customColors.brand,
        mpAccentPicker: customColors.accent,
        mpStrongPicker: customColors.accentStrong
      };
      Object.entries(mp).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      });
      const texts = {
        mpBrandText: customColors.brand,
        mpAccentText: customColors.accent,
        mpStrongText: customColors.accentStrong
      };
      Object.entries(texts).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      });
    }

    function mpSyncColor(pickerId, textId, colorKey) {
      const val = document.getElementById(pickerId).value;
      document.getElementById(textId).value = val;
      customColors[colorKey] = val;
      // Also sync main pickers
      const mainMap = { brand: 'brandColorPicker', accent: 'accentColorPicker', accentStrong: 'accentStrongPicker' };
      const mainPicker = document.getElementById(mainMap[colorKey]);
      if (mainPicker) mainPicker.value = val;
    }

    function mpSyncColorText(pickerId, textId, colorKey) {
      const val = document.getElementById(textId).value;
      document.getElementById(pickerId).value = val;
      customColors[colorKey] = val;
    }

    function mpOpenCustomize() {
      mpSyncFromMain();
    }

    // ----------------------------------------------------------------
    // §8  SOLAR UI — SETTINGS PANEL
    // ----------------------------------------------------------------
    function mpSelectFav(btn, favKey) {
      document.querySelectorAll('.mp-fav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Sync main settings
      document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
      const mainBtn = document.querySelector(`[data-favicon="${favKey}"]`);
      if (mainBtn) mainBtn.classList.add('active');
    }

    function mpApplyCloak() {
      const title = document.getElementById('mpTabTitle').value.trim();
      if (title) {
        document.getElementById('tabTitleInput').value = title;
      }
      applyTabCloak();
      showNotification('🕵️ Cloak applied!');
    }

    function mpSavePanic() {
      const url = document.getElementById('mpPanicUrl').value.trim();
      if (url) {
        document.getElementById('panicUrlInput').value = url;
        panicUrl = url;
        localStorage.setItem('nebulahub-panic-url', url);
        showNotification('💾 Panic URL saved!');
      }
    }

    function mpSetTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('site-theme', theme);
      document.getElementById('themeSelector').value = theme;
      showNotification(`🎨 Theme: ${theme}`);
    }

    // ----------------------------------------------------------------
    // §9  SOLAR UI — DEV PANEL
    // ----------------------------------------------------------------
    function mpRenderFeatures() {
      const container = document.getElementById('mpFeatureList');
      if (!container) return;
      container.innerHTML = devMode.features.map(f => `
        <div class="mp-feature-item">
          <div>
            <div class="mp-feature-name">${f.name}</div>
            <div class="mp-feature-desc">${f.description}</div>
          </div>
          <input type="checkbox" class="mp-toggle" ${f.enabled ? 'checked' : ''} onchange="devMode.toggleFeature('${f.id}');mpRenderFeatures()">
        </div>
      `).join('');
    }

    function mpRenderGameEditor() {
      const container = document.getElementById('mpGameEditorList');
      const count = document.getElementById('mpGameCount');
      if (!container) return;
      if (count) count.textContent = games.length;
      container.innerHTML = games.slice(0, 20).map(g => `
        <div class="mp-game-edit-row">
          <div class="mp-game-edit-thumb">${g.name.slice(0,2).toUpperCase()}</div>
          <div class="mp-game-edit-info">
            <div class="mp-game-edit-name">${g.name}</div>
            <div class="mp-game-edit-cat">${g.category}</div>
          </div>
          <div class="mp-game-edit-btns">
            <button class="mp-icon-btn" onclick="devMode.editGame('${g.id}');mpRenderGameEditor()" title="Edit">✏️</button>
            <button class="mp-icon-btn" onclick="devMode.deleteGame('${g.id}');mpRenderGameEditor()" title="Delete">🗑️</button>
          </div>
        </div>
      `).join('');
    }

    function mpApplyCSS() {
      const css = document.getElementById('mpCssEditor').value;
      devMode.injectCSS(css);
      devMode.customCSS = css;
      document.getElementById('devCssEditor').value = css;
      showNotification('🎨 CSS applied');
    }

    function mpClearCSS() {
      document.getElementById('mpCssEditor').value = '';
      devMode.injectCSS('');
      devMode.customCSS = '';
      document.getElementById('devCssEditor').value = '';
      showNotification('🗑️ CSS cleared');
    }

    function mpExportConfig() {
      const config = { games, customColors, layout: devMode.layout, features: devMode.features, customCSS: devMode.customCSS, exportDate: new Date().toISOString(), version: UPDATE_CONFIG.version };
      const json = JSON.stringify(config, null, 2);
      document.getElementById('mpConfigArea').value = json;
      navigator.clipboard.writeText(json).then(() => showNotification('📋 Copied to clipboard!'));
    }

    // ================================================================
    // §10  DOCK TAB HANDLER
    // Routes dock icon clicks to the correct panel/view depending
    // on which UI is active (Solar UI panels vs Full Hub views)
    // ================================================================
    function openDockTab(tab, dockEl) {
      if (currentUI === 'solar') {
        // Solar UI — open inline full-screen panel
        switch(tab) {
          case 'library':
            openMinimalPanel('mpLibrary', dockEl);
            mpRenderLibrary();
            const mpsi = document.getElementById('mpSearchInput');
            if (mpsi && !mpsi._wired) {
              mpsi.addEventListener('input', mpRenderLibrary);
              mpsi._wired = true;
            }
            break;
          case 'news':
            openMinimalPanel('mpNews', dockEl);
            mpRenderNews();
            break;
          case 'survey':
            openMinimalPanel('mpSurvey', dockEl);
            mpOpenSurvey();
            break;
          case 'chat':
            openMinimalPanel('mpChat', dockEl);
            if (!supabaseClient) initSupabase();
            else { loadMessages(); subscribeToMessages(); }
            break;
          case 'customize':
            openMinimalPanel('mpCustomize', dockEl);
            mpOpenCustomize();
            break;
          case 'settings':
            openMinimalPanel('mpSettings', dockEl);
            document.getElementById('mpPanicUrl').value = panicUrl;
            const saved = localStorage.getItem('nebulahub-cloak-title');
            if (saved) document.getElementById('mpTabTitle').value = saved;
            break;
          case 'player':
            if (mpCurrentGameUrl || (activeGame && activeGame.url)) {
              openMinimalPanel('mpPlayer', dockEl);
            } else {
              showNotification('🎮 Open a game from the library first!');
            }
            break;
          case 'dev':
            if (devMode.isActive) {
              openMinimalPanel('mpDev', dockEl);
              mpRenderFeatures();
              mpRenderGameEditor();
              const savedCSS = localStorage.getItem('nebulahub-dev-css') || devMode.customCSS;
              if (savedCSS) document.getElementById('mpCssEditor').value = savedCSS;
            } else {
              devMode.requestAccess();
            }
            break;
        }
      } else {
        // Full Hub mode — navigate to the view
        switch(tab) {
          case 'library':    showLibraryView(); break;
          case 'news':       showAnnouncementsView(); break;
          case 'survey':     showSurveyView(); break;
          case 'chat':       showChatView(); break;
          case 'customize':  showCustomizeView(); break;
          case 'settings':   showSettingsView(); break;
          case 'player':     if (activeGame) showPlayerView(); break;
          case 'dev':
            if (devMode.isActive) devMode.showDevView();
            else devMode.requestAccess();
            break;
        }
      }
    }

    // ================================================================
    // §11  UI TOGGLE SYSTEM
    // switchUI('solar') → Solar UI  |  switchUI('nebulahub') → Full Hub
    // ================================================================
    let currentUI = 'nebulahub';
    
    function toggleUIDropdown() {
      document.getElementById('uiToggleDropdown').classList.toggle('active');
    }

    function switchUI(mode) {
      currentUI = mode;
      localStorage.setItem('nebulahub-ui-mode', mode);
      
      const nebulaHubUI = document.getElementById('nebulaHubUI');
      const nebulaMinimalUI = document.getElementById('nebulaHubMinimalUI');
      const optionNebulaHub = document.getElementById('optionNebulaHub');
      const optionMinimal = document.getElementById('optionMinimal');
      
      if (mode === 'solar' || mode === 'minimal') {
        currentUI = 'solar'; // normalise to 'solar'
        nebulaHubUI.style.display = 'none';
        nebulaMinimalUI.classList.add('active');
        document.body.style.padding = '0';
        optionNebulaHub.classList.remove('active');
        optionMinimal.classList.add('active');
        startNebulaClock();
        setTimeout(() => document.getElementById('nebulaSearchInput').focus(), 100);
      } else {
        closeAllMinimalPanels();
        nebulaMinimalUI.classList.remove('active');
        nebulaHubUI.style.display = '';
        document.body.style.padding = '20px';
        optionMinimal.classList.remove('active');
        optionNebulaHub.classList.add('active');
        stopNebulaClock();
      }
      
      document.getElementById('uiToggleDropdown').classList.remove('active');
    }

    let nebulaClockInterval;
    function startNebulaClock() {
      updateNebulaTime();
      nebulaClockInterval = setInterval(updateNebulaTime, 1000);
    }
    function stopNebulaClock() {
      if (nebulaClockInterval) clearInterval(nebulaClockInterval);
    }
    function updateNebulaTime() {
      const now = new Date();
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('nebulaTime').textContent = `${h}:${m}`;
    }

    function loadSavedUI() {
      const savedUI = localStorage.getItem('nebulahub-ui-mode');
      if (savedUI === 'solar' || savedUI === 'minimal') switchUI('solar');
    }

    document.addEventListener('click', (e) => {
      const container = document.querySelector('.ui-toggle-container');
      if (container && !container.contains(e.target)) {
        document.getElementById('uiToggleDropdown').classList.remove('active');
      }
    });

    // ================================================================
    // §12  ANNOUNCEMENTS DATA
    // Add objects to the array below to show new announcements.
    // Types: 'normal' | 'important' | 'update'
    // ================================================================
    const ANNOUNCEMENTS = [
      {
        id: 1,
        title: "🎮 Welcome to NebulaHub v2.4!",
        content: "This section will now be a dev log where we will update users on what we are working on and we'll give some sneak peaks as well.",
        date: "Feburary 13, 2026",
        image: null,
        gif: null,
        badge: "NEW",
        type: "update"
      },
      {
        id: 2,
        title: "🛠️ New Solar UI",
        content: "The brand new solar UI is here, we've been working real hard on this one and we are excited to finally release it, all tabs have been remade to fit the theme of the new UI and we will have a community poll on what to do next.",
        date: "February 13, 2026",
        image: null,
        gif: null,
        badge: null,
        type: "important"
      }
    ];

    // ================================================================
    // §13  SURVEY URL
    // Replace this with your Google Form link
    // ================================================================
    const SURVEY_URL = "https://forms.gle/ksnfAHu7X5wwmDgt9";

    // Max announcements shown before "show more"
    const MAX_DISPLAYED_ANNOUNCEMENTS = 5;

    // ================================================================
    // §14  UPDATE MODAL CONFIG
    // Change version + changes[] to show a new update popup
    // ================================================================
    const UPDATE_CONFIG = {
      version: "2.3",
      date: "January 30, 2026",
      title: "🎮 First Game Drop Indie Themed",
      changes: [
        "💻 NEW: Indie Game Drop",
        "🧪 Completed New Experimental Features (releasing next week)",
        "🎮 Quick game manager (for devs)",
        "⚙️ Developer Settings Revamp",
        "💬 NebulaChat integration (experimental)",
        "🎨 Full theme customization",
        "📢 NEW: Announcements tab with image/gif support",
        "📋 NEW: Survey tab for community feedback",
        "⚡ NEW: Solar UI mode - clean launcher interface"
      ],
      showOnce: true
    };

    // ================================================================
    // §15  FAVICONS  (tab-cloak icon presets)
    // Add more keys here and matching buttons in Settings panel HTML
    // ================================================================
    // Favicon Data URIs
    const FAVICONS = {
      default: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="n" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%2322c55e"/><stop offset="50%" stop-color="%238b5cf6"/><stop offset="100%" stop-color="%23030014"/></radialGradient></defs><rect width="100" height="100" rx="22" fill="%23030014"/><circle cx="50" cy="50" r="46" fill="url(%23n)" opacity="0.9"/><ellipse cx="50" cy="50" rx="28" ry="11" fill="none" stroke="%23a78bfa" stroke-width="2.5" opacity="0.7" transform="rotate(-20 50 50)"/><circle cx="50" cy="50" r="7" fill="white" opacity="0.9"/></svg>',
      google: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234285F4"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">G</text></svg>',
      classroom: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%2324a865"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">C</text></svg>',
      docs: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234285F4"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">D</text></svg>',
      slides: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23fbbc04"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">S</text></svg>'
    };

    // ================================================================
    // §16  GAME LIBRARY DATA
    // Each entry: { id, name, category, tags[], url }
    // Categories: 'arcade' | 'horror' | 'fps' | 'sandbox'
    // url can be a relative path or absolute https:// link
    // ================================================================
    let games = [
      { id: "geometry-dash", name: "Geometry Dash Lite", category: "arcade", tags: ["platformer", "rhythm", "gd"], url: "games/Geometry Dash Lite/Geometry Dash Lite.html" },
      { id: "Nautilus OS", name: "NautilusOS", category: "arcade", tags: ["platformer", "rhythm", "gd"], url: "https://frdhhfdhhhsfddsffds.vercel.app/" },
      { id: "buckshot-roulette", name: "Buckshot Roulette", category: "horror", tags: ["casino", "psych-horror"], url: "games/Buckshot Roulette/Buckshot Roulette.html" },
      { id: "minecraft", name: "Minecraft Web", category: "sandbox", tags: ["minecraft", "survival", "blocks"], url: "games/Minecraft/Minecraft 1.21.4.html" },
      { id: "basketball-random", name: "Basketball Random", category: "arcade", tags: ["sports", "2-player", "random"], url: "games/Basketball Random/Basket Random.html" },
      { id: "hollow-knight", name: "Hollow Knight Web", category: "sandbox", tags: ["metroidvania", "platformer", "indie"], url: "games/Hollow Knight/Hollow Knight.html" },
      { id: "ultrakill", name: "ULTRAKILL Web", category: "fps", tags: ["movement", "retro"], url: "games/Ultrakill/ULTRAKILL.html" },
      { id: "half-life", name: "Half-Life Web", category: "fps", tags: ["shooter", "valve", "classic"], url: "games/Half-Life/Half Life.html" },
      { id: "fnaf1", name: "FNAF 1", category: "horror", tags: ["fnaf", "classic"], url: "games/FNAF/Five Nights at Freddy's.html" },
      { id: "fnaf2", name: "FNAF 2", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 2/Five Nights at Freddy's 2.html" },
      { id: "fnaf3", name: "FNAF 3", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 3/Five Nights at Freddy's 3.html" },
      { id: "fnaf4", name: "FNAF 4", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 4/Five Nights at Freddy's 4.html" },
      { id: "fnaf-sl", name: "FNAF Sister Location", category: "horror", tags: ["fnaf", "sl"], url: "games/Five Nights at Freddy's SL/Five Nights at Freddy's_ Sister Location.html" },
      { id: "fnaf-ps", name: "FNAF Pizza Sim", category: "horror", tags: ["fnaf", "tycoon"], url: "games/Five Nights at Freddy's Pizza Sim/Five Nights at Freddy's_ Pizza Simulator.html" },
      { id: "fnaf-ucn", name: "FNAF UCN", category: "horror", tags: ["fnaf", "custom"], url: "games/FNAF UCN/Five Nights at Freddy's_ Ultimate Custom Night.html" },
      { id: "fnaf-world", name: "FNAF World", category: "horror", tags: ["fnaf", "rpg"], url: "games/Five Nights at Freddy's World/Five Nights at Freddy's_ World.html" },
      { id: "robbies-remastered", name: "Robbie's Remastered", category: "horror", tags: ["fnaf", "pc game"], url: "https://serve.gamejolt.net/1b5709b6eaec59282e589eac7043935165f91da53292f2d19d68d1377edceccd,1769840448,7/data/games/13/11/845011/files/674ab887625cb/index.html" },
      { id: "A Bite at Freddy's", name: "A Bite at Freddy's", category: "horror", tags: ["fnaf", "pcgame"], url: "games/A Bite at Freddy's/A Bite at Freddy's.html" },
      { id: "Baldi's Basic", name: "Baldi's Basic", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics.html" },
      { id: "Baldi's Basic Classic Remastered", name: "Baldi's Basic Classic Remastered", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics Classic Remastered.html" },
      { id: "Baldi's Basic Plus", name: "Baldi's Basic Plus", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics Plus.html" },
      { id: "Slope", name: "Slope", category: "arcade", tags: ["fun"], url: "games/Slope/Slope.html" },
      { id: "Terraria", name: "Terraria", category: "arcade", tags: ["fun"], url: "games/Terraria/Terraria.html" },
      { id: "Awesome Tanks 1", name: "Awesome Tanks 1", category: "arcade", tags: ["fun"], url: "games/Awesome Tanks/Awesome Tanks.html" },
      { id: "Awesome Tanks 2", name: "Awesome Tanks 2", category: "arcade", tags: ["fun"], url: "games/Awesome Tanks/Awesome Tanks 2.html" },
      { id: "Ball Blast", name: "Ball Blast", category: "arcade", tags: ["fun"], url: "games/BallBlast/Ball Blast.html" },
      { id: "That's Not My Neighbor", name: "That's Not My Neighbor", category: "arcade", tags: ["fun"], url: "games/That's Not My Neighbor/That's Not My Neighbor.html" },
      { id: "ChatBot", name: "ChatBot", category: "arcade", tags: ["fun"], url: "games/ChatBot/Chat Bot (A._.I).html" },
      { id: "Crazy Cattle", name: "Crazy Cattle", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Cattle 3D.html" },
      { id: "Crazy Chicken", name: "Crazy Chicken", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Chicken 3D.html" },
      { id: "Crazy Kitty", name: "Crazy Kitty", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Kitty 3D.html" },
      { id: "Karlson", name: "Karlson", category: "arcade", tags: ["fun"], url: "games/Karlson/Karlson.html" },
      { id: "People's Playground", name: "People's Playground", category: "arcade", tags: ["fun"], url: "games/People's Playground/People Playground.html" },
      { id: "Midnight Shift", name: "Midnight Shift", category: "arcade", tags: ["fun"], url: "games/Midnight Shift/Midnight Shift.html" },
      { id: "Raft", name: "Raft", category: "arcade", tags: ["fun"], url: "games/Raft/Raft.html" },
      { id: "0V0", name: "0V0", category: "arcade", tags: ["fun"], url: "games/0V0/OvO.html" },
      { id: "Steal a Brainrot", name: "Steal a Brainrot", category: "pc game", tags: ["fun"], url: "games/SAB/Steal Brainrot Online.html" },
      { id: "Geometry Dash Wave 3d", name: "Geometry Dash Wave 3d", category: "arcade", tags: ["arcade"], url: "https://www.gamenora.com/embed/geometry-dash-wave-original" }
    ];

    // elements
    const gameGrid = document.getElementById("gameGrid");
    const emptyState = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const filterChips = document.querySelectorAll(".filter-chip");
    const statGames = document.getElementById("statGames");
    const resultCountLabel = document.getElementById("resultCountLabel");

    const libraryView = document.getElementById("libraryView");
    const playerView = document.getElementById("playerView");
    const customizeView = document.getElementById("customizeView");
    const settingsView = document.getElementById("settingsView");
    const chatView = document.getElementById("chatView");
    const devView = document.getElementById("devView");
    const announcementsView = document.getElementById("announcementsView");
    const surveyView = document.getElementById("surveyView");
    const viewLibraryBtn = document.getElementById("viewLibraryBtn");
    const viewPlayerBtn = document.getElementById("viewPlayerBtn");
    const viewCustomizeBtn = document.getElementById("viewCustomizeBtn");
    const viewSettingsBtn = document.getElementById("viewSettingsBtn");
    const viewChatBtn = document.getElementById("viewChatBtn");
    const viewDevBtn = document.getElementById("viewDevBtn");
    const viewAnnouncementsBtn = document.getElementById("viewAnnouncementsBtn");
    const viewSurveyBtn = document.getElementById("viewSurveyBtn");
    const playerGameName = document.getElementById("playerGameName");
    const playerGameMeta = document.getElementById("playerGameMeta");
    const playerIframe = document.getElementById("playerIframe");
    const backToLibraryBtn = document.getElementById("backToLibraryBtn");
    const openInNewTabBtn = document.getElementById("openInNewTabBtn");
    const portalLink = document.getElementById("portalLink");
    const yearSpan = document.getElementById("yearSpan");
    const sidebarZone = document.getElementById("sidebarZone");
    const libraryZone = document.getElementById("libraryZone");

    // ================================================================
    // §17  CORE STATE VARIABLES
    // ================================================================
    let activeCategory = "all";
    let activeSearch = "";
    let activeGame = null;
    let panicUrl = localStorage.getItem('nebulahub-panic-url') || "https://clever.com/in/dallasisd/student/portal";

    // ================================================================
    // §18  ANNOUNCEMENTS SYSTEM
    // ================================================================
    function renderAnnouncements() {
      const container = document.getElementById('announcementsView');
      const badge = document.getElementById('announcementBadge');
      
      if (ANNOUNCEMENTS.length === 0) {
        container.innerHTML = `<div class="announcement-empty"><div class="announcement-empty-icon">📭</div><strong>No announcements yet</strong><p style="margin-top:8px;opacity:0.7;">Check back later for updates!</p></div>`;
        return;
      }
      
      const sorted = [...ANNOUNCEMENTS].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, MAX_DISPLAYED_ANNOUNCEMENTS);
      
      container.innerHTML = sorted.map(ann => `
        <div class="announcement-card ${ann.type || 'normal'}">
          ${ann.badge ? `<div class="announcement-badge">${ann.badge}</div>` : ''}
          <div class="announcement-title">${ann.title}</div>
          <div class="announcement-date">${ann.date}</div>
          ${ann.image ? `<img src="${ann.image}" class="announcement-image" alt="Announcement Image">` : ''}
          ${ann.gif ? `<img src="${ann.gif}" class="announcement-gif" alt="Announcement GIF">` : ''}
          <div class="announcement-content">${ann.content.replace(/\n/g, '<br>')}</div>
        </div>
      `).join('');
      
      const lastSeen = parseInt(localStorage.getItem('nebulahub-last-announcement') || '0');
      const latestId = Math.max(...ANNOUNCEMENTS.map(a => a.id));
      if (latestId > lastSeen) {
        badge.style.display = 'inline-flex';
        badge.textContent = ANNOUNCEMENTS.filter(a => a.id > lastSeen).length || 'NEW';
      }
    }

    function showAnnouncementsView() {
      hideAllViews();
      announcementsView.style.display = 'flex';
      viewAnnouncementsBtn.classList.add('active');
      const latestId = Math.max(...ANNOUNCEMENTS.map(a => a.id));
      localStorage.setItem('nebulahub-last-announcement', latestId);
      document.getElementById('announcementBadge').style.display = 'none';
    }

    // ================================================================
    // §19  SURVEY SYSTEM
    // ================================================================
    function showSurveyView() {
      hideAllViews();
      surveyView.style.display = 'flex';
      viewSurveyBtn.classList.add('active');
      
      if (SURVEY_URL && SURVEY_URL !== "https://forms.gle/gsBVKuUB9vhhrRNr9") {
        document.getElementById('surveyFrame').src = SURVEY_URL;
      } else {
        const container = document.querySelector('.survey-frame-container');
        container.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-soft);text-align:center;padding:40px;"><div style="font-size:3rem;margin-bottom:20px;">📋</div><h3 style="margin-bottom:12px;color:var(--text);">Survey Not Configured</h3><p>Edit the SURVEY_URL constant at the top of the JavaScript.</p></div>`;
      }
    }

    function hideAllViews() {
      [libraryView, customizeView, settingsView, chatView, playerView, devView, announcementsView, surveyView].forEach(v => v.style.display = 'none');
      [viewLibraryBtn, viewPlayerBtn, viewCustomizeBtn, viewSettingsBtn, viewChatBtn, viewDevBtn, viewAnnouncementsBtn, viewSurveyBtn].forEach(b => b.classList.remove('active'));
    }

    // ================================================================
    // §20  DEVELOPER MODE SYSTEM
    // Password is stored in devMode.password below
    // ================================================================
    const devMode = {
      password: "Ponchis721",
      isActive: false,
      features: [],
      layout: { sidebar: true, library: true, order: ['sidebar', 'library'] },
      customCSS: '',

      init() {
        this.loadState();
        this.initLayoutEditor();
        this.registerDefaultFeatures();
        this.renderGameList();
        if (this.customCSS) { this.injectCSS(this.customCSS); document.getElementById('devCssEditor').value = this.customCSS; }
        if (sessionStorage.getItem('dev-mode-active') === 'true') this.activate();
      },

      requestAccess() { document.getElementById('devAuthModal').classList.add('show'); setTimeout(() => document.getElementById('devPasswordInput').focus(), 100); },

      authenticate() {
        const input = document.getElementById('devPasswordInput');
        if (input.value === this.password) {
          this.activate(); this.closeAuth(); input.value = '';
          showNotification('🔓 Developer mode activated!');
        } else {
          input.style.borderColor = '#ef4444'; input.value = ''; input.placeholder = 'Incorrect password';
          setTimeout(() => { input.style.borderColor = ''; input.placeholder = '••••••••'; }, 1500);
        }
      },

      closeAuth() { document.getElementById('devAuthModal').classList.remove('show'); },

      activate() {
        this.isActive = true;
        document.body.classList.add('dev-active', 'dev-mode-active');
        sessionStorage.setItem('dev-mode-active', 'true');
        // If in minimal mode, open the dev panel; otherwise show the full dev view
        if (currentUI === 'solar') {
          openMinimalPanel('mpDev', null);
          setTimeout(() => { mpRenderFeatures(); mpRenderGameEditor(); }, 50);
        } else {
          this.showDevView();
        }
      },

      lock() {
        this.isActive = false;
        document.body.classList.remove('dev-active', 'dev-mode-active');
        sessionStorage.removeItem('dev-mode-active');
        showLibraryView();
        showNotification('🔒 Developer mode locked');
      },

      showDevView() {
        hideAllViews();
        devView.style.display = 'flex';
        viewDevBtn.classList.add('active');
        this.renderFeatures();
        this.renderGameList();
      },

      initLayoutEditor() {
        const container = document.getElementById('layoutPreview');
        if (window.Sortable) {
          new Sortable(container, {
            animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', handle: '.layout-zone',
            onEnd: (evt) => {
              const zones = container.querySelectorAll('.layout-zone');
              this.layout.order = Array.from(zones).map(z => z.dataset.zone);
            }
          });
        }
      },

      toggleZone(zone) {
        this.layout[zone] = !this.layout[zone];
        const toggle = document.querySelector(`[data-zone="${zone}"] .zone-toggle`);
        toggle.classList.toggle('active');
        const el = zone === 'sidebar' ? sidebarZone : libraryZone;
        el.style.opacity = this.layout[zone] ? '1' : '0.3';
      },

      saveLayout() { localStorage.setItem('nebulahub-dev-layout', JSON.stringify(this.layout)); showNotification('💾 Layout saved!'); },

      resetLayout() {
        this.layout = { sidebar: true, library: true, order: ['sidebar', 'library'] };
        document.querySelectorAll('.zone-toggle').forEach(t => t.classList.add('active'));
        sidebarZone.style.opacity = '1'; libraryZone.style.opacity = '1';
        this.saveLayout(); showNotification('↩ Layout reset');
      },

      registerFeature(id, name, description, defaultState = false, callback = null) {
        const feature = { id, name, description, enabled: defaultState, callback, beta: true };
        this.features.push(feature);
        if (this.isActive) this.renderFeatures();
        return feature;
      },

      registerDefaultFeatures() {
        this.registerFeature('particles', 'Enhanced Particles', 'Add floating particle effects to the background', false, (e) => { if(e) document.body.style.setProperty('--particle-count', '100'); else document.body.style.removeProperty('--particle-count'); });
        this.registerFeature('debug', 'Debug Mode', 'Show debug information in console', false, (e) => { window.DEBUG = e; });
        this.registerFeature('compact', 'Compact Mode', 'Reduce padding and margins for dense view', false, (e) => { document.body.classList.toggle('compact-mode', e); });
        this.registerFeature('animations', 'Reduced Motion', 'Disable animations for accessibility', false, (e) => { document.body.classList.toggle('reduce-motion', e); });
      },

      renderFeatures() {
        document.getElementById('featureList').innerHTML = this.features.map(f => `
          <div class="feature-item">
            <div class="feature-info">
              <div class="feature-name">${f.name}${f.beta ? '<span class="feature-beta">Beta</span>' : ''}</div>
              <div class="feature-desc">${f.description}</div>
            </div>
            <input type="checkbox" class="feature-toggle" ${f.enabled ? 'checked' : ''} onchange="devMode.toggleFeature('${f.id}')">
          </div>
        `).join('');
      },

      toggleFeature(id) {
        const f = this.features.find(f => f.id === id);
        if (f) { f.enabled = !f.enabled; if (f.callback) f.callback(f.enabled); this.saveState(); }
      },

      applyCSS() { const css = document.getElementById('devCssEditor').value; this.injectCSS(css); this.customCSS = css; showNotification('🎨 CSS applied'); },

      injectCSS(css) {
        let style = document.getElementById('dev-custom-css');
        if (!style) { style = document.createElement('style'); style.id = 'dev-custom-css'; document.head.appendChild(style); }
        style.textContent = css;
      },

      clearCSS() { document.getElementById('devCssEditor').value = ''; this.injectCSS(''); this.customCSS = ''; showNotification('🗑️ CSS cleared'); },
      saveCSS() { localStorage.setItem('nebulahub-dev-css', document.getElementById('devCssEditor').value); showNotification('💾 CSS saved'); },

      renderGameList() {
        const container = document.getElementById('devGameList');
        document.getElementById('devGameCount').textContent = games.length;
        container.innerHTML = games.map(g => `
          <div class="game-edit-item">
            <div class="game-edit-thumb">${g.name.slice(0,2).toUpperCase()}</div>
            <div class="game-edit-info">
              <div class="game-edit-name">${g.name}</div>
              <div class="game-edit-cat">${g.category}</div>
            </div>
            <div class="game-edit-actions">
              <button class="icon-btn" onclick="devMode.editGame('${g.id}')" title="Edit">✏️</button>
              <button class="icon-btn" onclick="devMode.deleteGame('${g.id}')" title="Delete">🗑️</button>
            </div>
          </div>
        `).join('');
      },

      deleteGame(id) { if (confirm('Delete this game?')) { games = games.filter(g => g.id !== id); renderGrid(); this.renderGameList(); this.saveState(); } },

      showAddGameModal() {
        const name = prompt('Game Name:'); if (!name) return;
        const category = prompt('Category (arcade/horror/fps/sandbox):', 'arcade') || 'arcade';
        const url = prompt('Game URL:'); if (!url) return;
        games.push({ id: 'custom-' + Date.now(), name, category: category.toLowerCase(), tags: ['custom'], url });
        renderGrid(); this.renderGameList(); this.saveState(); showNotification('🎮 Game added!');
      },

      editGame(id) {
        const game = games.find(g => g.id === id); if (!game) return;
        const newName = prompt('Game Name:', game.name); if (newName) game.name = newName;
        const newUrl = prompt('Game URL:', game.url); if (newUrl) game.url = newUrl;
        renderGrid(); this.renderGameList(); this.saveState();
      },

      exportConfig() {
        const config = { games, customColors, layout: this.layout, features: this.features, customCSS: this.customCSS, exportDate: new Date().toISOString(), version: UPDATE_CONFIG.version };
        const json = JSON.stringify(config, null, 2);
        document.getElementById('devConfigExport').value = json;
        navigator.clipboard.writeText(json).then(() => showNotification('📋 Config copied to clipboard!'));
      },

      importConfig() {
        const json = prompt('Paste configuration JSON:'); if (!json) return;
        try {
          const config = JSON.parse(json);
          if (config.games) { games = config.games; renderGrid(); this.renderGameList(); }
          if (config.customColors) { Object.assign(customColors, config.customColors); syncColorInputs(); applyCustomColors(); }
          if (config.customCSS) { this.customCSS = config.customCSS; document.getElementById('devCssEditor').value = config.customCSS; this.injectCSS(config.customCSS); }
          this.saveState(); showNotification('📥 Config imported successfully!');
        } catch(e) { alert('Invalid JSON configuration'); }
      },

      resetAll() {
        if (confirm('⚠️ WARNING: This will reset ALL developer settings. Continue?')) {
          localStorage.removeItem('nebulahub-dev-state');
          localStorage.removeItem('nebulahub-dev-layout');
          localStorage.removeItem('nebulahub-dev-css');
          location.reload();
        }
      },

      saveState() { localStorage.setItem('nebulahub-dev-state', JSON.stringify({ layout: this.layout, features: this.features, customCSS: this.customCSS })); },

      loadState() {
        const saved = localStorage.getItem('nebulahub-dev-state');
        if (saved) { try { const s = JSON.parse(saved); if (s.layout) this.layout = s.layout; if (s.features) this.features = s.features; if (s.customCSS) this.customCSS = s.customCSS; } catch(e) {} }
      }
    };

    function showNotification(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--custom-accent-color);color:white;padding:12px 24px;border-radius:999px;font-weight:600;font-size:0.9rem;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:9999;animation:slideUp 0.3s ease;`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    viewDevBtn.addEventListener('click', () => {
      if (devMode.isActive) devMode.showDevView();
      else devMode.requestAccess();
    });

    viewAnnouncementsBtn.addEventListener('click', showAnnouncementsView);
    viewSurveyBtn.addEventListener('click', showSurveyView);

    // ================================================================
    // §21  CUSTOMIZATION SYSTEM
    // Edit defaultColors below to change the default color scheme
    // ================================================================
    const customColors = {
      brand: '#22c55e', accent: '#8b5cf6', accentStrong: '#22c55e',
      bgGrad1: '#1f2937', bgGrad2: '#111827',
      overlay1: 'rgba(59,130,246,0.35)', overlay2: 'rgba(236,72,153,0.3)',
      chatSent: '#8b5cf6', chatBg: '#0c1024'
    };

    function syncColorInputs() {
      document.getElementById('brandColorPicker').value = customColors.brand;
      document.getElementById('brandColorText').value = customColors.brand;
      document.getElementById('accentColorPicker').value = customColors.accent;
      document.getElementById('accentColorText').value = customColors.accent;
      document.getElementById('accentStrongPicker').value = customColors.accentStrong;
      document.getElementById('accentStrongText').value = customColors.accentStrong;
      document.getElementById('bgGrad1Picker').value = customColors.bgGrad1;
      document.getElementById('bgGrad1Text').value = customColors.bgGrad1;
      document.getElementById('bgGrad2Picker').value = customColors.bgGrad2;
      document.getElementById('bgGrad2Text').value = customColors.bgGrad2;
      const hex1 = rgbToHex(customColors.overlay1) || '#3b82f6';
      const hex2 = rgbToHex(customColors.overlay2) || '#ec4899';
      document.getElementById('overlay1Picker').value = hex1;
      document.getElementById('overlay1Text').value = customColors.overlay1;
      document.getElementById('overlay2Picker').value = hex2;
      document.getElementById('overlay2Text').value = customColors.overlay2;
      document.getElementById('chatSentPicker').value = customColors.chatSent;
      document.getElementById('chatSentText').value = customColors.chatSent;
      document.getElementById('chatBgPicker').value = customColors.chatBg;
      document.getElementById('chatBgText').value = customColors.chatBg;
    }

    function rgbToHex(rgba) {
      if (!rgba || !rgba.includes('rgb')) return null;
      const parts = rgba.match(/\d+/g);
      if (!parts || parts.length < 3) return null;
      return "#" + ((1 << 24) + (parseInt(parts[0]) << 16) + (parseInt(parts[1]) << 8) + parseInt(parts[2])).toString(16).slice(1);
    }

    function hexToRgba(hex, alpha = 0.35) {
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function applyCustomColors() {
      const root = document.documentElement;
      root.style.setProperty('--custom-brand-color', customColors.brand);
      root.style.setProperty('--custom-accent-color', customColors.accent);
      root.style.setProperty('--custom-accent-strong', customColors.accentStrong);
      root.style.setProperty('--custom-bg-grad-1', customColors.bgGrad1);
      root.style.setProperty('--custom-bg-grad-2', customColors.bgGrad2);
      root.style.setProperty('--custom-overlay-1', customColors.overlay1);
      root.style.setProperty('--custom-overlay-2', customColors.overlay2);
      root.style.setProperty('--custom-chat-sent', customColors.chatSent);
      root.style.setProperty('--custom-chat-bg', customColors.chatBg);
      document.getElementById('customActiveNotice').classList.add('show');
      updateChatPreview();
    }

    function saveCustomTheme() {
      localStorage.setItem('nebulahub-custom-theme', JSON.stringify(customColors));
      localStorage.setItem('nebulahub-theme-type', 'custom');
      document.getElementById('themeSelector').value = 'nebula';
      alert('Theme saved! Your custom colors will persist across sessions.');
    }

    function resetCustomTheme() {
      Object.assign(customColors, { brand:'#22c55e', accent:'#8b5cf6', accentStrong:'#22c55e', bgGrad1:'#1f2937', bgGrad2:'#111827', overlay1:'rgba(59,130,246,0.35)', overlay2:'rgba(236,72,153,0.3)', chatSent:'#8b5cf6', chatBg:'#0c1024' });
      syncColorInputs(); applyCustomColors();
      localStorage.removeItem('nebulahub-custom-theme');
      localStorage.removeItem('nebulahub-theme-type');
      document.getElementById('customActiveNotice').classList.remove('show');
    }

    function previewTheme() { applyCustomColors(); }

    function applyPreset(name) {
      const presets = {
        ocean: { brand:'#0ea5e9', accent:'#0284c7', accentStrong:'#38bdf8', bgGrad1:'#0c4a6e', bgGrad2:'#082f49', overlay1:'rgba(14,165,233,0.4)', overlay2:'rgba(56,189,248,0.3)', chatSent:'#0ea5e9', chatBg:'#082f49' },
        sunset: { brand:'#f97316', accent:'#ea580c', accentStrong:'#fb923c', bgGrad1:'#7c2d12', bgGrad2:'#431407', overlay1:'rgba(249,115,22,0.4)', overlay2:'rgba(236,72,153,0.3)', chatSent:'#f97316', chatBg:'#431407' },
        forest: { brand:'#22c55e', accent:'#16a34a', accentStrong:'#4ade80', bgGrad1:'#14532d', bgGrad2:'#052e16', overlay1:'rgba(34,197,94,0.4)', overlay2:'rgba(101,163,13,0.3)', chatSent:'#22c55e', chatBg:'#052e16' },
        crimson: { brand:'#ef4444', accent:'#dc2626', accentStrong:'#f87171', bgGrad1:'#7f1d1d', bgGrad2:'#450a0a', overlay1:'rgba(239,68,68,0.4)', overlay2:'rgba(249,115,22,0.3)', chatSent:'#ef4444', chatBg:'#450a0a' },
        gold: { brand:'#eab308', accent:'#ca8a04', accentStrong:'#facc15', bgGrad1:'#713f12', bgGrad2:'#422006', overlay1:'rgba(234,179,8,0.4)', overlay2:'rgba(251,191,36,0.3)', chatSent:'#eab308', chatBg:'#422006' },
        purple: { brand:'#a855f7', accent:'#9333ea', accentStrong:'#c084fc', bgGrad1:'#581c87', bgGrad2:'#3b0764', overlay1:'rgba(168,85,247,0.4)', overlay2:'rgba(192,132,252,0.3)', chatSent:'#a855f7', chatBg:'#3b0764' }
      };
      if (presets[name]) { Object.assign(customColors, presets[name]); syncColorInputs(); applyCustomColors(); }
    }

    function updateChatPreview() {
      const box = document.getElementById('chatPreviewBox');
      if (box) {
        box.style.background = customColors.chatBg;
        const sent = box.querySelector('.sent');
        if (sent) sent.style.background = customColors.chatSent;
      }
    }

    ['brand', 'accent', 'accentStrong'].forEach(key => {
      const picker = document.getElementById(key + 'ColorPicker');
      const text = document.getElementById(key + 'ColorText');
      if (picker) picker.addEventListener('input', (e) => { customColors[key] = e.target.value; if (text) text.value = e.target.value; });
      if (text) text.addEventListener('change', (e) => { customColors[key] = e.target.value; if (picker) picker.value = e.target.value; });
    });

    ['bgGrad1', 'bgGrad2'].forEach(key => {
      const picker = document.getElementById(key + 'Picker');
      const text = document.getElementById(key + 'Text');
      if (picker) picker.addEventListener('input', (e) => { customColors[key] = e.target.value; if (text) text.value = e.target.value; });
    });

    document.getElementById('overlay1Picker').addEventListener('input', (e) => { customColors.overlay1 = hexToRgba(e.target.value, 0.35); document.getElementById('overlay1Text').value = customColors.overlay1; });
    document.getElementById('overlay2Picker').addEventListener('input', (e) => { customColors.overlay2 = hexToRgba(e.target.value, 0.3); document.getElementById('overlay2Text').value = customColors.overlay2; });
    document.getElementById('chatSentPicker').addEventListener('input', (e) => { customColors.chatSent = e.target.value; document.getElementById('chatSentText').value = e.target.value; document.documentElement.style.setProperty('--custom-chat-sent', e.target.value); updateChatPreview(); });
    document.getElementById('chatBgPicker').addEventListener('input', (e) => { customColors.chatBg = e.target.value; document.getElementById('chatBgText').value = e.target.value; document.documentElement.style.setProperty('--custom-chat-bg', e.target.value); updateChatPreview(); });

    // ================================================================
    // §22  TAB CLOAKING SYSTEM
    // ================================================================
    document.querySelectorAll('.favicon-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    function applyTabCloak() {
      const title = document.getElementById('tabTitleInput').value.trim();
      const faviconType = document.querySelector('.favicon-btn.active').dataset.favicon;
      if (title) { document.title = title; localStorage.setItem('nebulahub-cloak-title', title); }
      let link = document.querySelector("link[rel*='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
      link.href = FAVICONS[faviconType];
      localStorage.setItem('nebulahub-cloak-favicon', faviconType);
      const btn = document.querySelector('button[onclick="applyTabCloak()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '✅ Applied!';
      setTimeout(() => { btn.innerHTML = originalText; }, 1500);
    }

    function resetTabCloak() {
      document.title = 'NEBULAHUB';
      document.getElementById('tabTitleInput').value = '';
      // Restore the NebulaHub favicon
      let link = document.querySelector("link[rel*='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
      link.href = FAVICONS.default;
      document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-favicon="default"]').classList.add('active');
      localStorage.removeItem('nebulahub-cloak-title');
      localStorage.removeItem('nebulahub-cloak-favicon');
    }

    function savePanicUrl() {
      const url = document.getElementById('panicUrlInput').value.trim();
      if (url) { panicUrl = url; localStorage.setItem('nebulahub-panic-url', url); alert('Panic button URL saved!'); }
    }

    function loadTabCloak() {
      const savedTitle = localStorage.getItem('nebulahub-cloak-title');
      const savedFavicon = localStorage.getItem('nebulahub-cloak-favicon');
      if (savedTitle) { document.title = savedTitle; document.getElementById('tabTitleInput').value = savedTitle; }
      if (savedFavicon && FAVICONS[savedFavicon]) {
        let link = document.querySelector("link[rel*='icon']");
        if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
        link.href = FAVICONS[savedFavicon];
        document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`[data-favicon="${savedFavicon}"]`);
        if (btn) btn.classList.add('active');
      }
    }

    // ================================================================
    // §23  UPDATE MODAL
    // ================================================================
    function showUpdateModal() {
      const lastSeen = localStorage.getItem('nebulahub-update-seen');
      const savedVersion = localStorage.getItem('nebulahub-update-version');
      if (UPDATE_CONFIG.showOnce && savedVersion === UPDATE_CONFIG.version && lastSeen === 'true') return;
      document.getElementById('updateTitle').textContent = UPDATE_CONFIG.title;
      document.getElementById('updateDate').textContent = UPDATE_CONFIG.date;
      document.getElementById('updateList').innerHTML = UPDATE_CONFIG.changes.map(c => `<li>${c}</li>`).join('');
      document.getElementById('updateModal').classList.add('show');
    }

    function closeUpdateModal() {
      const dontShow = document.getElementById('dontShowAgain').checked;
      if (dontShow && UPDATE_CONFIG.showOnce) { localStorage.setItem('nebulahub-update-seen', 'true'); localStorage.setItem('nebulahub-update-version', UPDATE_CONFIG.version); }
      document.getElementById('updateModal').classList.remove('show');
    }

    // ================================================================
    // §24  CORE FUNCTIONS
    // renderGrid, showView helpers, theme switching, panic button
    // ================================================================
    function renderGrid() {
      const query = activeSearch.trim().toLowerCase();
      const filtered = games.filter(game => {
        const matchesCategory = activeCategory === "all" || game.category === activeCategory;
        const haystack = (game.name + " " + (game.tags || []).join(" ")).toLowerCase();
        return matchesCategory && (query === "" || haystack.includes(query));
      });

      gameGrid.innerHTML = "";
      if (filtered.length === 0) {
        emptyState.style.display = "block";
      } else {
        emptyState.style.display = "none";
        filtered.forEach(game => {
          const card = document.createElement("article");
          card.className = "game-card";
          const initials = game.name.split(" ").map(w => w[0]?.toUpperCase() || "").join("").slice(0, 3);
          card.innerHTML = `
            <div class="game-thumb"><span>${initials}</span></div>
            <div class="game-name" title="${game.name}">${game.name}</div>
            <div class="game-meta">
              <span>${(game.category || "game").toUpperCase()}</span>
              <span class="game-tag">${(game.tags && game.tags[0]) ? game.tags[0] : "game"}</span>
            </div>
          `;
          card.addEventListener("click", () => openGame(game));
          gameGrid.appendChild(card);
        });
      }

      statGames.textContent = games.length;
      resultCountLabel.textContent = filtered.length + " RESULT" + (filtered.length === 1 ? "" : "S");
    }

    function openGame(game) {
      activeGame = game;
      playerGameName.textContent = game.name;
      playerGameMeta.textContent = (game.category || "game").toUpperCase() + " • Embedded player";
      playerIframe.src = game.url;
      showPlayerView();
    }

    function showPlayerView() { hideAllViews(); playerView.style.display = "flex"; viewPlayerBtn.classList.add("active"); viewPlayerBtn.disabled = false; }
    function showLibraryView() { playerIframe.src = ""; hideAllViews(); libraryView.style.display = "block"; viewLibraryBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showCustomizeView() { playerIframe.src = ""; hideAllViews(); customizeView.style.display = "flex"; viewCustomizeBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showSettingsView() { playerIframe.src = ""; hideAllViews(); settingsView.style.display = "flex"; viewSettingsBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showChatView() { playerIframe.src = ""; hideAllViews(); chatView.style.display = "flex"; viewChatBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; if (!supabaseClient) initSupabase(); }

    searchInput.addEventListener("input", () => {
      activeSearch = searchInput.value;
      clearSearchBtn.style.display = activeSearch.trim().length > 0 ? "block" : "none";
      renderGrid();
    });

    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = ""; activeSearch = ""; clearSearchBtn.style.display = "none"; searchInput.focus(); renderGrid();
    });

    filterChips.forEach(chip => {
      chip.addEventListener("click", () => {
        filterChips.forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        activeCategory = chip.dataset.category || "all";
        renderGrid();
      });
    });

    viewLibraryBtn.addEventListener("click", showLibraryView);
    viewPlayerBtn.addEventListener("click", () => { if (activeGame) showPlayerView(); });
    viewCustomizeBtn.addEventListener("click", showCustomizeView);
    viewSettingsBtn.addEventListener("click", showSettingsView);
    viewChatBtn.addEventListener("click", showChatView);
    backToLibraryBtn.addEventListener("click", showLibraryView);
    openInNewTabBtn.addEventListener("click", () => { if (activeGame && activeGame.url) window.open(activeGame.url, "_blank"); });
    portalLink.addEventListener("click", () => { location.hash = (location.hash === "#portal") ? "" : "#portal"; location.reload(); });

    const themeSelector = document.getElementById("themeSelector");
    const savedTheme = localStorage.getItem("site-theme") || "nebula";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeSelector.value = savedTheme;

    themeSelector.addEventListener("change", () => {
      const newTheme = themeSelector.value;
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("site-theme", newTheme);
      localStorage.removeItem('nebulahub-theme-type');
      document.getElementById('customActiveNotice').classList.remove('show');
    });

    function panicHide() { window.location.href = panicUrl; }

    function loadSavedCustomTheme() {
      const saved = localStorage.getItem('nebulahub-custom-theme');
      const themeType = localStorage.getItem('nebulahub-theme-type');
      if (saved && themeType === 'custom') {
        try { const parsed = JSON.parse(saved); Object.assign(customColors, parsed); syncColorInputs(); applyCustomColors(); document.getElementById('customActiveNotice').classList.add('show'); } catch(e) {}
      }
    }

    // ================================================================
    // §25  NEBULACHAT SYSTEM
    // Supabase credentials are in SUPABASE_CONFIG below
    // ================================================================
    const SUPABASE_CONFIG = {
      url: 'https://eatwwxzrnsyxuzkfckal.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdHd3eHpybnN5eHV6a2Zja2FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjM0MjgsImV4cCI6MjA3OTQ5OTQyOH0.UZoqLR93nMHoK_zQAEndaSntx9F05CXLEKMNGDyi9qc'
    };

    let supabaseClient = null;
    let currentUser = null;
    let currentRoom = 'general';
    let chatSubscription = null;

    function initSupabase() {
      if (window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        document.getElementById('connectionStatus').textContent = 'Connected';
        checkChatUser();
      } else {
        document.getElementById('connectionStatus').textContent = 'Error';
      }
    }

    function checkChatUser() {
      const saved = localStorage.getItem('nebulahub-chat-user');
      if (saved) { currentUser = JSON.parse(saved); document.getElementById('usernameModal').classList.remove('show'); loadMessages(); subscribeToMessages(); }
      else { document.getElementById('usernameModal').classList.add('show'); }
    }

    function saveChatUser() {
      const username = document.getElementById('usernameInput').value.trim();
      if (!username || username.length < 2) { alert('Please enter a username (2+ characters)'); return; }
      currentUser = { username, display_name: username, id: crypto.randomUUID(), joined_at: new Date().toISOString() };
      localStorage.setItem('nebulahub-chat-user', JSON.stringify(currentUser));
      document.getElementById('usernameModal').classList.remove('show');
      supabaseClient.from('profiles').upsert({ id: currentUser.id, username: currentUser.username, display_name: currentUser.display_name, avatar_url: null });
      loadMessages(); subscribeToMessages();
    }

    async function loadMessages() {
      const { data, error } = await supabaseClient.from('messages').select('*').eq('chat_id', currentRoom).order('created_at', { ascending: true }).limit(50);
      if (error) { console.error('Error loading messages:', error); return; }
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';
      if (data) { data.forEach(msg => renderMessage(msg)); scrollToBottom(); }
    }

    function subscribeToMessages() {
      if (chatSubscription) chatSubscription.unsubscribe();
      chatSubscription = supabaseClient.channel(`room:${currentRoom}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentRoom}` }, payload => { renderMessage(payload.new, true); }).subscribe();
    }

    function renderMessage(msg, animate = false) {
      const container = document.getElementById('chatMessages');
      const isOwn = msg.user_id === currentUser?.id;
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${isOwn ? 'own' : ''}`;
      if (animate) msgDiv.style.animation = 'slideIn 0.3s ease';
      const avatarText = msg.display_name ? msg.display_name.charAt(0).toUpperCase() : '?';
      const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      msgDiv.innerHTML = `<div class="message-avatar">${avatarText}</div><div class="message-content"><div class="message-header"><span>${msg.display_name || 'Anonymous'}</span><span style="opacity:0.6;">${time}</span></div><div class="message-text">${escapeHtml(msg.content)}</div></div>`;
      container.appendChild(msgDiv);
      if (animate) scrollToBottom();
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();
      if (!content || !currentUser) return;
      input.value = '';
      const { error } = await supabaseClient.from('messages').insert({ chat_id: currentRoom, user_id: currentUser.id, display_name: currentUser.display_name, content, created_at: new Date().toISOString() });
      if (error) { console.error('Error sending message:', error); alert('Failed to send message'); }
    }

    function scrollToBottom() { const c = document.getElementById('chatMessages'); c.scrollTop = c.scrollHeight; }
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    document.querySelectorAll('.chat-room-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chat-room-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRoom = btn.dataset.room;
        document.getElementById('currentRoomName').textContent = currentRoom;
        loadMessages(); subscribeToMessages();
      });
    });

    // ================================================================
    // §26  INIT — Event Listeners & Bootstrap
    // ================================================================
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    document.getElementById('devPasswordInput').addEventListener('keypress', e => { if (e.key === 'Enter') devMode.authenticate(); });

    document.addEventListener("DOMContentLoaded", () => {
      if (location.hash === "#portal") document.body.classList.add("portal-mode");
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();
      loadSavedCustomTheme();
      loadTabCloak();
      loadSavedUI();
      devMode.init();
      renderAnnouncements();
      const savedPanic = localStorage.getItem('nebulahub-panic-url');
      if (savedPanic) { panicUrl = savedPanic; document.getElementById('panicUrlInput').value = savedPanic; }
      renderGrid();
      setTimeout(showUpdateModal, 1000);
    });
  </script>
</body>
</html>
