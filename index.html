<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NEBULAHUB</title>

  <!-- NebulaHub SVG Favicon - unique nebula/galaxy logo -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='nebula' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%2322c55e'/%3E%3Cstop offset='40%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%23030014'/%3E%3C/radialGradient%3E%3CradialGradient id='glow' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='0.9'/%3E%3Cstop offset='100%25' stop-color='%23ffffff' stop-opacity='0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='%23030014'/%3E%3Ccircle cx='50' cy='50' r='46' fill='url(%23nebula)' opacity='0.9'/%3E%3Cellipse cx='50' cy='50' rx='28' ry='12' fill='none' stroke='%23a78bfa' stroke-width='2.5' opacity='0.7' transform='rotate(-20 50 50)'/%3E%3Cellipse cx='50' cy='50' rx='38' ry='16' fill='none' stroke='%2322c55e' stroke-width='1.5' opacity='0.5' transform='rotate(15 50 50)'/%3E%3Ccircle cx='50' cy='50' r='7' fill='url(%23glow)'/%3E%3Ccircle cx='50' cy='50' r='4' fill='white' opacity='0.95'/%3E%3Ccircle cx='30' cy='32' r='1.5' fill='white' opacity='0.8'/%3E%3Ccircle cx='70' cy='28' r='1' fill='white' opacity='0.7'/%3E%3Ccircle cx='72' cy='68' r='1.5' fill='%2322c55e' opacity='0.9'/%3E%3Ccircle cx='25' cy='65' r='1' fill='%23a78bfa' opacity='0.8'/%3E%3Ccircle cx='62' cy='22' r='1' fill='white' opacity='0.6'/%3E%3C/svg%3E">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-886SN3349C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-886SN3349C');
  </script>

  <!-- AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8989843364629092" crossorigin="anonymous"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- SortableJS for drag-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ============================================================
       NEBULAHUB — STYLESHEET
       ============================================================
       TABLE OF CONTENTS
       ----------------------------------------------------------
       1.  CSS VARIABLES & ROOT
       2.  BASE / RESET / BODY
       3.  LAYOUT — APP SHELL & SIDEBAR
       4.  LIBRARY — GAME GRID & CARDS
       5.  PLAYER VIEW
       6.  DEVELOPER MODE
       7.  UPDATE MODAL
       8.  PORTAL MODE
       9.  THEMES
       10. NEBULACHAT
       11. ANNOUNCEMENTS & SURVEY
       12. SOLAR UI — BRAND & SEARCH BAR
       13. SOLAR UI — BOTTOM DOCK
       14. SOLAR UI — FULL-SCREEN PANELS
       15. UI TOGGLE DROPDOWN
       ============================================================ */

    /* ============================================================
       1. CSS VARIABLES & ROOT
       ============================================================ */
    :root {
      --bg: #030014;
      --bg-elevated: #06051c;
      --bg-soft: #0c1024;
      --accent: #8b5cf6;
      --accent-soft: rgba(139, 92, 246, 0.25);
      --accent-strong: #22c55e;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.6);
      --transition-fast: 0.15s ease-out;
      
      /* Custom user overrides */
      --custom-brand-color: #22c55e;
      --custom-accent-color: #8b5cf6;
      --custom-accent-strong: #22c55e;
      --custom-bg-grad-1: #1f2937;
      --custom-bg-grad-2: #111827;
      --custom-overlay-1: rgba(59,130,246,0.35);
      --custom-overlay-2: rgba(236,72,153,0.3);
      --custom-chat-sent: #8b5cf6;
      --custom-chat-bg: #0c1024;
      /* New customization variables */
      --custom-radius: 18px;
      --custom-glass: 18px;
      --custom-card-opacity: 0.97;
      --custom-font: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    /* ============================================================
       2. BASE / RESET / BODY
       ============================================================ */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--custom-font);
      background:
        radial-gradient(circle at top left, var(--custom-bg-grad-1) 0, transparent 55%),
        radial-gradient(circle at bottom right, var(--custom-bg-grad-2) 0, transparent 55%),
        radial-gradient(circle at top right, var(--custom-overlay-1), transparent 60%),
        radial-gradient(circle at bottom left, var(--custom-overlay-2), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.55;
      mix-blend-mode: screen;
      z-index: -2;
    }

    body::before {
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.8) 0, transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 30%, rgba(244,244,245,0.7) 0, transparent 55%),
        radial-gradient(2px 2px at 50% 80%, rgba(248,250,252,0.7) 0, transparent 60%),
        radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,0.4) 0, transparent 55%);
      animation: driftStars 38s linear infinite;
    }

    body::after {
      background-image:
        radial-gradient(circle at 20% 0%, rgba(59,130,246,0.45), transparent 60%),
        radial-gradient(circle at 80% 100%, rgba(236,72,153,0.45), transparent 60%);
      filter: blur(8px);
      z-index: -3;
      opacity: 0.8;
    }

    @keyframes driftStars {
      0% { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-40px, -60px, 0); }
    }

    /* ============================================================
       3. LAYOUT — APP SHELL & SIDEBAR
       ============================================================ */
    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, rgba(129,140,248,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(236,72,153,0.16), transparent 55%),
                  linear-gradient(145deg, rgba(15,23,42,0.97), rgba(3,7,18,0.98));
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(129,140,248,0.4);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      backdrop-filter: blur(18px) saturate(1.2);
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand { display:flex; align-items:center; gap:10px; }

    .brand-logo {
      width: 38px; height: 38px; border-radius: 14px;
      background: conic-gradient(from 200deg, var(--custom-accent-color), var(--custom-accent-strong), #ec4899, #0ea5e9, var(--custom-accent-color));
      padding: 2px;
      box-shadow: 0 0 20px rgba(129,140,248,0.8);
    }

    .brand-logo-inner {
      width: 100%; height: 100%; border-radius: 12px;
      background:
        radial-gradient(circle at 30% 20%, var(--custom-brand-color), #040018 65%),
        radial-gradient(circle at 80% 80%, rgba(96,165,250,0.65), transparent 60%);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:1.1rem; color:#e5e7eb; letter-spacing:0.08em;
    }

    .brand-text-main {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .brand-text-main span:nth-child(2) { color: var(--custom-accent-strong); font-weight: 800; }
    .brand-sub { font-size: 0.78rem; color: var(--text-soft); }

    .pill {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--custom-accent-strong);
      box-shadow: 0 0 10px rgba(34,197,94,0.8);
    }

    .toolbar {
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
    }

    .search-wrapper { flex:1 1 220px; position:relative; max-width:420px; }

    .search-input {
      width:100%;
      padding:10px 34px 10px 32px;
      background: rgba(15,23,42,0.95);
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      color:var(--text);
      outline:none;
      font-size:0.9rem;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    .search-input::placeholder { color:#6b7280; }

    .search-input:focus {
      border-color: var(--custom-accent-color);
      box-shadow: 0 0 0 1px rgba(139,92,246,0.75), 0 0 24px rgba(59,130,246,0.45);
      background: rgba(15,23,42,0.98);
      transform: translateY(-1px);
    }

    .search-icon {
      position:absolute; left:10px; top:50%;
      transform:translateY(-50%);
      font-size:0.9rem; color:#6b7280; pointer-events:none;
    }

    .clear-search {
      position:absolute; right:10px; top:50%;
      transform:translateY(-50%);
      border:none; background:transparent;
      color:#6b7280; cursor:pointer;
      font-size:0.8rem; padding:0;
      display:none;
    }

    .filters {
      display:flex; flex-wrap:wrap;
      gap:8px; justify-content:flex-end;
    }

    .filter-chip {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.96);
      padding:6px 11px;
      font-size:0.78rem;
      color:var(--text-soft);
      cursor:pointer;
      transition: background var(--transition-fast), border var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
      display:inline-flex; align-items:center; gap:6px;
    }

    .filter-chip span.dot {
      width:8px; height:8px; border-radius:999px;
      background: rgba(148,163,184,0.8);
    }

    .filter-chip.active {
      background: var(--accent-soft);
      border-color: var(--custom-accent-color);
      color:#e5e7eb;
      transform: translateY(-1px);
    }

    .filter-chip.active span.dot {
      background: var(--custom-accent-strong);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .content {
      margin-top: 4px;
      display:grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap:14px;
      transition: all 0.3s ease;
    }

    .content.dev-mode-layout {
      border: 2px dashed var(--custom-accent-color);
      padding: 10px;
      border-radius: 16px;
    }

    @media (max-width: 850px) {
      .content { grid-template-columns: minmax(0,1fr); }
    }

    .sidebar {
      background: radial-gradient(circle at top left, rgba(51,65,85,0.5), transparent 60%), var(--bg-elevated);
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.35);
      padding:13px 13px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition: all 0.3s ease;
    }

    .sidebar.dragging {
      opacity: 0.5;
      border-color: var(--custom-accent-strong);
      transform: scale(0.98);
    }

    .dev-drag-handle {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background: var(--custom-accent-color);
      border-radius: 6px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: grab;
      font-size: 14px;
      z-index: 10;
    }

    body.dev-mode-active .dev-drag-handle { display: flex; }
    body.dev-mode-active .sidebar,
    body.dev-mode-active .library { position: relative; }
    body.dev-mode-active .sidebar:hover .dev-drag-handle,
    body.dev-mode-active .library:hover .dev-drag-handle { opacity: 1; }

    .sidebar-title {
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-soft);
      margin-bottom:4px;
    }

    .sidebar-card {
      background: var(--bg-soft);
      border-radius:16px;
      padding:10px 11px;
      border:1px solid rgba(148,163,184,0.28);
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .sidebar-card-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }

    .badge {
      font-size:0.72rem;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(34,197,94,0.16);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.6);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .sidebar-card-title { font-size:0.9rem; font-weight:600; }
    .sidebar-card-text { font-size:0.78rem; color:var(--text-soft); line-height:1.45; }

    .hint-list {
      font-size:0.75rem;
      color:var(--text-soft);
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:4px;
    }

    .hint-list span { opacity:0.95; }

    .stat-row {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:0.78rem;
      margin-top:6px;
      color:var(--text-soft);
    }

    .stat-row strong { font-size:0.9rem; color:#e5e7eb; }

    .small-link {
      font-size:0.75rem;
      color:#93c5fd;
      text-decoration:none;
      margin-top:4px;
      align-self:flex-start;
    }

    .small-link:hover { text-decoration:underline; }

    .library {
      background: radial-gradient(circle at top right, rgba(79,70,229,0.24), transparent 60%), var(--bg-elevated);
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.3);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:260px;
      position: relative;
      transition: all 0.3s ease;
    }

    .library.dragging {
      opacity: 0.5;
      border-color: var(--custom-accent-strong);
      transform: scale(0.98);
    }

    .library-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .library-title {
      font-size:0.97rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .library-title span.count {
      font-size:0.75rem;
      color:var(--text-soft);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    .view-toggle { display:flex; gap:6px; font-size:0.75rem; flex-wrap: wrap; }

    .view-btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      padding:4px 9px;
      color:var(--text-soft);
      cursor:pointer;
      transition: background var(--transition-fast), border var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .view-btn.active {
      background: rgba(15,23,42,0.9);
      border-color: var(--custom-accent-color);
      color:#e5e7eb;
      transform: translateY(-1px);
    }

    .view-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .view-btn.dev-btn {
      background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(245,158,11,0.2));
      border-color: rgba(239,68,68,0.5);
      color: #fca5a5;
      font-weight: 600;
    }

    .view-btn.dev-btn:hover {
      background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(245,158,11,0.3));
      border-color: rgba(239,68,68,0.8);
      transform: translateY(-1px) scale(1.05);
    }

    .view-btn .btn-badge {
      background: #ef4444;
      color: white;
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 999px;
      margin-left: 4px;
      font-weight: 700;
      animation: pulse 2s infinite;
    }

    .library-body {
      margin-top:2px;
      border-radius:18px;
      background: rgba(15,23,42,0.7);
      border:1px solid rgba(30,64,175,0.5);
      padding:10px;
      flex: 1;
    }

    /* ============================================================
       4. LIBRARY — GAME GRID & CARDS
       ============================================================ */
    .game-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap:10px;
    }

    @media (max-width:600px) {
      .game-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
    }

    .game-card {
      background: radial-gradient(circle at top left, rgba(22,163,74,0.32), transparent 58%),
                  linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.85));
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.45);
      padding:8px 9px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast), background var(--transition-fast);
      position:relative;
      overflow:hidden;
    }

    .game-card::before {
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at top, rgba(129,140,248,0.45), transparent 60%);
      opacity:0;
      transition: opacity var(--transition-fast);
      pointer-events:none;
    }

    .game-card:hover::before { opacity:0.65; }

    .game-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(15,23,42,0.9);
      border-color: rgba(129,140,248,0.9);
    }

    .game-thumb {
      height:80px;
      border-radius:11px;
      background:
        radial-gradient(circle at 30% 20%, var(--custom-brand-color), #0b1020),
        radial-gradient(circle at 80% 90%, rgba(56,189,248,0.9), transparent 60%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#e5e7eb;
      position:relative;
      overflow:hidden;
    }

    .game-thumb span {
      position:relative;
      z-index:1;
      font-weight:700;
      letter-spacing:0.12em;
      font-size:0.9rem;
      text-transform:uppercase;
    }

    .game-thumb::after {
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at bottom right, rgba(56,189,248,0.6), transparent 60%);
      mix-blend-mode: screen;
      opacity:0.7;
    }

    .game-name {
      font-size:0.88rem;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .game-meta {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:0.75rem;
      color:var(--text-soft);
    }

    .game-tag {
      font-size:0.7rem;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(37,99,235,0.25);
      border:1px solid rgba(129,140,248,0.7);
    }

    .empty-state {
      padding:24px 10px;
      text-align:center;
      font-size:0.85rem;
      color:var(--text-soft);
    }

    .empty-state strong { color:#e5e7eb; }

    /* ============================================================
       4b. APP LIBRARY — Grid & Cards
       ============================================================ */
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px;
      padding: 4px 2px;
    }
    @media (max-width: 640px) { .app-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } }

    .app-card {
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: var(--custom-radius, 16px);
      padding: 18px 14px;
      cursor: pointer;
      transition: all 0.18s ease-out;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      text-align: center; position: relative; overflow: hidden;
      backdrop-filter: blur(var(--custom-glass, 18px));
    }
    .app-card::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      opacity: 0; transition: opacity 0.18s;
    }
    .app-card:hover::before { opacity: 0.08; }
    .app-card:hover { border-color: rgba(139,92,246,0.45); transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,0.35); }

    .app-icon {
      width: 56px; height: 56px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.7rem; flex-shrink: 0; position: relative; z-index: 1;
    }
    .app-name { font-size: 0.82rem; font-weight: 700; color: var(--text); position: relative; z-index: 1; line-height: 1.25; }
    .app-desc { font-size: 0.7rem; color: var(--text-soft); position: relative; z-index: 1; }
    .app-tag {
      display: inline-flex; align-items: center;
      padding: 2px 8px; border-radius: 999px;
      font-size: 0.64rem; font-weight: 600;
      background: rgba(139,92,246,0.18); color: #c4b5fd;
      border: 1px solid rgba(139,92,246,0.25);
      position: relative; z-index: 1;
    }

    /* App library filter chips re-use .filter-chip styles */
    .app-category-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }

    /* Solar UI app panel mp-app-grid */
    .mp-app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px; padding: 4px 2px;
    }
    .mp-app-card {
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 14px; padding: 14px 10px;
      cursor: pointer; transition: all 0.15s;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      text-align: center;
    }
    .mp-app-card:hover { border-color: var(--custom-accent-color); background: rgba(139,92,246,0.08); transform: translateY(-2px); }
    .mp-app-card .app-icon { width: 46px; height: 46px; font-size: 1.4rem; border-radius: 12px; }
    .mp-app-card .app-name { font-size: 0.78rem; font-weight: 700; }

    /* Customization extras */
    .customize-range-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .customize-range-group label { font-size: 0.78rem; color: var(--text-soft); display: flex; justify-content: space-between; }
    .customize-range-group input[type="range"] { width: 100%; accent-color: var(--custom-accent-color); }
    .font-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
    .font-btn {
      padding: 10px 8px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.6); color: var(--text-soft);
      cursor: pointer; font-size: 0.82rem; transition: all 0.15s; text-align: center;
    }
    .font-btn:hover, .font-btn.active { border-color: var(--custom-accent-color); color: var(--text); background: var(--accent-soft); }
    .starfield-toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
    .toggle-switch { position: relative; width: 44px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: rgba(148,163,184,0.2); border-radius: 999px; cursor: pointer; transition: .3s; border: 1px solid rgba(148,163,184,0.3); }
    .toggle-slider::before { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background: white; bottom: 2px; left: 2px; transition: .3s; }
    .toggle-switch input:checked + .toggle-slider { background: var(--custom-accent-color); border-color: var(--custom-accent-color); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

    /* ============================================================
       5. PLAYER VIEW
       ============================================================ */
    .player-view { display:none; flex-direction:column; gap:8px; }

    .player-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .player-title {
      font-size:0.93rem;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .player-title span.main { font-weight:600; }
    .player-title span.sub { font-size:0.76rem; color:var(--text-soft); }

    .btn {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.96);
      padding:6px 11px;
      font-size:0.78rem;
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: background var(--transition-fast), border var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      background: rgba(30,64,175,0.9);
      border-color: rgba(129,140,248,0.95);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.8);
    }

    .btn-ghost { background: rgba(15,23,42,0.9); }

    .player-frame {
      margin-top:2px;
      border-radius:18px;
      border:1px solid rgba(30,64,175,0.6);
      overflow:hidden;
      background:#020617;
      height: 80vh;
      max-height: 800px;
    }

    .player-frame iframe {
      width:100%;
      height:100%;
      border:none;
      display:block;
      background:#020617;
    }

    footer {
      margin-top:6px;
      font-size:0.7rem;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:4px;
      flex-wrap:wrap;
    }

    footer a { color:#93c5fd; text-decoration:none; }
    footer a:hover { text-decoration:underline; }

    footer .portal-link {
      cursor:pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    /* ============================================================
       6. DEVELOPER MODE
       ============================================================ */
    .dev-view {
      display: none;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.3s ease;
    }

    .dev-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .dev-card {
      background: var(--bg-soft);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(148,163,184,0.28);
      position: relative;
      overflow: hidden;
    }

    .dev-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ef4444, #f97316, #eab308);
    }

    .dev-card h3 {
      font-size: 1rem;
      margin-bottom: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .dev-badge {
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .dev-section { margin-bottom: 20px; }
    .dev-section:last-child { margin-bottom: 0; }

    .dev-label {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 8px;
      display: block;
      font-weight: 500;
    }

    .layout-preview {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 16px;
      border: 2px dashed rgba(148,163,184,0.3);
      min-height: 200px;
    }

    .layout-zone {
      background: rgba(139,92,246,0.1);
      border: 2px solid rgba(139,92,246,0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: move;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .layout-zone:hover {
      background: rgba(139,92,246,0.2);
      border-color: rgba(139,92,246,0.5);
      transform: translateX(4px);
    }

    .layout-zone.sortable-ghost { opacity: 0.4; background: rgba(139,92,246,0.3); }
    .layout-zone.sortable-drag { cursor: grabbing; background: rgba(139,92,246,0.4); transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    .zone-icon { width: 32px; height: 32px; background: var(--custom-accent-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .zone-info { flex: 1; }
    .zone-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .zone-desc { font-size: 0.75rem; color: var(--text-soft); }

    .zone-toggle {
      width: 40px; height: 22px;
      background: rgba(148,163,184,0.3);
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .zone-toggle.active { background: var(--custom-accent-strong); }
    .zone-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: transform 0.2s; }
    .zone-toggle.active::after { transform: translateX(18px); }

    .feature-list { display: flex; flex-direction: column; gap: 10px; }

    .feature-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(15,23,42,0.6);
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      transition: all 0.15s ease;
    }

    .feature-item:hover { background: rgba(15,23,42,0.8); border-color: rgba(148,163,184,0.4); transform: translateX(2px); }
    .feature-info { display: flex; flex-direction: column; gap: 2px; }
    .feature-name { font-weight: 600; font-size: 0.85rem; color: var(--text); display: flex; align-items: center; gap: 6px; }
    .feature-beta { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; text-transform: uppercase; }
    .feature-desc { font-size: 0.75rem; color: var(--text-soft); }

    .feature-toggle {
      appearance: none;
      width: 44px; height: 24px;
      background: rgba(148,163,184,0.3);
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: background 0.2s;
    }

    .feature-toggle:checked { background: var(--custom-accent-strong); }
    .feature-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .feature-toggle:checked::after { transform: translateX(20px); }

    .css-editor {
      width: 100%;
      min-height: 120px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 12px;
      color: #a5f3fc;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      resize: vertical;
      tab-size: 2;
    }

    .css-editor:focus { outline: none; border-color: var(--custom-accent-color); box-shadow: 0 0 0 2px var(--accent-soft); }

    .dev-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    .btn-danger { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); color: #fca5a5; }
    .btn-danger:hover { background: rgba(239,68,68,0.4); border-color: rgba(239,68,68,0.8); }
    .btn-success { background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.5); color: #bbf7d0; }
    .btn-success:hover { background: rgba(34,197,94,0.4); border-color: rgba(34,197,94,0.8); }
    .btn-warning { background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.5); color: #fde68a; }

    .dev-auth-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .dev-auth-modal.show { display: flex; }

    .dev-auth-card {
      background: var(--bg-elevated);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 24px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      text-align: center;
    }

    .dev-auth-card h2 { margin-bottom: 8px; font-size: 1.5rem; background: linear-gradient(135deg, #ef4444, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .dev-auth-card p { color: var(--text-soft); margin-bottom: 24px; font-size: 0.9rem; }

    .password-input-group { position: relative; margin-bottom: 20px; }
    .password-input-group input {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-soft);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: all 0.15s ease;
      text-align: center;
      letter-spacing: 0.1em;
    }
    .password-input-group input:focus { border-color: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.2); }

    .dev-access-indicator {
      position: fixed;
      bottom: 20px; right: 20px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(239,68,68,0.4);
      z-index: 1000;
      animation: pulse 2s infinite;
      cursor: pointer;
    }

    body.dev-active .dev-access-indicator { display: flex; }

    .game-list-editor { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

    .game-edit-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(15,23,42,0.6); border-radius: 8px; border: 1px solid rgba(148,163,184,0.2); }
    .game-edit-thumb { width: 40px; height: 40px; background: var(--custom-accent-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
    .game-edit-info { flex: 1; min-width: 0; }
    .game-edit-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-edit-cat { font-size: 0.75rem; color: var(--text-soft); }
    .game-edit-actions { display: flex; gap: 4px; }

    .icon-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.8); color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.15s; }
    .icon-btn:hover { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); transform: scale(1.1); }

    .add-game-btn {
      width: 100%; padding: 12px;
      border: 2px dashed rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.4);
      color: var(--text-soft);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .add-game-btn:hover { border-color: var(--custom-accent-color); color: var(--text); background: rgba(139,92,246,0.1); }

    .config-textarea { width: 100%; min-height: 100px; background: rgba(0,0,0,0.5); border: 1px solid rgba(148,163,184,0.3); border-radius: 8px; padding: 12px; color: #a5f3fc; font-family: monospace; font-size: 0.75rem; word-break: break-all; resize: vertical; }

    .customize-view {
      display: none;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .customize-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }

    .customize-card { background: var(--bg-soft); border-radius: 16px; padding: 16px; border: 1px solid rgba(148,163,184,0.28); }
    .customize-card h3 { font-size: 0.9rem; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 8px; }

    .color-input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .color-input-group label { font-size: 0.78rem; color: var(--text-soft); display: flex; justify-content: space-between; align-items: center; }

    .color-picker-wrapper { display: flex; align-items: center; gap: 10px; }
    .color-picker-wrapper input[type="color"] { width: 50px; height: 36px; border: none; border-radius: 8px; cursor: pointer; background: none; }
    .color-picker-wrapper input[type="text"] { flex: 1; padding: 6px 10px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 8px; color: var(--text); font-size: 0.8rem; font-family: monospace; }

    .customize-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    .btn-primary { background: var(--custom-accent-color); border-color: var(--custom-accent-color); color: white; }
    .btn-primary:hover { background: var(--custom-accent-strong); border-color: var(--custom-accent-strong); }
    .btn-secondary { background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.4); }

    .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .preset-btn { padding: 8px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.6); color: var(--text-soft); cursor: pointer; font-size: 0.75rem; transition: all 0.15s ease; }
    .preset-btn:hover { border-color: var(--custom-accent-color); color: var(--text); }

    .settings-view { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s ease; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .settings-card { background: var(--bg-soft); border-radius: 16px; padding: 20px; border: 1px solid rgba(148,163,184,0.28); }
    .settings-card h3 { font-size: 1rem; margin-bottom: 6px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .settings-desc { font-size: 0.8rem; color: var(--text-soft); margin-bottom: 16px; }

    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-soft); margin-bottom: 8px; font-weight: 500; }
    .input-group input[type="text"] { width: 100%; padding: 10px 14px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 10px; color: var(--text); font-size: 0.9rem; transition: all 0.15s ease; }
    .input-group input[type="text"]:focus { outline: none; border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }

    .favicon-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .favicon-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 12px; border: 2px solid transparent; background: rgba(15,23,42,0.6); cursor: pointer; transition: all 0.15s ease; }
    .favicon-btn:hover { background: rgba(15,23,42,0.9); transform: translateY(-2px); }
    .favicon-btn.active { border-color: var(--custom-accent-color); background: var(--accent-soft); }
    .favicon-preview { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .favicon-preview.default { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .favicon-preview.google { background: #4285F4; }
    .favicon-preview.classroom { background: linear-gradient(135deg, #24a865, #1e8a53); }
    .favicon-preview.docs { background: #4285F4; }
    .favicon-preview.slides { background: #fbbc04; }
    .favicon-btn span:last-child { font-size: 0.75rem; color: var(--text-soft); }
    .favicon-btn.active span:last-child { color: var(--text); font-weight: 600; }

    /* ============================================================
       7. UPDATE MODAL
       ============================================================ */
    .update-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .update-modal.show { display: flex; }

    .update-card {
      background: var(--bg-elevated);
      border-radius: 24px;
      border: 1px solid var(--accent-soft);
      max-width: 480px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      animation: slideUp 0.3s ease;
      color: var(--text);
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .update-header {
      background: linear-gradient(135deg, rgba(129,140,248,0.1), transparent 60%);
      padding: 24px 24px 16px;
      border-bottom: 1px solid rgba(148,163,184,0.2);
      border-radius: 24px 24px 0 0;
    }

    .update-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .update-date { font-size: 0.8rem; color: var(--text-soft); }
    .update-body { padding: 20px 24px; background: var(--bg-elevated); }

    .update-list { list-style: none; display: flex; flex-direction: column; gap: 10px; margin: 0; padding: 0; }
    .update-list li { font-size: 0.9rem; color: var(--text); padding-left: 24px; position: relative; line-height: 1.5; }
    .update-list li::before { content: "→"; position: absolute; left: 0; color: var(--custom-accent-strong); font-weight: bold; font-size: 1.1rem; }

    .update-footer {
      padding: 16px 24px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border-top: 1px solid rgba(148,163,184,0.2);
      background: var(--bg-elevated);
      border-radius: 0 0 24px 24px;
    }

    .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-soft); cursor: pointer; }
    .checkbox-label input[type="checkbox"] { accent-color: var(--custom-accent-color); width: 16px; height: 16px; cursor: pointer; }

    /* ============================================================
       8. PORTAL MODE
       ============================================================ */
    body.portal-mode { background:#f9fafb; color:#111827; }
    body.portal-mode::before, body.portal-mode::after { display:none; }
    body.portal-mode .app-shell { background:#fff; border-radius:0; border:1px solid #e5e7eb; box-shadow:none; }
    body.portal-mode .sidebar, body.portal-mode .library { background:#fff; border-color:#e5e7eb; }
    body.portal-mode .game-card { background:#f9fafb; box-shadow:none; border-color:#e5e7eb; }
    body.portal-mode .game-thumb { background:#e5e7eb; }
    body.portal-mode .brand-logo { box-shadow:none; }
    body.portal-mode .brand-logo-inner { background:#f3f4f6; color:#111827; }
    body.portal-mode .brand-text-main span:nth-child(2) { color:#111827; }
    body.portal-mode .search-input, body.portal-mode .view-btn, body.portal-mode .filter-chip, body.portal-mode .btn { background:#f9fafb; border-color:#e5e7eb; color:#374151; box-shadow:none; }
    body.portal-mode .search-input:focus { box-shadow:none; border-color:#9ca3af; }
    body.portal-mode .customize-card, body.portal-mode .settings-card, body.portal-mode .dev-card { background: #f9fafb; border-color: #e5e7eb; }
    body.portal-mode .color-picker-wrapper input[type="text"], body.portal-mode .input-group input[type="text"], body.portal-mode .css-editor, body.portal-mode .config-textarea { background: #ffffff; border-color: #e5e7eb; color: #111827; }
    body.portal-mode .preset-btn, body.portal-mode .favicon-btn { background: #ffffff; border-color: #e5e7eb; color: #374151; }
    body.portal-mode .favicon-btn.active { background: rgba(99,102,241,0.1); border-color: #4f46e5; }
    body.portal-mode .feature-item, body.portal-mode .game-edit-item { background: #ffffff; border-color: #e5e7eb; }

    /* ============================================================
       9. THEMES
       (data-theme attribute on <html> — options: nebula / midnight / bubblegum / matrix / minecraft)
       ============================================================ */
    :root[data-theme="nebula"] { --bg: #050816; --bg-elevated: #0b1020; --bg-soft: #11182a; --accent: #4f46e5; --accent-soft: rgba(79, 70, 229, 0.25); --accent-strong: #22c55e; --text: #e5e7eb; --text-soft: #9ca3af; }
    :root[data-theme="midnight"] { --bg: #010409; --bg-elevated: #0d1117; --bg-soft: #161b22; --accent: #58a6ff; --accent-soft: rgba(88,166,255,0.23); --accent-strong: #238636; --text: #c9d1d9; --text-soft: #8b949e; }
    :root[data-theme="bubblegum"] { --bg: #ffe4f1; --bg-elevated: #ffd6ec; --bg-soft: #ffcae6; --accent: #ff4fa3; --accent-soft: rgba(255, 79, 163, 0.23); --accent-strong: #ff1e80; --text: #3a0035; --text-soft: #5f1a50; }
    :root[data-theme="matrix"] { --bg: #000000; --bg-elevated: #020402; --bg-soft: #001100; --accent: #00ff41; --accent-soft: rgba(0,255,65,0.15); --accent-strong: #00ff41; --text: #d9ffd9; --text-soft: #71ff8e; }
    :root[data-theme="minecraft"] { --bg: #0b2e0b; --bg-elevated: #0f3d0f; --bg-soft: #145214; --accent: #3c8527; --accent-soft: rgba(60,133,39,0.25); --accent-strong: #8b5a2b; --text: #d6f5d6; --text-soft: #a4c9a4; }

    .panic-btn { background:#ef4444; border:1px solid #f87171; color:white; font-weight:600; border-radius:12px; padding:6px 12px; cursor:pointer; transition:0.15s ease; }
    .panic-btn:hover { background:#dc2626; border-color:#fca5a5; }

    .legal-footer { margin-top: 10px; font-size: 0.75rem; color: #9ca3af; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .legal-footer a { color:#93c5fd; text-decoration:none; }
    .legal-footer a:hover { text-decoration:underline; }

    .theme-active-notice { font-size: 0.75rem; color: var(--custom-accent-strong); margin-top: 8px; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 8px; border: 1px solid rgba(34,197,94,0.3); display: none; }
    .theme-active-notice.show { display: block; }
    body.portal-mode .theme-active-notice { background: rgba(34,197,94,0.05); color: #059669; border-color: rgba(34,197,94,0.2); }

    /* ============================================================
       10. NEBULACHAT
       ============================================================ */
    .chat-view { display: none; flex-direction: column; gap: 16px; animation: fadeIn 0.3s ease; height: 70vh; min-height: 500px; }

    .chat-container { display: grid; grid-template-columns: 260px 1fr; height: 100%; background: var(--bg-elevated); border-radius: 22px; border: 1px solid rgba(148,163,184,0.3); overflow: hidden; }

    .chat-sidebar { background: var(--custom-chat-bg, var(--bg-soft)); border-right: 1px solid rgba(148,163,184,0.2); padding: 16px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }

    .chat-room-btn { width: 100%; padding: 12px; background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; color: var(--text); cursor: pointer; text-align: left; transition: all 0.15s ease; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
    .chat-room-btn:hover, .chat-room-btn.active { background: var(--accent-soft); border-color: var(--custom-accent-color); transform: translateX(4px); }
    .chat-room-btn .room-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; }

    /* ---- Chat sidebar sections ---- */
    .chat-section-label { font-size: 0.68rem; font-weight: 700; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.1em; padding: 10px 4px 4px; display: flex; align-items: center; justify-content: space-between; }
    .chat-section-label button { width: 18px; height: 18px; border-radius: 4px; border: none; background: rgba(148,163,184,0.2); color: var(--text-soft); cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .chat-section-label button:hover { background: var(--accent-soft); color: var(--text); }

    /* ---- DM / group items in sidebar ---- */
    .chat-conv-btn { width: 100%; padding: 9px 10px; background: transparent; border: 1px solid transparent; border-radius: 10px; color: var(--text); cursor: pointer; text-align: left; transition: all 0.15s; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; position: relative; }
    .chat-conv-btn:hover { background: rgba(148,163,184,0.08); border-color: rgba(148,163,184,0.15); }
    .chat-conv-btn.active { background: var(--accent-soft); border-color: var(--custom-accent-color); }
    .chat-conv-avatar { width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: white; overflow: hidden; }
    .chat-conv-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-conv-avatar.group { border-radius: 10px; }
    .chat-conv-info { flex: 1; min-width: 0; }
    .chat-conv-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-conv-sub { font-size: 0.72rem; color: var(--text-soft); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-unread { min-width: 18px; height: 18px; border-radius: 999px; background: var(--custom-accent-color); color: white; font-size: 0.65rem; font-weight: 700; display: flex; align-items: center; justify-content: center; padding: 0 4px; }

    /* ---- Friends panel (full-screen solar panel style) ---- */
    .friends-panel { position: fixed; inset: 0; bottom: 88px; background: rgba(3,0,20,0.98); backdrop-filter: blur(28px); z-index: 200; display: none; flex-direction: column; animation: panelIn 0.2s ease-out; }
    .friends-panel.show { display: flex; }
    .friends-layout { display: grid; grid-template-columns: 280px 1fr; flex: 1; overflow: hidden; }
    @media (max-width: 700px) { .friends-layout { grid-template-columns: 1fr; } }
    .friends-sidebar { border-right: 1px solid rgba(148,163,184,0.15); display: flex; flex-direction: column; overflow: hidden; }
    .friends-list { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 4px; }
    .friend-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
    .friend-item:hover { background: rgba(148,163,184,0.08); border-color: rgba(148,163,184,0.15); }
    .friend-item.active { background: var(--accent-soft); border-color: var(--custom-accent-color); }
    .friend-avatar { width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: white; overflow: hidden; position: relative; }
    .friend-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .friend-status-dot { position: absolute; bottom: 1px; right: 1px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(3,0,20,0.98); background: #6b7280; }
    .friend-status-dot.online { background: #22c55e; }
    .friend-status-dot.idle { background: #f59e0b; }
    .friend-info { flex: 1; min-width: 0; }
    .friend-name { font-weight: 600; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .friend-sub { font-size: 0.72rem; color: var(--text-soft); }
    .friend-actions { display: flex; gap: 4px; }
    .friend-action-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.25); background: rgba(15,23,42,0.7); color: var(--text-soft); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: all 0.15s; }
    .friend-action-btn:hover { background: var(--accent-soft); border-color: var(--custom-accent-color); color: var(--text); }
    .friend-action-btn.danger:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #fca5a5; }

    /* friend request items */
    .friend-req-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(139,92,246,0.07); border: 1px solid rgba(139,92,246,0.2); margin-bottom: 6px; }
    .req-btns { display: flex; gap: 4px; margin-left: auto; }
    .req-btn { padding: 4px 10px; border-radius: 8px; font-size: 0.72rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.15s; }
    .req-btn.accept { background: rgba(34,197,94,0.2); color: #bbf7d0; border: 1px solid rgba(34,197,94,0.4); }
    .req-btn.accept:hover { background: rgba(34,197,94,0.4); }
    .req-btn.decline { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
    .req-btn.decline:hover { background: rgba(239,68,68,0.3); }

    /* friends detail pane */
    .friends-detail { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; color: var(--text-soft); text-align: center; }
    .friends-empty-icon { font-size: 3rem; margin-bottom: 12px; }

    /* add friend search */
    .add-friend-bar { padding: 12px; border-top: 1px solid rgba(148,163,184,0.12); }
    .add-friend-row { display: flex; gap: 6px; }
    .add-friend-input { flex: 1; padding: 8px 12px; background: rgba(15,23,42,0.9); border: 1px solid rgba(148,163,184,0.3); border-radius: 10px; color: var(--text); font-size: 0.82rem; outline: none; transition: border-color 0.15s; }
    .add-friend-input:focus { border-color: var(--custom-accent-color); }
    .add-friend-btn { padding: 8px 12px; border-radius: 10px; border: none; background: var(--custom-accent-color); color: white; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
    .add-friend-btn:hover { background: var(--custom-accent-strong); }

    /* new group modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal-card { background: linear-gradient(145deg, rgba(15,23,42,0.99), rgba(6,5,28,0.97)); border: 1px solid rgba(139,92,246,0.35); border-radius: 20px; padding: 28px; width: 100%; max-width: 420px; }
    .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
    .modal-field { margin-bottom: 14px; }
    .modal-field label { display: block; font-size: 0.76rem; color: var(--text-soft); margin-bottom: 6px; font-weight: 600; }
    .modal-input { width: 100%; padding: 10px 13px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.3); border-radius: 10px; color: var(--text); font-size: 0.88rem; outline: none; transition: border-color 0.15s; }
    .modal-input:focus { border-color: var(--custom-accent-color); }
    .modal-member-list { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; margin-bottom: 4px; }
    .modal-member-item { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 8px; background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.15); }
    .modal-member-check { accent-color: var(--custom-accent-color); width: 16px; height: 16px; cursor: pointer; }
    .modal-footer { display: flex; gap: 8px; margin-top: 18px; }
    .modal-btn { flex: 1; padding: 10px; border-radius: 10px; font-size: 0.88rem; font-weight: 700; cursor: pointer; transition: all 0.15s; border: none; }
    .modal-btn.primary { background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); color: white; }
    .modal-btn.ghost { background: rgba(148,163,184,0.1); color: var(--text-soft); border: 1px solid rgba(148,163,184,0.2); }

    .chat-main { display: flex; flex-direction: column; height: 100%; background: radial-gradient(circle at top right, rgba(79,70,229,0.1), transparent 60%); }
    .chat-header { padding: 16px 20px; border-bottom: 1px solid rgba(148,163,184,0.2); display: flex; justify-content: space-between; align-items: center; }
    .chat-header-title { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .chat-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-soft); }
    .status-dot { width: 8px; height: 8px; background: var(--custom-accent-strong); border-radius: 50%; animation: pulse 2s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }

    .message { display: flex; gap: 12px; max-width: 80%; animation: slideIn 0.2s ease; }
    .message.own { align-self: flex-end; flex-direction: row-reverse; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong)); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    .message-content { background: var(--bg-soft); padding: 12px 16px; border-radius: 16px; border: 1px solid rgba(148,163,184,0.3); position: relative; }
    .message.own .message-content { background: linear-gradient(135deg, var(--custom-chat-sent, var(--custom-accent-color)), var(--custom-accent-strong)); border-color: transparent; color: white; }

    .message-header { font-size: 0.75rem; color: var(--text-soft); margin-bottom: 4px; display: flex; gap: 8px; align-items: center; }
    .message.own .message-header { color: rgba(255,255,255,0.8); justify-content: flex-end; }
    .message-text { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }

    .chat-input-area { padding: 16px 20px; border-top: 1px solid rgba(148,163,184,0.2); background: rgba(0,0,0,0.2); }
    .chat-input-wrapper { display: flex; gap: 10px; background: var(--bg-soft); padding: 4px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.3); transition: all 0.15s ease; }
    .chat-input-wrapper:focus-within { border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }
    .chat-input { flex: 1; background: transparent; border: none; padding: 10px 16px; color: var(--text); font-size: 0.9rem; outline: none; }
    .chat-send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--custom-accent-color); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; }
    .chat-send-btn:hover { background: var(--custom-accent-strong); transform: scale(1.05); }
    .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .username-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .username-modal.show { display: flex; }
    .username-card { background: var(--bg-elevated); border: 1px solid var(--accent-soft); border-radius: 24px; padding: 32px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.5); text-align: center; }
    .username-card h2 { margin-bottom: 8px; font-size: 1.5rem; }
    .username-card p { color: var(--text-soft); margin-bottom: 24px; font-size: 0.9rem; }
    .username-input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .username-input-group input { padding: 14px 18px; background: var(--bg-soft); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; color: var(--text); font-size: 1rem; outline: none; transition: all 0.15s ease; }
    .username-input-group input:focus { border-color: var(--custom-accent-color); box-shadow: 0 0 0 3px var(--accent-soft); }

    @media (max-width: 850px) { .chat-container { grid-template-columns: 1fr; } .chat-sidebar { display: none; } }

    .customize-card.chat-colors { grid-column: 1 / -1; }
    .chat-preview-box { height: 120px; background: var(--custom-chat-bg, var(--bg-soft)); border-radius: 12px; border: 1px solid rgba(148,163,184,0.3); margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; }
    .chat-preview-msg { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; max-width: 140px; }
    .chat-preview-msg.received { background: var(--bg-elevated); color: var(--text); border: 1px solid rgba(148,163,184,0.3); align-self: flex-start; }
    .chat-preview-msg.sent { background: var(--custom-chat-sent, var(--custom-accent-color)); color: white; align-self: flex-end; }

    /* ============================================================
       11. ANNOUNCEMENTS & SURVEY
       ============================================================ */
    .announcements-view, .survey-view { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s ease; max-height: 75vh; overflow-y: auto; }

    .announcement-card { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(30,64,175,0.05)); border: 1px solid rgba(139,92,246,0.3); border-radius: 20px; padding: 24px; position: relative; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .announcement-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .announcement-card.important { border-color: rgba(239,68,68,0.5); background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(245,158,11,0.05)); }
    .announcement-card.update { border-color: rgba(34,197,94,0.5); background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(21,128,61,0.05)); }

    .announcement-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; background: rgba(139,92,246,0.2); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.4); }
    .announcement-card.important .announcement-badge { background: rgba(239,68,68,0.2); color: #fca5a5; border-color: rgba(239,68,68,0.4); }
    .announcement-card.update .announcement-badge { background: rgba(34,197,94,0.2); color: #bbf7d0; border-color: rgba(34,197,94,0.4); }

    .announcement-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; color: var(--text); }
    .announcement-date { font-size: 0.8rem; color: var(--text-soft); margin-bottom: 16px; opacity: 0.8; }
    .announcement-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; margin: 16px 0; border: 1px solid rgba(148,163,184,0.2); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .announcement-gif { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; margin: 16px 0; background: rgba(0,0,0,0.3); padding: 8px; }
    .announcement-content { font-size: 0.95rem; line-height: 1.6; color: var(--text); opacity: 0.95; }
    .announcement-empty { text-align: center; padding: 60px 20px; color: var(--text-soft); }
    .announcement-empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }

    .survey-container { background: var(--bg-soft); border-radius: 20px; border: 1px solid rgba(148,163,184,0.3); overflow: hidden; display: flex; flex-direction: column; height: 70vh; min-height: 500px; }
    .survey-header { padding: 20px 24px; background: radial-gradient(circle at top right, rgba(79,70,229,0.2), transparent 60%); border-bottom: 1px solid rgba(148,163,184,0.2); display: flex; justify-content: space-between; align-items: center; }
    .survey-title { font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .survey-frame-container { flex: 1; position: relative; background: #fff; }
    .survey-frame { width: 100%; height: 100%; border: none; background: #fff; }

    /* ============================================================
       12. SOLAR UI — BRAND, SEARCH BAR & PROXY SELECTOR
       ============================================================ */
    .nebulahub-ui {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 30px;
      padding: 20px;
      position: relative;
    }

    .nebulahub-ui.active { display: flex; }

    /* NebulaHub brand in the minimal UI */
    .nebulahub-minimal-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    /* Animated nebula logo SVG */
    .nebulahub-logo-svg {
      width: 80px;
      height: 80px;
      animation: nebulaSpin 12s linear infinite;
      filter: drop-shadow(0 0 18px rgba(139,92,246,0.7));
    }

    @keyframes nebulaSpin {
      0% { filter: drop-shadow(0 0 18px rgba(139,92,246,0.7)); }
      33% { filter: drop-shadow(0 0 24px rgba(34,197,94,0.8)); }
      66% { filter: drop-shadow(0 0 20px rgba(236,72,153,0.7)); }
      100% { filter: drop-shadow(0 0 18px rgba(139,92,246,0.7)); }
    }

    @keyframes orbitRing {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .nebulahub-minimal-title {
      font-size: 2.8rem;
      font-weight: 200;
      letter-spacing: 0.2em;
      color: var(--text);
      text-transform: uppercase;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    .nebulahub-minimal-title strong {
      font-weight: 700;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nebulahub-minimal-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .nebulahub-search-container {
      width: 100%;
      max-width: 640px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    /* Proxy selector */
    .proxy-selector {
      display: flex;
      gap: 8px;
      background: rgba(15,23,42,0.9);
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
    }

    .proxy-option {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .proxy-option.active {
      background: var(--custom-accent-color);
      color: white;
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }

    .nebulahub-search-box {
      width: 100%;
      position: relative;
    }

    .nebulahub-search-input {
      width: 100%;
      padding: 18px 60px 18px 28px;
      background: rgba(15,23,42,0.95);
      border: 2px solid var(--custom-accent-strong);
      border-radius: 999px;
      color: var(--text);
      font-size: 1.05rem;
      outline: none;
      transition: all 0.2s ease;
    }

    .nebulahub-search-input::placeholder { color: #6b7280; }

    .nebulahub-search-input:focus {
      border-color: var(--custom-accent-color);
      box-shadow: 0 0 40px rgba(139,92,246,0.25);
      transform: scale(1.01);
    }

    .nebulahub-search-submit {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--custom-accent-color);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s ease;
    }

    .nebulahub-search-submit:hover {
      background: var(--custom-accent-strong);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(34,197,94,0.4);
    }

    .nebulahub-proxy-status {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nebulahub-proxy-status .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--custom-accent-strong); animation: pulse 2s infinite; }

    /* NebulaHub search results panel */
    .nebulahub-results-frame {
      width: 100%;
      max-width: 900px;
      height: 60vh;
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.3);
      overflow: hidden;
      background: #020617;
      display: none;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .nebulahub-results-frame.show { display: block; }

    .nebulahub-results-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ============================================================
       13. SOLAR UI — BOTTOM DOCK
       ============================================================ */
    .nebulahub-dock {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      background: rgba(6,5,28,0.92);
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 999px;
      backdrop-filter: blur(20px) saturate(1.3);
      box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(139,92,246,0.15);
      z-index: 200;
    }

    .nebulahub-dock-item {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-size: 1.3rem;
      position: relative;
      color: var(--text-soft);
      border: 1px solid transparent;
    }

    .nebulahub-dock-item:hover {
      transform: translateY(-8px) scale(1.15);
      background: rgba(139,92,246,0.2);
      border-color: rgba(139,92,246,0.4);
      color: var(--text);
    }

    .nebulahub-dock-item.active-dock-item {
      background: rgba(139,92,246,0.25);
      border-color: rgba(139,92,246,0.6);
      color: #c4b5fd;
    }

    /* Tooltip on hover */
    .nebulahub-dock-item::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.97);
      border: 1px solid rgba(148,163,184,0.3);
      color: var(--text);
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .nebulahub-dock-item:hover::after { opacity: 1; }

    .nebulahub-dock-divider { width: 1px; height: 26px; background: rgba(148,163,184,0.25); margin: 0 4px; }

    .nebulahub-dock-time {
      font-size: 0.82rem;
      color: var(--text-soft);
      font-family: monospace;
      padding: 0 6px;
      letter-spacing: 0.05em;
    }

    /* Portal mode adjustments for nebulahub UI */
    body.portal-mode .nebulahub-search-input,
    body.portal-mode .nebulahub-dock,
    body.portal-mode .proxy-selector {
      background: #ffffff;
      border-color: #e5e7eb;
      color: #111827;
    }

    body.portal-mode .nebulahub-dock-item:hover { background: rgba(99,102,241,0.1); }

    /* ============================================================
       14. SOLAR UI — FULL-SCREEN PANELS
       (library / player / news / survey / chat / customize / settings / dev)
       ============================================================ */
    .minimal-panel {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      bottom: 88px; /* dock is ~70px + 18px gap */
      background: rgba(3, 0, 20, 0.98);
      backdrop-filter: blur(28px) saturate(1.4);
      flex-direction: column;
      z-index: 200;
      overflow: hidden;
      animation: panelIn 0.2s ease-out;
    }
    .minimal-panel.show { display: flex; }

    @keyframes panelIn {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Panel header */
    .mp-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 36px;
      border-bottom: 1px solid rgba(139,92,246,0.2);
      background: rgba(6,5,28,0.9);
      flex-shrink: 0;
    }

    .mp-title {
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .mp-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.8);
      color: var(--text-soft);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      transition: all 0.15s;
    }
    .mp-close:hover { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); color: #fca5a5; }

    /* Panel body scroll */
    .mp-body {
      overflow-y: auto;
      padding: 24px 36px;
      flex: 1;
    }

    /* ---- LIBRARY PANEL ---- */
    .mp-game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .mp-game-card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.8));
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 14px;
      padding: 10px 8px;
      cursor: pointer;
      display: flex; flex-direction: column; gap: 6px;
      transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
      position: relative; overflow: hidden;
    }
    .mp-game-card:hover { transform: translateY(-3px); border-color: rgba(139,92,246,0.8); box-shadow: 0 12px 28px rgba(0,0,0,0.5); }

    .mp-game-thumb {
      height: 90px; border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, var(--custom-brand-color), #0b1020);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; letter-spacing: 0.1em; color: #e5e7eb;
      text-transform: uppercase;
    }

    .mp-game-name {
      font-size: 0.78rem; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: var(--text);
    }

    .mp-game-cat {
      font-size: 0.65rem; color: var(--text-soft);
      text-transform: uppercase; letter-spacing: 0.08em;
    }

    .mp-search-bar {
      display: flex; gap: 8px; margin-bottom: 14px;
    }

    .mp-search-input {
      flex: 1; padding: 9px 14px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 999px; color: var(--text);
      font-size: 0.85rem; outline: none;
      transition: border-color 0.15s;
    }
    .mp-search-input:focus { border-color: var(--custom-accent-color); }
    .mp-search-input::placeholder { color: #6b7280; }

    .mp-filter-row {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px;
    }

    .mp-chip {
      padding: 4px 10px; border-radius: 999px; font-size: 0.72rem;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.8); color: var(--text-soft);
      cursor: pointer; transition: all 0.15s;
    }
    .mp-chip.active { background: var(--accent-soft); border-color: var(--custom-accent-color); color: #e5e7eb; }

    /* ---- PLAYER PANEL ---- */
    .mp-player-frame {
      width: 100%; flex: 1;
      border-radius: 0 0 20px 20px;
      overflow: hidden; background: #020617;
      min-height: 400px;
    }
    .mp-player-frame iframe { width:100%; height:100%; border:none; display:block; min-height: 400px; }

    /* ---- NEWS PANEL ---- */
    .mp-announcement {
      background: rgba(139,92,246,0.08);
      border: 1px solid rgba(139,92,246,0.25);
      border-radius: 16px; padding: 18px;
      margin-bottom: 12px;
      transition: transform 0.2s;
    }
    .mp-announcement:hover { transform: translateY(-1px); }
    .mp-announcement.important { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.07); }
    .mp-announcement.update { border-color: rgba(34,197,94,0.4); background: rgba(34,197,94,0.07); }

    .mp-ann-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 999px; font-size: 0.68rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 10px;
      background: rgba(139,92,246,0.2); color: #c4b5fd;
      border: 1px solid rgba(139,92,246,0.4);
    }
    .mp-announcement.important .mp-ann-badge { background: rgba(239,68,68,0.2); color: #fca5a5; border-color: rgba(239,68,68,0.4); }
    .mp-announcement.update .mp-ann-badge { background: rgba(34,197,94,0.2); color: #bbf7d0; border-color: rgba(34,197,94,0.4); }

    .mp-ann-title { font-size: 1.1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .mp-ann-date { font-size: 0.75rem; color: var(--text-soft); margin-bottom: 10px; }
    .mp-ann-content { font-size: 0.88rem; color: var(--text); line-height: 1.6; opacity: 0.92; }

    /* ---- SURVEY PANEL ---- */
    .mp-survey-frame {
      flex: 1; width: 100%; border: none; background: #fff;
      min-height: 440px;
    }

    /* ---- CHAT PANEL ---- */
    .mp-chat-layout {
      display: flex; flex: 1; overflow: hidden;
    }

    .mp-chat-rooms {
      width: 140px; flex-shrink: 0;
      background: rgba(15,23,42,0.5);
      border-right: 1px solid rgba(148,163,184,0.15);
      padding: 12px 8px;
      display: flex; flex-direction: column; gap: 6px;
      overflow-y: auto;
    }

    .mp-room-btn {
      padding: 8px 10px; border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(15,23,42,0.6);
      color: var(--text-soft); cursor: pointer;
      font-size: 0.78rem; text-align: left;
      transition: all 0.15s;
      display: flex; align-items: center; gap: 6px;
    }
    .mp-room-btn:hover, .mp-room-btn.active {
      background: var(--accent-soft);
      border-color: var(--custom-accent-color);
      color: var(--text);
    }

    .mp-chat-main {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
    }

    .mp-messages {
      flex: 1; overflow-y: auto; padding: 14px;
      display: flex; flex-direction: column; gap: 10px;
      scroll-behavior: smooth;
    }

    .mp-msg {
      display: flex; gap: 8px; max-width: 85%;
      animation: slideIn 0.2s ease;
    }
    .mp-msg.own { align-self: flex-end; flex-direction: row-reverse; }

    .mp-msg-avatar {
      width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; color: white;
    }

    .mp-msg-bubble {
      background: var(--bg-soft); padding: 8px 12px;
      border-radius: 12px; border: 1px solid rgba(148,163,184,0.25);
    }
    .mp-msg.own .mp-msg-bubble { background: linear-gradient(135deg, var(--custom-chat-sent, var(--custom-accent-color)), var(--custom-accent-strong)); border-color: transparent; color: white; }

    .mp-msg-meta { font-size: 0.68rem; color: var(--text-soft); margin-bottom: 3px; }
    .mp-msg.own .mp-msg-meta { color: rgba(255,255,255,0.7); text-align: right; }
    .mp-msg-text { font-size: 0.85rem; line-height: 1.4; word-break: break-word; }

    .mp-chat-input-row {
      padding: 10px 14px;
      border-top: 1px solid rgba(148,163,184,0.15);
      display: flex; gap: 8px;
    }

    .mp-chat-input {
      flex: 1; padding: 8px 14px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 999px; color: var(--text);
      font-size: 0.85rem; outline: none;
      transition: border-color 0.15s;
    }
    .mp-chat-input:focus { border-color: var(--custom-accent-color); }

    .mp-chat-send {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--custom-accent-color);
      border: none; color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.9rem; transition: all 0.15s;
    }
    .mp-chat-send:hover { background: var(--custom-accent-strong); transform: scale(1.08); }

    /* ---- CUSTOMIZE PANEL ---- */
    .mp-setting-group { margin-bottom: 18px; }
    .mp-setting-label { font-size: 0.78rem; color: var(--text-soft); margin-bottom: 8px; display: block; font-weight: 500; }
    .mp-color-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .mp-color-row input[type="color"] { width: 44px; height: 34px; border: none; border-radius: 8px; cursor: pointer; background: none; }
    .mp-color-row input[type="text"] { flex:1; padding: 6px 10px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 8px; color: var(--text); font-size: 0.78rem; font-family: monospace; outline: none; }
    .mp-color-row input[type="text"]:focus { border-color: var(--custom-accent-color); }

    .mp-preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
    .mp-preset-btn { padding: 7px 6px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.3); background: rgba(15,23,42,0.6); color: var(--text-soft); cursor: pointer; font-size: 0.72rem; transition: all 0.15s; }
    .mp-preset-btn:hover { border-color: var(--custom-accent-color); color: var(--text); }

    .mp-action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .mp-btn { padding: 7px 14px; border-radius: 999px; font-size: 0.78rem; cursor: pointer; border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.9); color: var(--text); transition: all 0.15s; }
    .mp-btn:hover { background: rgba(30,64,175,0.7); border-color: rgba(139,92,246,0.7); }
    .mp-btn.primary { background: var(--custom-accent-color); border-color: var(--custom-accent-color); color: white; }
    .mp-btn.primary:hover { background: var(--custom-accent-strong); border-color: var(--custom-accent-strong); }
    .mp-btn.danger { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); color: #fca5a5; }
    .mp-btn.danger:hover { background: rgba(239,68,68,0.4); }

    /* ---- SETTINGS PANEL ---- */
    .mp-input-group { margin-bottom: 14px; }
    .mp-input-group label { display: block; font-size: 0.78rem; color: var(--text-soft); margin-bottom: 6px; }
    .mp-input-group input[type="text"] { width: 100%; padding: 9px 12px; background: rgba(15,23,42,0.95); border: 1px solid rgba(148,163,184,0.4); border-radius: 10px; color: var(--text); font-size: 0.85rem; outline: none; transition: border-color 0.15s; }
    .mp-input-group input[type="text"]:focus { border-color: var(--custom-accent-color); }

    .mp-section-title { font-size: 0.85rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 6px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(148,163,184,0.15); }

    .mp-favicon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 14px; }
    .mp-fav-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 8px 4px; border-radius: 10px; border: 2px solid transparent; background: rgba(15,23,42,0.6); cursor: pointer; transition: all 0.15s; }
    .mp-fav-btn:hover { background: rgba(15,23,42,0.9); }
    .mp-fav-btn.active { border-color: var(--custom-accent-color); background: var(--accent-soft); }
    .mp-fav-icon { width: 28px; height: 28px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: white; }
    .mp-fav-label { font-size: 0.62rem; color: var(--text-soft); }
    .mp-fav-btn.active .mp-fav-label { color: var(--text); }

    /* ---- DEV PANEL ---- */
    .mp-dev-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 600px) { .mp-dev-grid { grid-template-columns: 1fr; } }

    .mp-dev-card {
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 14px; padding: 14px;
      position: relative; overflow: hidden;
    }
    .mp-dev-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, #ef4444, #f97316, #eab308); }

    .mp-dev-card-title { font-size: 0.88rem; font-weight: 700; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 6px; }

    .mp-feature-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(15,23,42,0.5); border-radius: 8px; border: 1px solid rgba(148,163,184,0.15); margin-bottom: 6px; }
    .mp-feature-name { font-size: 0.8rem; color: var(--text); font-weight: 500; }
    .mp-feature-desc { font-size: 0.7rem; color: var(--text-soft); }
    .mp-toggle { appearance: none; width: 38px; height: 20px; background: rgba(148,163,184,0.3); border-radius: 999px; position: relative; cursor: pointer; outline: none; transition: background 0.2s; flex-shrink: 0; }
    .mp-toggle:checked { background: var(--custom-accent-strong); }
    .mp-toggle::after { content:''; position:absolute; top:2px; left:2px; width:16px; height:16px; background:white; border-radius:50%; transition:transform 0.2s; }
    .mp-toggle:checked::after { transform: translateX(18px); }

    .mp-css-editor { width:100%; min-height:90px; background:rgba(0,0,0,0.5); border:1px solid rgba(148,163,184,0.3); border-radius:8px; padding:10px; color:#a5f3fc; font-family:monospace; font-size:0.75rem; resize:vertical; }
    .mp-css-editor:focus { outline:none; border-color:var(--custom-accent-color); }

    .mp-game-editor-list { max-height: 160px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
    .mp-game-edit-row { display:flex; align-items:center; gap:8px; padding:8px; background:rgba(15,23,42,0.5); border-radius:8px; border:1px solid rgba(148,163,184,0.15); }
    .mp-game-edit-thumb { width:32px; height:32px; border-radius:7px; background:var(--custom-accent-color); display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:700; flex-shrink:0; }
    .mp-game-edit-info { flex:1; min-width:0; }
    .mp-game-edit-name { font-size:0.78rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mp-game-edit-cat { font-size:0.68rem; color:var(--text-soft); }
    .mp-game-edit-btns { display:flex; gap:4px; }
    .mp-icon-btn { width:24px; height:24px; border-radius:5px; border:1px solid rgba(148,163,184,0.25); background:rgba(15,23,42,0.7); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition:all 0.15s; }
    .mp-icon-btn:hover { background:rgba(239,68,68,0.3); border-color:rgba(239,68,68,0.5); }

    .mp-add-btn { width:100%; padding:8px; border:2px dashed rgba(148,163,184,0.35); background:rgba(15,23,42,0.4); color:var(--text-soft); border-radius:8px; cursor:pointer; font-size:0.78rem; transition:all 0.15s; display:flex; align-items:center; justify-content:center; gap:6px; }
    .mp-add-btn:hover { border-color:var(--custom-accent-color); color:var(--text); }

    .mp-config-area { width:100%; min-height:80px; background:rgba(0,0,0,0.5); border:1px solid rgba(148,163,184,0.3); border-radius:8px; padding:10px; color:#a5f3fc; font-family:monospace; font-size:0.7rem; word-break:break-all; resize:vertical; }

    /* ============================================================
       15. UI TOGGLE DROPDOWN
       ============================================================ */
    .ui-toggle-container { position: relative; }

    .ui-toggle-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 14px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 12px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ui-toggle-btn:hover { background: var(--accent-soft); border-color: var(--custom-accent-color); }

    .ui-toggle-dropdown {
      position: absolute; top: 100%; right: 0;
      margin-top: 8px;
      background: var(--bg-elevated);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 8px;
      min-width: 190px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      opacity: 0; visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 100;
    }

    .ui-toggle-container:hover .ui-toggle-dropdown,
    .ui-toggle-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }

    .ui-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s ease; font-size: 0.85rem; }
    .ui-option:hover { background: rgba(139,92,246,0.15); }
    .ui-option.active { background: var(--accent-soft); }
    .ui-option-icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .ui-option-text { display: flex; flex-direction: column; }
    .ui-option-label { font-weight: 600; color: var(--text); }
    .ui-option-desc { font-size: 0.7rem; color: var(--text-soft); }

    /* Theme specific modal adjustments */
    body.portal-mode .update-modal { background: rgba(255,255,255,0.9); }
    body.portal-mode .update-card { background: #ffffff; border-color: #e5e7eb; box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
    body.portal-mode .update-header { background: linear-gradient(135deg, rgba(99,102,241,0.1), transparent 60%); border-bottom-color: #e5e7eb; }
    body.portal-mode .update-title { background: linear-gradient(135deg, #4f46e5, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    body.portal-mode .update-body, body.portal-mode .update-footer { background: #ffffff; }
    body.portal-mode .update-list li { color: #111827; }
    body.portal-mode .update-date, body.portal-mode .checkbox-label { color: #6b7280; }
    body.portal-mode .update-footer { border-top-color: #e5e7eb; }
    body.portal-mode .survey-container { background: #ffffff; border-color: #e5e7eb; }
    body.portal-mode .chat-container { background: #ffffff; border-color: #e5e7eb; }
    body.portal-mode .chat-sidebar { background: #f9fafb; border-color: #e5e7eb; }
    body.portal-mode .chat-room-btn { background: #ffffff; border-color: #e5e7eb; color: #374151; }

    /* ============================================================
       17. VALENTINE'S UPDATE — New Feature Styles
       ============================================================ */

    /* ---- Spotlight Search ---- */
    .spotlight-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(12px);
      z-index: 2000; display: none; align-items: flex-start; justify-content: center; padding-top: 14vh;
    }
    .spotlight-overlay.show { display: flex; }
    .spotlight-box {
      width: 100%; max-width: 600px; margin: 0 16px;
      background: linear-gradient(145deg, rgba(10,15,30,0.98), rgba(6,5,28,0.97));
      border: 1px solid rgba(139,92,246,0.45); border-radius: 20px;
      box-shadow: 0 32px 80px rgba(0,0,0,0.6); overflow: hidden;
    }
    .spotlight-input-row {
      display: flex; align-items: center; gap: 12px; padding: 16px 20px;
      border-bottom: 1px solid rgba(148,163,184,0.1);
    }
    .spotlight-icon { font-size: 1.1rem; opacity: 0.5; }
    .spotlight-input {
      flex: 1; background: none; border: none; outline: none; color: var(--text);
      font-size: 1.1rem; font-family: var(--custom-font);
    }
    .spotlight-esc { font-size: 0.65rem; color: var(--text-soft); background: rgba(148,163,184,0.15); padding: 2px 8px; border-radius: 6px; white-space: nowrap; }
    .spotlight-results { max-height: 380px; overflow-y: auto; padding: 8px; }
    .spotlight-section-label { font-size: 0.65rem; font-weight: 700; color: var(--text-soft); text-transform: uppercase; letter-spacing: .08em; padding: 8px 10px 4px; }
    .spotlight-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 12px;
      border-radius: 10px; cursor: pointer; transition: all 0.1s; color: var(--text);
    }
    .spotlight-item:hover, .spotlight-item.selected { background: var(--accent-soft); }
    .spotlight-item-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; background: rgba(139,92,246,0.15); }
    .spotlight-item-name { font-weight: 600; font-size: 0.88rem; }
    .spotlight-item-sub  { font-size: 0.72rem; color: var(--text-soft); }
    .spotlight-empty { text-align: center; padding: 32px 20px; color: var(--text-soft); font-size: 0.85rem; }
    .kb-hint { font-size: 0.65rem; color: var(--text-soft); background: rgba(148,163,184,0.12); border: 1px solid rgba(148,163,184,0.2); border-radius: 6px; padding: 2px 6px; font-family: monospace; }

    /* ---- Favorites ---- */
    .card-fav-btn { position: absolute; top: 8px; right: 8px; z-index: 2; background: none; border: none; cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.15s, transform 0.15s; line-height: 1; }
    .game-card:hover .card-fav-btn, .card-fav-btn.faved { opacity: 1; }
    .card-fav-btn.faved { color: #f43f5e; filter: drop-shadow(0 0 4px rgba(244,63,94,0.5)); }

    /* ---- Recent games ---- */
    .recent-strip { display: flex; gap: 8px; padding: 0 2px 12px; overflow-x: auto; scrollbar-width: none; }
    .recent-strip::-webkit-scrollbar { display: none; }
    .recent-strip-label { font-size: 0.68rem; font-weight: 700; color: var(--text-soft); text-transform: uppercase; letter-spacing: .08em; padding: 0 2px 6px; }
    .recent-chip { display: flex; align-items: center; gap: 7px; padding: 7px 12px; background: rgba(15,23,42,0.75); border: 1px solid rgba(148,163,184,0.2); border-radius: 999px; cursor: pointer; white-space: nowrap; font-size: 0.8rem; transition: all 0.15s; flex-shrink: 0; }
    .recent-chip:hover { border-color: var(--custom-accent-color); background: var(--accent-soft); }

    /* ---- Message reactions ---- */
    .msg-reactions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
    .reaction-pill { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 999px; font-size: 0.8rem; background: rgba(139,92,246,0.12); border: 1px solid rgba(139,92,246,0.25); cursor: pointer; transition: all 0.15s; user-select: none; }
    .reaction-pill:hover { background: rgba(139,92,246,0.25); transform: scale(1.08); }
    .reaction-pill.mine { background: rgba(139,92,246,0.3); border-color: var(--custom-accent-color); }
    .reaction-pill .r-count { font-size: 0.72rem; font-weight: 700; color: var(--text-soft); }
    .reaction-picker { display: none; position: absolute; bottom: calc(100% + 6px); left: 0; background: rgba(10,15,30,0.97); border: 1px solid rgba(139,92,246,0.35); border-radius: 14px; padding: 6px 8px; gap: 4px; flex-wrap: nowrap; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5); white-space: nowrap; }
    .reaction-picker.show { display: flex; }
    .reaction-picker button { background: none; border: none; font-size: 1.25rem; cursor: pointer; padding: 3px 5px; border-radius: 8px; transition: all 0.1s; }
    .reaction-picker button:hover { background: rgba(139,92,246,0.2); transform: scale(1.2); }

    /* ---- Message actions ---- */
    .message-actions { display: none; position: absolute; top: -14px; right: 8px; background: rgba(10,15,30,0.97); border: 1px solid rgba(139,92,246,0.3); border-radius: 10px; padding: 3px 6px; gap: 4px; z-index: 10; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
    .message:hover .message-actions { display: flex; }
    .message-actions button { background: none; border: none; font-size: 0.9rem; cursor: pointer; padding: 3px 5px; border-radius: 6px; color: var(--text-soft); transition: all 0.1s; }
    .message-actions button:hover { background: rgba(139,92,246,0.2); color: var(--text); }
    .message { position: relative; }

    /* ---- Reply quote ---- */
    .reply-quote { background: rgba(139,92,246,0.1); border-left: 3px solid var(--custom-accent-color); border-radius: 0 8px 8px 0; padding: 5px 10px; margin-bottom: 6px; font-size: 0.76rem; color: var(--text-soft); cursor: pointer; }
    .reply-quote strong { color: var(--text); }
    .reply-bar { display: none; align-items: center; gap: 10px; padding: 7px 14px 0; border-top: 1px solid rgba(148,163,184,0.1); }
    .reply-bar.show { display: flex; }
    .reply-bar-text { font-size: 0.78rem; color: var(--text-soft); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .reply-bar-text strong { color: var(--custom-accent-color); }
    .reply-cancel { background: none; border: none; color: var(--text-soft); cursor: pointer; font-size: 1rem; padding: 2px 6px; border-radius: 6px; transition: all 0.1s; }
    .reply-cancel:hover { background: rgba(239,68,68,0.2); color: #fca5a5; }

    /* ---- Typing indicator ---- */
    .typing-indicator { display: none; align-items: center; gap: 8px; padding: 4px 16px; font-size: 0.78rem; color: var(--text-soft); min-height: 22px; }
    .typing-indicator.show { display: flex; }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dots span { width: 5px; height: 5px; border-radius: 50%; background: var(--custom-accent-color); animation: typingBounce 1.2s infinite ease-in-out; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%,60%,100% { transform: translateY(0); opacity:.4; } 30% { transform: translateY(-4px); opacity:1; } }
    .message-deleted .message-text { color: var(--text-soft); font-style: italic; opacity: 0.6; }

    /* ---- Valentine's Mode ---- */
    @keyframes heartFloat { 0% { transform: translateY(0) scale(1) rotate(0deg); opacity:.9; } 100% { transform: translateY(-100vh) scale(0.5) rotate(20deg); opacity:0; } }
    .heart-particle { position: fixed; pointer-events: none; z-index: 9998; font-size: 1.2rem; animation: heartFloat linear forwards; }
    body.valentine-mode { --custom-accent-color: #f43f5e !important; --custom-accent-strong: #fb7185 !important; }

    body.portal-mode .message-content { background: #f3f4f6; border-color: #e5e7eb; color: #111827; }
    body.portal-mode .message.own .message-content { background: linear-gradient(135deg, #4f46e5, #22c55e); color: white; }

    /* ============================================================
       16. PROFILE SYSTEM
       ============================================================ */

    /* ---- Auth Gate (sign-in / sign-up overlay) ---- */
    .auth-gate {
      position: fixed; inset: 0;
      background: rgba(3,0,20,0.97);
      backdrop-filter: blur(28px) saturate(1.3);
      z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .auth-gate.hidden { display: none; }

    .auth-card {
      width: 100%; max-width: 420px;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(6,5,28,0.96));
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 24px;
      padding: 36px 32px;
      box-shadow: 0 32px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(139,92,246,0.1);
      animation: panelIn 0.3s ease-out;
    }

    .auth-logo {
      width: 64px; height: 64px; margin: 0 auto 20px;
      background: radial-gradient(circle at 40% 30%, #22c55e, #8b5cf6 60%, #030014);
      border-radius: 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6rem; font-weight: 900; color: white;
      box-shadow: 0 0 28px rgba(139,92,246,0.5);
    }

    .auth-heading { text-align: center; margin-bottom: 6px; font-size: 1.4rem; font-weight: 800; }
    .auth-sub { text-align: center; color: var(--text-soft); font-size: 0.85rem; margin-bottom: 28px; }

    .auth-tabs {
      display: flex; background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 12px; padding: 4px; gap: 4px; margin-bottom: 24px;
    }
    .auth-tab {
      flex: 1; padding: 8px; border-radius: 9px; border: none;
      background: transparent; color: var(--text-soft);
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all 0.15s;
    }
    .auth-tab.active {
      background: linear-gradient(135deg, rgba(139,92,246,0.4), rgba(34,197,94,0.2));
      color: var(--text);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .auth-form { display: flex; flex-direction: column; gap: 14px; }
    .auth-form.hidden { display: none; }

    .auth-field { display: flex; flex-direction: column; gap: 6px; }
    .auth-field label { font-size: 0.78rem; font-weight: 600; color: var(--text-soft); }
    .auth-input {
      padding: 11px 14px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px; color: var(--text);
      font-size: 0.9rem; outline: none; transition: border-color 0.15s, box-shadow 0.15s;
    }
    .auth-input:focus {
      border-color: var(--custom-accent-color);
      box-shadow: 0 0 0 3px rgba(139,92,246,0.15);
    }
    .auth-input::placeholder { color: #4b5563; }

    .auth-btn {
      padding: 12px; border-radius: 12px; border: none;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      color: white; font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      margin-top: 4px;
    }
    .auth-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(139,92,246,0.4); }
    .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .auth-error {
      padding: 10px 14px; border-radius: 10px;
      background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3);
      color: #fca5a5; font-size: 0.82rem; display: none;
    }
    .auth-error.show { display: block; }
    .auth-success {
      padding: 10px 14px; border-radius: 10px;
      background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.3);
      color: #bbf7d0; font-size: 0.82rem; display: none; text-align: center;
    }
    .auth-success.show { display: block; }

    .auth-divider { display: flex; align-items: center; gap: 10px; margin: 4px 0; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(148,163,184,0.2); }
    .auth-divider span { font-size: 0.75rem; color: var(--text-soft); }

    /* ---- Profile avatar button in top-bar ---- */
    .profile-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: 2px solid rgba(139,92,246,0.5);
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      cursor: pointer; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.9rem; color: white;
      transition: all 0.15s; flex-shrink: 0;
      position: relative;
    }
    .profile-btn:hover { border-color: rgba(139,92,246,0.9); transform: scale(1.05); }
    .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

    /* ---- Profile Panel (full-screen like Solar UI panels) ---- */
    .profile-panel {
      position: fixed; inset: 0; bottom: 88px;
      background: rgba(3,0,20,0.98);
      backdrop-filter: blur(28px) saturate(1.4);
      z-index: 200; overflow-y: auto;
      display: none; flex-direction: column;
      animation: panelIn 0.2s ease-out;
    }
    .profile-panel.show { display: flex; }

    .profile-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 36px; border-bottom: 1px solid rgba(139,92,246,0.18);
      background: rgba(6,5,28,0.9); flex-shrink: 0;
    }
    .profile-panel-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }

    .profile-panel-body {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px; padding: 28px 36px;
      max-width: 1100px; width: 100%; margin: 0 auto;
    }
    @media (max-width: 768px) { .profile-panel-body { grid-template-columns: 1fr; } }

    /* Profile card (left column) */
    .profile-card {
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 20px; overflow: hidden;
    }

    .profile-banner {
      height: 100px; position: relative;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      cursor: pointer; overflow: hidden;
    }
    .profile-banner::after {
      content: '📷'; position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem; opacity: 0; transition: opacity 0.2s;
      background: rgba(0,0,0,0.4);
    }
    .profile-banner:hover::after { opacity: 1; }
    .profile-banner img { width: 100%; height: 100%; object-fit: cover; }

    .profile-avatar-wrap {
      width: 80px; height: 80px; border-radius: 50%;
      border: 4px solid rgba(3,0,20,0.98);
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      margin: -40px 0 0 20px;
      position: relative; cursor: pointer; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; font-weight: 800; color: white;
      transition: all 0.15s;
    }
    .profile-avatar-wrap:hover { opacity: 0.85; }
    .profile-avatar-wrap img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
    .profile-avatar-wrap input[type="file"] { display: none; }

    .profile-info { padding: 12px 20px 20px; }
    .profile-display-name { font-size: 1.2rem; font-weight: 800; }
    .profile-username { font-size: 0.82rem; color: var(--text-soft); margin-bottom: 8px; }
    .profile-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 999px; font-size: 0.7rem;
      font-weight: 700; background: rgba(139,92,246,0.2);
      border: 1px solid rgba(139,92,246,0.4); color: #c4b5fd; margin-bottom: 10px;
    }
    .profile-bio { font-size: 0.84rem; color: var(--text-soft); line-height: 1.5; margin-bottom: 14px; }
    .profile-stats { display: flex; gap: 16px; }
    .profile-stat { text-align: center; }
    .profile-stat-num { font-size: 1.1rem; font-weight: 700; }
    .profile-stat-label { font-size: 0.68rem; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.06em; }

    /* Edit sections (right column) */
    .profile-edit-col { display: flex; flex-direction: column; gap: 18px; }

    .profile-section {
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 16px; padding: 20px;
    }
    .profile-section-title {
      font-size: 0.88rem; font-weight: 700; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
      padding-bottom: 10px; border-bottom: 1px solid rgba(148,163,184,0.12);
    }

    .profile-field { margin-bottom: 14px; }
    .profile-field:last-child { margin-bottom: 0; }
    .profile-field label { display: block; font-size: 0.76rem; color: var(--text-soft); margin-bottom: 6px; font-weight: 600; }
    .profile-field input[type="text"],
    .profile-field textarea {
      width: 100%; padding: 10px 13px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px; color: var(--text);
      font-size: 0.88rem; font-family: inherit;
      outline: none; transition: border-color 0.15s;
      resize: vertical;
    }
    .profile-field input:focus, .profile-field textarea:focus { border-color: var(--custom-accent-color); }
    .profile-char-count { font-size: 0.7rem; color: var(--text-soft); text-align: right; margin-top: 3px; }

    /* Background picker */
    .bg-type-row { display: flex; gap: 8px; margin-bottom: 14px; }
    .bg-type-btn {
      flex: 1; padding: 8px 6px; border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.6); color: var(--text-soft);
      font-size: 0.75rem; cursor: pointer; transition: all 0.15s; text-align: center;
    }
    .bg-type-btn.active { border-color: var(--custom-accent-color); color: var(--text); background: var(--accent-soft); }

    .bg-presets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px; }
    .bg-preset {
      height: 40px; border-radius: 8px; cursor: pointer;
      border: 2px solid transparent; transition: all 0.15s;
      position: relative; overflow: hidden;
    }
    .bg-preset:hover { transform: scale(1.05); }
    .bg-preset.active { border-color: white; box-shadow: 0 0 0 2px var(--custom-accent-color); }

    .bg-custom-input { display: none; }
    .bg-custom-input.show { display: block; }

    /* Avatar grid picker */
    .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 12px; }
    .avatar-option {
      width: 100%; aspect-ratio: 1; border-radius: 50%;
      cursor: pointer; border: 2px solid transparent;
      transition: all 0.15s; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }
    .avatar-option:hover { transform: scale(1.1); }
    .avatar-option.active { border-color: white; box-shadow: 0 0 0 2px var(--custom-accent-color); }
    .avatar-option img { width: 100%; height: 100%; object-fit: cover; }

    .upload-zone {
      border: 2px dashed rgba(148,163,184,0.3);
      border-radius: 12px; padding: 18px;
      text-align: center; cursor: pointer;
      transition: all 0.15s; color: var(--text-soft);
      font-size: 0.82rem;
    }
    .upload-zone:hover { border-color: var(--custom-accent-color); color: var(--text); background: rgba(139,92,246,0.05); }
    .upload-zone input[type="file"] { display: none; }

    .profile-save-btn {
      width: 100%; padding: 12px; border-radius: 12px; border: none;
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      color: white; font-size: 0.9rem; font-weight: 700; cursor: pointer;
      transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .profile-save-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(139,92,246,0.4); }
    .profile-save-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .profile-signout-btn {
      width: 100%; padding: 10px; border-radius: 12px; margin-top: 8px;
      border: 1px solid rgba(239,68,68,0.3);
      background: rgba(239,68,68,0.08); color: #fca5a5;
      font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
    }
    .profile-signout-btn:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); }

    /* Dock profile avatar (Solar UI) */
    .dock-profile-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      border: 2px solid rgba(139,92,246,0.5);
      background: linear-gradient(135deg, var(--custom-accent-color), var(--custom-accent-strong));
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; color: white; cursor: pointer;
      transition: all 0.15s; flex-shrink: 0;
    }
    .dock-profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .dock-profile-avatar:hover { transform: scale(1.1); border-color: rgba(139,92,246,0.9); }
  </style>
</head>
<body>
  <!-- ============================================================
       FULL HUB UI  (visible when mode = 'nebulahub')
       ============================================================ -->
  <div class="app-shell" id="nebulaHubUI">
    <header class="top-bar">
      <div class="brand">
        <div class="brand-logo">
          <div class="brand-logo-inner"><span>NH</span></div>
        </div>
        <div>
          <div class="brand-text-main">
            <span>NEBULA</span><span>HUB</span>
          </div>
          <div class="brand-sub">Games • Apps • Your cosmic escape 🌌</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="pill">
          <span class="pill-dot"></span>
          LIVE LIBRARY
        </div>

        <select id="themeSelector" class="theme-selector"
          style="padding:6px 10px; border-radius:12px; background:var(--bg-soft); border:1px solid var(--accent-soft); color:var(--text);">
          <option value="nebula">Nebula</option>
          <option value="midnight">Midnight</option>
          <option value="bubblegum">Bubblegum</option>
          <option value="matrix">Matrix</option>
          <option value="minecraft">Minecraft</option>
        </select>

        <!-- UI Toggle Dropdown -->
        <div class="ui-toggle-container">
          <button class="ui-toggle-btn" onclick="toggleUIDropdown()">
            <span>🎨</span>
            <span>UI Mode</span>
            <span style="margin-left:4px;">▼</span>
          </button>
          <div class="ui-toggle-dropdown" id="uiToggleDropdown">
            <div class="ui-option active" onclick="switchUI('nebulahub')" id="optionNebulaHub">
              <div class="ui-option-icon" style="background: linear-gradient(135deg, #8b5cf6, #22c55e);">🌌</div>
              <div class="ui-option-text">
                <span class="ui-option-label">NebulaHub</span>
                <span class="ui-option-desc">Full game portal</span>
              </div>
            </div>
            <div class="ui-option" onclick="switchUI('solar')" id="optionMinimal">
              <div class="ui-option-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">⚡</div>
              <div class="ui-option-text">
                <span class="ui-option-label">Solar UI</span>
                <span class="ui-option-desc">Solar UI — clean launcher</span>
              </div>
            </div>
          </div>
        </div>

        <button class="btn panic-btn" onclick="panicHide()">🚨 Panic</button>
        <button class="profile-btn" id="topBarProfileBtn" onclick="openProfilePanel()" title="Your Profile">
          <span id="topBarProfileInitials">?</span>
          <img id="topBarProfileAvatar" src="" alt="" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
        </button>
      </div>
    </header>

    <section class="toolbar">
      <div class="search-wrapper" style="position:relative;">
        <span class="search-icon">🔍</span>
        <input id="searchInput" class="search-input" type="text"
          placeholder="Search games... (Ctrl+K for Spotlight)"
          autocomplete="off" />
        <button id="clearSearchBtn" class="clear-search" aria-label="Clear search">✕</button>
      </div>

      <div class="filters" id="gameFilters">
        <button class="filter-chip active" data-category="all"><span class="dot"></span>All</button>
        <button class="filter-chip" data-category="arcade"><span class="dot"></span>Arcade</button>
        <button class="filter-chip" data-category="horror"><span class="dot"></span>Horror</button>
        <button class="filter-chip" data-category="fps"><span class="dot"></span>FPS</button>
        <button class="filter-chip" data-category="sandbox"><span class="dot"></span>Sandbox</button>
        <button class="filter-chip" data-category="movies"><span class="dot"></span>Movies</button>
      </div>
    </section>

    <main class="content" id="mainContent">
      <aside class="sidebar" id="sidebarZone">
        <div class="dev-drag-handle" title="Drag to reorder">⋮⋮</div>
        <div>
          <div class="sidebar-title">Session info</div>
          <div class="sidebar-card">
            <div class="sidebar-card-header">
              <div class="sidebar-card-title">Stealth mode tips</div>
              <span class="badge">School safe*</span>
            </div>
            <p class="sidebar-card-text">
              Rename this tab, change the favicon, and host from a boring-looking URL
              so it blends in with "homework" tabs.
            </p>
            <div class="hint-list">
              <span>• Name suggestion: <strong>Algebra Notes</strong></span>
              <span>• Use a subpage like: <strong>#portal</strong></span>
              <span>• Keep volume low 💀</span>
            </div>
            <a class="small-link" href="https://github.com" target="_blank" rel="noreferrer">
              Manage on GitHub ↗
            </a>
          </div>
        </div>

        <div>
          <div class="sidebar-title">Stats</div>
          <div class="sidebar-card">
            <div class="stat-row"><span>Games loaded</span><strong id="statGames">0</strong></div>
            <div class="stat-row"><span>Filters</span><strong>Search + category</strong></div>
            <div class="stat-row"><span>Status</span><strong style="color:#bbf7d0;">Online</strong></div>
            <p class="sidebar-card-text">
              All links are static. Nothing is stored server-side; it's literally just HTML + JS.
            </p>
          </div>
        </div>
      </aside>

      <section class="library" id="libraryZone">
        <div class="dev-drag-handle" title="Drag to reorder">⋮⋮</div>
        <div class="library-header">
          <div class="library-title">
            <span>Library</span>
            <span class="count" id="resultCountLabel">0 RESULTS</span>
          </div>
          <div class="view-toggle">
            <button class="view-btn active" id="viewLibraryBtn">🎮 Games</button>
            <button class="view-btn" id="viewAppsBtn">📱 Apps</button>
            <button class="view-btn" id="viewPlayerBtn" disabled>▶ Player</button>
            <button class="view-btn" id="viewAnnouncementsBtn">📢 News<span class="btn-badge" id="announcementBadge" style="display:none;">NEW</span></button>
            <button class="view-btn" id="viewSurveyBtn">📋 Survey</button>
            <button class="view-btn" id="viewCustomizeBtn">Customize</button>
            <button class="view-btn" id="viewSettingsBtn">Settings</button>
            <button class="view-btn" id="viewChatBtn">💬 Chat</button>
            <button class="view-btn dev-btn" id="viewDevBtn" onclick="devMode.requestAccess()">⚡ Dev</button>
          </div>
        </div>

        <div class="library-body">
          <div id="libraryView">
            <div id="recentGamesSection" style="display:none;">
              <div class="recent-strip-label">🕒 Recently Played</div>
              <div class="recent-strip" id="recentGamesStrip"></div>
            </div>
            <div id="gameGrid" class="game-grid"></div>
            <div id="emptyState" class="empty-state" style="display:none;">
              <strong>No matches.</strong><br />
              Try clearing the search or switching categories.
            </div>
          </div>

          <!-- App Library View -->
          <div id="appView" style="display:none;">
            <div class="app-category-filters" id="appCategoryFilters">
              <button class="filter-chip active" data-appcategory="all"><span class="dot"></span>All</button>
              <button class="filter-chip" data-appcategory="productivity"><span class="dot"></span>Productivity</button>
              <button class="filter-chip" data-appcategory="creative"><span class="dot"></span>Creative</button>
              <button class="filter-chip" data-appcategory="reference"><span class="dot"></span>Reference</button>
              <button class="filter-chip" data-appcategory="tools"><span class="dot"></span>Tools</button>
              <button class="filter-chip" data-appcategory="media"><span class="dot"></span>Media</button>
            </div>
            <div class="app-grid" id="appGrid"></div>
          </div>

          <div id="playerView" class="player-view">
            <div class="player-header">
              <div class="player-title">
                <span class="main" id="playerGameName">Game name</span>
                <span class="sub" id="playerGameMeta">Category • Opens in iframe</span>
              </div>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn btn-ghost" id="openInNewTabBtn">🔗 Open in new tab</button>
                <button class="btn" id="backToLibraryBtn">⬅ Back to library</button>
              </div>
            </div>
            <div class="player-frame">
              <iframe id="playerIframe" src=""></iframe>
            </div>
          </div>

          <div id="announcementsView" class="announcements-view"></div>

          <div id="surveyView" class="survey-view">
            <div class="survey-container">
              <div class="survey-header">
                <div class="survey-title"><span>📋</span><span>Community Survey</span></div>
                <div style="font-size:0.8rem;color:var(--text-soft);">Help us improve NebulaHub</div>
              </div>
              <div class="survey-frame-container">
                <iframe class="survey-frame" id="surveyFrame" src=""></iframe>
              </div>
            </div>
          </div>

          <div id="customizeView" class="customize-view">
            <div class="customize-grid">
              <div class="customize-card">
                <h3>🎨 Icon & Brand Colors</h3>
                <div class="color-input-group">
                  <label>Logo Primary Color</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="brandColorPicker" value="#22c55e">
                    <input type="text" id="brandColorText" value="#22c55e" placeholder="#22c55e">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Accent Color</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="accentColorPicker" value="#8b5cf6">
                    <input type="text" id="accentColorText" value="#8b5cf6" placeholder="#8b5cf6">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Strong Accent (Highlights)</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="accentStrongPicker" value="#22c55e">
                    <input type="text" id="accentStrongText" value="#22c55e" placeholder="#22c55e">
                  </div>
                </div>
              </div>

              <div class="customize-card">
                <h3>🌌 Background Gradients</h3>
                <div class="color-input-group">
                  <label>Gradient Top-Left</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="bgGrad1Picker" value="#1f2937">
                    <input type="text" id="bgGrad1Text" value="#1f2937" placeholder="#1f2937">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Gradient Bottom-Right</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="bgGrad2Picker" value="#111827">
                    <input type="text" id="bgGrad2Text" value="#111827" placeholder="#111827">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Overlay Tint 1</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="overlay1Picker" value="#3b82f6">
                    <input type="text" id="overlay1Text" value="rgba(59,130,246,0.35)" placeholder="rgba(59,130,246,0.35)">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Overlay Tint 2</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="overlay2Picker" value="#ec4899">
                    <input type="text" id="overlay2Text" value="rgba(236,72,153,0.3)" placeholder="rgba(236,72,153,0.3)">
                  </div>
                </div>
              </div>

              <div class="customize-card">
                <h3>⚡ Quick Presets</h3>
                <div class="preset-grid">
                  <button class="preset-btn" onclick="applyPreset('ocean')">🌊 Ocean</button>
                  <button class="preset-btn" onclick="applyPreset('sunset')">🌅 Sunset</button>
                  <button class="preset-btn" onclick="applyPreset('forest')">🌲 Forest</button>
                  <button class="preset-btn" onclick="applyPreset('crimson')">🔴 Crimson</button>
                  <button class="preset-btn" onclick="applyPreset('gold')">✨ Gold</button>
                  <button class="preset-btn" onclick="applyPreset('purple')">💜 Purple</button>
                  <button class="preset-btn" onclick="applyPreset('neon')">⚡ Neon</button>
                  <button class="preset-btn" onclick="applyPreset('cyber')">🤖 Cyber</button>
                  <button class="preset-btn" onclick="applyPreset('rose')">🌸 Rose</button>
                  <button class="preset-btn" onclick="applyPreset('arctic')">❄️ Arctic</button>
                  <button class="preset-btn" onclick="applyPreset('lava')">🌋 Lava</button>
                  <button class="preset-btn" onclick="applyPreset('nebula')">🌌 Nebula</button>
                </div>
                <div class="theme-active-notice" id="customActiveNotice">
                  ✨ Custom theme active! Select a preset theme from the dropdown above to reset.
                </div>
              </div>

              <div class="customize-card">
                <h3>🔤 Font Style</h3>
                <div class="font-grid">
                  <button class="font-btn active" id="fontBtnSystem" onclick="applyFont('system')">System</button>
                  <button class="font-btn" id="fontBtnMono" onclick="applyFont('mono')" style="font-family:monospace;">Mono</button>
                  <button class="font-btn" id="fontBtnRounded" onclick="applyFont('rounded')" style="font-family:'Trebuchet MS',sans-serif;">Rounded</button>
                  <button class="font-btn" id="fontBtnSerif" onclick="applyFont('serif')" style="font-family:Georgia,serif;">Serif</button>
                </div>
              </div>

              <div class="customize-card">
                <h3>🪟 Interface Feel</h3>
                <div class="customize-range-group">
                  <label>Card Radius <span id="radiusVal">18px</span></label>
                  <input type="range" id="radiusSlider" min="0" max="32" value="18" oninput="applyRadius(this.value)">
                </div>
                <div class="customize-range-group">
                  <label>Glass Blur <span id="glassVal">18px</span></label>
                  <input type="range" id="glassSlider" min="0" max="40" value="18" oninput="applyGlass(this.value)">
                </div>
                <div class="customize-range-group">
                  <label>Card Opacity <span id="opacityVal">97%</span></label>
                  <input type="range" id="opacitySlider" min="60" max="100" value="97" oninput="applyCardOpacity(this.value)">
                </div>
                <div class="starfield-toggle">
                  <span style="font-size:0.85rem;">✨ Starfield Animation</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="starfieldToggle" checked onchange="applyStarfield(this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="starfield-toggle" style="margin-top:6px;">
                  <span style="font-size:0.85rem;">💝 Valentine's Mode</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="valentineToggle" onchange="applyValentineMode(this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div class="customize-card chat-colors">
                <h3>💬 Chat Theme Colors</h3>
                <div class="color-input-group">
                  <label>Sent Message Bubble</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="chatSentPicker" value="#8b5cf6">
                    <input type="text" id="chatSentText" value="#8b5cf6" placeholder="#8b5cf6">
                  </div>
                </div>
                <div class="color-input-group">
                  <label>Chat Background Tint</label>
                  <div class="color-picker-wrapper">
                    <input type="color" id="chatBgPicker" value="#0c1024">
                    <input type="text" id="chatBgText" value="#0c1024" placeholder="#0c1024">
                  </div>
                </div>
                <div class="chat-preview-box" id="chatPreviewBox">
                  <div class="chat-preview-msg received">Hello there! 👋</div>
                  <div class="chat-preview-msg sent">Hey! How's it going?</div>
                </div>
              </div>
            </div>

            <div class="customize-actions">
              <button class="btn btn-primary" onclick="saveCustomTheme()">💾 Save Theme</button>
              <button class="btn btn-secondary" onclick="resetCustomTheme()">↩ Reset to Default</button>
              <button class="btn btn-secondary" onclick="previewTheme()">👁 Preview</button>
            </div>
          </div>

          <div id="settingsView" class="settings-view">
            <div class="settings-grid">
              <div class="settings-card">
                <h3>🕵️ Tab Cloaking</h3>
                <p class="settings-desc">Disguise this site to look like a different tab</p>
                <div class="input-group">
                  <label>Tab Title</label>
                  <input type="text" id="tabTitleInput" placeholder="e.g. Algebra Notes, Google Docs, My Drive" maxlength="50">
                </div>
                <div class="input-group">
                  <label>Tab Icon</label>
                  <div class="favicon-options">
                    <button class="favicon-btn active" data-favicon="default">
                      <span class="favicon-preview default">NH</span>
                      <span>Default</span>
                    </button>
                    <button class="favicon-btn" data-favicon="google">
                      <span class="favicon-preview google">G</span>
                      <span>Google</span>
                    </button>
                    <button class="favicon-btn" data-favicon="classroom">
                      <span class="favicon-preview classroom">C</span>
                      <span>Classroom</span>
                    </button>
                    <button class="favicon-btn" data-favicon="docs">
                      <span class="favicon-preview docs">D</span>
                      <span>Docs</span>
                    </button>
                    <button class="favicon-btn" data-favicon="slides">
                      <span class="favicon-preview slides">S</span>
                      <span>Slides</span>
                    </button>
                  </div>
                </div>
                <div class="customize-actions">
                  <button class="btn btn-primary" onclick="applyTabCloak()">🔄 Apply Cloak</button>
                  <button class="btn btn-secondary" onclick="resetTabCloak()">↩ Reset</button>
                </div>
              </div>

              <div class="settings-card">
                <h3>⚠️ Panic Button</h3>
                <p class="settings-desc">Configure the panic button redirect destination</p>
                <div class="input-group">
                  <label>Panic URL (where 🚨 takes you)</label>
                  <input type="text" id="panicUrlInput" placeholder="https://classroom.google.com" value="https://clever.com/in/dallasisd/student/portal">
                </div>
                <button class="btn btn-primary" onclick="savePanicUrl()" style="margin-top: 8px;">💾 Save Panic URL</button>
              </div>
            </div>
          </div>

          <!-- Developer View -->
          <div id="devView" class="dev-view">
            <div class="dev-grid">
              <div class="dev-card">
                <h3><span>🎛️</span> Layout Editor <span class="dev-badge">Dev</span></h3>
                <div class="dev-section">
                  <span class="dev-label">Drag zones to reorder layout</span>
                  <div class="layout-preview" id="layoutPreview">
                    <div class="layout-zone" data-zone="sidebar" draggable="true">
                      <div class="zone-icon">📊</div>
                      <div class="zone-info">
                        <div class="zone-title">Sidebar</div>
                        <div class="zone-desc">Session info & Stats</div>
                      </div>
                      <div class="zone-toggle active" onclick="devMode.toggleZone('sidebar')"></div>
                    </div>
                    <div class="layout-zone" data-zone="library" draggable="true">
                      <div class="zone-icon">🎮</div>
                      <div class="zone-info">
                        <div class="zone-title">Library</div>
                        <div class="zone-desc">Games grid & Player</div>
                      </div>
                      <div class="zone-toggle active" onclick="devMode.toggleZone('library')"></div>
                    </div>
                  </div>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.saveLayout()">💾 Save Layout</button>
                  <button class="btn btn-secondary" onclick="devMode.resetLayout()">↩ Reset</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🧪</span> Experimental Features</h3>
                <div class="feature-list" id="featureList"></div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; border: 1px solid rgba(245,158,11,0.3);">
                  <div style="font-size: 0.8rem; color: #fde68a; font-weight: 600;">💡 Developer Note</div>
                  <div style="font-size: 0.75rem; color: var(--text-soft); margin-top: 4px;">
                    New features can be registered via <code>devMode.registerFeature()</code>.
                  </div>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🎨</span> Live CSS Editor</h3>
                <div class="dev-section">
                  <span class="dev-label">Custom CSS (injected live)</span>
                  <textarea class="css-editor" id="devCssEditor" placeholder="/* Enter custom CSS here */"></textarea>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.applyCSS()">⚡ Apply CSS</button>
                  <button class="btn btn-secondary" onclick="devMode.clearCSS()">🗑️ Clear</button>
                  <button class="btn btn-success" onclick="devMode.saveCSS()">💾 Save</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>🎮</span> Quick Game Manager</h3>
                <div class="dev-section">
                  <span class="dev-label">Current Games (<span id="devGameCount">0</span>)</span>
                  <div class="game-list-editor" id="devGameList"></div>
                  <button class="add-game-btn" onclick="devMode.showAddGameModal()"><span>+</span> Add New Game</button>
                </div>
              </div>

              <div class="dev-card">
                <h3><span>⚙️</span> Global Configuration</h3>
                <div class="dev-section">
                  <span class="dev-label">Export/Import Settings</span>
                  <textarea class="config-textarea" id="devConfigExport" readonly placeholder="Configuration JSON will appear here..."></textarea>
                </div>
                <div class="dev-actions">
                  <button class="btn btn-primary" onclick="devMode.exportConfig()">📋 Export</button>
                  <button class="btn btn-secondary" onclick="devMode.importConfig()">📥 Import</button>
                  <button class="btn btn-danger" onclick="devMode.resetAll()">⚠️ Reset All</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat View -->
          <div id="chatView" class="chat-view">
            <div class="library-header">
              <div class="library-title">
                <span>💬 NebulaChat</span>
                <span class="count" id="chatUserCount">Live</span>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn" onclick="openFriendsPanel()" style="font-size:0.8rem;padding:6px 12px;">👥 Friends</button>
                <button class="btn" onclick="openNewGroupModal()" style="font-size:0.8rem;padding:6px 12px;">+ Group</button>
              </div>
            </div>
            <div class="chat-container">
              <div class="chat-sidebar" id="chatSidebar">
                <!-- Rendered dynamically by chatRenderSidebar() -->
              </div>
              <div class="chat-main">
                <div class="chat-header">
                  <div class="chat-header-title">
                    <span id="currentRoomIcon">#</span>
                    <span id="currentRoomName">general</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;">
                    <div class="chat-status"><span class="status-dot"></span><span id="connectionStatus">Connecting...</span></div>
                  </div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="typing-indicator" id="typingIndicator">
                  <div class="typing-dots"><span></span><span></span><span></span></div>
                  <span id="typingText"></span>
                </div>
                <div class="chat-input-area">
                  <div class="reply-bar" id="replyBar">
                    <span class="reply-bar-text" id="replyBarText">Replying to <strong id="replyBarName"></strong></span>
                    <button class="reply-cancel" onclick="chatCancelReply()" title="Cancel reply">✕</button>
                  </div>
                  <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." maxlength="500">
                    <button class="chat-send-btn" id="sendMessageBtn">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>NebulaHub • static HTML build</span>
      <span>
        Host this on <a href="https://pages.github.com/" target="_blank" rel="noreferrer">GitHub Pages</a>.
        <span class="portal-link" id="portalLink">Portal mode</span>
      </span>
    </footer>

    <div class="legal-footer">
      <span>© <span id="yearSpan"></span> NebulaHub</span>
      <a href="/about.html">About</a>
      <a href="/privacy.html">Privacy Policy</a>
      <a href="/terms.html">Terms of Use</a>
    </div>
  </div>

  <!-- ============================================================
       SOLAR UI  (visible when mode = 'solar')
       ============================================================ -->
  <div class="nebulahub-ui" id="nebulaHubMinimalUI">
    
    <!-- Animated NebulaHub Logo & Brand -->
    <div class="nebulahub-minimal-brand">
      <svg class="nebulahub-logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="nb1" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#22c55e"/>
            <stop offset="45%" stop-color="#8b5cf6"/>
            <stop offset="100%" stop-color="#030014"/>
          </radialGradient>
          <radialGradient id="nb2" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="1"/>
            <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <!-- Outer glow ring -->
        <circle cx="50" cy="50" r="48" fill="url(#nb1)" opacity="0.85"/>
        <!-- Orbit rings -->
        <ellipse cx="50" cy="50" rx="30" ry="12" fill="none" stroke="#a78bfa" stroke-width="2" opacity="0.7" transform="rotate(-25 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="-25 50 50;335 50 50;-25 50 50" dur="8s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="50" cy="50" rx="40" ry="17" fill="none" stroke="#22c55e" stroke-width="1.5" opacity="0.5" transform="rotate(15 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="15 50 50;375 50 50;15 50 50" dur="13s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="50" cy="50" rx="22" ry="8" fill="none" stroke="#ec4899" stroke-width="1.5" opacity="0.4" transform="rotate(60 50 50)">
          <animateTransform attributeName="transform" type="rotate" values="60 50 50;420 50 50;60 50 50" dur="6s" repeatCount="indefinite"/>
        </ellipse>
        <!-- Core star -->
        <circle cx="50" cy="50" r="8" fill="url(#nb2)"/>
        <circle cx="50" cy="50" r="4.5" fill="white" opacity="0.95"/>
        <!-- Stars -->
        <circle cx="28" cy="30" r="1.5" fill="white" opacity="0.8"/>
        <circle cx="72" cy="27" r="1" fill="white" opacity="0.7"/>
        <circle cx="74" cy="70" r="1.5" fill="#22c55e" opacity="0.9"/>
        <circle cx="23" cy="66" r="1" fill="#a78bfa" opacity="0.8"/>
        <circle cx="60" cy="20" r="1" fill="white" opacity="0.6"/>
        <circle cx="80" cy="52" r="1" fill="#22c55e" opacity="0.7"/>
      </svg>
      <div class="nebulahub-minimal-title">NEBULA<strong>HUB</strong></div>
      <div class="nebulahub-minimal-sub">Your cosmic escape</div>
    </div>

    <!-- Search with Proxy -->
    <div class="nebulahub-search-container">
      <!-- Proxy selector tabs -->
      <div class="proxy-selector" id="proxySelectorBar">
        <button class="proxy-option active" data-proxy="duckduckgo" onclick="selectProxy('duckduckgo', this)">DuckDuckGo</button>
        <button class="proxy-option" data-proxy="google" onclick="selectProxy('google', this)">Google</button>
        <button class="proxy-option" data-proxy="bing" onclick="selectProxy('bing', this)">Bing</button>
        <button class="proxy-option" data-proxy="ultraviolet" onclick="selectProxy('ultraviolet', this)">🔒 UV Proxy</button>
        <button class="proxy-option" data-proxy="direct" onclick="selectProxy('direct', this)">Direct URL</button>
      </div>

      <!-- Search bar -->
      <div class="nebulahub-search-box">
        <input type="text" class="nebulahub-search-input" id="nebulaSearchInput"
          placeholder="Search or enter a URL..."
          onkeypress="handleNebulaSearch(event)">
        <button class="nebulahub-search-submit" onclick="launchNebulaSearch()" title="Search">🔍</button>
      </div>

      <!-- Proxy status indicator -->
      <div class="nebulahub-proxy-status">
        <span class="dot"></span>
        <span id="proxyStatusText">DuckDuckGo · Private search</span>
      </div>
    </div>

    <!-- Search results frame (shows inline results) -->
    <div class="nebulahub-results-frame" id="nebulaResultsFrame">
      <iframe id="nebulaResultsIframe" src="" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>

    <!-- ============================================================
         SOLAR UI — FULL-SCREEN PANELS
         (each panel is position:fixed, toggled via .show class)
         ============================================================ -->

    <!-- LIBRARY PANEL -->
    <div class="minimal-panel" id="mpLibrary">
      <div class="mp-header">
        <div class="mp-title">🎮 <span>Games Library</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpLibrary')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-search-bar">
          <input type="text" class="mp-search-input" id="mpSearchInput" placeholder="Search games...">
        </div>
        <div class="mp-filter-row">
          <button class="mp-chip active" data-mpcat="all" onclick="mpFilterGame(this,'all')">All</button>
          <button class="mp-chip" data-mpcat="arcade" onclick="mpFilterGame(this,'arcade')">Arcade</button>
          <button class="mp-chip" data-mpcat="horror" onclick="mpFilterGame(this,'horror')">Horror</button>
          <button class="mp-chip" data-mpcat="fps" onclick="mpFilterGame(this,'fps')">FPS</button>
          <button class="mp-chip" data-mpcat="sandbox" onclick="mpFilterGame(this,'sandbox')">Sandbox</button>
        </div>
        <div class="mp-game-grid" id="mpGameGrid"></div>
      </div>
    </div>

    <!-- APPS PANEL -->
    <div class="minimal-panel" id="mpApps">
      <div class="mp-header">
        <div class="mp-title">📱 <span>App Library</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpApps')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-filter-row" id="mpAppFilters">
          <button class="mp-chip active" data-appcat="all" onclick="mpFilterApp(this,'all')">All</button>
          <button class="mp-chip" data-appcat="productivity" onclick="mpFilterApp(this,'productivity')">Work</button>
          <button class="mp-chip" data-appcat="creative" onclick="mpFilterApp(this,'creative')">Create</button>
          <button class="mp-chip" data-appcat="reference" onclick="mpFilterApp(this,'reference')">Learn</button>
          <button class="mp-chip" data-appcat="tools" onclick="mpFilterApp(this,'tools')">Tools</button>
          <button class="mp-chip" data-appcat="media" onclick="mpFilterApp(this,'media')">Media</button>
        </div>
        <div class="mp-app-grid" id="mpAppGrid"></div>
      </div>
    </div>

    <!-- PLAYER PANEL -->
    <div class="minimal-panel" id="mpPlayer">
      <div class="mp-header">
        <div class="mp-title">▶️ <span id="mpPlayerTitle">Now Playing</span></div>
        <div style="display:flex;gap:8px;">
          <button class="mp-close" style="width:auto;padding:0 10px;border-radius:999px;" onclick="window.open(mpCurrentGameUrl,'_blank')" title="Open in new tab">🔗</button>
          <button class="mp-close" onclick="closeMinimalPanel('mpPlayer')">✕</button>
        </div>
      </div>
      <div class="mp-player-frame">
        <iframe id="mpPlayerIframe" src="" allowfullscreen></iframe>
      </div>
    </div>

    <!-- NEWS PANEL -->
    <div class="minimal-panel" id="mpNews">
      <div class="mp-header">
        <div class="mp-title">📢 <span>News & Announcements</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpNews')">✕</button>
      </div>
      <div class="mp-body" id="mpNewsBody"></div>
    </div>

    <!-- SURVEY PANEL -->
    <div class="minimal-panel" id="mpSurvey">
      <div class="mp-header">
        <div class="mp-title">📋 <span>Community Survey</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpSurvey')">✕</button>
      </div>
      <iframe class="mp-survey-frame" id="mpSurveyIframe" src=""></iframe>
    </div>

    <!-- CHAT PANEL -->
    <div class="minimal-panel" id="mpChat">
      <div class="mp-header">
        <div class="mp-title">💬 <span>NebulaChat</span> <span style="font-size:0.75rem;color:var(--text-soft);font-weight:400;" id="mpChatStatus">· Connecting...</span></div>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="mp-close" style="width:auto;padding:0 10px;border-radius:999px;font-size:0.75rem;" onclick="openFriendsPanel()">👥</button>
          <button class="mp-close" onclick="closeMinimalPanel('mpChat')">✕</button>
        </div>
      </div>
      <div class="mp-chat-layout">
        <div class="mp-chat-rooms" id="mpChatRooms">
          <!-- Rendered dynamically by chatRenderSidebar() -->
        </div>
        <div class="mp-chat-main">
          <div class="mp-messages" id="mpMessages"></div>
          <div class="mp-chat-input-row">
            <input type="text" class="mp-chat-input" id="mpChatInput" placeholder="Type a message..." maxlength="500" onkeypress="if(event.key==='Enter')chatSend()">
            <button class="mp-chat-send" onclick="chatSend()">➤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOMIZE PANEL -->
    <div class="minimal-panel" id="mpCustomize">
      <div class="mp-header">
        <div class="mp-title">🎨 <span>Customize</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpCustomize')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-setting-group">
          <span class="mp-setting-label">Brand Color</span>
          <div class="mp-color-row"><input type="color" id="mpBrandPicker" oninput="mpSyncColor('mpBrandPicker','mpBrandText','brand')"><input type="text" id="mpBrandText" placeholder="#22c55e" onchange="mpSyncColorText('mpBrandPicker','mpBrandText','brand')"></div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Accent Color</span>
          <div class="mp-color-row"><input type="color" id="mpAccentPicker" oninput="mpSyncColor('mpAccentPicker','mpAccentText','accent')"><input type="text" id="mpAccentText" placeholder="#8b5cf6" onchange="mpSyncColorText('mpAccentPicker','mpAccentText','accent')"></div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Strong Accent</span>
          <div class="mp-color-row"><input type="color" id="mpStrongPicker" oninput="mpSyncColor('mpStrongPicker','mpStrongText','accentStrong')"><input type="text" id="mpStrongText" placeholder="#22c55e" onchange="mpSyncColorText('mpStrongPicker','mpStrongText','accentStrong')"></div>
        </div>
        <div class="mp-setting-group">
        <div class="mp-setting-group">
          <span class="mp-setting-label">Quick Presets</span>
          <div class="mp-preset-grid">
            <button class="mp-preset-btn" onclick="applyPreset('ocean');mpSyncFromMain()">🌊 Ocean</button>
            <button class="mp-preset-btn" onclick="applyPreset('sunset');mpSyncFromMain()">🌅 Sunset</button>
            <button class="mp-preset-btn" onclick="applyPreset('forest');mpSyncFromMain()">🌲 Forest</button>
            <button class="mp-preset-btn" onclick="applyPreset('crimson');mpSyncFromMain()">🔴 Crimson</button>
            <button class="mp-preset-btn" onclick="applyPreset('gold');mpSyncFromMain()">✨ Gold</button>
            <button class="mp-preset-btn" onclick="applyPreset('purple');mpSyncFromMain()">💜 Purple</button>
            <button class="mp-preset-btn" onclick="applyPreset('neon');mpSyncFromMain()">⚡ Neon</button>
            <button class="mp-preset-btn" onclick="applyPreset('cyber');mpSyncFromMain()">🤖 Cyber</button>
            <button class="mp-preset-btn" onclick="applyPreset('rose');mpSyncFromMain()">🌸 Rose</button>
            <button class="mp-preset-btn" onclick="applyPreset('arctic');mpSyncFromMain()">❄️ Arctic</button>
            <button class="mp-preset-btn" onclick="applyPreset('lava');mpSyncFromMain()">🌋 Lava</button>
            <button class="mp-preset-btn" onclick="applyPreset('nebula');mpSyncFromMain()">🌌 Nebula</button>
          </div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Interface Feel</span>
          <div style="display:flex;flex-direction:column;gap:10px;margin-top:6px;">
            <div style="display:flex;flex-direction:column;gap:4px;">
              <label style="font-size:0.72rem;color:var(--text-soft);display:flex;justify-content:space-between;">Card Radius <span id="mpRadiusVal">18px</span></label>
              <input type="range" min="0" max="32" value="18" style="accent-color:var(--custom-accent-color);" oninput="applyRadius(this.value);document.getElementById('mpRadiusVal').textContent=this.value+'px';const s=document.getElementById('radiusSlider');if(s)s.value=this.value;">
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <label style="font-size:0.72rem;color:var(--text-soft);display:flex;justify-content:space-between;">Glass Blur <span id="mpGlassVal">18px</span></label>
              <input type="range" min="0" max="40" value="18" style="accent-color:var(--custom-accent-color);" oninput="applyGlass(this.value);document.getElementById('mpGlassVal').textContent=this.value+'px';const s=document.getElementById('glassSlider');if(s)s.value=this.value;">
            </div>
          </div>
        </div>
        <div class="mp-setting-group">
          <span class="mp-setting-label">Font</span>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
            <button class="mp-btn" onclick="applyFont('system')">System</button>
            <button class="mp-btn" onclick="applyFont('mono')" style="font-family:monospace;">Mono</button>
            <button class="mp-btn" onclick="applyFont('rounded')" style="font-family:'Trebuchet MS';">Rounded</button>
            <button class="mp-btn" onclick="applyFont('serif')" style="font-family:Georgia;">Serif</button>
          </div>
        </div>
        <div class="mp-action-row">
          <button class="mp-btn primary" onclick="applyCustomColors();saveCustomTheme();showNotification('💾 Theme saved!')">💾 Save</button>
          <button class="mp-btn" onclick="resetCustomTheme();mpSyncFromMain()">↩ Reset</button>
          <button class="mp-btn" onclick="applyCustomColors()">👁 Preview</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="minimal-panel" id="mpSettings">
      <div class="mp-header">
        <div class="mp-title">⚙️ <span>Settings</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpSettings')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-section-title">🕵️ Tab Cloaking</div>
        <div class="mp-input-group">
          <label>Tab Title</label>
          <input type="text" id="mpTabTitle" placeholder="e.g. Algebra Notes" maxlength="50">
        </div>
        <div class="mp-input-group">
          <label>Tab Icon</label>
          <div class="mp-favicon-grid">
            <button class="mp-fav-btn active" data-mpfav="default" onclick="mpSelectFav(this,'default')">
              <span class="mp-fav-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a);">NH</span>
              <span class="mp-fav-label">Default</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="google" onclick="mpSelectFav(this,'google')">
              <span class="mp-fav-icon" style="background:#4285F4;">G</span>
              <span class="mp-fav-label">Google</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="classroom" onclick="mpSelectFav(this,'classroom')">
              <span class="mp-fav-icon" style="background:#24a865;">C</span>
              <span class="mp-fav-label">Class</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="docs" onclick="mpSelectFav(this,'docs')">
              <span class="mp-fav-icon" style="background:#4285F4;">D</span>
              <span class="mp-fav-label">Docs</span>
            </button>
            <button class="mp-fav-btn" data-mpfav="slides" onclick="mpSelectFav(this,'slides')">
              <span class="mp-fav-icon" style="background:#fbbc04;">S</span>
              <span class="mp-fav-label">Slides</span>
            </button>
          </div>
        </div>
        <div class="mp-action-row" style="margin-bottom:20px;">
          <button class="mp-btn primary" onclick="mpApplyCloak()">🔄 Apply Cloak</button>
          <button class="mp-btn" onclick="resetTabCloak();document.getElementById('mpTabTitle').value='';">↩ Reset</button>
        </div>

        <div class="mp-section-title">⚠️ Panic Button</div>
        <div class="mp-input-group">
          <label>Panic URL</label>
          <input type="text" id="mpPanicUrl" placeholder="https://classroom.google.com">
        </div>
        <div class="mp-action-row" style="margin-bottom:20px;">
          <button class="mp-btn primary" onclick="mpSavePanic()">💾 Save</button>
        </div>

        <div class="mp-section-title">🎨 Theme</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="mp-btn" onclick="mpSetTheme('nebula')">🌌 Nebula</button>
          <button class="mp-btn" onclick="mpSetTheme('midnight')">🌙 Midnight</button>
          <button class="mp-btn" onclick="mpSetTheme('bubblegum')">🍬 Bubblegum</button>
          <button class="mp-btn" onclick="mpSetTheme('matrix')">💚 Matrix</button>
          <button class="mp-btn" onclick="mpSetTheme('minecraft')">🟩 Minecraft</button>
        </div>
      </div>
    </div>

    <!-- DEV PANEL -->
    <div class="minimal-panel" id="mpDev">
      <div class="mp-header">
        <div class="mp-title">🛠️ <span>Dev Tools</span> <span style="background:linear-gradient(135deg,#ef4444,#f97316);color:white;padding:2px 8px;border-radius:999px;font-size:0.65rem;font-weight:800;margin-left:4px;">DEV</span></div>
        <button class="mp-close" onclick="closeMinimalPanel('mpDev')">✕</button>
      </div>
      <div class="mp-body">
        <div class="mp-dev-grid">
          <!-- Features -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🧪 Feature Flags</div>
            <div id="mpFeatureList"></div>
          </div>
          <!-- CSS -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🎨 Live CSS</div>
            <textarea class="mp-css-editor" id="mpCssEditor" placeholder="/* custom CSS */"></textarea>
            <div class="mp-action-row" style="margin-top:8px;">
              <button class="mp-btn primary" onclick="mpApplyCSS()">⚡ Apply</button>
              <button class="mp-btn" onclick="mpClearCSS()">🗑️ Clear</button>
              <button class="mp-btn" onclick="devMode.saveCSS();showNotification('💾 Saved')">💾 Save</button>
            </div>
          </div>
          <!-- Game Manager -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">🎮 Game Manager <span style="font-size:0.72rem;color:var(--text-soft);font-weight:400;">(<span id="mpGameCount">0</span>)</span></div>
            <div class="mp-game-editor-list" id="mpGameEditorList"></div>
            <button class="mp-add-btn" onclick="devMode.showAddGameModal();mpRenderGameEditor()">+ Add Game</button>
          </div>
          <!-- Config -->
          <div class="mp-dev-card">
            <div class="mp-dev-card-title">⚙️ Config</div>
            <textarea class="mp-config-area" id="mpConfigArea" readonly placeholder="Export JSON appears here..."></textarea>
            <div class="mp-action-row" style="margin-top:8px;">
              <button class="mp-btn primary" onclick="mpExportConfig()">📋 Export</button>
              <button class="mp-btn" onclick="devMode.importConfig()">📥 Import</button>
              <button class="mp-btn danger" onclick="devMode.resetAll()">⚠️ Reset All</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

    <!-- ============================================================
         BOTTOM DOCK  (shared between Solar UI and Full Hub)
         ============================================================ -->
    <div class="nebulahub-dock" id="nebulaHubDock">
      <!-- Profile avatar in dock -->
      <div class="dock-profile-avatar" id="dockProfileAvatar" onclick="openProfilePanel()" data-tip="Profile">
        <span id="dockProfileInitials">?</span>
        <img id="dockProfileAvatarImg" src="" alt="" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
      </div>

      <!-- Back to full UI -->
      <div class="nebulahub-dock-item" onclick="switchUI('nebulahub')" data-tip="Full Hub">🌌</div>

      <!-- Library / Games -->
      <div class="nebulahub-dock-item" onclick="openDockTab('library',this)" data-tip="Games Library">🎮</div>

      <!-- App Library -->
      <div class="nebulahub-dock-item" onclick="openDockTab('apps',this)" data-tip="App Library">📱</div>

      <!-- Announcements / News -->
      <div class="nebulahub-dock-item" onclick="openDockTab('news',this)" data-tip="News & Announcements">📢</div>

      <!-- Survey -->
      <div class="nebulahub-dock-item" onclick="openDockTab('survey',this)" data-tip="Community Survey">📋</div>

      <!-- Chat -->
      <div class="nebulahub-dock-item" onclick="openDockTab('chat',this)" data-tip="NebulaChat">💬</div>

      <!-- Friends -->
      <div class="nebulahub-dock-item" onclick="openFriendsPanel()" data-tip="Friends">👥</div>

      <!-- Customize -->
      <div class="nebulahub-dock-item" onclick="openDockTab('customize',this)" data-tip="Customize">🎨</div>

      <!-- Settings -->
      <div class="nebulahub-dock-item" onclick="openDockTab('settings',this)" data-tip="Settings">⚙️</div>

      <!-- Player -->
      <div class="nebulahub-dock-item" onclick="openDockTab('player',this)" data-tip="Now Playing">▶️</div>

      <!-- Dev -->
      <div class="nebulahub-dock-item" onclick="openDockTab('dev',this)" data-tip="Dev Tools">🛠️</div>

      <div class="nebulahub-dock-divider"></div>

      <!-- Panic -->
      <div class="nebulahub-dock-item" onclick="panicHide()" data-tip="Panic!">🚨</div>

      <div class="nebulahub-dock-divider"></div>

      <!-- Clock -->
      <div class="nebulahub-dock-time" id="nebulaTime">00:00</div>
    </div>

  <!-- ============================================================
       MODALS
       ============================================================ -->

  <!-- ============================================================
       AUTH GATE — shown to logged-out users
       ============================================================ -->
  <div class="auth-gate hidden" id="authGate">
    <div class="auth-card">
      <div class="auth-logo">NH</div>
      <h2 class="auth-heading">Welcome to NebulaHub</h2>
      <p class="auth-sub">Sign in to save your profile, settings, and play history</p>

      <div class="auth-tabs">
        <button class="auth-tab active" id="tabSignIn" onclick="authSwitchTab('signin')">Sign In</button>
        <button class="auth-tab" id="tabSignUp" onclick="authSwitchTab('signup')">Create Account</button>
      </div>

      <!-- Sign In Form -->
      <form class="auth-form" id="authSignInForm" onsubmit="authSignIn(event)">
        <div class="auth-field">
          <label>Email</label>
          <input class="auth-input" type="email" id="siEmail" placeholder="you@example.com" required autocomplete="email">
        </div>
        <div class="auth-field">
          <label>Password</label>
          <input class="auth-input" type="password" id="siPassword" placeholder="••••••••" required autocomplete="current-password">
        </div>
        <div class="auth-error" id="siError"></div>
        <button class="auth-btn" type="submit" id="siBtnSubmit">Sign In →</button>
        <div class="auth-divider"><span>or</span></div>
        <button class="auth-btn" type="button" id="siGuestBtn" onclick="authContinueAsGuest()"
          style="background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.3); color: var(--text-soft);">
          Continue as Guest
        </button>
      </form>

      <!-- Sign Up Form -->
      <form class="auth-form hidden" id="authSignUpForm" onsubmit="authSignUp(event)">
        <div class="auth-field">
          <label>Username</label>
          <input class="auth-input" type="text" id="suUsername" placeholder="cosmicgamer" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+">
          <span style="font-size:0.7rem;color:var(--text-soft);margin-top:3px;">Letters, numbers, underscores only</span>
        </div>
        <div class="auth-field">
          <label>Email</label>
          <input class="auth-input" type="email" id="suEmail" placeholder="you@example.com" required autocomplete="email">
        </div>
        <div class="auth-field">
          <label>Password</label>
          <input class="auth-input" type="password" id="suPassword" placeholder="••••••••" required minlength="6" autocomplete="new-password">
        </div>
        <div class="auth-error" id="suError"></div>
        <div class="auth-success" id="suSuccess">✅ Account created! Check your email to confirm, then sign in.</div>
        <button class="auth-btn" type="submit" id="suBtnSubmit">Create Account →</button>
        <div class="auth-divider"><span>or</span></div>
        <button class="auth-btn" type="button" onclick="authContinueAsGuest()"
          style="background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.3); color: var(--text-soft);">
          Continue as Guest
        </button>
      </form>
    </div>
  </div>

  <!-- ============================================================
       PROFILE PANEL
       ============================================================ -->
  <div class="profile-panel" id="profilePanel">
    <div class="profile-panel-header">
      <div class="profile-panel-title">👤 Your Profile</div>
      <button class="mp-close" onclick="closeProfilePanel()">✕</button>
    </div>
    <div class="profile-panel-body">

      <!-- Left: Profile Preview Card -->
      <div>
        <div class="profile-card">
          <!-- Banner -->
          <div class="profile-banner" id="profileBannerPreview" onclick="document.getElementById('bannerFileInput').click()" title="Click to change banner">
            <img id="profileBannerImg" src="" alt="" style="display:none;">
          </div>
          <input type="file" id="bannerFileInput" accept="image/*" onchange="profileHandleBannerUpload(this)">
          <!-- Avatar -->
          <div class="profile-avatar-wrap" id="profileAvatarPreview" onclick="document.getElementById('avatarFileInput').click()" title="Click to change avatar">
            <span id="profileAvatarInitials">?</span>
            <img id="profileAvatarImg" src="" alt="" style="display:none;">
          </div>
          <input type="file" id="avatarFileInput" accept="image/*" onchange="profileHandleAvatarUpload(this)">
          <!-- Info -->
          <div class="profile-info">
            <div class="profile-display-name" id="profileDisplayNamePreview">Loading...</div>
            <div class="profile-username" id="profileUsernamePreview">@...</div>
            <div class="profile-badge" id="profileBadgePreview">⭐ Member</div>
            <div class="profile-bio" id="profileBioPreview">No bio yet.</div>
            <div class="profile-stats">
              <div class="profile-stat">
                <div class="profile-stat-num" id="profileGamesPlayed">0</div>
                <div class="profile-stat-label">Games</div>
              </div>
              <div class="profile-stat">
                <div class="profile-stat-num" id="profileJoinDate">—</div>
                <div class="profile-stat-label">Joined</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sign out -->
        <button class="profile-signout-btn" onclick="authSignOut()">🚪 Sign Out</button>
      </div>

      <!-- Right: Edit Columns -->
      <div class="profile-edit-col">

        <!-- Basic Info -->
        <div class="profile-section">
          <div class="profile-section-title">✏️ Basic Info</div>
          <div class="profile-field">
            <label>Display Name</label>
            <input type="text" id="editDisplayName" maxlength="30" placeholder="Your display name">
          </div>
          <div class="profile-field">
            <label>Username</label>
            <input type="text" id="editUsername" maxlength="20" placeholder="username" pattern="[a-zA-Z0-9_]+">
          </div>
          <div class="profile-field">
            <label>Bio <span style="color:var(--text-soft);font-weight:400;">(max 200 chars)</span></label>
            <textarea id="editBio" rows="3" maxlength="200" placeholder="Tell the world about yourself..."></textarea>
            <div class="profile-char-count"><span id="bioCharCount">0</span>/200</div>
          </div>
        </div>

        <!-- Avatar -->
        <div class="profile-section">
          <div class="profile-section-title">🖼️ Profile Picture</div>
          <div class="avatar-grid" id="avatarPresetGrid">
            <!-- Emoji avatars — filled by JS -->
          </div>
          <div class="upload-zone" onclick="document.getElementById('avatarFileInput').click()">
            <div style="font-size:1.5rem;margin-bottom:6px;">📁</div>
            <div>Click to upload a photo</div>
            <div style="font-size:0.72rem;margin-top:4px;">JPG, PNG, WebP — max 2MB</div>
          </div>
        </div>

        <!-- Background -->
        <div class="profile-section">
          <div class="profile-section-title">🎨 NebulaHub Background</div>
          <div class="bg-type-row">
            <button class="bg-type-btn active" data-bgtype="default" onclick="bgTypeSelect(this,'default')">Default</button>
            <button class="bg-type-btn" data-bgtype="color" onclick="bgTypeSelect(this,'color')">Solid</button>
            <button class="bg-type-btn" data-bgtype="gradient" onclick="bgTypeSelect(this,'gradient')">Gradient</button>
            <button class="bg-type-btn" data-bgtype="image" onclick="bgTypeSelect(this,'image')">Image</button>
          </div>
          <div class="bg-presets" id="bgPresets"></div>
          <div class="bg-custom-input" id="bgCustomInput">
            <div class="profile-field">
              <label id="bgCustomLabel">Custom value</label>
              <input type="text" id="bgCustomValue" placeholder="#1a1a2e">
            </div>
          </div>
          <div class="bg-custom-input" id="bgImageUpload">
            <div class="upload-zone" onclick="document.getElementById('bgFileInput').click()">
              <div style="font-size:1.5rem;margin-bottom:6px;">🖼️</div>
              <div>Upload background image</div>
              <div style="font-size:0.72rem;margin-top:4px;">JPG, PNG, WebP — max 5MB</div>
            </div>
            <input type="file" id="bgFileInput" accept="image/*" style="display:none;" onchange="profileHandleBgUpload(this)">
          </div>
        </div>

        <!-- Save button -->
        <button class="profile-save-btn" id="profileSaveBtn" onclick="profileSave()">
          💾 Save Profile
        </button>
      </div>
    </div>
  </div>

  <!-- Username Setup Modal (legacy — kept for guests) -->
  <div id="usernameModal" class="username-modal" style="display:none;">
    <div class="username-card">
      <h2>👋 Welcome to NebulaChat</h2>
      <p>Choose a display name to join the conversation</p>
      <div class="username-input-group">
        <input type="text" id="usernameInput" placeholder="Enter username..." maxlength="20">
      </div>
      <button class="btn btn-primary" onclick="saveChatUser()" style="width:100%; justify-content:center;">Join Chat</button>
    </div>
  </div>

  <!-- ============================================================
       FRIENDS PANEL
       ============================================================ -->
  <div class="friends-panel" id="friendsPanel">
    <div class="profile-panel-header">
      <div class="profile-panel-title">👥 Friends</div>
      <div style="display:flex;gap:8px;">
        <button class="mp-close" style="width:auto;padding:0 14px;border-radius:999px;font-size:0.8rem;" onclick="openNewGroupModal()">+ Group Chat</button>
        <button class="mp-close" onclick="closeFriendsPanel()">✕</button>
      </div>
    </div>
    <div class="friends-layout">
      <!-- Left: friends list -->
      <div class="friends-sidebar">
        <!-- Pending requests -->
        <div id="friendRequestsSection" style="padding:12px;border-bottom:1px solid rgba(148,163,184,0.1);display:none;">
          <div class="chat-section-label" style="padding-bottom:8px;">Pending Requests</div>
          <div id="friendRequestsList"></div>
        </div>
        <!-- Online friends -->
        <div style="padding:12px 12px 0;">
          <div class="chat-section-label">
            Friends — <span id="friendsOnlineCount">0</span> online
          </div>
        </div>
        <div class="friends-list" id="friendsList">
          <div style="text-align:center;padding:32px 12px;color:var(--text-soft);font-size:0.85rem;">
            <div style="font-size:2rem;margin-bottom:8px;">👾</div>
            No friends yet. Add one below!
          </div>
        </div>
        <!-- Add friend bar -->
        <div class="add-friend-bar">
          <div style="font-size:0.72rem;color:var(--text-soft);margin-bottom:6px;">Add by username</div>
          <div class="add-friend-row">
            <input class="add-friend-input" id="addFriendInput" placeholder="username" maxlength="30"
              onkeypress="if(event.key==='Enter')friendSendRequest()">
            <button class="add-friend-btn" onclick="friendSendRequest()">Add</button>
          </div>
          <div id="addFriendResult" style="font-size:0.75rem;margin-top:6px;min-height:16px;"></div>
        </div>
      </div>
      <!-- Right: detail / empty state -->
      <div class="friends-detail" id="friendsDetail">
        <div class="friends-empty-icon">👥</div>
        <div style="font-weight:700;color:var(--text);margin-bottom:6px;">Your Friends</div>
        <div style="font-size:0.84rem;">Select a friend to message or start a group chat</div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       NEW GROUP CHAT MODAL
       ============================================================ -->
  <div class="modal-overlay" id="newGroupModal">
    <div class="modal-card">
      <div class="modal-title">👥 New Group Chat</div>
      <div class="modal-field">
        <label>Group Name</label>
        <input class="modal-input" id="newGroupName" placeholder="e.g. Squad Goals" maxlength="40">
      </div>
      <div class="modal-field">
        <label>Add Friends</label>
        <div class="modal-member-list" id="groupMemberList">
          <!-- filled by JS -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn ghost" onclick="closeNewGroupModal()">Cancel</button>
        <button class="modal-btn primary" onclick="chatCreateGroup()">Create Group</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       SPOTLIGHT SEARCH
       ============================================================ -->
  <div class="spotlight-overlay" id="spotlightOverlay" onclick="spotlightClose(event)">
    <div class="spotlight-box">
      <div class="spotlight-input-row">
        <span class="spotlight-icon">🔍</span>
        <input class="spotlight-input" id="spotlightInput" placeholder="Search games, apps, friends, views..."
          oninput="spotlightSearch(this.value)" onkeydown="spotlightKey(event)" autocomplete="off">
        <span class="spotlight-esc">ESC</span>
      </div>
      <div class="spotlight-results" id="spotlightResults">
        <div class="spotlight-empty">Start typing to search everything in NebulaHub</div>
      </div>
    </div>
  </div>

  <!-- Dev Auth Modal -->
  <div id="devAuthModal" class="dev-auth-modal">
    <div class="dev-auth-card">
      <h2>⚡ Developer Access</h2>
      <p>Enter password to access developer tools</p>
      <div class="password-input-group">
        <input type="password" id="devPasswordInput" placeholder="••••••••" maxlength="20">
      </div>
      <button class="btn btn-primary" onclick="devMode.authenticate()" style="width:100%; justify-content:center;">Unlock Dev Mode</button>
      <button class="btn btn-ghost" onclick="devMode.closeAuth()" style="width:100%; justify-content:center; margin-top: 8px;">Cancel</button>
    </div>
  </div>

  <!-- Update Modal -->
  <div id="updateModal" class="update-modal">
    <div class="update-card">
      <div class="update-header">
        <div class="update-title" id="updateTitle">🚀 What's New</div>
        <div class="update-date" id="updateDate">January 28, 2026</div>
      </div>
      <div class="update-body">
        <ul class="update-list" id="updateList"></ul>
      </div>
      <div class="update-footer">
        <label class="checkbox-label">
          <input type="checkbox" id="dontShowAgain">
          Don't show again until next update
        </label>
        <button class="btn btn-primary" onclick="closeUpdateModal()">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Dev Access Indicator -->
  <div class="dev-access-indicator" id="devIndicator" onclick="devMode.lock()">
    <span>⚡</span>
    <span>DEV MODE ACTIVE (Click to lock)</span>
  </div>

  <script>
    /* ============================================================
       NEBULAHUB — JAVASCRIPT
       ============================================================
       TABLE OF CONTENTS
       ----------------------------------------------------------
       §1   PROXY CONFIGURATION         (search engines & UV proxy)
       §2   SOLAR UI PANEL SYSTEM       (open/close full-screen panels)
       §3   SOLAR UI — LIBRARY PANEL    (game grid, search, filter)
       §4   SOLAR UI — NEWS PANEL       (announcements renderer)
       §5   SOLAR UI — SURVEY PANEL     (Google Form iframe)
       §6   SOLAR UI — CHAT PANEL       (room switching, send, render)
       §7   SOLAR UI — CUSTOMIZE PANEL  (color pickers sync)
       §8   SOLAR UI — SETTINGS PANEL   (cloak, panic, theme)
       §9   SOLAR UI — DEV PANEL        (features, CSS editor, game mgr)
       §10  DOCK TAB HANDLER            (routes dock clicks → correct UI)
       §11  UI TOGGLE SYSTEM            (switchUI, Solar ↔ Full Hub)
       §12  ANNOUNCEMENTS               (data array + MAX_DISPLAYED)
       §13  SURVEY                      (SURVEY_URL constant)
       §14  UPDATE MODAL CONFIG         (version, changelog entries)
       §15  FAVICONS                    (tab-cloak icon presets)
       §16  GAME LIBRARY DATA           (games[] array — add games here)
       §17  CORE STATE VARIABLES        (activeCategory, activeGame…)
       §18  ANNOUNCEMENTS SYSTEM        (render, badge, unread count)
       §19  SURVEY SYSTEM               (renderSurveyView)
       §20  DEVELOPER MODE SYSTEM       (devMode object — auth, features)
       §21  CUSTOMIZATION SYSTEM        (colors, presets, applyCustomColors)
       §22  TAB CLOAKING SYSTEM         (title + favicon spoofing)
       §23  UPDATE MODAL                (showUpdateModal, close)
       §24  CORE FUNCTIONS              (renderGrid, showView helpers)
       §25  NEBULACHAT SYSTEM           (Supabase realtime chat)
       §26  INIT                        (DOMContentLoaded bootstrap)
       ============================================================ */

    // ================================================================
    // §1  PROXY CONFIGURATION
    // ================================================================
    let activeProxy = 'duckduckgo';

    const PROXY_CONFIG = {
      duckduckgo: {
        label: 'DuckDuckGo · Private search',
        buildUrl: (query) => `https://duckduckgo.com/?q=${encodeURIComponent(query)}&kae=d`,
        isSearch: true
      },
      google: {
        label: 'Google · Standard search',
        buildUrl: (query) => `https://www.google.com/search?q=${encodeURIComponent(query)}`,
        isSearch: true
      },
      bing: {
        label: 'Bing · Microsoft search',
        buildUrl: (query) => `https://www.bing.com/search?q=${encodeURIComponent(query)}`,
        isSearch: true
      },
      ultraviolet: {
        label: '🔒 UV Proxy · Bypass filters',
        buildUrl: (query) => {
          // Ultraviolet proxy (common self-hosted path)
          const encoded = btoa(query.startsWith('http') ? query : `https://${query}`);
          return `/~/uv/service/${encoded}`;
        },
        isSearch: false,
        note: 'Requires UV proxy server'
      },
      direct: {
        label: 'Direct URL · Open in new tab',
        buildUrl: (query) => {
          if (query.startsWith('http')) return query;
          return `https://${query}`;
        },
        isSearch: false,
        openNew: true
      }
    };

    function selectProxy(proxyKey, btn) {
      activeProxy = proxyKey;
      // Update active button
      document.querySelectorAll('.proxy-option').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Update status text
      const cfg = PROXY_CONFIG[proxyKey];
      document.getElementById('proxyStatusText').textContent = cfg.label;
      // Update placeholder
      const input = document.getElementById('nebulaSearchInput');
      if (cfg.isSearch) {
        input.placeholder = 'Search or enter a URL...';
      } else if (proxyKey === 'direct') {
        input.placeholder = 'Enter URL (e.g. github.com)...';
      } else {
        input.placeholder = 'Enter URL to proxy...';
      }
    }

    function handleNebulaSearch(event) {
      if (event.key === 'Enter') launchNebulaSearch();
    }

    function launchNebulaSearch() {
      const query = document.getElementById('nebulaSearchInput').value.trim();
      if (!query) return;

      const cfg = PROXY_CONFIG[activeProxy];
      const url = cfg.buildUrl(query);

      if (cfg.openNew) {
        window.open(url, '_blank');
        document.getElementById('nebulaSearchInput').value = '';
        return;
      }

      // Show results in inline frame
      const frame = document.getElementById('nebulaResultsFrame');
      const iframe = document.getElementById('nebulaResultsIframe');
      iframe.src = url;
      frame.classList.add('show');
      document.getElementById('nebulaSearchInput').value = '';
    }

    // ================================================================
    // §2  SOLAR UI PANEL SYSTEM
    // ================================================================
    let mpActivePanel = null;
    let mpCurrentGameUrl = '';
    let mpActiveCategory = 'all';

    const MP_PANELS = ['mpLibrary','mpApps','mpPlayer','mpNews','mpSurvey','mpChat','mpCustomize','mpSettings','mpDev'];

    function closeAllMinimalPanels() {
      MP_PANELS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('show');
      });
      // Also hide search results
      document.getElementById('nebulaResultsFrame').classList.remove('show');
      mpActivePanel = null;
      // Remove active state from dock items
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => d.classList.remove('active-dock-item'));
    }

    function openMinimalPanel(panelId, dockEl) {
      if (mpActivePanel === panelId) {
        // Toggle off if already open
        closeAllMinimalPanels();
        return;
      }
      closeAllMinimalPanels();
      mpActivePanel = panelId;
      const panel = document.getElementById(panelId);
      if (panel) panel.classList.add('show');
      if (dockEl) dockEl.classList.add('active-dock-item');
    }

    function closeMinimalPanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) panel.classList.remove('show');
      if (mpActivePanel === panelId) mpActivePanel = null;
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => d.classList.remove('active-dock-item'));
    }

    // ----------------------------------------------------------------
    // §3  SOLAR UI — LIBRARY PANEL
    // ----------------------------------------------------------------
    function mpRenderLibrary() {
      const query = (document.getElementById('mpSearchInput')?.value || '').toLowerCase().trim();
      const grid = document.getElementById('mpGameGrid');
      if (!grid) return;

      const filtered = games.filter(g => {
        const catMatch = mpActiveCategory === 'all' || g.category === mpActiveCategory;
        const hay = (g.name + ' ' + (g.tags||[]).join(' ')).toLowerCase();
        return catMatch && (query === '' || hay.includes(query));
      });

      grid.innerHTML = filtered.map((g, i) => {
        const initials = g.name.split(' ').map(w => w[0]?.toUpperCase()||'').join('').slice(0,3);
        // Use data-index to avoid quote-escaping issues in onclick
        const idx = games.indexOf(g);
        return `
          <div class="mp-game-card" data-game-idx="${idx}" onclick="mpOpenGameByIndex(this)">
            <div class="mp-game-thumb">${initials}</div>
            <div class="mp-game-name" title="${g.name}">${g.name}</div>
            <div class="mp-game-cat">${(g.category||'game').toUpperCase()}</div>
          </div>
        `;
      }).join('') || '<div style="padding:20px;text-align:center;color:var(--text-soft);">No matches found.</div>';
    }

    function mpOpenGameByIndex(cardEl) {
      const idx = parseInt(cardEl.getAttribute('data-game-idx'), 10);
      const g = games[idx];
      if (!g) return;
      mpOpenGame(g.url, g.name);
    }

    function mpFilterGame(btn, cat) {
      mpActiveCategory = cat;
      document.querySelectorAll('.mp-chip').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      mpRenderLibrary();
    }

    function mpOpenGame(url, name) {
      mpCurrentGameUrl = url;
      document.getElementById('mpPlayerTitle').textContent = name;
      document.getElementById('mpPlayerIframe').src = url;
      activeGame = { name, url, category: 'game', tags: [] };

      // Close all panels (including library), then open player — Solar UI tab navigation
      closeAllMinimalPanels();
      mpActivePanel = 'mpPlayer';
      document.getElementById('mpPlayer').classList.add('show');
      // Highlight the ▶️ dock icon
      document.querySelectorAll('.nebulahub-dock-item').forEach(d => {
        if (d.getAttribute('data-tip') === 'Now Playing') d.classList.add('active-dock-item');
      });
    }

    // ----------------------------------------------------------------
    // §4  SOLAR UI — NEWS PANEL
    // ----------------------------------------------------------------
    function mpRenderNews() {
      const body = document.getElementById('mpNewsBody');
      if (!body) return;

      if (!ANNOUNCEMENTS.length) {
        body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-soft);">📭 No announcements yet.</div>';
        return;
      }

      const sorted = [...ANNOUNCEMENTS].sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, MAX_DISPLAYED_ANNOUNCEMENTS);
      body.innerHTML = sorted.map(ann => `
        <div class="mp-announcement ${ann.type||'normal'}">
          ${ann.badge ? `<div class="mp-ann-badge">${ann.badge}</div>` : ''}
          <div class="mp-ann-title">${ann.title}</div>
          <div class="mp-ann-date">${ann.date}</div>
          ${ann.image ? `<img src="${ann.image}" style="width:100%;border-radius:10px;margin:8px 0;" alt="">` : ''}
          ${ann.gif ? `<img src="${ann.gif}" style="width:100%;border-radius:10px;margin:8px 0;" alt="">` : ''}
          <div class="mp-ann-content">${ann.content.replace(/\n/g,'<br>')}</div>
        </div>
      `).join('');

      // Mark as seen
      const latestId = Math.max(...ANNOUNCEMENTS.map(a=>a.id));
      localStorage.setItem('nebulahub-last-announcement', latestId);
      document.getElementById('announcementBadge').style.display = 'none';
    }

    // ----------------------------------------------------------------
    // §5  SOLAR UI — SURVEY PANEL
    // ----------------------------------------------------------------
    function mpOpenSurvey() {
      const iframe = document.getElementById('mpSurveyIframe');
      if (!iframe) return;
      if (SURVEY_URL && SURVEY_URL !== 'https://forms.gle/gsBVKuUB9vhhrRNr9') {
        iframe.src = SURVEY_URL;
      } else {
        iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#9ca3af;text-align:center;padding:40px;background:#020617;"><div><div style="font-size:3rem;margin-bottom:16px;">📋</div><h3 style="color:#e5e7eb;margin-bottom:8px;">No survey configured</h3><p>Edit SURVEY_URL in the script.</p></div></div>';
      }
    }

    // ----------------------------------------------------------------
    // ----------------------------------------------------------------
    // §6  SOLAR UI — CHAT PANEL  (delegates to shared chatSend / chatRenderSidebar)
    // ----------------------------------------------------------------
    function mpSwitchRoom(btn, chatId) {
      document.querySelectorAll('.mp-room-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      chatSwitchRoom(chatId);
    }

    // Patch initSupabase to update mpChatStatus
    function initSupabase() {
      if (window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) statusEl.textContent = 'Connected';
        const mpStatus = document.getElementById('mpChatStatus');
        if (mpStatus) mpStatus.textContent = '· Connected';
        initAuthAndProfile();
      } else {
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) statusEl.textContent = 'Error';
      }
    }

    // ----------------------------------------------------------------
    // §7  SOLAR UI — CUSTOMIZE PANEL
    // ----------------------------------------------------------------
    function mpSyncFromMain() {
      // Sync mp pickers from main customColors
      const mp = {
        mpBrandPicker: customColors.brand,
        mpAccentPicker: customColors.accent,
        mpStrongPicker: customColors.accentStrong
      };
      Object.entries(mp).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      });
      const texts = {
        mpBrandText: customColors.brand,
        mpAccentText: customColors.accent,
        mpStrongText: customColors.accentStrong
      };
      Object.entries(texts).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      });
    }

    function mpSyncColor(pickerId, textId, colorKey) {
      const val = document.getElementById(pickerId).value;
      document.getElementById(textId).value = val;
      customColors[colorKey] = val;
      // Also sync main pickers
      const mainMap = { brand: 'brandColorPicker', accent: 'accentColorPicker', accentStrong: 'accentStrongPicker' };
      const mainPicker = document.getElementById(mainMap[colorKey]);
      if (mainPicker) mainPicker.value = val;
    }

    function mpSyncColorText(pickerId, textId, colorKey) {
      const val = document.getElementById(textId).value;
      document.getElementById(pickerId).value = val;
      customColors[colorKey] = val;
    }

    function mpOpenCustomize() {
      mpSyncFromMain();
    }

    // ----------------------------------------------------------------
    // §8  SOLAR UI — SETTINGS PANEL
    // ----------------------------------------------------------------
    function mpSelectFav(btn, favKey) {
      document.querySelectorAll('.mp-fav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Sync main settings
      document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
      const mainBtn = document.querySelector(`[data-favicon="${favKey}"]`);
      if (mainBtn) mainBtn.classList.add('active');
    }

    function mpApplyCloak() {
      const title = document.getElementById('mpTabTitle').value.trim();
      if (title) {
        document.getElementById('tabTitleInput').value = title;
      }
      applyTabCloak();
      showNotification('🕵️ Cloak applied!');
    }

    function mpSavePanic() {
      const url = document.getElementById('mpPanicUrl').value.trim();
      if (url) {
        document.getElementById('panicUrlInput').value = url;
        panicUrl = url;
        localStorage.setItem('nebulahub-panic-url', url);
        showNotification('💾 Panic URL saved!');
      }
    }

    function mpSetTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('site-theme', theme);
      document.getElementById('themeSelector').value = theme;
      showNotification(`🎨 Theme: ${theme}`);
    }

    // ----------------------------------------------------------------
    // §9  SOLAR UI — DEV PANEL
    // ----------------------------------------------------------------
    function mpRenderFeatures() {
      const container = document.getElementById('mpFeatureList');
      if (!container) return;
      container.innerHTML = devMode.features.map(f => `
        <div class="mp-feature-item">
          <div>
            <div class="mp-feature-name">${f.name}</div>
            <div class="mp-feature-desc">${f.description}</div>
          </div>
          <input type="checkbox" class="mp-toggle" ${f.enabled ? 'checked' : ''} onchange="devMode.toggleFeature('${f.id}');mpRenderFeatures()">
        </div>
      `).join('');
    }

    function mpRenderGameEditor() {
      const container = document.getElementById('mpGameEditorList');
      const count = document.getElementById('mpGameCount');
      if (!container) return;
      if (count) count.textContent = games.length;
      container.innerHTML = games.slice(0, 20).map(g => `
        <div class="mp-game-edit-row">
          <div class="mp-game-edit-thumb">${g.name.slice(0,2).toUpperCase()}</div>
          <div class="mp-game-edit-info">
            <div class="mp-game-edit-name">${g.name}</div>
            <div class="mp-game-edit-cat">${g.category}</div>
          </div>
          <div class="mp-game-edit-btns">
            <button class="mp-icon-btn" onclick="devMode.editGame('${g.id}');mpRenderGameEditor()" title="Edit">✏️</button>
            <button class="mp-icon-btn" onclick="devMode.deleteGame('${g.id}');mpRenderGameEditor()" title="Delete">🗑️</button>
          </div>
        </div>
      `).join('');
    }

    function mpApplyCSS() {
      const css = document.getElementById('mpCssEditor').value;
      devMode.injectCSS(css);
      devMode.customCSS = css;
      document.getElementById('devCssEditor').value = css;
      showNotification('🎨 CSS applied');
    }

    function mpClearCSS() {
      document.getElementById('mpCssEditor').value = '';
      devMode.injectCSS('');
      devMode.customCSS = '';
      document.getElementById('devCssEditor').value = '';
      showNotification('🗑️ CSS cleared');
    }

    function mpExportConfig() {
      const config = { games, customColors, layout: devMode.layout, features: devMode.features, customCSS: devMode.customCSS, exportDate: new Date().toISOString(), version: UPDATE_CONFIG.version };
      const json = JSON.stringify(config, null, 2);
      document.getElementById('mpConfigArea').value = json;
      navigator.clipboard.writeText(json).then(() => showNotification('📋 Copied to clipboard!'));
    }

    // ================================================================
    // §10  DOCK TAB HANDLER
    // Routes dock icon clicks to the correct panel/view depending
    // on which UI is active (Solar UI panels vs Full Hub views)
    // ================================================================
    function openDockTab(tab, dockEl) {
      if (currentUI === 'solar') {
        // Solar UI — open inline full-screen panel
        switch(tab) {
          case 'library':
            openMinimalPanel('mpLibrary', dockEl);
            mpRenderLibrary();
            const mpsi = document.getElementById('mpSearchInput');
            if (mpsi && !mpsi._wired) {
              mpsi.addEventListener('input', mpRenderLibrary);
              mpsi._wired = true;
            }
            break;
          case 'apps':
            openMinimalPanel('mpApps', dockEl);
            mpRenderApps('all');
            break;
          case 'news':
            openMinimalPanel('mpNews', dockEl);
            mpRenderNews();
            break;
          case 'survey':
            openMinimalPanel('mpSurvey', dockEl);
            mpOpenSurvey();
            break;
          case 'chat':
            openMinimalPanel('mpChat', dockEl);
            if (!supabaseClient) initSupabase();
            else { loadMessages(); subscribeToMessages(); }
            break;
          case 'customize':
            openMinimalPanel('mpCustomize', dockEl);
            mpOpenCustomize();
            break;
          case 'settings':
            openMinimalPanel('mpSettings', dockEl);
            document.getElementById('mpPanicUrl').value = panicUrl;
            const saved = localStorage.getItem('nebulahub-cloak-title');
            if (saved) document.getElementById('mpTabTitle').value = saved;
            break;
          case 'player':
            if (mpCurrentGameUrl || (activeGame && activeGame.url)) {
              openMinimalPanel('mpPlayer', dockEl);
            } else {
              showNotification('🎮 Open a game from the library first!');
            }
            break;
          case 'dev':
            if (devMode.isActive) {
              openMinimalPanel('mpDev', dockEl);
              mpRenderFeatures();
              mpRenderGameEditor();
              const savedCSS = localStorage.getItem('nebulahub-dev-css') || devMode.customCSS;
              if (savedCSS) document.getElementById('mpCssEditor').value = savedCSS;
            } else {
              devMode.requestAccess();
            }
            break;
        }
      } else {
        // Full Hub mode — navigate to the view
        switch(tab) {
          case 'library':    showLibraryView(); break;
          case 'news':       showAnnouncementsView(); break;
          case 'survey':     showSurveyView(); break;
          case 'chat':       showChatView(); break;
          case 'customize':  showCustomizeView(); break;
          case 'settings':   showSettingsView(); break;
          case 'player':     if (activeGame) showPlayerView(); break;
          case 'dev':
            if (devMode.isActive) devMode.showDevView();
            else devMode.requestAccess();
            break;
        }
      }
    }

    // ================================================================
    // §11  UI TOGGLE SYSTEM
    // switchUI('solar') → Solar UI  |  switchUI('nebulahub') → Full Hub
    // ================================================================
    let currentUI = 'nebulahub';
    
    function toggleUIDropdown() {
      document.getElementById('uiToggleDropdown').classList.toggle('active');
    }

    function switchUI(mode) {
      currentUI = mode;
      localStorage.setItem('nebulahub-ui-mode', mode);
      
      const nebulaHubUI = document.getElementById('nebulaHubUI');
      const nebulaMinimalUI = document.getElementById('nebulaHubMinimalUI');
      const optionNebulaHub = document.getElementById('optionNebulaHub');
      const optionMinimal = document.getElementById('optionMinimal');
      
      if (mode === 'solar' || mode === 'minimal') {
        currentUI = 'solar'; // normalise to 'solar'
        nebulaHubUI.style.display = 'none';
        nebulaMinimalUI.classList.add('active');
        document.body.style.padding = '0';
        optionNebulaHub.classList.remove('active');
        optionMinimal.classList.add('active');
        startNebulaClock();
        setTimeout(() => document.getElementById('nebulaSearchInput').focus(), 100);
      } else {
        closeAllMinimalPanels();
        nebulaMinimalUI.classList.remove('active');
        nebulaHubUI.style.display = '';
        document.body.style.padding = '20px';
        optionMinimal.classList.remove('active');
        optionNebulaHub.classList.add('active');
        stopNebulaClock();
      }
      
      document.getElementById('uiToggleDropdown').classList.remove('active');
    }

    let nebulaClockInterval;
    function startNebulaClock() {
      updateNebulaTime();
      nebulaClockInterval = setInterval(updateNebulaTime, 1000);
    }
    function stopNebulaClock() {
      if (nebulaClockInterval) clearInterval(nebulaClockInterval);
    }
    function updateNebulaTime() {
      const now = new Date();
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('nebulaTime').textContent = `${h}:${m}`;
    }

    function loadSavedUI() {
      const savedUI = localStorage.getItem('nebulahub-ui-mode');
      if (savedUI === 'solar' || savedUI === 'minimal') switchUI('solar');
    }

    document.addEventListener('click', (e) => {
      const container = document.querySelector('.ui-toggle-container');
      if (container && !container.contains(e.target)) {
        document.getElementById('uiToggleDropdown').classList.remove('active');
      }
    });

    // ================================================================
    // §12  ANNOUNCEMENTS DATA
    // Add objects to the array below to show new announcements.
    // Types: 'normal' | 'important' | 'update'
    // ================================================================
    const ANNOUNCEMENTS = [
      {
        id: 1,
        title: "🎮 Welcome to NebulaHub v2.3!",
        content: "Big news, for those of you who know Abel personally you know that NebulaHub has been extremely dry and has had no updates lately. Well now due to the newfound and unexpected popularity of NebulaHub Abel has hired a group of developers to work on NebulaHub with him, our plans for this website include Monthly large scale updates, weekly game and app drops, and lastly themed updates like our latest Developer update.",
        date: "January 30, 2026",
        image: null,
        gif: null,
        badge: "NEW",
        type: "update"
      },
      {
        id: 2,
        title: "🛠️ New Indie Game Drop",
        content: "New Indie games added to the website such as Oneshot, Omori, Celeste, and more",
        date: "February 2, 2026",
        image: null,
        gif: null,
        badge: null,
        type: "important"
      }
    ];

    // ================================================================
    // §13  SURVEY URL
    // Replace this with your Google Form link
    // ================================================================
    const SURVEY_URL = "https://forms.gle/ksnfAHu7X5wwmDgt9";

    // Max announcements shown before "show more"
    const MAX_DISPLAYED_ANNOUNCEMENTS = 5;

    // ================================================================
    // §14  UPDATE MODAL CONFIG
    // Change version + changes[] to show a new update popup
    // ================================================================
    const UPDATE_CONFIG = {
      version: "3.0",
      date: "February 14, 2026",
      title: "💝 The Valentine's Update",
      changes: [
        "💝 Happy Valentine's Day! — Valentine's Mode with heart particles",
        "🔍 Spotlight Search (Ctrl+K) — find games, apps, friends & views instantly",
        "💬 Message Reactions — react with 👍 ❤️ 😂 😮 😢 🔥 on any message",
        "↩️ Reply-to Messages — quote & reply inline in any chat",
        "🗑️ Delete Your Messages — remove your own messages from any chat",
        "⌨️ Typing Indicators — see when friends are typing in real time",
        "🌐 Presence & Online Status — live online/idle/offline dots on friends",
        "❤️ Favorite Games — heart any game to pin it to the top of your library",
        "🕒 Recently Played — last 5 games shown at the top of the library",
        "👤 Profiles now show avatar in chat messages",
        "📱 New App Library tab — 30+ curated apps across 5 categories",
        "🎨 New Customization — font picker, radius/blur/opacity sliders, 5 new presets",
        "🌌 Nebula, Neon, Cyber, Rose, Arctic & Lava color themes added",
        "⚡ Performance — indexed DB queries, faster message loading"
      ],
      showOnce: true
    };

    // ================================================================
    // §15  FAVICONS  (tab-cloak icon presets)
    // Add more keys here and matching buttons in Settings panel HTML
    // ================================================================
    // Favicon Data URIs
    const FAVICONS = {
      default: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="n" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%2322c55e"/><stop offset="50%" stop-color="%238b5cf6"/><stop offset="100%" stop-color="%23030014"/></radialGradient></defs><rect width="100" height="100" rx="22" fill="%23030014"/><circle cx="50" cy="50" r="46" fill="url(%23n)" opacity="0.9"/><ellipse cx="50" cy="50" rx="28" ry="11" fill="none" stroke="%23a78bfa" stroke-width="2.5" opacity="0.7" transform="rotate(-20 50 50)"/><circle cx="50" cy="50" r="7" fill="white" opacity="0.9"/></svg>',
      google: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234285F4"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">G</text></svg>',
      classroom: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%2324a865"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">C</text></svg>',
      docs: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234285F4"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">D</text></svg>',
      slides: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23fbbc04"/><text x="50" y="70" font-size="50" fill="white" text-anchor="middle" font-family="Arial" font-weight="bold">S</text></svg>'
    };

    // ================================================================
    // §16  GAME LIBRARY DATA
    // Each entry: { id, name, category, tags[], url }
    // Categories: 'arcade' | 'horror' | 'fps' | 'sandbox'
    // url can be a relative path or absolute https:// link
    // ================================================================
    let games = [
      { id: "geometry-dash", name: "Geometry Dash Lite", category: "arcade", tags: ["platformer", "rhythm", "gd"], url: "games/Geometry Dash Lite/Geometry Dash Lite.html" },
      { id: "Nautilus OS", name: "NautilusOS", category: "arcade", tags: ["platformer", "rhythm", "gd"], url: "https://frdhhfdhhhsfddsffds.vercel.app/" },
      { id: "buckshot-roulette", name: "Buckshot Roulette", category: "horror", tags: ["casino", "psych-horror"], url: "games/Buckshot Roulette/Buckshot Roulette.html" },
      { id: "minecraft", name: "Minecraft Web", category: "sandbox", tags: ["minecraft", "survival", "blocks"], url: "games/Minecraft/Minecraft 1.21.4.html" },
      { id: "basketball-random", name: "Basketball Random", category: "arcade", tags: ["sports", "2-player", "random"], url: "games/Basketball Random/Basket Random.html" },
      { id: "hollow-knight", name: "Hollow Knight Web", category: "sandbox", tags: ["metroidvania", "platformer", "indie"], url: "games/Hollow Knight/Hollow Knight.html" },
      { id: "ultrakill", name: "ULTRAKILL Web", category: "fps", tags: ["movement", "retro"], url: "games/Ultrakill/ULTRAKILL.html" },
      { id: "half-life", name: "Half-Life Web", category: "fps", tags: ["shooter", "valve", "classic"], url: "games/Half-Life/Half Life.html" },
      { id: "fnaf1", name: "FNAF 1", category: "horror", tags: ["fnaf", "classic"], url: "games/FNAF/Five Nights at Freddy's.html" },
      { id: "fnaf2", name: "FNAF 2", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 2/Five Nights at Freddy's 2.html" },
      { id: "fnaf3", name: "FNAF 3", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 3/Five Nights at Freddy's 3.html" },
      { id: "fnaf4", name: "FNAF 4", category: "horror", tags: ["fnaf", "classic"], url: "games/Five Nights at Freddy's 4/Five Nights at Freddy's 4.html" },
      { id: "fnaf-sl", name: "FNAF Sister Location", category: "horror", tags: ["fnaf", "sl"], url: "games/Five Nights at Freddy's SL/Five Nights at Freddy's_ Sister Location.html" },
      { id: "fnaf-ps", name: "FNAF Pizza Sim", category: "horror", tags: ["fnaf", "tycoon"], url: "games/Five Nights at Freddy's Pizza Sim/Five Nights at Freddy's_ Pizza Simulator.html" },
      { id: "fnaf-ucn", name: "FNAF UCN", category: "horror", tags: ["fnaf", "custom"], url: "games/FNAF UCN/Five Nights at Freddy's_ Ultimate Custom Night.html" },
      { id: "fnaf-world", name: "FNAF World", category: "horror", tags: ["fnaf", "rpg"], url: "games/Five Nights at Freddy's World/Five Nights at Freddy's_ World.html" },
      { id: "robbies-remastered", name: "Robbie's Remastered", category: "horror", tags: ["fnaf", "pc game"], url: "https://serve.gamejolt.net/1b5709b6eaec59282e589eac7043935165f91da53292f2d19d68d1377edceccd,1769840448,7/data/games/13/11/845011/files/674ab887625cb/index.html" },
      { id: "A Bite at Freddy's", name: "A Bite at Freddy's", category: "horror", tags: ["fnaf", "pcgame"], url: "games/A Bite at Freddy's/A Bite at Freddy's.html" },
      { id: "Baldi's Basic", name: "Baldi's Basic", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics.html" },
      { id: "Baldi's Basic Classic Remastered", name: "Baldi's Basic Classic Remastered", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics Classic Remastered.html" },
      { id: "Baldi's Basic Plus", name: "Baldi's Basic Plus", category: "arcade", tags: ["horror"], url: "games/Baldi's Basics/Baldi's Basics Plus.html" },
      { id: "Slope", name: "Slope", category: "arcade", tags: ["fun"], url: "games/Slope/Slope.html" },
      { id: "Terraria", name: "Terraria", category: "arcade", tags: ["fun"], url: "games/Terraria/Terraria.html" },
      { id: "Awesome Tanks 1", name: "Awesome Tanks 1", category: "arcade", tags: ["fun"], url: "games/Awesome Tanks/Awesome Tanks.html" },
      { id: "Awesome Tanks 2", name: "Awesome Tanks 2", category: "arcade", tags: ["fun"], url: "games/Awesome Tanks/Awesome Tanks 2.html" },
      { id: "Ball Blast", name: "Ball Blast", category: "arcade", tags: ["fun"], url: "games/BallBlast/Ball Blast.html" },
      { id: "That's Not My Neighbor", name: "That's Not My Neighbor", category: "arcade", tags: ["fun"], url: "games/That's Not My Neighbor/That's Not My Neighbor.html" },
      { id: "ChatBot", name: "ChatBot", category: "arcade", tags: ["fun"], url: "games/ChatBot/Chat Bot (A._.I).html" },
      { id: "Crazy Cattle", name: "Crazy Cattle", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Cattle 3D.html" },
      { id: "Crazy Chicken", name: "Crazy Chicken", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Chicken 3D.html" },
      { id: "Crazy Kitty", name: "Crazy Kitty", category: "arcade", tags: ["fun"], url: "games/Crazy Cattle Series/Crazy Kitty 3D.html" },
      { id: "Karlson", name: "Karlson", category: "arcade", tags: ["fun"], url: "games/Karlson/Karlson.html" },
      { id: "People's Playground", name: "People's Playground", category: "arcade", tags: ["fun"], url: "games/People's Playground/People Playground.html" },
      { id: "Midnight Shift", name: "Midnight Shift", category: "arcade", tags: ["fun"], url: "games/Midnight Shift/Midnight Shift.html" },
      { id: "Raft", name: "Raft", category: "arcade", tags: ["fun"], url: "games/Raft/Raft.html" },
      { id: "0V0", name: "0V0", category: "arcade", tags: ["fun"], url: "games/0V0/OvO.html" },
      { id: "Steal a Brainrot", name: "Steal a Brainrot", category: "pc game", tags: ["fun"], url: "games/SAB/Steal Brainrot Online.html" },
      { id: "Geometry Dash Wave 3d", name: "Geometry Dash Wave 3d", category: "arcade", tags: ["arcade"], url: "https://www.gamenora.com/embed/geometry-dash-wave-original" }
    ];

    // elements
    const gameGrid = document.getElementById("gameGrid");
    const emptyState = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const filterChips = document.querySelectorAll("#gameFilters .filter-chip");
    const statGames = document.getElementById("statGames");
    const resultCountLabel = document.getElementById("resultCountLabel");

    const libraryView = document.getElementById("libraryView");
    const playerView = document.getElementById("playerView");
    const customizeView = document.getElementById("customizeView");
    const settingsView = document.getElementById("settingsView");
    const chatView = document.getElementById("chatView");
    const devView = document.getElementById("devView");
    const announcementsView = document.getElementById("announcementsView");
    const surveyView = document.getElementById("surveyView");
    const viewLibraryBtn = document.getElementById("viewLibraryBtn");
    const viewPlayerBtn = document.getElementById("viewPlayerBtn");
    const viewCustomizeBtn = document.getElementById("viewCustomizeBtn");
    const viewSettingsBtn = document.getElementById("viewSettingsBtn");
    const viewChatBtn = document.getElementById("viewChatBtn");
    const viewDevBtn = document.getElementById("viewDevBtn");
    const viewAnnouncementsBtn = document.getElementById("viewAnnouncementsBtn");
    const viewSurveyBtn = document.getElementById("viewSurveyBtn");
    const playerGameName = document.getElementById("playerGameName");
    const playerGameMeta = document.getElementById("playerGameMeta");
    const playerIframe = document.getElementById("playerIframe");
    const backToLibraryBtn = document.getElementById("backToLibraryBtn");
    const openInNewTabBtn = document.getElementById("openInNewTabBtn");
    const portalLink = document.getElementById("portalLink");
    const yearSpan = document.getElementById("yearSpan");
    const sidebarZone = document.getElementById("sidebarZone");
    const libraryZone = document.getElementById("libraryZone");

    // ================================================================
    // §17  CORE STATE VARIABLES
    // ================================================================
    let activeCategory = "all";
    let activeSearch = "";
    let activeGame = null;
    let panicUrl = localStorage.getItem('nebulahub-panic-url') || "https://clever.com/in/dallasisd/student/portal";

    // ================================================================
    // §18  ANNOUNCEMENTS SYSTEM
    // ================================================================
    function renderAnnouncements() {
      const container = document.getElementById('announcementsView');
      const badge = document.getElementById('announcementBadge');
      
      if (ANNOUNCEMENTS.length === 0) {
        container.innerHTML = `<div class="announcement-empty"><div class="announcement-empty-icon">📭</div><strong>No announcements yet</strong><p style="margin-top:8px;opacity:0.7;">Check back later for updates!</p></div>`;
        return;
      }
      
      const sorted = [...ANNOUNCEMENTS].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, MAX_DISPLAYED_ANNOUNCEMENTS);
      
      container.innerHTML = sorted.map(ann => `
        <div class="announcement-card ${ann.type || 'normal'}">
          ${ann.badge ? `<div class="announcement-badge">${ann.badge}</div>` : ''}
          <div class="announcement-title">${ann.title}</div>
          <div class="announcement-date">${ann.date}</div>
          ${ann.image ? `<img src="${ann.image}" class="announcement-image" alt="Announcement Image">` : ''}
          ${ann.gif ? `<img src="${ann.gif}" class="announcement-gif" alt="Announcement GIF">` : ''}
          <div class="announcement-content">${ann.content.replace(/\n/g, '<br>')}</div>
        </div>
      `).join('');
      
      const lastSeen = parseInt(localStorage.getItem('nebulahub-last-announcement') || '0');
      const latestId = Math.max(...ANNOUNCEMENTS.map(a => a.id));
      if (latestId > lastSeen) {
        badge.style.display = 'inline-flex';
        badge.textContent = ANNOUNCEMENTS.filter(a => a.id > lastSeen).length || 'NEW';
      }
    }

    function showAnnouncementsView() {
      hideAllViews();
      announcementsView.style.display = 'flex';
      viewAnnouncementsBtn.classList.add('active');
      const latestId = Math.max(...ANNOUNCEMENTS.map(a => a.id));
      localStorage.setItem('nebulahub-last-announcement', latestId);
      document.getElementById('announcementBadge').style.display = 'none';
    }

    // ================================================================
    // §19  SURVEY SYSTEM
    // ================================================================
    function showSurveyView() {
      hideAllViews();
      surveyView.style.display = 'flex';
      viewSurveyBtn.classList.add('active');
      
      if (SURVEY_URL && SURVEY_URL !== "https://forms.gle/gsBVKuUB9vhhrRNr9") {
        document.getElementById('surveyFrame').src = SURVEY_URL;
      } else {
        const container = document.querySelector('.survey-frame-container');
        container.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-soft);text-align:center;padding:40px;"><div style="font-size:3rem;margin-bottom:20px;">📋</div><h3 style="margin-bottom:12px;color:var(--text);">Survey Not Configured</h3><p>Edit the SURVEY_URL constant at the top of the JavaScript.</p></div>`;
      }
    }

    function hideAllViews() {
      const appView = document.getElementById('appView');
      [libraryView, customizeView, settingsView, chatView, playerView, devView, announcementsView, surveyView, appView].forEach(v => { if (v) v.style.display = 'none'; });
      [viewLibraryBtn, viewPlayerBtn, viewCustomizeBtn, viewSettingsBtn, viewChatBtn, viewDevBtn, viewAnnouncementsBtn, viewSurveyBtn].forEach(b => b.classList.remove('active'));
      const appsBtn = document.getElementById('viewAppsBtn');
      if (appsBtn) appsBtn.classList.remove('active');
    }

    // ================================================================
    // §20  DEVELOPER MODE SYSTEM
    // Password is stored in devMode.password below
    // ================================================================
    const devMode = {
      password: "Ponchis721",
      isActive: false,
      features: [],
      layout: { sidebar: true, library: true, order: ['sidebar', 'library'] },
      customCSS: '',

      init() {
        this.loadState();
        this.initLayoutEditor();
        this.registerDefaultFeatures();
        this.renderGameList();
        if (this.customCSS) { this.injectCSS(this.customCSS); document.getElementById('devCssEditor').value = this.customCSS; }
        if (sessionStorage.getItem('dev-mode-active') === 'true') this.activate();
      },

      requestAccess() { document.getElementById('devAuthModal').classList.add('show'); setTimeout(() => document.getElementById('devPasswordInput').focus(), 100); },

      authenticate() {
        const input = document.getElementById('devPasswordInput');
        if (input.value === this.password) {
          this.activate(); this.closeAuth(); input.value = '';
          showNotification('🔓 Developer mode activated!');
        } else {
          input.style.borderColor = '#ef4444'; input.value = ''; input.placeholder = 'Incorrect password';
          setTimeout(() => { input.style.borderColor = ''; input.placeholder = '••••••••'; }, 1500);
        }
      },

      closeAuth() { document.getElementById('devAuthModal').classList.remove('show'); },

      activate() {
        this.isActive = true;
        document.body.classList.add('dev-active', 'dev-mode-active');
        sessionStorage.setItem('dev-mode-active', 'true');
        // If in minimal mode, open the dev panel; otherwise show the full dev view
        if (currentUI === 'solar') {
          openMinimalPanel('mpDev', null);
          setTimeout(() => { mpRenderFeatures(); mpRenderGameEditor(); }, 50);
        } else {
          this.showDevView();
        }
      },

      lock() {
        this.isActive = false;
        document.body.classList.remove('dev-active', 'dev-mode-active');
        sessionStorage.removeItem('dev-mode-active');
        showLibraryView();
        showNotification('🔒 Developer mode locked');
      },

      showDevView() {
        hideAllViews();
        devView.style.display = 'flex';
        viewDevBtn.classList.add('active');
        this.renderFeatures();
        this.renderGameList();
      },

      initLayoutEditor() {
        const container = document.getElementById('layoutPreview');
        if (window.Sortable) {
          new Sortable(container, {
            animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', handle: '.layout-zone',
            onEnd: (evt) => {
              const zones = container.querySelectorAll('.layout-zone');
              this.layout.order = Array.from(zones).map(z => z.dataset.zone);
            }
          });
        }
      },

      toggleZone(zone) {
        this.layout[zone] = !this.layout[zone];
        const toggle = document.querySelector(`[data-zone="${zone}"] .zone-toggle`);
        toggle.classList.toggle('active');
        const el = zone === 'sidebar' ? sidebarZone : libraryZone;
        el.style.opacity = this.layout[zone] ? '1' : '0.3';
      },

      saveLayout() { localStorage.setItem('nebulahub-dev-layout', JSON.stringify(this.layout)); showNotification('💾 Layout saved!'); },

      resetLayout() {
        this.layout = { sidebar: true, library: true, order: ['sidebar', 'library'] };
        document.querySelectorAll('.zone-toggle').forEach(t => t.classList.add('active'));
        sidebarZone.style.opacity = '1'; libraryZone.style.opacity = '1';
        this.saveLayout(); showNotification('↩ Layout reset');
      },

      registerFeature(id, name, description, defaultState = false, callback = null) {
        const feature = { id, name, description, enabled: defaultState, callback, beta: true };
        this.features.push(feature);
        if (this.isActive) this.renderFeatures();
        return feature;
      },

      registerDefaultFeatures() {
        this.registerFeature('particles', 'Enhanced Particles', 'Add floating particle effects to the background', false, (e) => { if(e) document.body.style.setProperty('--particle-count', '100'); else document.body.style.removeProperty('--particle-count'); });
        this.registerFeature('debug', 'Debug Mode', 'Show debug information in console', false, (e) => { window.DEBUG = e; });
        this.registerFeature('compact', 'Compact Mode', 'Reduce padding and margins for dense view', false, (e) => { document.body.classList.toggle('compact-mode', e); });
        this.registerFeature('animations', 'Reduced Motion', 'Disable animations for accessibility', false, (e) => { document.body.classList.toggle('reduce-motion', e); });
      },

      renderFeatures() {
        document.getElementById('featureList').innerHTML = this.features.map(f => `
          <div class="feature-item">
            <div class="feature-info">
              <div class="feature-name">${f.name}${f.beta ? '<span class="feature-beta">Beta</span>' : ''}</div>
              <div class="feature-desc">${f.description}</div>
            </div>
            <input type="checkbox" class="feature-toggle" ${f.enabled ? 'checked' : ''} onchange="devMode.toggleFeature('${f.id}')">
          </div>
        `).join('');
      },

      toggleFeature(id) {
        const f = this.features.find(f => f.id === id);
        if (f) { f.enabled = !f.enabled; if (f.callback) f.callback(f.enabled); this.saveState(); }
      },

      applyCSS() { const css = document.getElementById('devCssEditor').value; this.injectCSS(css); this.customCSS = css; showNotification('🎨 CSS applied'); },

      injectCSS(css) {
        let style = document.getElementById('dev-custom-css');
        if (!style) { style = document.createElement('style'); style.id = 'dev-custom-css'; document.head.appendChild(style); }
        style.textContent = css;
      },

      clearCSS() { document.getElementById('devCssEditor').value = ''; this.injectCSS(''); this.customCSS = ''; showNotification('🗑️ CSS cleared'); },
      saveCSS() { localStorage.setItem('nebulahub-dev-css', document.getElementById('devCssEditor').value); showNotification('💾 CSS saved'); },

      renderGameList() {
        const container = document.getElementById('devGameList');
        document.getElementById('devGameCount').textContent = games.length;
        container.innerHTML = games.map(g => `
          <div class="game-edit-item">
            <div class="game-edit-thumb">${g.name.slice(0,2).toUpperCase()}</div>
            <div class="game-edit-info">
              <div class="game-edit-name">${g.name}</div>
              <div class="game-edit-cat">${g.category}</div>
            </div>
            <div class="game-edit-actions">
              <button class="icon-btn" onclick="devMode.editGame('${g.id}')" title="Edit">✏️</button>
              <button class="icon-btn" onclick="devMode.deleteGame('${g.id}')" title="Delete">🗑️</button>
            </div>
          </div>
        `).join('');
      },

      deleteGame(id) { if (confirm('Delete this game?')) { games = games.filter(g => g.id !== id); renderGrid(); this.renderGameList(); this.saveState(); } },

      showAddGameModal() {
        const name = prompt('Game Name:'); if (!name) return;
        const category = prompt('Category (arcade/horror/fps/sandbox):', 'arcade') || 'arcade';
        const url = prompt('Game URL:'); if (!url) return;
        games.push({ id: 'custom-' + Date.now(), name, category: category.toLowerCase(), tags: ['custom'], url });
        renderGrid(); this.renderGameList(); this.saveState(); showNotification('🎮 Game added!');
      },

      editGame(id) {
        const game = games.find(g => g.id === id); if (!game) return;
        const newName = prompt('Game Name:', game.name); if (newName) game.name = newName;
        const newUrl = prompt('Game URL:', game.url); if (newUrl) game.url = newUrl;
        renderGrid(); this.renderGameList(); this.saveState();
      },

      exportConfig() {
        const config = { games, customColors, layout: this.layout, features: this.features, customCSS: this.customCSS, exportDate: new Date().toISOString(), version: UPDATE_CONFIG.version };
        const json = JSON.stringify(config, null, 2);
        document.getElementById('devConfigExport').value = json;
        navigator.clipboard.writeText(json).then(() => showNotification('📋 Config copied to clipboard!'));
      },

      importConfig() {
        const json = prompt('Paste configuration JSON:'); if (!json) return;
        try {
          const config = JSON.parse(json);
          if (config.games) { games = config.games; renderGrid(); this.renderGameList(); }
          if (config.customColors) { Object.assign(customColors, config.customColors); syncColorInputs(); applyCustomColors(); }
          if (config.customCSS) { this.customCSS = config.customCSS; document.getElementById('devCssEditor').value = config.customCSS; this.injectCSS(config.customCSS); }
          this.saveState(); showNotification('📥 Config imported successfully!');
        } catch(e) { alert('Invalid JSON configuration'); }
      },

      resetAll() {
        if (confirm('⚠️ WARNING: This will reset ALL developer settings. Continue?')) {
          localStorage.removeItem('nebulahub-dev-state');
          localStorage.removeItem('nebulahub-dev-layout');
          localStorage.removeItem('nebulahub-dev-css');
          location.reload();
        }
      },

      saveState() { localStorage.setItem('nebulahub-dev-state', JSON.stringify({ layout: this.layout, features: this.features, customCSS: this.customCSS })); },

      loadState() {
        const saved = localStorage.getItem('nebulahub-dev-state');
        if (saved) { try { const s = JSON.parse(saved); if (s.layout) this.layout = s.layout; if (s.features) this.features = s.features; if (s.customCSS) this.customCSS = s.customCSS; } catch(e) {} }
      }
    };

    function showNotification(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--custom-accent-color);color:white;padding:12px 24px;border-radius:999px;font-weight:600;font-size:0.9rem;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:9999;animation:slideUp 0.3s ease;`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    viewDevBtn.addEventListener('click', () => {
      if (devMode.isActive) devMode.showDevView();
      else devMode.requestAccess();
    });

    viewAnnouncementsBtn.addEventListener('click', showAnnouncementsView);
    viewSurveyBtn.addEventListener('click', showSurveyView);

    // ================================================================
    // §21  CUSTOMIZATION SYSTEM
    // Edit defaultColors below to change the default color scheme
    // ================================================================
    const customColors = {
      brand: '#22c55e', accent: '#8b5cf6', accentStrong: '#22c55e',
      bgGrad1: '#1f2937', bgGrad2: '#111827',
      overlay1: 'rgba(59,130,246,0.35)', overlay2: 'rgba(236,72,153,0.3)',
      chatSent: '#8b5cf6', chatBg: '#0c1024'
    };

    function syncColorInputs() {
      document.getElementById('brandColorPicker').value = customColors.brand;
      document.getElementById('brandColorText').value = customColors.brand;
      document.getElementById('accentColorPicker').value = customColors.accent;
      document.getElementById('accentColorText').value = customColors.accent;
      document.getElementById('accentStrongPicker').value = customColors.accentStrong;
      document.getElementById('accentStrongText').value = customColors.accentStrong;
      document.getElementById('bgGrad1Picker').value = customColors.bgGrad1;
      document.getElementById('bgGrad1Text').value = customColors.bgGrad1;
      document.getElementById('bgGrad2Picker').value = customColors.bgGrad2;
      document.getElementById('bgGrad2Text').value = customColors.bgGrad2;
      const hex1 = rgbToHex(customColors.overlay1) || '#3b82f6';
      const hex2 = rgbToHex(customColors.overlay2) || '#ec4899';
      document.getElementById('overlay1Picker').value = hex1;
      document.getElementById('overlay1Text').value = customColors.overlay1;
      document.getElementById('overlay2Picker').value = hex2;
      document.getElementById('overlay2Text').value = customColors.overlay2;
      document.getElementById('chatSentPicker').value = customColors.chatSent;
      document.getElementById('chatSentText').value = customColors.chatSent;
      document.getElementById('chatBgPicker').value = customColors.chatBg;
      document.getElementById('chatBgText').value = customColors.chatBg;
    }

    function rgbToHex(rgba) {
      if (!rgba || !rgba.includes('rgb')) return null;
      const parts = rgba.match(/\d+/g);
      if (!parts || parts.length < 3) return null;
      return "#" + ((1 << 24) + (parseInt(parts[0]) << 16) + (parseInt(parts[1]) << 8) + parseInt(parts[2])).toString(16).slice(1);
    }

    function hexToRgba(hex, alpha = 0.35) {
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function applyCustomColors() {
      const root = document.documentElement;
      root.style.setProperty('--custom-brand-color', customColors.brand);
      root.style.setProperty('--custom-accent-color', customColors.accent);
      root.style.setProperty('--custom-accent-strong', customColors.accentStrong);
      root.style.setProperty('--custom-bg-grad-1', customColors.bgGrad1);
      root.style.setProperty('--custom-bg-grad-2', customColors.bgGrad2);
      root.style.setProperty('--custom-overlay-1', customColors.overlay1);
      root.style.setProperty('--custom-overlay-2', customColors.overlay2);
      root.style.setProperty('--custom-chat-sent', customColors.chatSent);
      root.style.setProperty('--custom-chat-bg', customColors.chatBg);
      document.getElementById('customActiveNotice').classList.add('show');
      updateChatPreview();
    }

    function saveCustomTheme() {
      localStorage.setItem('nebulahub-custom-theme', JSON.stringify(customColors));
      localStorage.setItem('nebulahub-theme-type', 'custom');
      document.getElementById('themeSelector').value = 'nebula';
      showNotification('💾 Theme saved!');
    }

    function resetCustomTheme() {
      Object.assign(customColors, { brand:'#22c55e', accent:'#8b5cf6', accentStrong:'#22c55e', bgGrad1:'#1f2937', bgGrad2:'#111827', overlay1:'rgba(59,130,246,0.35)', overlay2:'rgba(236,72,153,0.3)', chatSent:'#8b5cf6', chatBg:'#0c1024' });
      syncColorInputs(); applyCustomColors();
      localStorage.removeItem('nebulahub-custom-theme');
      localStorage.removeItem('nebulahub-theme-type');
      document.getElementById('customActiveNotice').classList.remove('show');
    }

    function previewTheme() { applyCustomColors(); }

    function applyPreset(name) {
      const presets = {
        ocean: { brand:'#0ea5e9', accent:'#0284c7', accentStrong:'#38bdf8', bgGrad1:'#0c4a6e', bgGrad2:'#082f49', overlay1:'rgba(14,165,233,0.4)', overlay2:'rgba(56,189,248,0.3)', chatSent:'#0ea5e9', chatBg:'#082f49' },
        sunset: { brand:'#f97316', accent:'#ea580c', accentStrong:'#fb923c', bgGrad1:'#7c2d12', bgGrad2:'#431407', overlay1:'rgba(249,115,22,0.4)', overlay2:'rgba(236,72,153,0.3)', chatSent:'#f97316', chatBg:'#431407' },
        forest: { brand:'#22c55e', accent:'#16a34a', accentStrong:'#4ade80', bgGrad1:'#14532d', bgGrad2:'#052e16', overlay1:'rgba(34,197,94,0.4)', overlay2:'rgba(101,163,13,0.3)', chatSent:'#22c55e', chatBg:'#052e16' },
        crimson: { brand:'#ef4444', accent:'#dc2626', accentStrong:'#f87171', bgGrad1:'#7f1d1d', bgGrad2:'#450a0a', overlay1:'rgba(239,68,68,0.4)', overlay2:'rgba(249,115,22,0.3)', chatSent:'#ef4444', chatBg:'#450a0a' },
        gold: { brand:'#eab308', accent:'#ca8a04', accentStrong:'#facc15', bgGrad1:'#713f12', bgGrad2:'#422006', overlay1:'rgba(234,179,8,0.4)', overlay2:'rgba(251,191,36,0.3)', chatSent:'#eab308', chatBg:'#422006' },
        purple: { brand:'#a855f7', accent:'#9333ea', accentStrong:'#c084fc', bgGrad1:'#581c87', bgGrad2:'#3b0764', overlay1:'rgba(168,85,247,0.4)', overlay2:'rgba(192,132,252,0.3)', chatSent:'#a855f7', chatBg:'#3b0764' },
        neon:   { brand:'#39ff14', accent:'#00fff0', accentStrong:'#ff00ff', bgGrad1:'#050510', bgGrad2:'#000005', overlay1:'rgba(57,255,20,0.25)', overlay2:'rgba(0,255,240,0.2)', chatSent:'#39ff14', chatBg:'#050510' },
        cyber:  { brand:'#00d4ff', accent:'#ff6b35', accentStrong:'#ffe600', bgGrad1:'#0a0a1a', bgGrad2:'#050510', overlay1:'rgba(0,212,255,0.3)', overlay2:'rgba(255,107,53,0.25)', chatSent:'#00d4ff', chatBg:'#0a0a1a' },
        rose:   { brand:'#fb7185', accent:'#e11d48', accentStrong:'#fda4af', bgGrad1:'#4c0519', bgGrad2:'#27030e', overlay1:'rgba(251,113,133,0.35)', overlay2:'rgba(253,164,175,0.25)', chatSent:'#fb7185', chatBg:'#27030e' },
        arctic: { brand:'#67e8f9', accent:'#0891b2', accentStrong:'#a5f3fc', bgGrad1:'#0c4a6e', bgGrad2:'#0a2540', overlay1:'rgba(103,232,249,0.3)', overlay2:'rgba(165,243,252,0.2)', chatSent:'#67e8f9', chatBg:'#0a2540' },
        lava:   { brand:'#ff4500', accent:'#ff6a00', accentStrong:'#ffd700', bgGrad1:'#1a0500', bgGrad2:'#0d0200', overlay1:'rgba(255,69,0,0.4)', overlay2:'rgba(255,106,0,0.3)', chatSent:'#ff4500', chatBg:'#0d0200' },
        nebula: { brand:'#22c55e', accent:'#8b5cf6', accentStrong:'#22c55e', bgGrad1:'#1f2937', bgGrad2:'#111827', overlay1:'rgba(59,130,246,0.35)', overlay2:'rgba(236,72,153,0.3)', chatSent:'#8b5cf6', chatBg:'#0c1024' }
      };
      if (presets[name]) { Object.assign(customColors, presets[name]); syncColorInputs(); applyCustomColors(); }
    }

    function updateChatPreview() {
      const box = document.getElementById('chatPreviewBox');
      if (box) {
        box.style.background = customColors.chatBg;
        const sent = box.querySelector('.sent');
        if (sent) sent.style.background = customColors.chatSent;
      }
    }

    // ---- Font ----
    const FONTS = {
      system:  'system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif',
      mono:    '"Courier New",Courier,monospace',
      rounded: '"Trebuchet MS","Segoe UI",Tahoma,sans-serif',
      serif:   'Georgia,"Times New Roman",serif'
    };
    function applyFont(name) {
      document.documentElement.style.setProperty('--custom-font', FONTS[name] || FONTS.system);
      document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('fontBtn' + name.charAt(0).toUpperCase() + name.slice(1));
      if (btn) btn.classList.add('active');
      localStorage.setItem('nebulahub-font', name);
    }

    // ---- Border radius ----
    function applyRadius(val) {
      document.documentElement.style.setProperty('--custom-radius', val + 'px');
      const lbl = document.getElementById('radiusVal');
      if (lbl) lbl.textContent = val + 'px';
      localStorage.setItem('nebulahub-radius', val);
    }

    // ---- Glass blur ----
    function applyGlass(val) {
      document.documentElement.style.setProperty('--custom-glass', val + 'px');
      const lbl = document.getElementById('glassVal');
      if (lbl) lbl.textContent = val + 'px';
      localStorage.setItem('nebulahub-glass', val);
    }

    // ---- Card opacity ----
    function applyCardOpacity(val) {
      document.documentElement.style.setProperty('--custom-card-opacity', val / 100);
      const lbl = document.getElementById('opacityVal');
      if (lbl) lbl.textContent = val + '%';
      localStorage.setItem('nebulahub-opacity', val);
    }

    // ---- Starfield ----
    function applyStarfield(on) {
      const canvas = document.getElementById('starCanvas');
      if (canvas) canvas.style.display = on ? 'block' : 'none';
      localStorage.setItem('nebulahub-starfield', on ? '1' : '0');
    }

    // ---- Load all interface settings on boot ----
    function loadInterfaceSettings() {
      const font    = localStorage.getItem('nebulahub-font');
      const radius  = localStorage.getItem('nebulahub-radius');
      const glass   = localStorage.getItem('nebulahub-glass');
      const opacity = localStorage.getItem('nebulahub-opacity');
      const stars   = localStorage.getItem('nebulahub-starfield');

      if (font)    { applyFont(font); const sl = document.getElementById('radiusSlider'); /* font has no slider */ }
      if (radius)  { applyRadius(radius);  const sl = document.getElementById('radiusSlider');  if (sl) sl.value = radius; }
      if (glass)   { applyGlass(glass);    const sl = document.getElementById('glassSlider');   if (sl) sl.value = glass; }
      if (opacity) { applyCardOpacity(opacity); const sl = document.getElementById('opacitySlider'); if (sl) sl.value = opacity; }
      if (stars === '0') { applyStarfield(false); const tog = document.getElementById('starfieldToggle'); if (tog) tog.checked = false; }
    }

    ['brand', 'accent', 'accentStrong'].forEach(key => {
      const picker = document.getElementById(key + 'ColorPicker');
      const text = document.getElementById(key + 'ColorText');
      if (picker) picker.addEventListener('input', (e) => { customColors[key] = e.target.value; if (text) text.value = e.target.value; });
      if (text) text.addEventListener('change', (e) => { customColors[key] = e.target.value; if (picker) picker.value = e.target.value; });
    });

    ['bgGrad1', 'bgGrad2'].forEach(key => {
      const picker = document.getElementById(key + 'Picker');
      const text = document.getElementById(key + 'Text');
      if (picker) picker.addEventListener('input', (e) => { customColors[key] = e.target.value; if (text) text.value = e.target.value; });
    });

    document.getElementById('overlay1Picker').addEventListener('input', (e) => { customColors.overlay1 = hexToRgba(e.target.value, 0.35); document.getElementById('overlay1Text').value = customColors.overlay1; });
    document.getElementById('overlay2Picker').addEventListener('input', (e) => { customColors.overlay2 = hexToRgba(e.target.value, 0.3); document.getElementById('overlay2Text').value = customColors.overlay2; });
    document.getElementById('chatSentPicker').addEventListener('input', (e) => { customColors.chatSent = e.target.value; document.getElementById('chatSentText').value = e.target.value; document.documentElement.style.setProperty('--custom-chat-sent', e.target.value); updateChatPreview(); });
    document.getElementById('chatBgPicker').addEventListener('input', (e) => { customColors.chatBg = e.target.value; document.getElementById('chatBgText').value = e.target.value; document.documentElement.style.setProperty('--custom-chat-bg', e.target.value); updateChatPreview(); });

    // ================================================================
    // §22  TAB CLOAKING SYSTEM
    // ================================================================
    document.querySelectorAll('.favicon-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    function applyTabCloak() {
      const title = document.getElementById('tabTitleInput').value.trim();
      const faviconType = document.querySelector('.favicon-btn.active').dataset.favicon;
      if (title) { document.title = title; localStorage.setItem('nebulahub-cloak-title', title); }
      let link = document.querySelector("link[rel*='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
      link.href = FAVICONS[faviconType];
      localStorage.setItem('nebulahub-cloak-favicon', faviconType);
      const btn = document.querySelector('button[onclick="applyTabCloak()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '✅ Applied!';
      setTimeout(() => { btn.innerHTML = originalText; }, 1500);
    }

    function resetTabCloak() {
      document.title = 'NEBULAHUB';
      document.getElementById('tabTitleInput').value = '';
      // Restore the NebulaHub favicon
      let link = document.querySelector("link[rel*='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
      link.href = FAVICONS.default;
      document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-favicon="default"]').classList.add('active');
      localStorage.removeItem('nebulahub-cloak-title');
      localStorage.removeItem('nebulahub-cloak-favicon');
    }

    function savePanicUrl() {
      const url = document.getElementById('panicUrlInput').value.trim();
      if (url) { panicUrl = url; localStorage.setItem('nebulahub-panic-url', url); alert('Panic button URL saved!'); }
    }

    function loadTabCloak() {
      const savedTitle = localStorage.getItem('nebulahub-cloak-title');
      const savedFavicon = localStorage.getItem('nebulahub-cloak-favicon');
      if (savedTitle) { document.title = savedTitle; document.getElementById('tabTitleInput').value = savedTitle; }
      if (savedFavicon && FAVICONS[savedFavicon]) {
        let link = document.querySelector("link[rel*='icon']");
        if (!link) { link = document.createElement('link'); link.rel = 'shortcut icon'; link.type = 'image/svg+xml'; document.head.appendChild(link); }
        link.href = FAVICONS[savedFavicon];
        document.querySelectorAll('.favicon-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`[data-favicon="${savedFavicon}"]`);
        if (btn) btn.classList.add('active');
      }
    }

    // ================================================================
    // §23  UPDATE MODAL
    // ================================================================
    function showUpdateModal() {
      const lastSeen = localStorage.getItem('nebulahub-update-seen');
      const savedVersion = localStorage.getItem('nebulahub-update-version');
      if (UPDATE_CONFIG.showOnce && savedVersion === UPDATE_CONFIG.version && lastSeen === 'true') return;
      document.getElementById('updateTitle').textContent = UPDATE_CONFIG.title;
      document.getElementById('updateDate').textContent = UPDATE_CONFIG.date;
      document.getElementById('updateList').innerHTML = UPDATE_CONFIG.changes.map(c => `<li>${c}</li>`).join('');
      document.getElementById('updateModal').classList.add('show');
    }

    function closeUpdateModal() {
      const dontShow = document.getElementById('dontShowAgain').checked;
      if (dontShow && UPDATE_CONFIG.showOnce) { localStorage.setItem('nebulahub-update-seen', 'true'); localStorage.setItem('nebulahub-update-version', UPDATE_CONFIG.version); }
      document.getElementById('updateModal').classList.remove('show');
    }

    // ================================================================
    // §24  CORE FUNCTIONS
    // renderGrid, showView helpers, theme switching, panic button
    // ================================================================
    function renderGrid() {
      const query = activeSearch.trim().toLowerCase();
      const filtered = games.filter(game => {
        const matchesCategory = activeCategory === "all" || game.category === activeCategory;
        const haystack = (game.name + " " + (game.tags || []).join(" ")).toLowerCase();
        return matchesCategory && (query === "" || haystack.includes(query));
      });

      gameGrid.innerHTML = "";
      if (filtered.length === 0) {
        emptyState.style.display = "block";
      } else {
        emptyState.style.display = "none";
        // Sort: favorites first (when showing all), then rest
        const sortedFiltered = [...filtered].sort((a,b) => {
          const af = gameFavorites.includes(a.id) ? 0 : 1;
          const bf = gameFavorites.includes(b.id) ? 0 : 1;
          return af - bf;
        });
        sortedFiltered.forEach(game => {
          const card = document.createElement("article");
          card.className = "game-card";
          card.dataset.id = game.id;
          const initials = game.name.split(" ").map(w => w[0]?.toUpperCase() || "").join("").slice(0, 3);
          const isFav = gameFavorites.includes(game.id);
          card.innerHTML = `
            <div class="game-thumb"><span>${initials}</span></div>
            <div class="game-name" title="${game.name}">${game.name}</div>
            <div class="game-meta">
              <span>${(game.category || "game").toUpperCase()}</span>
              <span class="game-tag">${(game.tags && game.tags[0]) ? game.tags[0] : "game"}</span>
            </div>
            <button class="card-fav-btn ${isFav ? 'faved' : ''}" title="Favorite" onclick="toggleFavorite('${game.id}',event)">${isFav ? '❤️' : '🤍'}</button>
          `;
          card.addEventListener("click", () => openGame(game));
          gameGrid.appendChild(card);
        });
      }

      statGames.textContent = games.length;
      resultCountLabel.textContent = filtered.length + " RESULT" + (filtered.length === 1 ? "" : "S");
    }

    function openGame(game) {
      activeGame = game;
      playerGameName.textContent = game.name;
      playerGameMeta.textContent = (game.category || "game").toUpperCase() + " • Embedded player";
      playerIframe.src = game.url;
      showPlayerView();
    }

    function showPlayerView() { hideAllViews(); playerView.style.display = "flex"; viewPlayerBtn.classList.add("active"); viewPlayerBtn.disabled = false; }
    function showLibraryView() { playerIframe.src = ""; hideAllViews(); libraryView.style.display = "block"; viewLibraryBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showAppView() { playerIframe.src = ""; hideAllViews(); const av = document.getElementById('appView'); if (av) av.style.display = "block"; const ab = document.getElementById('viewAppsBtn'); if (ab) ab.classList.add('active'); viewPlayerBtn.disabled = !activeGame; renderAppGrid('all'); }
    function showCustomizeView() { playerIframe.src = ""; hideAllViews(); customizeView.style.display = "flex"; viewCustomizeBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showSettingsView() { playerIframe.src = ""; hideAllViews(); settingsView.style.display = "flex"; viewSettingsBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; }
    function showChatView() { playerIframe.src = ""; hideAllViews(); chatView.style.display = "flex"; viewChatBtn.classList.add("active"); viewPlayerBtn.disabled = !activeGame; if (!supabaseClient) initSupabase(); }

    searchInput.addEventListener("input", () => {
      activeSearch = searchInput.value;
      clearSearchBtn.style.display = activeSearch.trim().length > 0 ? "block" : "none";
      renderGrid();
    });

    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = ""; activeSearch = ""; clearSearchBtn.style.display = "none"; searchInput.focus(); renderGrid();
    });

    filterChips.forEach(chip => {
      chip.addEventListener("click", () => {
        filterChips.forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        activeCategory = chip.dataset.category || "all";
        renderGrid();
      });
    });

    viewLibraryBtn.addEventListener("click", showLibraryView);
    viewPlayerBtn.addEventListener("click", () => { if (activeGame) showPlayerView(); });
    const viewAppsBtn = document.getElementById('viewAppsBtn');
    if (viewAppsBtn) viewAppsBtn.addEventListener('click', showAppView);
    viewCustomizeBtn.addEventListener("click", showCustomizeView);
    viewSettingsBtn.addEventListener("click", showSettingsView);
    viewChatBtn.addEventListener("click", showChatView);
    backToLibraryBtn.addEventListener("click", showLibraryView);
    openInNewTabBtn.addEventListener("click", () => { if (activeGame && activeGame.url) window.open(activeGame.url, "_blank"); });
    portalLink.addEventListener("click", () => { location.hash = (location.hash === "#portal") ? "" : "#portal"; location.reload(); });

    const themeSelector = document.getElementById("themeSelector");
    const savedTheme = localStorage.getItem("site-theme") || "nebula";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeSelector.value = savedTheme;

    themeSelector.addEventListener("change", () => {
      const newTheme = themeSelector.value;
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("site-theme", newTheme);
      localStorage.removeItem('nebulahub-theme-type');
      document.getElementById('customActiveNotice').classList.remove('show');
    });

    function panicHide() { window.location.href = panicUrl; }

    function loadSavedCustomTheme() {
      const saved = localStorage.getItem('nebulahub-custom-theme');
      const themeType = localStorage.getItem('nebulahub-theme-type');
      if (saved && themeType === 'custom') {
        try { const parsed = JSON.parse(saved); Object.assign(customColors, parsed); syncColorInputs(); applyCustomColors(); document.getElementById('customActiveNotice').classList.add('show'); } catch(e) {}
      }
    }

    // ================================================================
    // §25b  PROFILE & AUTH SYSTEM
    // Email/password auth via Supabase + profile customization
    // ================================================================

    let authUser = null;       // Supabase auth user (null = guest)
    let userProfile = null;    // profiles table row
    let profilePendingBg = null; // { type, value } waiting to be saved
    let profilePendingAvatar = null; // File object
    let profilePendingBanner = null; // File object

    // ---- Auth: tab switching ----
    function authSwitchTab(tab) {
      document.getElementById('authSignInForm').classList.toggle('hidden', tab !== 'signin');
      document.getElementById('authSignUpForm').classList.toggle('hidden', tab !== 'signup');
      document.getElementById('tabSignIn').classList.toggle('active', tab === 'signin');
      document.getElementById('tabSignUp').classList.toggle('active', tab === 'signup');
    }

    // ---- Auth: sign in ----
    async function authSignIn(e) {
      e.preventDefault();
      const btn = document.getElementById('siBtnSubmit');
      const errEl = document.getElementById('siError');
      errEl.classList.remove('show');
      btn.disabled = true; btn.textContent = 'Signing in...';
      const email = document.getElementById('siEmail').value.trim();
      const password = document.getElementById('siPassword').value;
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        authUser = data.user;
        await profileLoad();
        closeAuthGate();
      } catch (err) {
        errEl.textContent = err.message || 'Sign in failed. Check your email/password.';
        errEl.classList.add('show');
      } finally {
        btn.disabled = false; btn.textContent = 'Sign In →';
      }
    }

    // ---- Auth: sign up ----
    async function authSignUp(e) {
      e.preventDefault();
      const btn = document.getElementById('suBtnSubmit');
      const errEl = document.getElementById('suError');
      const succEl = document.getElementById('suSuccess');
      errEl.classList.remove('show'); succEl.classList.remove('show');
      const username = document.getElementById('suUsername').value.trim();
      const email = document.getElementById('suEmail').value.trim();
      const password = document.getElementById('suPassword').value;
      if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        errEl.textContent = 'Username can only contain letters, numbers, underscores.';
        errEl.classList.add('show'); return;
      }
      btn.disabled = true; btn.textContent = 'Creating account...';
      try {
        // Check username not taken
        const { data: existing } = await supabaseClient.from('profiles').select('id').eq('username', username).maybeSingle();
        if (existing) throw new Error('That username is already taken.');
        const { data, error } = await supabaseClient.auth.signUp({
          email, password,
          options: { data: { username, display_name: username } }
        });
        if (error) throw error;
        succEl.classList.add('show');
        setTimeout(() => authSwitchTab('signin'), 2500);
      } catch (err) {
        errEl.textContent = err.message || 'Sign up failed.';
        errEl.classList.add('show');
      } finally {
        btn.disabled = false; btn.textContent = 'Create Account →';
      }
    }

    // ---- Auth: guest ----
    function authContinueAsGuest() {
      authUser = null;
      userProfile = { display_name: 'Guest', username: 'guest_' + Math.random().toString(36).slice(2,6), avatar_url: null };
      closeAuthGate();
    }

    // ---- Auth: sign out ----
    async function authSignOut() {
      if (supabaseClient) await supabaseClient.auth.signOut();
      authUser = null; userProfile = null; currentUser = null;
      profileUpdateUI(null);
      closeProfilePanel();
      localStorage.removeItem('nebulahub-chat-user');
      showAuthGate();
    }

    // ---- Auth Gate open/close ----
    function showAuthGate() {
      document.getElementById('authGate').classList.remove('hidden');
    }
    let _updateModalShown = false;
    function closeAuthGate() {
      document.getElementById('authGate').classList.add('hidden');
      profileUpdateUI(userProfile);
      // Set chat user from profile
      if (authUser && userProfile) {
        currentUser = {
          id: authUser.id,
          display_name: userProfile.display_name,
          username: userProfile.username,
          avatar_url: userProfile.avatar_url || null
        };
        localStorage.setItem('nebulahub-chat-user', JSON.stringify(currentUser));
      }
      applyProfileBackground();
      // Boot chat
      chatInit();
      // Start presence heartbeat
      startPresenceHeartbeat();
      // Show update modal once per page load, after the user is in
      if (!_updateModalShown) {
        _updateModalShown = true;
        setTimeout(showUpdateModal, 800);
      }
    }

    // ---- Profile: load from Supabase ----
    async function profileLoad() {
      if (!authUser || !supabaseClient) return;
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', authUser.id)
        .single();
      if (!error && data) {
        userProfile = data;
        profileUpdateUI(data);
        applyProfileBackground();
      }
    }

    // ---- Profile: update all UI elements ----
    function profileUpdateUI(profile) {
      if (!profile) {
        ['topBarProfileInitials','dockProfileInitials','profileAvatarInitials'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '?';
        });
        return;
      }
      const initials = (profile.display_name || profile.username || 'U')
        .split(' ').map(w => w[0]?.toUpperCase()).join('').slice(0,2);

      // Top-bar button
      document.getElementById('topBarProfileInitials').textContent = initials;
      if (profile.avatar_url) {
        const img = document.getElementById('topBarProfileAvatar');
        img.src = profile.avatar_url; img.style.display = 'block';
        document.getElementById('topBarProfileInitials').style.display = 'none';
      }

      // Dock button
      document.getElementById('dockProfileInitials').textContent = initials;
      if (profile.avatar_url) {
        const img = document.getElementById('dockProfileAvatarImg');
        img.src = profile.avatar_url; img.style.display = 'block';
        document.getElementById('dockProfileInitials').style.display = 'none';
      }

      // Profile panel preview
      document.getElementById('profileAvatarInitials').textContent = initials;
      document.getElementById('profileDisplayNamePreview').textContent = profile.display_name || profile.username || 'Unnamed';
      document.getElementById('profileUsernamePreview').textContent = '@' + (profile.username || 'unknown');
      document.getElementById('profileBioPreview').textContent = profile.bio || 'No bio yet.';
      document.getElementById('profileGamesPlayed').textContent = profile.games_played || 0;
      const joined = profile.join_date ? new Date(profile.join_date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '—';
      document.getElementById('profileJoinDate').textContent = joined;

      if (profile.avatar_url) {
        const img = document.getElementById('profileAvatarImg');
        img.src = profile.avatar_url; img.style.display = 'block';
        document.getElementById('profileAvatarInitials').style.display = 'none';
      }
      if (profile.bg_type && profile.bg_type !== 'default' && profile.bg_value) {
        const btn = document.querySelector(`[data-bgtype="${profile.bg_type}"]`);
        if (btn) bgTypeSelect(btn, profile.bg_type, false);
        document.getElementById('bgCustomValue').value = profile.bg_value;
      }

      // Fill edit fields
      document.getElementById('editDisplayName').value = profile.display_name || '';
      document.getElementById('editUsername').value = profile.username || '';
      document.getElementById('editBio').value = profile.bio || '';
      document.getElementById('bioCharCount').textContent = (profile.bio || '').length;
    }

    // ---- Profile: apply background to page ----
    function applyProfileBackground() {
      if (!userProfile) return;
      const { bg_type, bg_value } = userProfile;
      if (!bg_type || bg_type === 'default') {
        document.body.style.backgroundImage = '';
        return;
      }
      if (bg_type === 'color') document.body.style.background = bg_value;
      else if (bg_type === 'gradient') document.body.style.background = bg_value;
      else if (bg_type === 'image') {
        document.body.style.background = `url("${bg_value}") center/cover no-repeat fixed`;
      }
    }

    // ---- Profile panel open/close ----
    function openProfilePanel() {
      const panel = document.getElementById('profilePanel');
      panel.classList.add('show');
      profileRenderAvatarGrid();
      profileRenderBgPresets('default');
      if (userProfile) profileUpdateUI(userProfile);
    }
    function closeProfilePanel() {
      document.getElementById('profilePanel').classList.remove('show');
    }

    // ---- Avatar preset grid ----
    const AVATAR_EMOJIS = ['🧑‍🚀','👾','🎮','🌌','🦊','🐱','🐸','🐧','🦁','🐉','🤖','🎭'];
    function profileRenderAvatarGrid() {
      const grid = document.getElementById('avatarPresetGrid');
      if (!grid) return;
      grid.innerHTML = AVATAR_EMOJIS.map((emoji, i) => `
        <div class="avatar-option" style="background:linear-gradient(135deg,var(--custom-accent-color),var(--custom-accent-strong));font-size:1.3rem;"
          onclick="profileSelectEmojiAvatar('${emoji}',this)">${emoji}</div>
      `).join('');
    }

    function profileSelectEmojiAvatar(emoji, el) {
      document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('active'));
      el.classList.add('active');
      // Create a canvas to make a tiny avatar image from emoji
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 64;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = `hsl(${Math.floor(Math.random()*360)},60%,40%)`;
      ctx.fillRect(0,0,64,64);
      ctx.font = '40px serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(emoji, 32, 34);
      profilePendingAvatar = { dataUrl: canvas.toDataURL('image/png'), emoji };
      // Update preview
      const img = document.getElementById('profileAvatarImg');
      img.src = canvas.toDataURL('image/png'); img.style.display = 'block';
      document.getElementById('profileAvatarInitials').style.display = 'none';
    }

    // ---- File uploads ----
    function profileHandleAvatarUpload(input) {
      const file = input.files?.[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { showNotification('❌ Image too large — max 2MB'); return; }
      profilePendingAvatar = { file };
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById('profileAvatarImg');
        img.src = e.target.result; img.style.display = 'block';
        document.getElementById('profileAvatarInitials').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    function profileHandleBannerUpload(input) {
      const file = input.files?.[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { showNotification('❌ Image too large — max 5MB'); return; }
      profilePendingBanner = file;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.getElementById('profileBannerImg');
        img.src = e.target.result; img.style.display = 'block';
        document.getElementById('profileBannerPreview').style.background = 'none';
      };
      reader.readAsDataURL(file);
    }

    function profileHandleBgUpload(input) {
      const file = input.files?.[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { showNotification('❌ Image too large — max 5MB'); return; }
      profilePendingBg = { type: 'image', file };
      showNotification('🖼️ Image selected — save your profile to apply');
    }

    // ---- Background type selector ----
    const BG_PRESETS = {
      default: [],
      color: [
        { label: 'Midnight', value: '#030014' },
        { label: 'Deep Blue', value: '#0d1b2a' },
        { label: 'Forest', value: '#0a1a0f' },
        { label: 'Crimson', value: '#1a0505' },
        { label: 'Gold', value: '#1a1400' },
      ],
      gradient: [
        { label: 'Nebula', value: 'linear-gradient(135deg, #0d0019 0%, #030014 50%, #001a0d 100%)' },
        { label: 'Sunset', value: 'linear-gradient(135deg, #1a0a05 0%, #0a0005 50%, #00050a 100%)' },
        { label: 'Aurora', value: 'linear-gradient(135deg, #00140a 0%, #0a0014 50%, #000a14 100%)' },
        { label: 'Ocean', value: 'linear-gradient(135deg, #000d1a 0%, #001a1a 100%)' },
        { label: 'Void', value: 'linear-gradient(135deg, #050005 0%, #050010 100%)' },
      ],
      image: []
    };

    function bgTypeSelect(btn, type, updatePending = true) {
      document.querySelectorAll('.bg-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      profileRenderBgPresets(type);
      document.getElementById('bgCustomInput').classList.toggle('show', type === 'color' || type === 'gradient');
      document.getElementById('bgImageUpload').classList.toggle('show', type === 'image');
      if (updatePending) profilePendingBg = { type, value: BG_PRESETS[type]?.[0]?.value || '' };
      // Label
      const labels = { color: 'Hex color (e.g. #1a1a2e)', gradient: 'CSS gradient string', image: '' };
      const labelEl = document.getElementById('bgCustomLabel');
      if (labelEl) labelEl.textContent = labels[type] || '';
    }

    function profileRenderBgPresets(type) {
      const container = document.getElementById('bgPresets');
      if (!container) return;
      const presets = BG_PRESETS[type] || [];
      container.innerHTML = presets.map((p, i) => `
        <div class="bg-preset" style="background:${p.value};" title="${p.label}"
          onclick="profileSelectBgPreset('${p.value.replace(/'/g,'"')}','${type}',this)"></div>
      `).join('');
    }

    function profileSelectBgPreset(value, type, el) {
      document.querySelectorAll('.bg-preset').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('bgCustomValue').value = value;
      profilePendingBg = { type, value };
      // Live preview
      if (type === 'color') document.body.style.background = value;
      else if (type === 'gradient') document.body.style.background = value;
    }

    // ---- Profile: save ----
    async function profileSave() {
      const btn = document.getElementById('profileSaveBtn');
      btn.disabled = true; btn.textContent = '⏳ Saving...';
      try {
        const displayName = document.getElementById('editDisplayName').value.trim();
        const username = document.getElementById('editUsername').value.trim();
        const bio = document.getElementById('editBio').value.trim();
        const bgValue = document.getElementById('bgCustomValue').value.trim();
        const bgTypeBtn = document.querySelector('.bg-type-btn.active');
        const bgType = bgTypeBtn ? bgTypeBtn.dataset.bgtype : 'default';

        let avatarUrl = userProfile?.avatar_url || null;
        let bgFinal = bgValue || profilePendingBg?.value || '';

        // Upload avatar if pending
        if (authUser && profilePendingAvatar) {
          if (profilePendingAvatar.dataUrl) {
            // Emoji avatar — upload data URL as blob
            const res = await fetch(profilePendingAvatar.dataUrl);
            const blob = await res.blob();
            const path = `${authUser.id}/avatar.png`;
            const { data, error } = await supabaseClient.storage.from('avatars').upload(path, blob, { upsert: true, contentType: 'image/png' });
            if (!error) {
              const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(path);
              avatarUrl = urlData.publicUrl + '?t=' + Date.now();
            }
          } else if (profilePendingAvatar.file) {
            const file = profilePendingAvatar.file;
            const ext = file.name.split('.').pop();
            const path = `${authUser.id}/avatar.${ext}`;
            const { data, error } = await supabaseClient.storage.from('avatars').upload(path, file, { upsert: true, contentType: file.type });
            if (!error) {
              const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(path);
              avatarUrl = urlData.publicUrl + '?t=' + Date.now();
            }
          }
        }

        // Upload background image if pending
        if (authUser && profilePendingBg?.file) {
          const file = profilePendingBg.file;
          const ext = file.name.split('.').pop();
          const path = `${authUser.id}/bg.${ext}`;
          const { data, error } = await supabaseClient.storage.from('backgrounds').upload(path, file, { upsert: true, contentType: file.type });
          if (!error) {
            const { data: urlData } = supabaseClient.storage.from('backgrounds').getPublicUrl(path);
            bgFinal = urlData.publicUrl + '?t=' + Date.now();
          }
        }

        const updates = {
          display_name: displayName || userProfile?.display_name,
          username: username || userProfile?.username,
          bio: bio,
          avatar_url: avatarUrl,
          bg_type: bgType,
          bg_value: bgFinal,
          updated_at: new Date().toISOString()
        };

        if (authUser && supabaseClient) {
          const { data, error } = await supabaseClient.from('profiles').update(updates).eq('id', authUser.id).select().single();
          if (error) throw error;
          userProfile = data;
        } else {
          // Guest: just update in memory
          userProfile = { ...userProfile, ...updates };
        }

        profilePendingAvatar = null;
        profilePendingBg = null;
        profileUpdateUI(userProfile);
        applyProfileBackground();

        // Update chat user
        if (userProfile) {
          currentUser = { ...(currentUser||{}), display_name: userProfile.display_name, username: userProfile.username };
          localStorage.setItem('nebulahub-chat-user', JSON.stringify(currentUser));
        }

        showNotification('✅ Profile saved!');
        btn.textContent = '✅ Saved!';
        setTimeout(() => { btn.disabled = false; btn.textContent = '💾 Save Profile'; }, 2000);
      } catch (err) {
        console.error('Profile save error:', err);
        showNotification('❌ Save failed: ' + (err.message || 'unknown error'));
        btn.disabled = false; btn.textContent = '💾 Save Profile';
      }
    }

    // ---- Bio char counter ----
    function initProfileListeners() {
      const bioEl = document.getElementById('editBio');
      if (bioEl) {
        bioEl.addEventListener('input', () => {
          document.getElementById('bioCharCount').textContent = bioEl.value.length;
          document.getElementById('profileBioPreview').textContent = bioEl.value || 'No bio yet.';
        });
      }
      const dispEl = document.getElementById('editDisplayName');
      if (dispEl) dispEl.addEventListener('input', () => {
        document.getElementById('profileDisplayNamePreview').textContent = dispEl.value;
      });
    }

    // ---- Init auth + profile on page load ----
    async function initAuthAndProfile() {
      if (!supabaseClient) return;
      // Listen for future auth state changes (sign in / sign out events)
      supabaseClient.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session?.user) {
          authUser = session.user;
          await profileLoad();
          closeAuthGate();
        } else if (event === 'SIGNED_OUT') {
          authUser = null; userProfile = null;
          profileUpdateUI(null);
          showAuthGate();
        }
      });
      // Check for an existing persisted session on page load
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user) {
        authUser = session.user;
        await profileLoad();
        closeAuthGate(); // restores UI + boots chat without showing auth gate
      } else {
        showAuthGate();
      }
    }

    // ================================================================
    // §25a  APP LIBRARY SYSTEM
    // ================================================================
    const apps = [
      // Productivity
      { id:'gdocs',      name:'Google Docs',       category:'productivity', icon:'📝', color:'#4285F4', desc:'Word processor',         url:'https://docs.google.com' },
      { id:'gsheets',    name:'Google Sheets',     category:'productivity', icon:'📊', color:'#34A853', desc:'Spreadsheets',           url:'https://sheets.google.com' },
      { id:'gslides',    name:'Google Slides',     category:'productivity', icon:'📑', color:'#FBBC05', desc:'Presentations',          url:'https://slides.google.com' },
      { id:'gdrive',     name:'Google Drive',      category:'productivity', icon:'☁️', color:'#4285F4', desc:'Cloud storage',          url:'https://drive.google.com' },
      { id:'gcal',       name:'Google Calendar',   category:'productivity', icon:'📅', color:'#1a73e8', desc:'Schedule & events',       url:'https://calendar.google.com' },
      { id:'gclassroom', name:'Google Classroom',  category:'productivity', icon:'🏫', color:'#24a865', desc:'Assignments & class',     url:'https://classroom.google.com' },
      { id:'notion',     name:'Notion',            category:'productivity', icon:'⬜', color:'#000000', desc:'Notes & wikis',           url:'https://notion.so' },
      { id:'canva',      name:'Canva',             category:'creative',     icon:'🎨', color:'#00c4cc', desc:'Design anything',         url:'https://canva.com' },
      // Creative
      { id:'figma',      name:'Figma',             category:'creative',     icon:'🖌️', color:'#f24e1e', desc:'UI & prototyping',        url:'https://figma.com' },
      { id:'sketchpad',  name:'Sketchpad',         category:'creative',     icon:'✏️', color:'#8b5cf6', desc:'Draw online',             url:'https://sketch.io/sketchpad' },
      { id:'pixlr',      name:'Pixlr Editor',      category:'creative',     icon:'🖼️', color:'#2196f3', desc:'Photo editing',           url:'https://pixlr.com/editor' },
      { id:'musiclab',   name:'Chrome Music Lab',  category:'creative',     icon:'🎵', color:'#ea4335', desc:'Make music',              url:'https://musiclab.chromeexperiments.com' },
      { id:'autodraw',   name:'AutoDraw',          category:'creative',     icon:'🤖', color:'#fbbc04', desc:'AI drawing tool',         url:'https://autodraw.com' },
      // Reference
      { id:'wikipedia',  name:'Wikipedia',         category:'reference',    icon:'📚', color:'#6b7280', desc:'Free encyclopedia',       url:'https://en.wikipedia.org' },
      { id:'wolframalpha',name:'Wolfram Alpha',    category:'reference',    icon:'🔢', color:'#dd1100', desc:'Computational answers',   url:'https://wolframalpha.com' },
      { id:'khanacademy',name:'Khan Academy',      category:'reference',    icon:'🎓', color:'#14bf96', desc:'Free learning',           url:'https://khanacademy.org' },
      { id:'desmos',     name:'Desmos Graphing',   category:'reference',    icon:'📈', color:'#6741d9', desc:'Graph calculator',        url:'https://desmos.com/calculator' },
      { id:'quizlet',    name:'Quizlet',           category:'reference',    icon:'🃏', color:'#4257b2', desc:'Flashcards & study',      url:'https://quizlet.com' },
      { id:'gscholar',   name:'Google Scholar',    category:'reference',    icon:'🔬', color:'#4285F4', desc:'Academic papers',         url:'https://scholar.google.com' },
      // Tools
      { id:'gforms',     name:'Google Forms',      category:'tools',        icon:'📋', color:'#7248b9', desc:'Surveys & quizzes',       url:'https://forms.google.com' },
      { id:'translate',  name:'Google Translate',  category:'tools',        icon:'🌐', color:'#4285F4', desc:'Translate anything',      url:'https://translate.google.com' },
      { id:'timer',      name:'Timer Tab',         category:'tools',        icon:'⏱️', color:'#f59e0b', desc:'Pomodoro & timers',       url:'https://timer.guru' },
      { id:'typeracer',  name:'TypeRacer',         category:'tools',        icon:'⌨️', color:'#1e40af', desc:'Practice typing',         url:'https://play.typeracer.com' },
      { id:'excalidraw', name:'Excalidraw',        category:'tools',        icon:'🔷', color:'#6965db', desc:'Whiteboard & diagrams',   url:'https://excalidraw.com' },
      // Media
      { id:'youtube',    name:'YouTube',           category:'media',        icon:'▶️', color:'#ff0000', desc:'Watch videos',            url:'https://youtube.com' },
      { id:'spotify',    name:'Spotify Web',       category:'media',        icon:'🎧', color:'#1db954', desc:'Stream music',            url:'https://open.spotify.com' },
      { id:'soundcloud', name:'SoundCloud',        category:'media',        icon:'☁️', color:'#ff5500', desc:'Discover music',          url:'https://soundcloud.com' },
      { id:'archive',    name:'Internet Archive',  category:'media',        icon:'📦', color:'#428bca', desc:'Books, music, movies',    url:'https://archive.org' },
      { id:'itch',       name:'itch.io',           category:'media',        icon:'🕹️', color:'#fa5c5c', desc:'Indie game store',        url:'https://itch.io' },
    ];

    let activeAppCategory = 'all';

    function renderAppGrid(category) {
      activeAppCategory = category || activeAppCategory;
      const grid = document.getElementById('appGrid');
      if (!grid) return;
      const filtered = activeAppCategory === 'all' ? apps : apps.filter(a => a.category === activeAppCategory);
      grid.innerHTML = filtered.map(app => `
        <div class="app-card" onclick="window.open('${app.url}','_blank')" title="${app.desc}">
          <div class="app-icon" style="background:${app.color}22;border:1.5px solid ${app.color}44;">${app.icon}</div>
          <div class="app-name">${app.name}</div>
          <div class="app-desc">${app.desc}</div>
          <span class="app-tag">${app.category}</span>
        </div>`).join('');
    }

    // Wire Full Hub app category chips
    document.querySelectorAll('[data-appcategory]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('[data-appcategory]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        renderAppGrid(chip.dataset.appcategory);
      });
    });

    // Solar UI Apps panel
    function mpRenderApps(category) {
      const grid = document.getElementById('mpAppGrid');
      if (!grid) return;
      const filtered = (!category || category === 'all') ? apps : apps.filter(a => a.category === category);
      grid.innerHTML = filtered.map(app => `
        <div class="mp-app-card" onclick="window.open('${app.url}','_blank')" title="${app.desc}">
          <div class="app-icon" style="background:${app.color}22;border:1.5px solid ${app.color}44;">${app.icon}</div>
          <div class="app-name">${app.name}</div>
          <div class="app-desc" style="font-size:0.68rem;color:var(--text-soft);">${app.desc}</div>
        </div>`).join('');
    }

    function mpFilterApp(btn, category) {
      document.querySelectorAll('[data-appcat]').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      mpRenderApps(category);
    }

    // ================================================================
    // §25c  NEBULACHAT SYSTEM — complete rewrite
    // Fixed: uses sender_id, UUID chat_id, proper RLS, realtime
    // Added: friends list, DMs, group chats, dynamic sidebar
    // ================================================================
    const SUPABASE_CONFIG = {
      url: 'https://eatwwxzrnsyxuzkfckal.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdHd3eHpybnN5eHV6a2Zja2FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjM0MjgsImV4cCI6MjA3OTQ5OTQyOH0.UZoqLR93nMHoK_zQAEndaSntx9F05CXLEKMNGDyi9qc'
    };

    // ---- State ----
    let supabaseClient = null;
    let currentUser    = null;   // { id, display_name, username, avatar_url }
    let currentChatId  = null;   // UUID of active chat
    let chatSubscription = null;

    // Cached data
    let chatPublicRooms = [];    // [{id, name, type}]
    let chatMyConvos    = [];    // DMs + groups I'm in
    let friendsList     = [];    // accepted friends with profile data
    let friendRequests  = [];    // pending incoming requests

    // ---- IDs for the 3 hardcoded public rooms ----
    const PUBLIC_ROOM_IDS = {
      general: '00000000-0000-0000-0000-000000000001',
      gaming:  '00000000-0000-0000-0000-000000000002',
      random:  '00000000-0000-0000-0000-000000000003'
    };

    // ================================================================
    // CHAT CORE
    // ================================================================

    async function chatInit() {
      if (!supabaseClient || !currentUser) return;
      // Ensure user is in all 3 public rooms
      for (const id of Object.values(PUBLIC_ROOM_IDS)) {
        await supabaseClient.from('chat_members').upsert(
          { chat_id: id, user_id: currentUser.id },
          { onConflict: 'chat_id,user_id', ignoreDuplicates: true }
        );
      }
      await chatLoadSidebar();
      chatSwitchRoom(PUBLIC_ROOM_IDS.general);
    }

    async function chatLoadSidebar() {
      if (!supabaseClient || !currentUser) return;
      // Load DMs + groups I'm a member of (excludes the 3 public rooms)
      const { data: memberRows } = await supabaseClient
        .from('chat_members')
        .select('chat_id, chats(id, name, type, is_public)')
        .eq('user_id', currentUser.id);

      chatPublicRooms = [];
      chatMyConvos    = [];

      if (memberRows) {
        for (const row of memberRows) {
          const c = row.chats;
          if (!c) continue;
          if (c.is_public) chatPublicRooms.push(c);
          else chatMyConvos.push(c);
        }
        // Sort public rooms in canonical order
        chatPublicRooms.sort((a,b) => {
          const order = ['general','gaming','random'];
          return order.indexOf(a.name) - order.indexOf(b.name);
        });
      }
      chatRenderSidebar();
    }

    function chatRenderSidebar() {
      // ---- Full Hub sidebar ----
      const sidebar = document.getElementById('chatSidebar');
      if (sidebar) {
        let html = `<div class="chat-section-label">Public Channels</div>`;
        for (const r of chatPublicRooms) {
          const icons = { general: '#', gaming: '🎮', random: '💫' };
          const icon = icons[r.name] || '#';
          const active = r.id === currentChatId ? 'active' : '';
          html += `<button class="chat-conv-btn ${active}" onclick="chatSwitchRoom('${r.id}')">
            <div class="chat-conv-avatar group" style="border-radius:10px;">${icon}</div>
            <div class="chat-conv-info">
              <div class="chat-conv-name">${r.name}</div>
              <div class="chat-conv-sub">Public</div>
            </div>
          </button>`;
        }
        if (chatMyConvos.length > 0) {
          html += `<div class="chat-section-label" style="margin-top:10px;">DMs & Groups</div>`;
          for (const c of chatMyConvos) {
            const active = c.id === currentChatId ? 'active' : '';
            const icon = c.type === 'group' ? '👥' : '💬';
            const label = c.name || 'Direct Message';
            html += `<button class="chat-conv-btn ${active}" onclick="chatSwitchRoom('${c.id}')">
              <div class="chat-conv-avatar ${c.type === 'group' ? 'group' : ''}">${icon}</div>
              <div class="chat-conv-info">
                <div class="chat-conv-name">${escapeHtml(label)}</div>
                <div class="chat-conv-sub">${c.type === 'group' ? 'Group' : 'DM'}</div>
              </div>
            </button>`;
          }
        }
        sidebar.innerHTML = html;
      }

      // ---- Solar UI sidebar ----
      const mpRooms = document.getElementById('mpChatRooms');
      if (mpRooms) {
        let html = `<div style="font-size:0.65rem;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.08em;padding:10px 8px 4px;">Channels</div>`;
        for (const r of chatPublicRooms) {
          const icons = { general: '#', gaming: '🎮', random: '💫' };
          const icon = icons[r.name] || '#';
          const active = r.id === currentChatId ? 'active' : '';
          html += `<button class="mp-room-btn ${active}" onclick="chatSwitchRoom('${r.id}')">${icon} ${r.name}</button>`;
        }
        if (chatMyConvos.length > 0) {
          html += `<div style="font-size:0.65rem;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.08em;padding:10px 8px 4px;">DMs & Groups</div>`;
          for (const c of chatMyConvos) {
            const active = c.id === currentChatId ? 'active' : '';
            const label = (c.name || 'DM').slice(0, 16);
            const icon = c.type === 'group' ? '👥' : '💬';
            html += `<button class="mp-room-btn ${active}" onclick="chatSwitchRoom('${c.id}')">${icon} ${label}</button>`;
          }
        }
        mpRooms.innerHTML = html;
      }
    }

    async function chatSwitchRoom(chatId) {
      currentChatId = chatId;
      document.querySelectorAll('.chat-conv-btn, .mp-room-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll(`[onclick*="chatSwitchRoom('${chatId}')"]`).forEach(b => b.classList.add('active'));
      const chat = [...chatPublicRooms, ...chatMyConvos].find(c => c.id === chatId);
      const name = chat?.name || 'Chat';
      const el = document.getElementById('currentRoomName');
      if (el) el.textContent = name;
      const icon = { general:'#', gaming:'🎮', random:'💫' }[name] || (chat?.type === 'group' ? '👥' : '💬');
      const iconEl = document.getElementById('currentRoomIcon');
      if (iconEl) iconEl.textContent = icon;
      ['chatMessages','mpMessages'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
      });
      // Reset typing UI for new room
      typersMap = {};
      chatUpdateTypingUI();
      chatCancelReply();
      await chatLoadMessages();
      chatSubscribeRoom();
      chatSubscribeTyping(chatId);
    }

    async function chatLoadMessages() {
      if (!supabaseClient || !currentChatId) return;
      const { data, error } = await supabaseClient
        .from('messages')
        .select('id, sender_id, display_name, avatar_url, content, created_at, deleted_at, reply_to_id, reply_display_name, reply_content')
        .eq('chat_id', currentChatId)
        .order('created_at', { ascending: true })
        .limit(80);
      if (error) { console.error('Load messages error:', error); return; }
      if (data) {
        data.forEach(msg => chatRenderMessage(msg, false));
        ['chatMessages','mpMessages'].forEach(id => {
          const el = document.getElementById(id); if (el) el.scrollTop = el.scrollHeight;
        });
        // Load reactions for all messages
        const ids = data.map(m => m.id);
        if (ids.length) await chatLoadReactions(ids);
      }
    }

    function chatSubscribeRoom() {
      if (chatSubscription) { chatSubscription.unsubscribe(); chatSubscription = null; }
      if (!supabaseClient || !currentChatId) return;
      chatSubscription = supabaseClient
        .channel(`chat:${currentChatId}`)
        .on('postgres_changes', {
          event: 'INSERT', schema: 'public', table: 'messages',
          filter: `chat_id=eq.${currentChatId}`
        }, payload => chatRenderMessage(payload.new, true))
        .subscribe();
    }

    function chatRenderMessage(msg, animate) {
      const isOwn    = msg.sender_id === currentUser?.id;
      const name     = msg.display_name || 'Anonymous';
      const time     = new Date(msg.created_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      const init     = name.charAt(0).toUpperCase();
      const isDeleted = !!msg.deleted_at;
      const avatarUrl = msg.avatar_url;

      // Reply quote HTML
      const replyHtml = (msg.reply_to_id && msg.reply_display_name)
        ? `<div class="reply-quote"><strong>${escapeHtml(msg.reply_display_name)}</strong><div class="quote-text">${escapeHtml(msg.reply_content||'')}</div></div>`
        : '';

      // Message action buttons
      const actionsHtml = isDeleted ? '' : `
        <div class="message-actions">
          <button onclick="showReactionPicker('${msg.id}',this)" title="React">😊</button>
          <button onclick="chatSetReply('${msg.id}','${escapeHtml(name).replace(/'/g,"\'")}','${escapeHtml(msg.content||'').replace(/'/g,"\'").slice(0,60)}')" title="Reply">↩</button>
          ${isOwn ? `<button onclick="chatDeleteMsg('${msg.id}')" title="Delete" style="color:#fca5a5;">🗑</button>` : ''}
        </div>`;

      const avatarHtml = avatarUrl
        ? `<img src="${avatarUrl}" class="message-avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<div class=\"message-avatar\">${init}</div>'">`
        : `<div class="message-avatar">${init}</div>`;

      // Full Hub
      const mainEl = document.getElementById('chatMessages');
      if (mainEl) {
        const div = document.createElement('div');
        div.className = `message ${isOwn ? 'own' : ''} ${isDeleted ? 'message-deleted' : ''}`;
        div.dataset.msgid = msg.id;
        if (animate) div.style.animation = 'slideIn 0.3s ease';
        div.innerHTML = `${avatarHtml}<div class="message-content">${replyHtml}<div class="message-header"><span>${escapeHtml(name)}</span><span style="opacity:.6;">${time}</span></div><div class="message-text">${escapeHtml(msg.content)}</div><div class="msg-reactions"></div></div>${actionsHtml}`;
        mainEl.appendChild(div);
        if (animate) mainEl.scrollTop = mainEl.scrollHeight;
      }

      // Solar UI panel
      const mpEl = document.getElementById('mpMessages');
      if (mpEl) {
        const div = document.createElement('div');
        div.className = `mp-msg ${isOwn ? 'own' : ''} ${isDeleted ? 'message-deleted' : ''}`;
        div.dataset.msgid = msg.id;
        if (animate) div.style.animation = 'slideIn 0.3s ease';
        div.innerHTML = `<div class="mp-msg-avatar">${init}</div><div class="mp-msg-bubble">${replyHtml}<div class="mp-msg-meta">${escapeHtml(name)} · ${time}</div><div class="mp-msg-text">${escapeHtml(msg.content)}</div></div>`;
        mpEl.appendChild(div);
        if (animate) mpEl.scrollTop = mpEl.scrollHeight;
      }
    }

    async function chatSend() {
      const inputs = ['messageInput','mpChatInput'];
      let content = '';
      for (const id of inputs) {
        const el = document.getElementById(id);
        if (el && el.value.trim()) { content = el.value.trim(); el.value = ''; break; }
      }
      if (!content || !currentUser || !currentChatId) return;
      chatStopTyping();
      const payload = {
        chat_id:      currentChatId,
        sender_id:    currentUser.id,
        display_name: currentUser.display_name || currentUser.username || 'Anonymous',
        avatar_url:   currentUser.avatar_url || null,
        content,
        room_name: [...chatPublicRooms, ...chatMyConvos].find(c => c.id === currentChatId)?.name || ''
      };
      if (replyToMsg) {
        payload.reply_to_id       = replyToMsg.id;
        payload.reply_display_name = replyToMsg.display_name;
        payload.reply_content     = replyToMsg.content;
        chatCancelReply();
      }
      const { error } = await supabaseClient.from('messages').insert(payload);
      if (error) { console.error('Send error:', error); showNotification('❌ Failed to send message'); }
    }

    // ================================================================
    // FRIENDS SYSTEM
    // ================================================================

    async function friendsLoad() {
      if (!supabaseClient || !currentUser) return;

      // Rows where I sent the request (user_id = me) and it was accepted
      const { data: sentRows } = await supabaseClient
        .from('friends')
        .select('id, friend_id, status, profiles!friends_friend_id_fkey(id, username, display_name, avatar_url, status)')
        .eq('user_id', currentUser.id)
        .eq('status', 'accepted');

      // Rows where someone sent me a request (friend_id = me) and it was accepted
      const { data: recvRows } = await supabaseClient
        .from('friends')
        .select('id, user_id, status, profiles!friends_user_id_fkey(id, username, display_name, avatar_url, status)')
        .eq('friend_id', currentUser.id)
        .eq('status', 'accepted');

      friendsList = [];
      // Deduplicate by profile id
      const seen = new Set();
      if (sentRows) sentRows.forEach(r => {
        const p = r.profiles;
        if (p && !seen.has(p.id)) { seen.add(p.id); friendsList.push({ friendRowId: r.id, ...p }); }
      });
      if (recvRows) recvRows.forEach(r => {
        const p = r.profiles;
        if (p && !seen.has(p.id)) { seen.add(p.id); friendsList.push({ friendRowId: r.id, ...p }); }
      });

      // Incoming pending requests (friend_id = me, status = pending)
      const { data: reqRows } = await supabaseClient
        .from('friends')
        .select('id, user_id, profiles!friends_user_id_fkey(id, username, display_name, avatar_url)')
        .eq('friend_id', currentUser.id)
        .eq('status', 'pending');
      friendRequests = reqRows || [];

      friendsRenderPanel();
    }

    function friendsRenderPanel() {
      // Pending requests
      const reqSection = document.getElementById('friendRequestsSection');
      const reqList    = document.getElementById('friendRequestsList');
      if (reqSection && reqList) {
        if (friendRequests.length > 0) {
          reqSection.style.display = 'block';
          reqList.innerHTML = friendRequests.map(r => {
            const p = r.profiles;
            if (!p) return '';
            const init = (p.display_name || p.username || '?').charAt(0).toUpperCase();
            return `<div class="friend-req-item">
              <div class="friend-avatar">${init}</div>
              <div class="friend-info">
                <div class="friend-name">${escapeHtml(p.display_name || p.username)}</div>
                <div class="friend-sub">@${escapeHtml(p.username)}</div>
              </div>
              <div class="req-btns">
                <button class="req-btn accept" onclick="friendAccept('${r.id}','${p.id}')">✓</button>
                <button class="req-btn decline" onclick="friendDecline('${r.id}')">✕</button>
              </div>
            </div>`;
          }).join('');
        } else {
          reqSection.style.display = 'none';
        }
      }

      // Friends list
      const list = document.getElementById('friendsList');
      const countEl = document.getElementById('friendsOnlineCount');
      if (!list) return;
      if (friendsList.length === 0) {
        list.innerHTML = `<div style="text-align:center;padding:32px 12px;color:var(--text-soft);font-size:0.85rem;"><div style="font-size:2rem;margin-bottom:8px;">👾</div>No friends yet. Add one below!</div>`;
        if (countEl) countEl.textContent = '0';
        return;
      }
      const online = friendsList.filter(f => f.status === 'active').length;
      if (countEl) countEl.textContent = online;

      list.innerHTML = friendsList.map(f => {
        const init = (f.display_name || f.username || '?').charAt(0).toUpperCase();
        const statusClass = f.status === 'active' ? 'online' : f.status === 'idle' ? 'idle' : '';
        const avatarHtml = f.avatar_url
          ? `<img src="${f.avatar_url}" alt="">`
          : init;
        return `<div class="friend-item" id="fi-${f.id}">
          <div class="friend-avatar">
            ${avatarHtml}
            <span class="friend-status-dot ${statusClass}"></span>
          </div>
          <div class="friend-info">
            <div class="friend-name">${escapeHtml(f.display_name || f.username)}</div>
            <div class="friend-sub">@${escapeHtml(f.username)}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-action-btn" title="Send DM" onclick="friendOpenDM('${f.id}')">💬</button>
            <button class="friend-action-btn danger" title="Remove friend" onclick="friendRemove('${f.friendRowId}','${f.id}')">✕</button>
          </div>
        </div>`;
      }).join('');
    }

    async function friendSendRequest() {
      const input = document.getElementById('addFriendInput');
      const resultEl = document.getElementById('addFriendResult');
      const username = input?.value.trim().replace('@','');
      if (!username) return;
      resultEl.textContent = '';
      resultEl.style.color = 'var(--text-soft)';

      if (!supabaseClient || !currentUser) { resultEl.textContent = 'Sign in to add friends'; return; }
      if (username.toLowerCase() === (currentUser.username||'').toLowerCase()) {
        resultEl.textContent = "You can't add yourself!"; return;
      }

      // Find user by username
      const { data: target } = await supabaseClient
        .from('profiles').select('id, display_name, username').eq('username', username).maybeSingle();
      if (!target) { resultEl.textContent = '❌ User not found'; return; }

      // Check not already friends / pending
      const { data: existing } = await supabaseClient
        .from('friends')
        .select('id, status')
        .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${target.id}),and(user_id.eq.${target.id},friend_id.eq.${currentUser.id})`)
        .maybeSingle();

      if (existing) {
        const labels = { accepted: 'Already friends!', pending: 'Request already sent', blocked: 'User is blocked' };
        resultEl.textContent = labels[existing.status] || 'Already connected';
        return;
      }

      const { error } = await supabaseClient.from('friends').insert({
        user_id: currentUser.id, friend_id: target.id, status: 'pending'
      });
      if (error) { resultEl.textContent = '❌ Error sending request'; console.error(error); return; }

      resultEl.style.color = '#bbf7d0';
      resultEl.textContent = `✅ Request sent to ${target.display_name || target.username}`;
      if (input) input.value = '';
    }

    async function friendAccept(rowId, fromUserId) {
      await supabaseClient.from('friends').update({ status: 'accepted' }).eq('id', rowId);
      // Create reverse row so both sides see each other
      await supabaseClient.from('friends').upsert(
        { user_id: currentUser.id, friend_id: fromUserId, status: 'accepted' },
        { onConflict: 'user_id,friend_id', ignoreDuplicates: false }
      );
      showNotification('✅ Friend request accepted!');
      await friendsLoad();
    }

    async function friendDecline(rowId) {
      await supabaseClient.from('friends').delete().eq('id', rowId);
      await friendsLoad();
    }

    async function friendRemove(rowId, friendUserId) {
      if (!confirm('Remove this friend?')) return;
      // Delete both directions
      await supabaseClient.from('friends').delete()
        .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${friendUserId}),and(user_id.eq.${friendUserId},friend_id.eq.${currentUser.id})`);
      showNotification('Friend removed');
      await friendsLoad();
    }

    async function friendOpenDM(friendUserId) {
      if (!supabaseClient || !currentUser) return;
      // Check if a DM chat already exists between these two users
      const { data: myChats } = await supabaseClient
        .from('chat_members').select('chat_id').eq('user_id', currentUser.id);
      const { data: theirChats } = await supabaseClient
        .from('chat_members').select('chat_id').eq('user_id', friendUserId);

      const myIds    = new Set((myChats||[]).map(r => r.chat_id));
      const theirIds = new Set((theirChats||[]).map(r => r.chat_id));
      const shared   = [...myIds].filter(id => theirIds.has(id));

      // Find which shared chat is a DM (type='dm', not public)
      let dmChatId = null;
      if (shared.length > 0) {
        const { data: sharedChats } = await supabaseClient
          .from('chats').select('id, type, is_public').in('id', shared);
        const dm = (sharedChats||[]).find(c => c.type === 'dm' && !c.is_public);
        if (dm) dmChatId = dm.id;
      }

      if (!dmChatId) {
        // Create DM chat
        const { data: newChat, error } = await supabaseClient
          .from('chats').insert({ type: 'dm', created_by: currentUser.id, owner_id: currentUser.id })
          .select().single();
        if (error || !newChat) { console.error('DM create error', error); return; }
        dmChatId = newChat.id;
        // Add both users
        await supabaseClient.from('chat_members').insert([
          { chat_id: dmChatId, user_id: currentUser.id },
          { chat_id: dmChatId, user_id: friendUserId }
        ]);
      }

      // Navigate to the DM
      closeFriendsPanel();
      await chatLoadSidebar();
      chatSwitchRoom(dmChatId);

      // Open chat view / panel
      if (document.getElementById('mpChat')?.classList.contains('show') ||
          document.getElementById('mpChatRooms')) {
        // Solar UI — open chat panel
        closeAllMinimalPanels();
        mpActivePanel = 'mpChat';
        document.getElementById('mpChat').classList.add('show');
      } else {
        showChatView?.();
      }
    }

    // ================================================================
    // GROUP CHAT
    // ================================================================

    function openFriendsPanel() {
      document.getElementById('friendsPanel').classList.add('show');
      if (supabaseClient && currentUser) friendsLoad();
    }
    function closeFriendsPanel() { document.getElementById('friendsPanel').classList.remove('show'); }

    function openNewGroupModal() {
      const list = document.getElementById('groupMemberList');
      if (list) {
        if (friendsList.length === 0) {
          list.innerHTML = `<div style="color:var(--text-soft);font-size:0.82rem;padding:8px 0;">No friends to add yet.</div>`;
        } else {
          list.innerHTML = friendsList.map(f => `
            <div class="modal-member-item">
              <input type="checkbox" class="modal-member-check" id="gm-${f.id}" value="${f.id}">
              <label for="gm-${f.id}" style="cursor:pointer;font-size:0.85rem;">
                ${escapeHtml(f.display_name || f.username)}
                <span style="color:var(--text-soft);font-size:0.75rem;"> @${escapeHtml(f.username)}</span>
              </label>
            </div>`).join('');
        }
      }
      document.getElementById('newGroupModal').classList.add('show');
      document.getElementById('newGroupName').value = '';
    }
    function closeNewGroupModal() { document.getElementById('newGroupModal').classList.remove('show'); }

    async function chatCreateGroup() {
      const name = document.getElementById('newGroupName')?.value.trim();
      if (!name) { showNotification('❌ Enter a group name'); return; }
      const checked = [...document.querySelectorAll('.modal-member-check:checked')].map(c => c.value);
      if (checked.length === 0) { showNotification('❌ Select at least one friend'); return; }
      if (!supabaseClient || !currentUser) return;

      // Create group chat
      const { data: newChat, error } = await supabaseClient
        .from('chats').insert({ type: 'group', name, created_by: currentUser.id, owner_id: currentUser.id })
        .select().single();
      if (error || !newChat) { console.error('Group create error:', error); return; }

      // Add all members including self
      const members = [currentUser.id, ...checked].map(uid => ({ chat_id: newChat.id, user_id: uid }));
      await supabaseClient.from('chat_members').insert(members);

      closeNewGroupModal();
      showNotification(`✅ Group "${name}" created!`);
      await chatLoadSidebar();
      chatSwitchRoom(newChat.id);
    }

    // ================================================================
    // LEGACY STUBS (kept so old call-sites don't crash)
    // ================================================================
    function checkChatUser() { /* replaced by initAuthAndProfile */ }
    function saveChatUser()  { /* replaced by authSignUp */ }
    async function loadMessages() { await chatLoadMessages(); }
    async function subscribeToMessages() { chatSubscribeRoom(); }
    function renderMessage(msg, animate = false) { chatRenderMessage(msg, animate); }
    async function sendMessage() { await chatSend(); }
    function scrollToBottom() {
      ['chatMessages','mpMessages'].forEach(id => {
        const el = document.getElementById(id); if (el) el.scrollTop = el.scrollHeight;
      });
    }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }

    // ================================================================
    // Notification helper — defined earlier in §24 CORE FUNCTIONS
    // ================================================================

    // Room-switching event delegation for static .chat-room-btn elements (legacy)
    document.addEventListener('click', e => {
      const btn = e.target.closest('.chat-room-btn[data-room]');
      if (btn) {
        const roomName = btn.dataset.room;
        const chatId = PUBLIC_ROOM_IDS[roomName];
        if (chatId) chatSwitchRoom(chatId);
      }
    });


    // ================================================================
    // §27  VALENTINE'S UPDATE — New Features
    // Spotlight · Favorites · Recently Played · Reactions · Reply-to
    // Delete Messages · Typing Indicators · Presence · Valentine Mode
    // ================================================================

    // ---- Spotlight Search ----
    let spotlightIdx = -1;

    function spotlightOpen() {
      document.getElementById('spotlightOverlay').classList.add('show');
      setTimeout(() => document.getElementById('spotlightInput').focus(), 50);
      spotlightSearch('');
    }

    function spotlightClose(e) {
      if (!e || e.target === document.getElementById('spotlightOverlay')) {
        document.getElementById('spotlightOverlay').classList.remove('show');
        document.getElementById('spotlightInput').value = '';
      }
    }

    function spotlightSearch(q) {
      q = (q || '').toLowerCase().trim();
      const results = document.getElementById('spotlightResults');
      let html = '';
      spotlightIdx = -1;

      // Views
      const views = [
        { name:'Games Library', sub:'View', icon:'🎮', action:"showLibraryView()" },
        { name:'App Library', sub:'View', icon:'📱', action:"showAppView()" },
        { name:'Customize', sub:'View', icon:'🎨', action:"showCustomizeView()" },
        { name:'Settings', sub:'View', icon:'⚙️', action:"showSettingsView()" },
        { name:'Chat', sub:'View', icon:'💬', action:"showChatView()" },
        { name:'Friends', sub:'View', icon:'👥', action:"openFriendsPanel()" },
        { name:"Valentine's Mode", sub:'Toggle', icon:'💝', action:"document.getElementById('valentineToggle').click()" },
        { name:'Spotlight', sub:'Hint', icon:'🔍', action:"" },
      ];
      const matchViews = q ? views.filter(v => v.name.toLowerCase().includes(q)) : views.slice(0,4);
      if (matchViews.length) {
        html += '<div class="spotlight-section-label">Views & Actions</div>';
        matchViews.forEach(v => {
          html += `<div class="spotlight-item" onclick="${v.action};spotlightClose()"><div class="spotlight-item-icon">${v.icon}</div><div><div class="spotlight-item-name">${v.name}</div><div class="spotlight-item-sub">${v.sub}</div></div></div>`;
        });
      }

      // Games
      if (typeof games !== 'undefined') {
        const matchGames = q
          ? games.filter(g => g.name.toLowerCase().includes(q) || (g.tags||[]).some(t=>t.includes(q)))
          : recentlyPlayed.slice(0,4).map(id => games.find(g=>g.id===id)).filter(Boolean);
        if (matchGames.length) {
          html += `<div class="spotlight-section-label">${q ? 'Games' : 'Recent Games'}</div>`;
          matchGames.slice(0,6).forEach(g => {
            html += `<div class="spotlight-item" onclick="openGame(games.find(g=>g.id==='${g.id}'));spotlightClose()"><div class="spotlight-item-icon">🎮</div><div><div class="spotlight-item-name">${escapeHtml(g.name)}</div><div class="spotlight-item-sub">${g.category}</div></div></div>`;
          });
        }
      }

      // Apps
      if (typeof apps !== 'undefined') {
        const matchApps = q ? apps.filter(a => a.name.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q)) : [];
        if (matchApps.length) {
          html += '<div class="spotlight-section-label">Apps</div>';
          matchApps.slice(0,5).forEach(a => {
            html += `<div class="spotlight-item" onclick="window.open('${a.url}','_blank');spotlightClose()"><div class="spotlight-item-icon">${a.icon}</div><div><div class="spotlight-item-name">${escapeHtml(a.name)}</div><div class="spotlight-item-sub">${a.desc}</div></div></div>`;
          });
        }
      }

      // Friends
      if (q && friendsList.length) {
        const matchFriends = friendsList.filter(f => (f.display_name||'').toLowerCase().includes(q) || (f.username||'').toLowerCase().includes(q));
        if (matchFriends.length) {
          html += '<div class="spotlight-section-label">Friends</div>';
          matchFriends.slice(0,4).forEach(f => {
            html += `<div class="spotlight-item" onclick="friendOpenDM('${f.id}');spotlightClose()"><div class="spotlight-item-icon">👤</div><div><div class="spotlight-item-name">${escapeHtml(f.display_name||f.username)}</div><div class="spotlight-item-sub">@${escapeHtml(f.username)}</div></div></div>`;
          });
        }
      }

      results.innerHTML = html || '<div class="spotlight-empty">No results found</div>';
    }

    function spotlightKey(e) {
      const items = document.querySelectorAll('#spotlightResults .spotlight-item');
      if (e.key === 'Escape') { spotlightClose(); return; }
      if (e.key === 'ArrowDown') { spotlightIdx = Math.min(spotlightIdx+1, items.length-1); }
      else if (e.key === 'ArrowUp') { spotlightIdx = Math.max(spotlightIdx-1, 0); }
      else if (e.key === 'Enter' && spotlightIdx >= 0) { items[spotlightIdx]?.click(); return; }
      else return;
      items.forEach((el,i) => el.classList.toggle('selected', i === spotlightIdx));
      items[spotlightIdx]?.scrollIntoView({ block:'nearest' });
      e.preventDefault();
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        spotlightOpen();
      }
      if (e.key === 'Escape') {
        spotlightClose();
        closeFriendsPanel();
        closeNewGroupModal();
        const profilePanel = document.getElementById('profilePanel');
        if (profilePanel?.classList.contains('show')) profilePanel.classList.remove('show');
      }
    });

    // ---- Favorites ----
    let gameFavorites = JSON.parse(localStorage.getItem('nebulahub-favorites') || '[]');

    function toggleFavorite(gameId, e) {
      e.stopPropagation();
      const idx = gameFavorites.indexOf(gameId);
      if (idx === -1) gameFavorites.push(gameId);
      else gameFavorites.splice(idx, 1);
      localStorage.setItem('nebulahub-favorites', JSON.stringify(gameFavorites));
      renderGrid();
    }

    // ---- Recently Played ----
    let recentlyPlayed = JSON.parse(localStorage.getItem('nebulahub-recent') || '[]');

    function addRecentGame(gameId) {
      recentlyPlayed = [gameId, ...recentlyPlayed.filter(id => id !== gameId)].slice(0, 5);
      localStorage.setItem('nebulahub-recent', JSON.stringify(recentlyPlayed));
      renderRecentStrip();
    }

    function renderRecentStrip() {
      const section = document.getElementById('recentGamesSection');
      const strip   = document.getElementById('recentGamesStrip');
      if (!section || !strip || typeof games === 'undefined') return;
      const recent = recentlyPlayed.map(id => games.find(g=>g.id===id)).filter(Boolean);
      if (recent.length === 0) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      strip.innerHTML = recent.map(g => `
        <div class="recent-chip" onclick="openGame(games.find(g=>g.id==='${g.id}'))">
          🕒 ${escapeHtml(g.name)}
        </div>`).join('');
    }

    // openGame is defined in §24 above; we extend it by overwriting after definition.
    // The actual override happens via the renderGrid patch which uses the local openGame.
    // addRecentGame is called directly from card click handlers via the patched renderGrid.

    // ---- Valentine's Mode ----
    let _heartInterval = null;

    function applyValentineMode(on) {
      document.body.classList.toggle('valentine-mode', on);
      localStorage.setItem('nebulahub-valentine', on ? '1' : '0');
      if (on) startHeartParticles();
      else stopHeartParticles();
    }

    function startHeartParticles() {
      stopHeartParticles();
      _heartInterval = setInterval(() => {
        if (!document.body.classList.contains('valentine-mode')) return stopHeartParticles();
        const h = document.createElement('div');
        h.className = 'heart-particle';
        h.textContent = ['💝','💖','💗','💓','❤️','💕'][Math.floor(Math.random()*6)];
        h.style.left = Math.random() * 100 + 'vw';
        h.style.bottom = '-20px';
        const dur = 4 + Math.random() * 4;
        h.style.animationDuration = dur + 's';
        h.style.fontSize = (0.8 + Math.random() * 1.2) + 'rem';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), dur * 1000);
      }, 600);
    }

    function stopHeartParticles() {
      clearInterval(_heartInterval);
      _heartInterval = null;
      document.querySelectorAll('.heart-particle').forEach(h => h.remove());
    }

    // ---- Message Reactions ----
    const REACTION_EMOJIS = ['👍','❤️','😂','😮','😢','🔥'];
    let msgReactions = {}; // { msgId: [{emoji, count, mine}] }

    async function chatLoadReactions(messageIds) {
      if (!supabaseClient || !messageIds.length) return;
      const { data } = await supabaseClient
        .from('reactions')
        .select('message_id, emoji, user_id')
        .in('message_id', messageIds);
      if (!data) return;
      msgReactions = {};
      data.forEach(r => {
        if (!msgReactions[r.message_id]) msgReactions[r.message_id] = {};
        if (!msgReactions[r.message_id][r.emoji]) msgReactions[r.message_id][r.emoji] = { count: 0, mine: false };
        msgReactions[r.message_id][r.emoji].count++;
        if (r.user_id === currentUser?.id) msgReactions[r.message_id][r.emoji].mine = true;
      });
      // Render all reaction rows
      document.querySelectorAll('[data-msgid]').forEach(el => {
        const mid = el.dataset.msgid;
        renderReactionRow(el, mid);
      });
    }

    function renderReactionRow(msgEl, msgId) {
      let row = msgEl.querySelector('.msg-reactions');
      if (!row) { row = document.createElement('div'); row.className = 'msg-reactions'; msgEl.querySelector('.message-content')?.appendChild(row); }
      const reacts = msgReactions[msgId] || {};
      row.innerHTML = Object.entries(reacts).filter(([,v])=>v.count>0).map(([emoji, v]) =>
        `<span class="reaction-pill ${v.mine?'mine':''}" onclick="chatToggleReaction('${msgId}','${emoji}',this)">${emoji} <span class="r-count">${v.count}</span></span>`
      ).join('');
    }

    async function chatToggleReaction(msgId, emoji, pill) {
      if (!currentUser || !supabaseClient) return;
      const reacts = msgReactions[msgId] || {};
      const existing = reacts[emoji];
      if (existing?.mine) {
        // Remove reaction
        await supabaseClient.from('reactions').delete()
          .eq('message_id', msgId).eq('user_id', currentUser.id).eq('emoji', emoji);
        if (reacts[emoji]) { reacts[emoji].count--; reacts[emoji].mine = false; }
      } else {
        // Add reaction
        await supabaseClient.from('reactions').insert({ message_id: msgId, user_id: currentUser.id, emoji });
        if (!reacts[emoji]) reacts[emoji] = { count: 0, mine: false };
        reacts[emoji].count++;
        reacts[emoji].mine = true;
      }
      msgReactions[msgId] = reacts;
      const msgEl = document.querySelector(`[data-msgid="${msgId}"]`);
      if (msgEl) renderReactionRow(msgEl, msgId);
    }

    function showReactionPicker(msgId, anchorBtn) {
      // Close any open picker
      document.querySelectorAll('.reaction-picker.show').forEach(p => p.classList.remove('show'));
      let picker = anchorBtn.parentElement.querySelector('.reaction-picker');
      if (!picker) {
        picker = document.createElement('div');
        picker.className = 'reaction-picker';
        picker.innerHTML = REACTION_EMOJIS.map(e =>
          `<button onclick="chatToggleReaction('${msgId}','${e}',this);this.closest('.reaction-picker').classList.remove('show')">${e}</button>`
        ).join('');
        anchorBtn.parentElement.appendChild(picker);
      }
      picker.classList.toggle('show');
      // Close on outside click
      setTimeout(() => {
        const close = ev => { picker.classList.remove('show'); document.removeEventListener('click', close); };
        document.addEventListener('click', close);
      }, 50);
    }

    // ---- Reply-to ----
    let replyToMsg = null; // { id, display_name, content }

    function chatSetReply(msgId, name, text) {
      replyToMsg = { id: msgId, display_name: name, content: text };
      const bar = document.getElementById('replyBar');
      const nameEl = document.getElementById('replyBarName');
      const textEl = document.getElementById('replyBarText');
      if (bar) bar.classList.add('show');
      if (nameEl) nameEl.textContent = name;
      document.getElementById('messageInput')?.focus();
    }

    function chatCancelReply() {
      replyToMsg = null;
      document.getElementById('replyBar')?.classList.remove('show');
    }

    // ---- Delete message ----
    async function chatDeleteMsg(msgId) {
      if (!confirm('Delete this message?')) return;
      await supabaseClient.from('messages').update({ deleted_at: new Date().toISOString(), content: '🗑️ This message was deleted' }).eq('id', msgId).eq('sender_id', currentUser.id);
      const el = document.querySelector(`[data-msgid="${msgId}"]`);
      if (el) {
        el.classList.add('message-deleted');
        const txt = el.querySelector('.message-text');
        if (txt) txt.textContent = '🗑️ This message was deleted';
      }
    }

    // ---- Typing Indicators ----
    let typingChannel = null;
    let typingTimeout = null;
    let typersMap = {}; // { userId: { name, ts } }

    function chatStartTyping() {
      if (!supabaseClient || !currentChatId || !currentUser) return;
      clearTimeout(typingTimeout);
      typingChannel?.send({ type: 'broadcast', event: 'typing', payload: { user_id: currentUser.id, display_name: currentUser.display_name || currentUser.username } });
      typingTimeout = setTimeout(chatStopTyping, 3000);
    }

    function chatStopTyping() {
      clearTimeout(typingTimeout);
      typingChannel?.send({ type: 'broadcast', event: 'stop_typing', payload: { user_id: currentUser.id } });
    }

    function chatSubscribeTyping(chatId) {
      if (typingChannel) { supabaseClient.removeChannel(typingChannel); typingChannel = null; }
      typersMap = {};
      if (!supabaseClient || !chatId) return;
      typingChannel = supabaseClient.channel(`typing:${chatId}`)
        .on('broadcast', { event: 'typing' }, ({ payload }) => {
          if (payload.user_id === currentUser?.id) return;
          typersMap[payload.user_id] = { name: payload.display_name, ts: Date.now() };
          chatUpdateTypingUI();
        })
        .on('broadcast', { event: 'stop_typing' }, ({ payload }) => {
          delete typersMap[payload.user_id];
          chatUpdateTypingUI();
        })
        .subscribe();
      // Clean stale typers every 4s
      setInterval(() => {
        const now = Date.now();
        Object.keys(typersMap).forEach(uid => { if (now - typersMap[uid].ts > 4000) delete typersMap[uid]; });
        chatUpdateTypingUI();
      }, 2000);
    }

    function chatUpdateTypingUI() {
      const indicator = document.getElementById('typingIndicator');
      const textEl    = document.getElementById('typingText');
      if (!indicator || !textEl) return;
      const names = Object.values(typersMap).map(t => t.name);
      if (names.length === 0) {
        indicator.classList.remove('show');
      } else {
        indicator.classList.add('show');
        textEl.textContent = names.length === 1
          ? `${names[0]} is typing...`
          : `${names.slice(0,-1).join(', ')} and ${names.at(-1)} are typing...`;
      }
    }

    // ---- Online Presence ----
    let presenceInterval = null;

    function startPresenceHeartbeat() {
      if (!supabaseClient || !currentUser) return;
      const update = () => supabaseClient.from('profiles').update({ status: 'active', last_seen: new Date().toISOString() }).eq('id', currentUser.id);
      update();
      presenceInterval = setInterval(update, 30000);
      // Set idle after 2min of no activity
      let idleTimer;
      const resetIdle = () => {
        clearTimeout(idleTimer);
        supabaseClient.from('profiles').update({ status: 'active' }).eq('id', currentUser.id);
        idleTimer = setTimeout(() => supabaseClient.from('profiles').update({ status: 'idle' }).eq('id', currentUser.id), 120000);
      };
      ['mousemove','keydown','click','touchstart'].forEach(ev => document.addEventListener(ev, resetIdle, { passive: true }));
      // Set inactive on page hide
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) supabaseClient.from('profiles').update({ status: 'idle' }).eq('id', currentUser.id);
        else resetIdle();
      });
      window.addEventListener('beforeunload', () => supabaseClient.from('profiles').update({ status: 'inactive' }).eq('id', currentUser.id));
    }

    // Wire typing event to message input
    document.getElementById('messageInput')?.addEventListener('input', chatStartTyping);
    document.getElementById('mpChatInput')?.addEventListener('input', chatStartTyping);


    // ---- Load Valentine's and interface settings on boot ----
    function loadValentineSettings() {
      if (localStorage.getItem('nebulahub-valentine') === '1') {
        const tog = document.getElementById('valentineToggle');
        if (tog) { tog.checked = true; applyValentineMode(true); }
      }
    }

    // ================================================================
    // §26  INIT — Event Listeners & Bootstrap
    // ================================================================
    document.getElementById('sendMessageBtn').addEventListener('click', chatSend);
    document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key === 'Enter') chatSend(); });
    document.getElementById('devPasswordInput').addEventListener('keypress', e => { if (e.key === 'Enter') devMode.authenticate(); });

    document.addEventListener("DOMContentLoaded", () => {
      if (location.hash === "#portal") document.body.classList.add("portal-mode");
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();
      loadSavedCustomTheme();
      loadTabCloak();
      loadSavedUI();
      devMode.init();
      renderAnnouncements();
      const savedPanic = localStorage.getItem('nebulahub-panic-url');
      if (savedPanic) { panicUrl = savedPanic; document.getElementById('panicUrlInput').value = savedPanic; }
      renderGrid();
      renderRecentStrip();
      loadInterfaceSettings();
      loadValentineSettings();
      // Init Supabase + Auth on every page load
      initSupabase();
      initProfileListeners();
    });
  </script>
</body>
</html>
